<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>20170719 [學習筆記] 30天作業系統自作入門筆記 (2)</title>
    <meta name="description" content="  20170719 - Day_2          一、修改 helloos.nas      二、編譯 helloos.nas        工作環境          Lubuntu 17.04      VMware Workstation 12.5.2        參考資料          Lin...">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href=" /css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href=" /css/main.css ">
    <link rel="canonical" href="http://shouzo.github.io/2017/07/19/30OS_day2/">
    <link rel="alternate" type="application/rss+xml" title="少左 shouzo" href="http://shouzo.github.io /feed.xml ">



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">少左 shouzo</a>
        <small>Be strong to Be useful！</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/blog/index.html">
                    
                        <i class="fa fa-home"></i>首頁 Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>內容 Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分類 Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>標籤 Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>收藏 Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/demo/">
                        
                            <i class="fa fa-play"></i>展示 Demo
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-commenting"></i>關於 About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>20170719 [學習筆記] 30天作業系統自作入門筆記 (2)</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-07-19
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#組合語言" title="Category: 組合語言" rel="category">組合語言</a>&nbsp;
    
        <a href="/category/#C語言" title="Category: C語言" rel="category">C語言</a>&nbsp;
    
        <a href="/category/#作業系統" title="Category: 作業系統" rel="category">作業系統</a>&nbsp;
    
        <a href="/category/#程式設計" title="Category: 程式設計" rel="category">程式設計</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#%E7%B5%84%E5%90%88%E8%AA%9E%E8%A8%80" title="Tag: 組合語言" rel="tag">組合語言</a-->
        <a href="/tag/#組合語言" title="Tag: 組合語言" rel="tag">組合語言</a>&nbsp;
    
        <!--a href="/tag/#C%E8%AA%9E%E8%A8%80" title="Tag: C語言" rel="tag">C語言</a-->
        <a href="/tag/#C語言" title="Tag: C語言" rel="tag">C語言</a>&nbsp;
    
        <!--a href="/tag/#%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1" title="Tag: 作業系統" rel="tag">作業系統</a-->
        <a href="/tag/#作業系統" title="Tag: 作業系統" rel="tag">作業系統</a>&nbsp;
    
        <!--a href="/tag/#%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88" title="Tag: 程式設計" rel="tag">程式設計</a-->
        <a href="/tag/#程式設計" title="Tag: 程式設計" rel="tag">程式設計</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#20170719---day_2" id="markdown-toc-20170719---day_2">20170719 - Day_2</a>    <ul>
      <li><a href="#一修改-helloosnas" id="markdown-toc-一修改-helloosnas">一、修改 <code class="highlighter-rouge">helloos.nas</code></a></li>
      <li><a href="#二編譯-helloosnas" id="markdown-toc-二編譯-helloosnas">二、編譯 <code class="highlighter-rouge">helloos.nas</code></a></li>
      <li><a href="#三啟動虛擬機讀取-osimg" id="markdown-toc-三啟動虛擬機讀取-osimg">三、啟動虛擬機，讀取 <code class="highlighter-rouge">os.img</code></a></li>
    </ul>
  </li>
</ul>

<ul>
  <li>工作環境
    <ul>
      <li>Lubuntu 17.04</li>
      <li>VMware Workstation 12.5.2</li>
    </ul>
  </li>
  <li>參考資料
    <ul>
      <li>Linux 版本筆記：<a href="http://lengly.top/archives/85">http://lengly.top/archives/85</a></li>
    </ul>
  </li>
</ul>

<h1 id="20170719---day_2">20170719 - Day_2</h1>
<ul>
  <li>進度摘要
    <ul>
      <li>簡易 IPL 製作。</li>
    </ul>
  </li>
  <li>完整專案
    <ul>
      <li><a href="https://github.com/shouzo/My-30OS/tree/master/20170719">https://github.com/shouzo/My-30OS/tree/master/20170719</a></li>
    </ul>
  </li>
  <li>參考資料
    <ul>
      <li><a href="https://blog.gtwang.org/linux/dd-command-examples/">dd 指令教學與實用範例，備份與回復資料的小工具</a></li>
    </ul>
  </li>
</ul>

<h2 id="一修改-helloosnas">一、修改 <code class="highlighter-rouge">helloos.nas</code></h2>
<ul>
  <li><code class="highlighter-rouge">RESB	0x7dfe-$</code> 此行無法通過編譯，故修改成 <code class="highlighter-rouge">TIMES 510-($-$$)    DB    0</code>。
    <ul>
      <li><code class="highlighter-rouge">$</code> 代表目前行的位址，<code class="highlighter-rouge">$$</code> 為目前 section 的位址。(TIMES 意思為重複，先決定次數再確定重複的內容)。</li>
    </ul>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>; hello-os
; TAB=4

ORG		0x7c00			; 指定從 0x7c00 開始執行

;   以下是為了標準 FAT12 格式的軟式磁碟片的記述

    JMP		entry
    DB		0x90
    DB		"HELLOIPL"		
    DW		512				
    DB		1				
    DW		1				
    DB		2				
    DW		224				
    DW		2880			
    DB		0xf0			
    DW		9				
    DW		18				
    DW		2				
    DD		0				
    DD		2880			
    DB		0,0,0x29		
    DD		0xffffffff		
    DB		"HELLO-OS   "	
    DB		"FAT12   "		
    RESB	18				


; 程式碼本身

entry:
    MOV		AX,0			; 暫存器初始化
    MOV		SS,AX
    MOV		SP,0x7c00
    MOV		DS,AX
    MOV		ES,AX

    MOV		SI,msg


putloop:
    MOV		AL,[SI]
    ADD		SI,1			; 在 SI 加 1
    CMP		AL,0
    JE		fin
    MOV		AH,0x0e			; 一個文字表示功能
    MOV		BX,15			; 顏色代碼 (color code)
    INT		0x10			; 呼叫視訊 BIOS
    JMP		putloop


fin:
    HLT						; 直到有了某個物件就將 CPU 停止
    JMP		fin				; 無限迴圈


msg:
    DB		0x0a, 0x0a		; 連續兩個換行
    DB		"hello, world"
    DB		0x0a			; 換行 
    DB		0

    ; RESB	0x7dfe-$	       ; 此行編譯無法通過，故修改成 "TIMES 510-($-$$)    DB    0"
    TIMES 510-($-$$)    DB    0      ; "$" 代表目前行的位址，"$$" 為目前 section 的位址。(TIMES 意思為重複，先確定次數再確定重複的內容)

    DB		0x55, 0xaa
</code></pre></div></div>

<h2 id="二編譯-helloosnas">二、編譯 <code class="highlighter-rouge">helloos.nas</code></h2>
<ol>
  <li>編譯 <code class="highlighter-rouge">helloos.nas</code>，在輸出 <code class="highlighter-rouge">bootloader</code> 的同時也輸出列表檔案 <code class="highlighter-rouge">ipl.lst</code>。</li>
</ol>

<blockquote>
  <p>nasm -o bootloader -l ipl.lst helloos.nas</p>
</blockquote>

<p><img src="https://i.imgur.com/KfOYHIM.png" alt="" /></p>

<ol>
  <li>在 Linux 系統下使用 <code class="highlighter-rouge">dd</code> 指令產生 <code class="highlighter-rouge">os.img</code> 檔案。
    <ul>
      <li>先將 os.img 清空歸零，再將 bootloader 拷貝到 img 裡面。</li>
    </ul>
    <ul>
      <li>一個軟碟片容量：<strong>1.44MB = 512KB * 2880</strong></li>
    </ul>
  </li>
</ol>

<blockquote>
  <p>dd if=/dev/zero of=os.img bs=512 count=2880</p>

  <p>dd if=bootloader of=os.img bs=512 count=1</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if：指定輸入檔案
of：指定輸出檔案
bs：指定 block size，一次讀取與寫入 N 個位元組的資料
count：處理 N 個輸入區塊
</code></pre></div></div>

<p><img src="https://i.imgur.com/DbKECqo.png" alt="" /></p>

<ul>
  <li>如果打開 <code class="highlighter-rouge">ipl.lst</code> ，可以檢視組合語言轉換成機械碼的情形。</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     1                                  ; hello-os
     2                                  ; TAB=4
     3                                  
     4                                  ORG		0x7c00			    ;   指定從 0x7c00 開始執行
     5                                  
     6                                  ;   以下是為了標準 FAT12 格式的軟式磁碟片的記述
     7                                  
     8 00000000 EB4E                        JMP		entry
     9 00000002 90                          DB		0x90
    10 00000003 48454C4C4F49504C            DB		"HELLOIPL"		
    11 0000000B 0002                        DW		512				
    12 0000000D 01                          DB		1				
    13 0000000E 0100                        DW		1				
    14 00000010 02                          DB		2				
    15 00000011 E000                        DW		224				
    16 00000013 400B                        DW		2880			
    17 00000015 F0                          DB		0xf0			
    18 00000016 0900                        DW		9				
    19 00000018 1200                        DW		18				
    20 0000001A 0200                        DW		2				
    21 0000001C 00000000                    DD		0				
    22 00000020 400B0000                    DD		2880			
    23 00000024 000029                      DB		0,0,0x29		
    24 00000027 FFFFFFFF                    DD		0xffffffff		
    25 0000002B 48454C4C4F2D4F5320-         DB		"HELLO-OS   "	
    25 00000034 2020               
    26 00000036 4641543132202020            DB		"FAT12   "		
    27 0000003E &lt;res 00000012&gt;              RESB	18				
    27          ******************       warning: uninitialized space declared in .text section: zeroing
    28                                  
    29                                  
    30                                  
    31                                  
    32                                  ; 程式碼本身
    33                                  
    34                                  entry:
    35 00000050 B80000                      MOV		AX,0			;   暫存器初始化
    36 00000053 8ED0                        MOV		SS,AX
    37 00000055 BC007C                      MOV		SP,0x7c00
    38 00000058 8ED8                        MOV		DS,AX
    39 0000005A 8EC0                        MOV		ES,AX
    40                                  
    41 0000005C BE[7400]                    MOV		SI,msg
    42                                  
    43                                  
    44                                  putloop:
    45 0000005F 8A04                        MOV		AL,[SI]
    46 00000061 83C601                      ADD		SI,1			;   在 SI 加 1
    47 00000064 3C00                        CMP		AL,0
    48 00000066 7409                        JE		fin
    49 00000068 B40E                        MOV		AH,0x0e			;   一個文字表示功能
    50 0000006A BB0F00                      MOV		BX,15			;   顏色代碼 (color code)
    51 0000006D CD10                        INT		0x10			;   呼叫視訊 BIOS
    52 0000006F EBEE                        JMP		putloop
    53                                  
    54                                  
    55                                  fin:
    56 00000071 F4                          HLT						;   直到有了某個物件就將 CPU 停止
    57 00000072 EBFD                        JMP		fin				;   無限迴圈
    58                                  
    59                                  
    60                                  msg:
    61 00000074 0A0A                        DB		0x0a, 0x0a		;   連續兩個換行
    62 00000076 68656C6C6F2C20776F-         DB		"hello, world"
    62 0000007F 726C64             
    63 00000082 0A                          DB		0x0a			;   換行 
    64 00000083 00                          DB		0
    65                                  
    66                                      ;   RESB	0x7dfe-$	;   此行編譯無法通過，故修改成 "TIMES 510-($-$$)      DB      0"
    67 00000084 00&lt;rept&gt;                    TIMES 510-($-$$)    DB      0   ;   '$' 代表目前行的位址，'$$' 為目前 section 的位址。(TIMES 意思為重複，先確定次數再確定重複的內容)
    68                                  
    69 000001FE 55AA                        DB		0x55, 0xaa
</code></pre></div></div>

<h2 id="三啟動虛擬機讀取-osimg">三、啟動虛擬機，讀取 <code class="highlighter-rouge">os.img</code></h2>
<ul>
  <li>執行結果
<img src="https://i.imgur.com/ZwHRrHj.png" alt="" /></li>
</ul>


        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
                    
                
            
        
        

        <div class="post-recent">
    
    <div class="pre">

        <p><strong>上一篇</strong> <a href="/2017/07/14/30OS_day1/">20170714 [學習筆記] 30天作業系統自作入門筆記 (1)</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2017/07/20/Data_Structure_Book/">20170720 [學習筆記] 細談資料結構_6th (1)</a></p>
        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://shouzo.github.io/2017/07/19/30OS_day2/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://shouzo.github.io/2017/07/19/30OS_day2/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//shouzonotes.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


  <div class="wrapper">
     <p class="cc - icon">
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/"><img alt="創用 CC 授權條款" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png" /></a>
      </p>


      <p class="description">
          
          Martial Artist、Traceur & Engineer!
          
      </p>


        <p class="contact">
            Contact me at:
            
            <a href="https://github.com/shouzo"><i class="fa fa-github" aria-hidden="true"></i></a>
            

            
            <a href="mailto:danny200026@yahoo.com.tw"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>
            

            

            

            

            
            <a href="https://www.facebook.com/danny200026"><i class="fa fa-facebook-official" aria-hidden="true"></i></a>
            
        </p>


        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
            <span>
                <br> 除非另有註明，本部落格內容皆採用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/"> 創用 CC 姓名標示-非商業性-相同方式分享 3.0 台灣 </a> 授權條款
            </span>
        </p>

  </div>
	
	
	<div class="realtimeuserscounter realtimeuserscounter--styled"></div>
	<script src="https://realtimeusers.bycontrast.co/realtimeusers.js"></script>
	
</footer>
<script src="/js/main.js " charset="utf-8"></script>
    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
