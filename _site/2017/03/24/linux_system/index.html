<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>20170324 [學習筆記] Linux 系統程式 (4)</title>
    <meta name="description" content="  一、作業系統          Multithread Architecture      一、Multicore Programming      二、Concurrency vs Parallelism                  1. Concurrency          2. Paralle...">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href=" /css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href=" /css/main.css ">
    <link rel="canonical" href="http://shouzo.github.io/2017/03/24/linux_system/">
    <link rel="alternate" type="application/rss+xml" title="少左 shouzo" href="http://shouzo.github.io /feed.xml ">



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">少左 shouzo</a>
        <small>Be strong to Be useful！</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/blog/index.html">
                    
                        <i class="fa fa-home"></i>首頁 Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>內容 Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分類 Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>標籤 Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>收藏 Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/demo/">
                        
                            <i class="fa fa-play"></i>展示 Demo
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-commenting"></i>關於 About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>20170324 [學習筆記] Linux 系統程式 (4)</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-03-24
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Linux" title="Category: Linux" rel="category">Linux</a>&nbsp;
    
        <a href="/category/#作業系統" title="Category: 作業系統" rel="category">作業系統</a>&nbsp;
    
        <a href="/category/#程式設計" title="Category: 程式設計" rel="category">程式設計</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#Linux" title="Tag: Linux" rel="tag">Linux</a-->
        <a href="/tag/#Linux" title="Tag: Linux" rel="tag">Linux</a>&nbsp;
    
        <!--a href="/tag/#%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1" title="Tag: 作業系統" rel="tag">作業系統</a-->
        <a href="/tag/#作業系統" title="Tag: 作業系統" rel="tag">作業系統</a>&nbsp;
    
        <!--a href="/tag/#%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88" title="Tag: 程式設計" rel="tag">程式設計</a-->
        <a href="/tag/#程式設計" title="Tag: 程式設計" rel="tag">程式設計</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">一、作業系統</a>    <ul>
      <li><a href="#multithread-architecture" id="markdown-toc-multithread-architecture">Multithread Architecture</a></li>
      <li><a href="#multicore-programming" id="markdown-toc-multicore-programming">一、Multicore Programming</a></li>
      <li><a href="#concurrency-vs-parallelism" id="markdown-toc-concurrency-vs-parallelism">二、Concurrency vs Parallelism</a>        <ul>
          <li><a href="#concurrency" id="markdown-toc-concurrency">1. Concurrency</a></li>
          <li><a href="#parallelism" id="markdown-toc-parallelism">2. Parallelism</a></li>
          <li><a href="#concurrency-vs-parallelism-1" id="markdown-toc-concurrency-vs-parallelism-1">3. Concurrency vs Parallelism</a></li>
          <li><a href="#section-1" id="markdown-toc-section-1">4. 相關整理</a></li>
        </ul>
      </li>
      <li><a href="#single-and-multithreaded-processes" id="markdown-toc-single-and-multithreaded-processes">三、Single and Multithreaded Processes</a></li>
      <li><a href="#user-threads-and-kernel-threads" id="markdown-toc-user-threads-and-kernel-threads">四、User Threads and Kernel Threads</a></li>
      <li><a href="#multithreading-models" id="markdown-toc-multithreading-models">五、Multithreading Models</a></li>
      <li><a href="#pthreads" id="markdown-toc-pthreads">六、Pthreads</a>        <ul>
          <li><a href="#pthreadh" id="markdown-toc-pthreadh">pthread.h</a>            <ul>
              <li><a href="#pthreadcreate" id="markdown-toc-pthreadcreate">pthread_create()</a></li>
              <li><a href="#pthreadexit" id="markdown-toc-pthreadexit">pthread_exit()</a></li>
              <li><a href="#pthreadjoin" id="markdown-toc-pthreadjoin">pthread_join()</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#section-2" id="markdown-toc-section-2">課程作業</a></li>
    </ul>
  </li>
  <li><a href="#linux-" id="markdown-toc-linux-">二、Linux 程式設計</a>    <ul>
      <li><a href="#pthreads-1" id="markdown-toc-pthreads-1">一、Pthreads</a>        <ul>
          <li><a href="#pthreadh-1" id="markdown-toc-pthreadh-1">pthread.h</a>            <ul>
              <li><a href="#pthreadcreate-1" id="markdown-toc-pthreadcreate-1">pthread_create()</a></li>
              <li><a href="#pthreadexit-1" id="markdown-toc-pthreadexit-1">pthread_exit()</a></li>
              <li><a href="#pthreadjoin-1" id="markdown-toc-pthreadjoin-1">pthread_join()</a></li>
              <li><a href="#pthreadsetcancelstate" id="markdown-toc-pthreadsetcancelstate">pthread_setcancelstate()</a></li>
              <li><a href="#pthreadsetcanceltype" id="markdown-toc-pthreadsetcanceltype">pthread_setcanceltype()</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#condition-variables" id="markdown-toc-condition-variables">二、Condition Variables</a>        <ul>
          <li><a href="#pthreadconddestroy-condition" id="markdown-toc-pthreadconddestroy-condition">pthread_cond_destroy (condition)</a></li>
          <li><a href="#pthreadcondattrinit-attr" id="markdown-toc-pthreadcondattrinit-attr">pthread_condattr_init (attr)</a></li>
          <li><a href="#pthreadcondattrdestroy-attr" id="markdown-toc-pthreadcondattrdestroy-attr">pthread_condattr_destroy (attr)</a></li>
        </ul>
      </li>
      <li><a href="#thread-synchronization" id="markdown-toc-thread-synchronization">三、Thread Synchronization</a>        <ul>
          <li><a href="#seminit" id="markdown-toc-seminit">sem_init()</a></li>
          <li><a href="#semwait" id="markdown-toc-semwait">sem_wait()</a></li>
          <li><a href="#sempost" id="markdown-toc-sempost">sem_post()</a></li>
          <li><a href="#semdestroy" id="markdown-toc-semdestroy">sem_destroy()</a></li>
        </ul>
      </li>
      <li><a href="#mutex" id="markdown-toc-mutex">2. Mutex</a>        <ul>
          <li><a href="#pthreadmutexinit" id="markdown-toc-pthreadmutexinit">pthread_mutex_init()</a></li>
          <li><a href="#pthreadmutexlock" id="markdown-toc-pthreadmutexlock">pthread_mutex_lock()</a></li>
          <li><a href="#pthreadmutexunlock" id="markdown-toc-pthreadmutexunlock">pthread_mutex_unlock()</a></li>
          <li><a href="#pthreadmutexdestroy" id="markdown-toc-pthreadmutexdestroy">pthread_mutex_destroy()</a></li>
        </ul>
      </li>
      <li><a href="#section-3" id="markdown-toc-section-3">課程作業</a></li>
    </ul>
  </li>
</ul>

<h2 id="section">一、作業系統</h2>
<ul>
  <li>課程簡報
    <ul>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170323/ch04.pdf">Chapter 4: Mutithread Programming</a></li>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170323/Linux_programming_pthread.pdf">Linux_programming_pthread</a></li>
    </ul>
  </li>
  <li>參考資料
    <ul>
      <li><a href="https://hackmd.io/s/Skh_AaVix">Toward Concurrency</a></li>
      <li><a href="https://chi_gitbook.gitbooks.io/personal-note/content/amdahls_law.html">Amdahl’s Law</a></li>
    </ul>
  </li>
</ul>

<h3 id="multithread-architecture">Multithread Architecture</h3>
<p><img src="https://i.imgur.com/8ICdvBz.jpg" alt="" /><br />
* <strong>Responsiveness</strong> – may allow continued execution if part of process is blocked, especially important for user interfaces.<br />
* <strong>Resource Sharing</strong> – threads share resources of process, easier than shared memory or message passing.<br />
* <strong>Economy</strong> – cheaper than process creation, thread switching lower overhead than context switching.<br />
* <strong>Scalability</strong> – process can take advantage of multiprocessor architectures.</p>

<h3 id="multicore-programming">一、Multicore Programming</h3>
<ul>
  <li><strong>Multicore</strong> or <strong>multiprocessor</strong> systems putting pressure on programmers, challenges include:
    <ul>
      <li><strong>Dividing activities</strong></li>
      <li><strong>Balance</strong></li>
      <li><strong>Data splitting</strong></li>
      <li><strong>Data dependency</strong></li>
      <li><strong>Testing and debugging</strong></li>
    </ul>
  </li>
  <li><strong>Parallelism</strong> implies a system can perform more than one task simultaneously.</li>
  <li><strong>Concurrency</strong> supports more than one task making progress.
    <ul>
      <li>Single processor / core, scheduler providing concurrency</li>
    </ul>
  </li>
  <li>Types of parallelism
    <ul>
      <li><strong>Data parallelism</strong> – distributes subsets of the same data across multiple cores, same operation on each.</li>
      <li><strong>Task parallelism</strong> – distributing threads across cores, each thread performing unique operation.</li>
    </ul>
  </li>
  <li>As # of threads grows, so does architectural support for threading.
    <ul>
      <li>CPUs have cores as well as <strong>hardware threads</strong>.</li>
      <li>Consider Oracle SPARC T4 with 8 cores, and 8 hardware threads per core.</li>
    </ul>
  </li>
</ul>

<h3 id="concurrency-vs-parallelism">二、Concurrency vs Parallelism</h3>
<ul>
  <li>引用資料：<a href="https://hackmd.io/s/Skh_AaVix">Toward Concurrency</a></li>
  <li><a href="https://blog.golang.org/concurrency-is-not-parallelism">Concurrency is not Parallelism</a>, by Rob Pike
    <ul>
      <li><a href="https://talks.golang.org/2012/waza.slide#1">投影片</a></li>
      <li><a href="https://www.youtube.com/watch?v=cN_DpYBzKso">錄影</a></li>
      <li><a href="http://stackoverflow.com/questions/11700953/concurrency-is-not-parallelism">後續 stackoverflow 討論</a></li>
    </ul>
  </li>
  <li>Concurrency 對軟體設計的影響
    <ul>
      <li>想要充分使用到 CPU 的資源</li>
      <li>程式越來越有機會造成 CPU-bound。雖然主要還是 IO-bound 等，但如果 CPU 時脈無法增加，而其他存取方式速度變快，最後會發生 CPU-bound</li>
      <li>軟體效能優化將會越來越重要</li>
      <li>程式語言必須好好處理 concurrency</li>
    </ul>
  </li>
</ul>

<h4 id="concurrency">1. Concurrency</h4>
<ul>
  <li>是指程式架構，將程式拆開成多個可獨立運作的工作。eg：drivers，都可以獨立運作，但不需要平行化。
    <ul>
      <li>拆開多個的工作不一定要同時運行</li>
      <li>多個工作在單核心 CPU 上運行</li>
    </ul>
  </li>
</ul>

<h4 id="parallelism">2. Parallelism</h4>
<ul>
  <li>是指程式執行，同時執行多個程式。Concurrency 可能會用到 parallelism，但不一定要用 parallelism 才能實現 concurrency。eg：Vector dot product
    <ul>
      <li>程式會同時執行 (例如：分支後，同時執行，再收集結果)</li>
      <li>一個工作在多核心 CPU 上運行</li>
    </ul>
  </li>
</ul>

<h4 id="concurrency-vs-parallelism-1">3. Concurrency vs Parallelism</h4>
<ul>
  <li>
    <p>Rob Pike 用地鼠燒書做例子:<br />
<img src="https://hackpad-attachments.s3.amazonaws.com/embedded2016.hackpad.com_K6DJ0ZtiecH_p.537916_1460613009716_task.jpg" alt="" /></p>
  </li>
  <li>
    <p>如果今天增加多一只地鼠，一個推車或多一個焚燒盧，這樣有機會作到更好的資源使用率，但我們不能保證兩只或更多地鼠會同時進行 (可能只有有限的火爐)。在單核系統中只能允許一次進行一次的燒書工作，那樣就沒有效率了。<br />
<img src="https://i.imgur.com/XTGAK98.jpg" alt="" /><br />
以 Concurrency 的方式去作業，能夠以不同的解構方式去進行，可以是三個地鼠分別負責一部分的工作 (decomposition)<br />
<img src="https://i.imgur.com/w5Eugs7.jpg" alt="" /><br />
其中也可以 Parallelism:<br />
<img src="https://i.imgur.com/3IHX5BT.jpg" alt="" /><br />
或<br />
<img src="https://i.imgur.com/duEVvNK.jpg" alt="" /></p>
  </li>
</ul>

<p><strong>Concurrency:</strong> 是指程式架構，將程式拆開成多個可獨立運作的工作，像是驅動程式都可獨立運作，但不需要平行化<br />
* 拆開多個的工作不一定要同時運行<br />
* 多個工作在單核心 CPU 上運行</p>

<p><strong>Parallelism:</strong> 是指程式執行，同時執行多個程式。Concurrency 可能會用到 parallelism，但不一定要用 parallelism 才能實現 concurrency。eg：Vector dot product<br />
* 程式會同時執行 (例如：fork 後，同時執行，再收集結果 [join])<br />
* 一個工作在多核心 CPU 上運行</p>

<h4 id="section-1">4. 相關整理</h4>
<p>線上教材 <a href="https://www.youtube.com/watch?v=6jFkNjhJ-Z4">Introduction to OpenMP</a> 做了以下整理：</p>

<p>(1) Concurrent (並行)<br />
* 工作可拆分成「獨立執行」的部份，這樣「可以」讓很多事情一起做，但是「不一定」要真的同時做。下方情境：<br />
<img src="https://i.imgur.com/rweOyiD.png" alt="" /><br />
    * 展示具有並行性，但不去同時執行。<br />
    * 並行性是種「架構程式」的概念。寫下一段程式之前，思考問題架構時就決定好的。</p>

<p>(2) Parallel (平行)<br />
* 把規劃好、能夠並行的程式，分配給不同執行緒，並讓他們同時執行。<br />
<img src="https://i.imgur.com/Oom3wM5.png" alt="" /><br />
   * 「平行」是一種選擇。</p>

<h3 id="single-and-multithreaded-processes">三、Single and Multithreaded Processes</h3>
<p><img src="https://i.imgur.com/KLVunhJ.jpg" alt="" /></p>

<ul>
  <li><strong>Amdahl’s Law</strong>
    <ul>
      <li>針對系統裡面某一個特定的元件予以最佳化，對於整體系統有多少的效能改變。<br />
  <img src="https://i.imgur.com/E1L6ODN.jpg" alt="" /></li>
      <li>分成兩部份
        <ul>
          <li><strong>有辦法改進的部份</strong></li>
          <li><strong>沒有辦法改進的部份</strong></li>
        </ul>
      </li>
      <li>因為有無法改進的部份，所以不可能無限提升系統的某一個特定部分的效率。</li>
    </ul>
  </li>
</ul>

<h3 id="user-threads-and-kernel-threads">四、User Threads and Kernel Threads</h3>
<ul>
  <li><strong>User threads</strong>
    <ul>
      <li>Management done by user-level threads library.</li>
    </ul>
  </li>
  <li><strong>Kernel threads</strong>
    <ul>
      <li>Supported by the Kernel.</li>
    </ul>
  </li>
</ul>

<h3 id="multithreading-models">五、Multithreading Models</h3>
<ol>
  <li><strong>Many-to-One</strong>
    <ul>
      <li>Many user-level threads mapped to single kernel thread.</li>
      <li><strong>One thread blocking causes all to block.</strong></li>
      <li>Multiple threads may not run in parallel on muticore system because only one may be in kernel at a time.</li>
      <li>Examples：<code class="highlighter-rouge">Solaris Green Threads</code>、<code class="highlighter-rouge">GNU Portable Threads</code><br />
<img src="https://i.imgur.com/dwfuxrT.jpg" alt="" /></li>
    </ul>
  </li>
  <li><strong>One-to-One</strong>
    <ul>
      <li>Each user-level thread maps to kernel thread.</li>
      <li><strong>Creating a user-level thread creates a kernel thread.</strong></li>
      <li>More concurrency than many-to-one.</li>
      <li>Number of threads per process sometimes restricted due to overhead.</li>
      <li>Examples：<code class="highlighter-rouge">Windows NT/XP/2000</code>、<code class="highlighter-rouge">Linux</code>、<code class="highlighter-rouge">Solaris 9 and later</code><br />
<img src="https://i.imgur.com/Fh9QH0S.jpg" alt="" /></li>
    </ul>
  </li>
  <li><strong>Many-to-Many</strong>
    <ul>
      <li>Allows many user level threads to be mapped to many kernel threads.</li>
      <li>Allows the operating system to create a sufficient number of kernel threads.</li>
      <li>Solaris prior to version 9.</li>
      <li>Example：<code class="highlighter-rouge">Windows NT/2000 with the ThreadFiber package</code><br />
<img src="https://i.imgur.com/hWCuKOk.jpg" alt="" /></li>
    </ul>
  </li>
  <li><strong>Two-level</strong>
    <ul>
      <li>Similar to M:M, except that it allows a user thread to be bound to kernel thread.</li>
      <li>Examples：<code class="highlighter-rouge">IRIX</code>、<code class="highlighter-rouge">HP-UX</code>、<code class="highlighter-rouge">Tru64 UNIX</code>、<code class="highlighter-rouge">Solaris 8 and earlier</code><br />
<img src="https://i.imgur.com/iRt3Xj2.jpg" alt="" /></li>
    </ul>
  </li>
</ol>

<h3 id="pthreads">六、Pthreads</h3>
<ul>
  <li>May be provided either as user-level or kernel-level.</li>
  <li>A POSIX standard (IEEE 1003.1c) API for thread creation and synchronization.</li>
  <li><strong>Specification, not implementation.</strong></li>
  <li>API specifies behavior of the thread library, implementation is up to development of the library.</li>
  <li>Common in UNIX operating systems (Solaris, Linux, Mac OS X).</li>
</ul>

<h4 id="pthreadh">pthread.h</h4>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;pthread.h&gt;
</span>
<span class="kt">int</span> <span class="n">pthread_create</span><span class="p">(</span><span class="n">pthread_t</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span> <span class="n">pthread_attr_t</span>
<span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">start_routine</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="c1">//create a thread
</span>

<span class="kt">void</span> <span class="n">pthread_exit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">retval</span><span class="p">);</span>
<span class="c1">//terminate a thread
</span>

<span class="kt">int</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">pthread_t</span> <span class="n">th</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">thread_return</span><span class="p">);</span>
<span class="c1">//wait for thread termination
</span>
</code></pre>
</div>

<h5 id="pthreadcreate">pthread_create()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_create</span><span class="p">(</span><span class="n">pthread_t</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
<span class="n">pthread_attr_t</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">start_routine</span><span class="p">)(</span><span class="kt">void</span>
<span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">pthread_t *thread</code>：thread 的識別字</li>
  <li><code class="highlighter-rouge">pthread_attr_t *attr</code>：thread 的屬性，設定為 NULL 表示使用預設值</li>
  <li><code class="highlighter-rouge">void *(*start_routine)(void*)</code>：thread 要執行的 function</li>
  <li><code class="highlighter-rouge">void *arg</code>：傳遞給 thread 的參數</li>
</ul>

<h5 id="pthreadexit">pthread_exit()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="n">pthread_exit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">retval</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">void *retval</code>：thread 結束時回傳的變數</li>
</ul>

<h5 id="pthreadjoin">pthread_join()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">pthread_t</span> <span class="n">th</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">thread_return</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">pthread_t th</code>：thread 識別字</li>
  <li><code class="highlighter-rouge">void **thread_return</code>：接收 pthread_exit 傳回的變數</li>
</ul>

<h3 id="section-2">課程作業</h3>
<ul>
  <li>從 1 - 10000 之間取出所有的質數，利用 threads 來分配計算質數的範圍。</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;pthread.h&gt;
#include &lt;semaphore.h&gt; 
#include &lt;time.h&gt;
</span>
<span class="cp">#define NUM_THREADS 10
#define MSIZE 10000
</span>
<span class="c1">// 找出 1 - 10000 的所有質數
</span>
<span class="k">static</span> <span class="kt">double</span> <span class="n">getDoubleTime</span><span class="p">();</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">thread_function</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="n">pthread_mutex_t</span> <span class="n">work_mutex</span><span class="p">;</span>

<span class="c1">// 宣告 prime_array 陣列
</span><span class="kt">int</span> <span class="n">prime_array</span><span class="p">[</span><span class="n">NUM_THREADS</span><span class="p">][(</span><span class="n">MSIZE</span> <span class="o">/</span> <span class="n">NUM_THREADS</span><span class="p">)];</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">pthread_t</span> <span class="n">a_thread</span><span class="p">[</span><span class="n">NUM_THREADS</span><span class="p">];</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">thread_result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lots_of_threads</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">print_prime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="c1">// start to measure time...
</span>	<span class="kt">double</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">getDoubleTime</span><span class="p">();</span>
	
	<span class="c1">// initialize mutex...
</span>	<span class="n">res</span> <span class="o">=</span> <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work_mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       	<span class="n">perror</span><span class="p">(</span><span class="s">"Mutex initialization failed"</span><span class="p">);</span>
	    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

	<span class="c1">// pthread_create...
</span>	<span class="k">for</span> <span class="p">(</span><span class="n">lots_of_threads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lots_of_threads</span> <span class="o">&lt;</span> <span class="n">NUM_THREADS</span><span class="p">;</span> <span class="n">lots_of_threads</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">a_thread</span><span class="p">[</span><span class="n">lots_of_threads</span><span class="p">]),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">thread_function</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">lots_of_threads</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">"Thread creation failed"</span><span class="p">);</span>
        		<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// pthread_join...
</span>	<span class="k">for</span> <span class="p">(</span><span class="n">lots_of_threads</span> <span class="o">=</span> <span class="n">NUM_THREADS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">lots_of_threads</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lots_of_threads</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        	<span class="n">res</span> <span class="o">=</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">a_thread</span><span class="p">[</span><span class="n">lots_of_threads</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">thread_result</span><span class="p">);</span> 

            <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	            <span class="n">perror</span><span class="p">(</span><span class="s">"pthread_join failed"</span><span class="p">);</span>
        	<span class="p">}</span>
    <span class="p">}</span>	
    
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// 設定計數器
</span>    <span class="k">for</span> <span class="p">(</span><span class="n">lots_of_threads</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lots_of_threads</span> <span class="o">&lt;</span> <span class="n">NUM_THREADS</span><span class="p">;</span> <span class="n">lots_of_threads</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span> 
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">The thread[%d]'s numbers：</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">lots_of_threads</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MSIZE</span> <span class="o">/</span> <span class="n">NUM_THREADS</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prime_array</span><span class="p">[</span><span class="n">lots_of_threads</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\t</span><span class="s">"</span><span class="p">,</span> <span class="n">prime_array</span><span class="p">[</span><span class="n">lots_of_threads</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>                        <span class="p">}</span>
    <span class="p">}</span>


	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Thread joined</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

	<span class="c1">// stop measuring time...
</span>	<span class="kt">double</span> <span class="n">finish_time</span> <span class="o">=</span> <span class="n">getDoubleTime</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Execute Time:  %.3lf ms</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="n">finish_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">));</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="o">*</span><span class="nf">thread_function</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// pthread_mutex_lock(&amp;work_mutex);
</span>	
    <span class="kt">int</span> <span class="n">my_num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="c1">// if (MSIZE % NUM_THREADS != 0){    printf("error");   pthread_exit(-1);    }
</span>
    <span class="kt">int</span> <span class="n">start_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSIZE</span> <span class="o">/</span> <span class="n">NUM_THREADS</span><span class="p">)</span> <span class="o">*</span> <span class="n">my_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSIZE</span> <span class="o">/</span> <span class="n">NUM_THREADS</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">my_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// Set the loop
</span>    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="c1">// Set the counter
</span>    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// result
</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"I'm thread[%d], start_num:%d, end_num:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">my_num</span><span class="p">,</span> <span class="n">start_num</span><span class="p">,</span> <span class="n">end_num</span><span class="p">);</span>

    <span class="cm">/* find the prime number */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start_num</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">end_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="c1">// Reset counter
</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> 
            <span class="n">prime_array</span><span class="p">[</span><span class="n">my_num</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">k</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="c1">// pthread_mutex_unlock(&amp;work_mutex);
</span>	<span class="n">pthread_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">double</span> <span class="nf">getDoubleTime</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tm_tv</span><span class="p">;</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tm_tv</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(((</span><span class="kt">double</span><span class="p">)</span><span class="n">tm_tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mi">1000</span><span class="p">.</span> <span class="o">+</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">tm_tv</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="mi">0</span><span class="p">.</span><span class="mo">001</span><span class="p">);</span>
<span class="p">}</span>

</code></pre>
</div>
<ul>
  <li>執行結果<br />
<img src="https://i.imgur.com/jw2pSxj.jpg" alt="" /></li>
</ul>

<h2 id="linux-">二、Linux 程式設計</h2>
<ul>
  <li>課程簡報
    <ul>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170324/Linux_programming_pthread.pdf">Linux Programming - Pthread</a></li>
    </ul>
  </li>
  <li>參考資料
    <ul>
      <li><a href="https://hackmd.io/s/Skh_AaVix">Toward Concurrency</a></li>
      <li><a href="https://barrgroup.com/Embedded-Systems/How-To/RTOS-Mutex-Semaphore">Mutexes and Semaphores Demystified</a></li>
      <li><a href="https://blog.feabhas.com/2009/09/mutex-vs-semaphores-%E2%80%93-part-1-semaphores/">Mutex vs. Semaphores – Part 1: Semaphores</a></li>
      <li><a href="https://blog.feabhas.com/2009/09/mutex-vs-semaphores-%E2%80%93-part-2-the-mutex/">Mutex vs. Semaphores – Part 2: The Mutex</a></li>
      <li><a href="https://blog.feabhas.com/2009/10/mutex-vs-semaphores-%E2%80%93-part-3-final-part-mutual-exclusion-problems/">Mutex vs. Semaphores – Part 3: Mutual Exclusion Problems</a></li>
    </ul>
  </li>
</ul>

<h3 id="pthreads-1">一、Pthreads</h3>
<ul>
  <li>May be provided either as user-level or kernel-level.</li>
  <li>A POSIX standard (IEEE 1003.1c) API for thread creation and synchronization.</li>
  <li><strong>Specification, not implementation.</strong></li>
  <li>API specifies behavior of the thread library, implementation is up to development of the library.</li>
  <li>Common in UNIX operating systems (Solaris, Linux, Mac OS X).</li>
</ul>

<h4 id="pthreadh-1">pthread.h</h4>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;pthread.h&gt;
</span>
<span class="kt">int</span> <span class="n">pthread_create</span><span class="p">(</span><span class="n">pthread_t</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span> <span class="n">pthread_attr_t</span>
<span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">start_routine</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="c1">//create a thread
</span>

<span class="kt">void</span> <span class="n">pthread_exit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">retval</span><span class="p">);</span>
<span class="c1">//terminate a thread
</span>

<span class="kt">int</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">pthread_t</span> <span class="n">th</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">thread_return</span><span class="p">);</span>
<span class="c1">//wait for thread termination
</span>

<span class="kt">int</span> <span class="n">pthread_cancel</span><span class="p">(</span><span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">);</span>
<span class="c1">//cancel a thread
</span>

<span class="kt">int</span> <span class="n">pthread_setcancelstate</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">oldstate</span><span class="p">);</span>
<span class="c1">//set cancellation state
</span>

<span class="kt">int</span> <span class="n">pthread_setcanceltype</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">oldtype</span><span class="p">);</span>
<span class="c1">//set cancellation type
</span></code></pre>
</div>

<h5 id="pthreadcreate-1">pthread_create()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_create</span><span class="p">(</span><span class="n">pthread_t</span> <span class="o">*</span><span class="kr">thread</span><span class="p">,</span>
<span class="n">pthread_attr_t</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">start_routine</span><span class="p">)(</span><span class="kt">void</span>
<span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">pthread_t *thread</code>：thread 的識別字</li>
  <li><code class="highlighter-rouge">pthread_attr_t *attr</code>：thread 的屬性，設定為 NULL 表示使用預設值</li>
  <li><code class="highlighter-rouge">void *(*start_routine)(void*)</code>：thread 要執行的 function</li>
  <li><code class="highlighter-rouge">void *arg</code>：傳遞給 thread 的參數</li>
</ul>

<h5 id="pthreadexit-1">pthread_exit()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="n">pthread_exit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">retval</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">void *retval</code>：thread 結束時回傳的變數</li>
</ul>

<h5 id="pthreadjoin-1">pthread_join()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">pthread_t</span> <span class="n">th</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">thread_return</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">pthread_t th</code>：thread 識別字</li>
  <li><code class="highlighter-rouge">void **thread_return</code>：接收 pthread_exit 傳回的變數</li>
</ul>

<h5 id="pthreadsetcancelstate">pthread_setcancelstate()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_setcancelstate</span><span class="p">(</span><span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">oldstate</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">int state</code>：設定為 PTHREAD_CANCEL_ENABLE 即表示允許取消 thread 的請求；設定為 PTHREAD_CANCEL_DISABLE 即表示忽略取消的請求。</li>
  <li><code class="highlighter-rouge">int *oldstate</code>：此指標指向前一個狀態</li>
</ul>

<h5 id="pthreadsetcanceltype">pthread_setcanceltype()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_setcanceltype</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">oldtype</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">int type</code>：設定為 PTHREAD_CANCEL_ASYNCHRONOUS 則立即取消 thread；設定為 PTHREAD_CANCEL_DEFERRED 則會遇到取消點才會取消 thread。
    <ul>
      <li>取消點即是下列函數：<code class="highlighter-rouge">pthread_join</code>、<code class="highlighter-rouge">pthread_cond_wait</code>、<code class="highlighter-rouge">pthread_testcancel</code>…等</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">int *oldtype</code>：此指標指向前一個型態。</li>
</ul>

<h3 id="condition-variables">二、Condition Variables</h3>
<p>#### pthread_cond_init (condition, attr)<br />
* <a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_cond_init.txt">pthread_cond_init</a></p>

<h4 id="pthreadconddestroy-condition">pthread_cond_destroy (condition)</h4>
<ul>
  <li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_cond_destroy.txt">pthread_cond_destroy</a></li>
</ul>

<h4 id="pthreadcondattrinit-attr">pthread_condattr_init (attr)</h4>
<ul>
  <li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_condattr_init.txt">pthread_condattr_init</a></li>
</ul>

<h4 id="pthreadcondattrdestroy-attr">pthread_condattr_destroy (attr)</h4>
<ul>
  <li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_condattr_destroy.txt">pthread_condattr_destroy</a></li>
</ul>

<h3 id="thread-synchronization">三、Thread Synchronization</h3>
<p>### 1. Semaphore<br />
#### semaphore.h<br />
```c<br />
#include <semaphore.h></semaphore.h></p>

<p>int sem_init(sem_t *sem, int pshared, unsigned int value);<br />
//create a semaphore</p>

<p>int sem_wait(sem_t *sem);<br />
//lock a semaphore</p>

<p>int sem_post(sem_t *sem);<br />
//unlock a semaphore</p>

<p>int sem_destroy(sem_t *sem);<br />
//delete a semaphore<br />
```</p>

<h5 id="seminit">sem_init()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">sem_init</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pshared</span><span class="p">,</span> <span class="kt">unsigned</span>
<span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">sem_t *sem</code>：semaphore 識別字</li>
  <li><code class="highlighter-rouge">int pshared</code>：設定為 0 表示僅供目前的 process 及其 thread 使用。非 0 表示此 semaphore 與其他 process 共用</li>
  <li><code class="highlighter-rouge">unsigned int value</code>：semaphore 的初始值</li>
</ul>

<h5 id="semwait">sem_wait()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">sem_wait</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li>若 semaphore 為非 0，則 semaphore 值減<br />
1；若 semaphore 為 0，則呼叫此 function<br />
的 thread 會被 block ，直到 semaphore 值不<br />
為 0。</li>
</ul>

<h5 id="sempost">sem_post()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">sem_post</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li>對 semaphore 值加 1 。</li>
</ul>

<h5 id="semdestroy">sem_destroy()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">sem_destroy</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
<span class="c1">//delete a semaphore
</span></code></pre>
</div>

<h3 id="mutex">2. Mutex</h3>
<p>#### pthread.h<br />
```c<br />
#include <pthread.h></pthread.h></p>

<p>int pthread_mutex_init(pthread_mutex_t *mutex, const pthread_mutexattr_t *mutexattr);<br />
//create a mutex</p>

<p>int pthread_mutex_lock(pthread_mutex_t *mutex);<br />
//lock a mutex</p>

<p>int pthread_mutex_unlock(pthread_mutex_t *mutex);<br />
//unlock a mutex</p>

<p>int pthread_mutex_destroy(pthread_mutex_t *mutex);<br />
//delete a mutex<br />
```</p>

<h5 id="pthreadmutexinit">pthread_mutex_init()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">,</span> <span class="k">const</span> <span class="n">pthread_mutexattr_t</span> <span class="o">*</span><span class="n">mutexattr</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">pthread_mutex_t *mutex</code>：mutex 識別字</li>
  <li><code class="highlighter-rouge">const pthread_mutexattr_t *mutexattr</code>：mutex 的屬性。設定為 NULL 表示使用預設。</li>
</ul>

<h5 id="pthreadmutexlock">pthread_mutex_lock()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">//lock a mutex
</span></code></pre>
</div>

<h5 id="pthreadmutexunlock">pthread_mutex_unlock()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">//unlock a mutex
</span></code></pre>
</div>

<h5 id="pthreadmutexdestroy">pthread_mutex_destroy()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">//delete a mutex
</span></code></pre>
</div>

<h3 id="section-3">課程作業</h3>
<ul>
  <li>Producer - Consumer<br />
```c<br />
/*</li>
  <li>Solution to Producer Consumer Problem</li>
  <li>Using Ptheads, a mutex and condition variables</li>
  <li>From Tanenbaum, Modern Operating Systems, 3rd Ed.<br />
 */</li>
</ul>

<p>/*<br />
    In this version the buffer is a single number.<br />
    The producer is putting numbers into the shared buffer<br />
    (in this case sequentially)<br />
    And the consumer is taking them out.<br />
    If the buffer contains zero, that indicates that the buffer is empty.<br />
    Any other value is valid.<br />
*/</p>

<p>#include <stdio.h>
#include <pthread.h></pthread.h></stdio.h></p>

<p>#define MAX 10   /* Numbers to produce */<br />
#define buf_max 5</p>

<p>pthread_mutex_t the_mutex;<br />
pthread_cond_t condc, condp;<br />
int buffer[5];<br />
int in = 0;<br />
int count = 0;</p>

<p>void *producer(void *ptr) {<br />
    int i = 0;</p>

<div class="highlighter-rouge"><pre class="highlight"><code>for (i = 1; i &lt;= MAX; i++) {
    pthread_mutex_lock(&amp;the_mutex);	    /* protect buffer */
    while (count == buf_max)    /* If there is something in the buffer then wait */
        pthread_cond_wait(&amp;condp, &amp;the_mutex);

    in++;
    buffer[in] = i;
    printf("ProBuffer[%d]：%2d\n", in, buffer[in]);
    count++;

    pthread_cond_signal(&amp;condc);	    /* wake up consumer */
    pthread_mutex_unlock(&amp;the_mutex);	/* release the buffer */
}
pthread_exit(0); }
</code></pre>
</div>

<p>void *consumer(void *ptr) {<br />
    int i = 0;</p>

<div class="highlighter-rouge"><pre class="highlight"><code>for (i = 1; i &lt;= MAX; i++) {
    pthread_mutex_lock(&amp;the_mutex);	    /* protect buffer */
    while (count == 0)			    /* If there is nothing in the buffer then wait */
        pthread_cond_wait(&amp;condc, &amp;the_mutex);
    
    printf("ConBuffer[%d]：%2d\n", in, buffer[in]);
    buffer[in] = 0;
    in--;
    count--;
    pthread_cond_signal(&amp;condp);	    /* wake up consumer */

    pthread_mutex_unlock(&amp;the_mutex);	/* release the buffer */
}
pthread_exit(0); }
</code></pre>
</div>

<p>int main(int argc, char **argv) {<br />
    pthread_t pro, con;</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// Initialize the mutex and condition variables
/* What's the NULL for ??? */
pthread_mutex_init(&amp;the_mutex, NULL);	
pthread_cond_init(&amp;condc, NULL);		/* Initialize consumer condition variable */
pthread_cond_init(&amp;condp, NULL);		/* Initialize producer condition variable */

// Create the threads
pthread_create(&amp;con, NULL, consumer, NULL);
pthread_create(&amp;pro, NULL, producer, NULL);

// Wait for the threads to finish
// Otherwise main might run to the end
// and kill the entire process when it exits.
pthread_join(con, NULL);
pthread_join(pro, NULL);

// Cleanup -- would happen automatically at end of program
pthread_mutex_destroy(&amp;the_mutex);	/* Free up the_mutex */
pthread_cond_destroy(&amp;condc);		/* Free up consumer condition variable */
pthread_cond_destroy(&amp;condp);		/* Free up producer condition variable */ } ``` * 執行結果 ![](https://i.imgur.com/OCVTU3V.jpg)
</code></pre>
</div>

        </article>
        <hr>

        
        
            
            
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/04/14/linux_system/">20170414 [學習筆記] Linux 系統程式 (7)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/04/07/linux_system/">20170407 [學習筆記] Linux 系統程式 (6)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/31/linux_system/">20170331 [學習筆記] Linux 系統程式 (5)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/22/get_prime/">20170322 [學習筆記] 關於用 Pthread 取質數的問題
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/17/vim/">20170317 [學習筆記] Vim 常用技巧
                            
                            </a>
                        </li>
                        
                        
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/17/linux_system/">20170317 [學習筆記] Linux 系統程式 (3)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    
    <div class="pre">

        <p><strong>上一篇</strong> <a href="/2017/03/23/ai/">20170323 [學習筆記] 人工智慧 (4)</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2017/03/30/ai/">20170330 [學習筆記] 人工智慧 (5)</a></p>
        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://shouzo.github.io/2017/03/24/linux_system/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://shouzo.github.io/2017/03/24/linux_system/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//shouzonotes.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


  <div class="wrapper">
     <p class="cc - icon">
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/"><img alt="創用 CC 授權條款" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png" /></a>
      </p>


      <p class="description">
          
          Martial Artist、Traceur & Engineer!
          
      </p>


        <p class="contact">
            Contact me at:
            
            <a href="https://github.com/shouzo"><i class="fa fa-github" aria-hidden="true"></i></a>
            

            
            <a href="mailto:danny200026@yahoo.com.tw"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>
            

            

            

            

            
            <a href="https://www.facebook.com/danny200026"><i class="fa fa-facebook-official" aria-hidden="true"></i></a>
            
        </p>


        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
            <span>
                <br> 除非另有註明，本部落格內容皆採用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/"> 創用 CC 姓名標示-非商業性-相同方式分享 3.0 台灣 </a> 授權條款
            </span>
        </p>

  </div>
	
	
	<div class="realtimeuserscounter realtimeuserscounter--styled"></div>
	<script src="https://realtimeusers.bycontrast.co/realtimeusers.js"></script>
	
</footer>
<script src="/js/main.js " charset="utf-8"></script>
    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
