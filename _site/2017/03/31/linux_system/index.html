<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>20170331 [學習筆記] Linux 系統程式 (5)</title>
    <meta name="description" content="  一、作業系統          (一) Thread Synchronization                  sem_init()          sem_wait()          sem_post()          sem_destroy()                    2....">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href=" /css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href=" /css/main.css ">
    <link rel="canonical" href="http://shouzo.github.io/2017/03/31/linux_system/">
    <link rel="alternate" type="application/rss+xml" title="少左 shouzo" href="http://shouzo.github.io /feed.xml ">



</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">少左 shouzo</a>
        <small>Be strong to Be useful！</small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/blog/index.html">
                    
                        <i class="fa fa-home"></i>首頁 Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>內容 Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>分類 Categories
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>標籤 Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>收藏 Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/demo/">
                        
                            <i class="fa fa-play"></i>展示 Demo
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-commenting"></i>關於 About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>20170331 [學習筆記] Linux 系統程式 (5)</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2017-03-31
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#Linux" title="Category: Linux" rel="category">Linux</a>&nbsp;
    
        <a href="/category/#作業系統" title="Category: 作業系統" rel="category">作業系統</a>&nbsp;
    
        <a href="/category/#程式設計" title="Category: 程式設計" rel="category">程式設計</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#Linux" title="Tag: Linux" rel="tag">Linux</a-->
        <a href="/tag/#Linux" title="Tag: Linux" rel="tag">Linux</a>&nbsp;
    
        <!--a href="/tag/#%E4%BD%9C%E6%A5%AD%E7%B3%BB%E7%B5%B1" title="Tag: 作業系統" rel="tag">作業系統</a-->
        <a href="/tag/#作業系統" title="Tag: 作業系統" rel="tag">作業系統</a>&nbsp;
    
        <!--a href="/tag/#%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88" title="Tag: 程式設計" rel="tag">程式設計</a-->
        <a href="/tag/#程式設計" title="Tag: 程式設計" rel="tag">程式設計</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">一、作業系統</a>    <ul>
      <li><a href="#thread-synchronization" id="markdown-toc-thread-synchronization">(一) Thread Synchronization</a>        <ul>
          <li><a href="#seminit" id="markdown-toc-seminit">sem_init()</a></li>
          <li><a href="#semwait" id="markdown-toc-semwait">sem_wait()</a></li>
          <li><a href="#sempost" id="markdown-toc-sempost">sem_post()</a></li>
          <li><a href="#semdestroy" id="markdown-toc-semdestroy">sem_destroy()</a></li>
        </ul>
      </li>
      <li><a href="#mutex" id="markdown-toc-mutex">2. Mutex</a>        <ul>
          <li><a href="#pthreadmutexinit" id="markdown-toc-pthreadmutexinit">pthread_mutex_init()</a></li>
          <li><a href="#pthreadmutexlock" id="markdown-toc-pthreadmutexlock">pthread_mutex_lock()</a></li>
          <li><a href="#pthreadmutexunlock" id="markdown-toc-pthreadmutexunlock">pthread_mutex_unlock()</a></li>
          <li><a href="#pthreadmutexdestroy" id="markdown-toc-pthreadmutexdestroy">pthread_mutex_destroy()</a></li>
        </ul>
      </li>
      <li><a href="#condition-variables" id="markdown-toc-condition-variables">3. Condition Variables</a>        <ul>
          <li><a href="#pthreadconddestroy-condition" id="markdown-toc-pthreadconddestroy-condition">pthread_cond_destroy (condition)</a></li>
          <li><a href="#pthreadcondattrinit-attr" id="markdown-toc-pthreadcondattrinit-attr">pthread_condattr_init (attr)</a></li>
          <li><a href="#pthreadcondattrdestroy-attr" id="markdown-toc-pthreadcondattrdestroy-attr">pthread_condattr_destroy (attr)</a></li>
        </ul>
      </li>
      <li><a href="#barrier" id="markdown-toc-barrier">4. Barrier</a></li>
      <li><a href="#producer-consumer-problem" id="markdown-toc-producer-consumer-problem">(二) Producer-Consumer Problem</a>        <ul>
          <li><a href="#consumer" id="markdown-toc-consumer">2. Consumer</a></li>
        </ul>
      </li>
      <li><a href="#section-1" id="markdown-toc-section-1">課程作業</a></li>
    </ul>
  </li>
  <li><a href="#linux-" id="markdown-toc-linux-">二、Linux 程式設計</a>    <ul>
      <li><a href="#socket-programming" id="markdown-toc-socket-programming">Socket Programming</a>        <ul>
          <li><a href="#two-essential-types-of-sockets" id="markdown-toc-two-essential-types-of-sockets">2. Two essential types of sockets</a></li>
          <li><a href="#sockstream" id="markdown-toc-sockstream">(1) SOCK_STREAM</a></li>
          <li><a href="#sockdgram" id="markdown-toc-sockdgram">(2) SOCK_DGRAM</a></li>
          <li><a href="#example" id="markdown-toc-example">Example</a></li>
        </ul>
      </li>
      <li><a href="#section-2" id="markdown-toc-section-2">課程作業</a></li>
    </ul>
  </li>
</ul>

<h2 id="section">一、作業系統</h2>
<ul>
  <li>課程簡報
    <ul>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170330/ch04.pdf">Chapter 4: Mutithread Programming</a></li>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170330/ch05.pdf">Chapter 5: Process Scheduling</a></li>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170330/Linux_programming_pthread.pdf">Linux_programming_pthread</a></li>
    </ul>
  </li>
  <li>參考資料
    <ul>
      <li><a href="https://hackmd.io/s/Skh_AaVix">Toward Concurrency</a></li>
      <li><a href="http://tuxthink.blogspot.tw/2013/01/using-condition-variables-in-pthreads.html">Using condition variables in pthreads</a></li>
    </ul>
  </li>
</ul>

<h3 id="thread-synchronization">(一) Thread Synchronization</h3>
<p>### 1. Semaphore<br />
#### semaphore.h<br />
```c<br />
#include <semaphore.h></semaphore.h></p>

<p>int sem_init(sem_t *sem, int pshared, unsigned int value);<br />
//create a semaphore</p>

<p>int sem_wait(sem_t *sem);<br />
//lock a semaphore</p>

<p>int sem_post(sem_t *sem);<br />
//unlock a semaphore</p>

<p>int sem_destroy(sem_t *sem);<br />
//delete a semaphore<br />
```</p>

<h5 id="seminit">sem_init()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">sem_init</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pshared</span><span class="p">,</span> <span class="kt">unsigned</span>
<span class="kt">int</span> <span class="n">value</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">sem_t *sem</code>：semaphore 識別字</li>
  <li><code class="highlighter-rouge">int pshared</code>：設定為 0 表示僅供目前的 process 及其 thread 使用。非 0 表示此 semaphore 與其他 process 共用</li>
  <li><code class="highlighter-rouge">unsigned int value</code>：semaphore 的初始值</li>
</ul>

<h5 id="semwait">sem_wait()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">sem_wait</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li>若 semaphore 為非 0，則 semaphore 值減<br />
1；若 semaphore 為 0，則呼叫此 function<br />
的 thread 會被 block ，直到 semaphore 值不<br />
為 0。</li>
</ul>

<h5 id="sempost">sem_post()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">sem_post</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li>對 semaphore 值加 1 。</li>
</ul>

<h5 id="semdestroy">sem_destroy()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">sem_destroy</span><span class="p">(</span><span class="n">sem_t</span> <span class="o">*</span><span class="n">sem</span><span class="p">);</span>
<span class="c1">//delete a semaphore
</span></code></pre>
</div>

<h3 id="mutex">2. Mutex</h3>
<p>#### pthread.h<br />
```c<br />
#include <pthread.h></pthread.h></p>

<p>int pthread_mutex_init(pthread_mutex_t *mutex, const pthread_mutexattr_t *mutexattr);<br />
//create a mutex</p>

<p>int pthread_mutex_lock(pthread_mutex_t *mutex);<br />
//lock a mutex</p>

<p>int pthread_mutex_unlock(pthread_mutex_t *mutex);<br />
//unlock a mutex</p>

<p>int pthread_mutex_destroy(pthread_mutex_t *mutex);<br />
//delete a mutex<br />
```</p>

<h5 id="pthreadmutexinit">pthread_mutex_init()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">,</span> <span class="k">const</span> <span class="n">pthread_mutexattr_t</span> <span class="o">*</span><span class="n">mutexattr</span><span class="p">);</span>
</code></pre>
</div>
<ul>
  <li><code class="highlighter-rouge">pthread_mutex_t *mutex</code>：mutex 識別字</li>
  <li><code class="highlighter-rouge">const pthread_mutexattr_t *mutexattr</code>：mutex 的屬性。設定為 NULL 表示使用預設。</li>
</ul>

<h5 id="pthreadmutexlock">pthread_mutex_lock()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">//lock a mutex
</span></code></pre>
</div>

<h5 id="pthreadmutexunlock">pthread_mutex_unlock()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">//unlock a mutex
</span></code></pre>
</div>

<h5 id="pthreadmutexdestroy">pthread_mutex_destroy()</h5>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="kt">int</span> <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="n">pthread_mutex_t</span> <span class="o">*</span><span class="n">mutex</span><span class="p">);</span>
<span class="c1">//delete a mutex
</span></code></pre>
</div>

<h3 id="condition-variables">3. Condition Variables</h3>
<p>#### pthread_cond_init (condition, attr)<br />
* <a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_cond_init.txt">pthread_cond_init</a></p>

<h4 id="pthreadconddestroy-condition">pthread_cond_destroy (condition)</h4>
<ul>
  <li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_cond_destroy.txt">pthread_cond_destroy</a></li>
</ul>

<h4 id="pthreadcondattrinit-attr">pthread_condattr_init (attr)</h4>
<ul>
  <li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_condattr_init.txt">pthread_condattr_init</a></li>
</ul>

<h4 id="pthreadcondattrdestroy-attr">pthread_condattr_destroy (attr)</h4>
<ul>
  <li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_condattr_destroy.txt">pthread_condattr_destroy</a></li>
</ul>

<h3 id="barrier">4. Barrier</h3>
<ul>
  <li><a href="http://angelonotes.blogspot.tw/2012/02/pthreadbarrier.html">Using barriers in pthreads</a></li>
  <li><a href="http://angelonotes.blogspot.tw/2012/02/pthreadbarrier.html">pthread︰barrier</a></li>
</ul>

<h3 id="producer-consumer-problem">(二) Producer-Consumer Problem</h3>
<p>#### 1. Producer<br />
```c<br />
item next produced;<br />
while (true) {<br />
    /* produce an item in next produced */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>while (((in + 1) % BUFFER SIZE) == out)
; /* do nothing */
    
buffer[in] = next produced;
in = (in + 1) % BUFFER SIZE; } ```
</code></pre>
</div>

<h4 id="consumer">2. Consumer</h4>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">item</span> <span class="n">next</span> <span class="n">consumed</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">in</span> <span class="o">==</span> <span class="n">out</span><span class="p">)</span>
    <span class="p">;</span> <span class="cm">/* do nothing */</span>
    
    <span class="n">next</span> <span class="n">consumed</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">out</span><span class="p">];</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER</span> <span class="n">SIZE</span><span class="p">;</span>
    
    <span class="cm">/* consume the item in next consumed */</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="section-1">課程作業</h3>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="cm">/*
 *  Solution to Producer Consumer Problem
 *  Using Ptheads, a mutex and condition variables
 *  From Tanenbaum, Modern Operating Systems, 3rd Ed.
 */</span>

<span class="cm">/*
    In this version the buffer is a single number.
    The producer is putting numbers into the shared buffer
    (in this case sequentially)
    And the consumer is taking them out.
    If the buffer contains zero, that indicates that the buffer is empty.
    Any other value is valid.
*/</span>

<span class="cp">#include &lt;stdio.h&gt;
#include &lt;pthread.h&gt;
</span>
<span class="cp">#define MAX 10//000000			</span><span class="cm">/* Numbers to produce */</span><span class="cp">
#define BUFFER_SIZE 5
</span>
<span class="n">pthread_mutex_t</span> <span class="n">the_mutex</span><span class="p">;</span>
<span class="n">pthread_cond_t</span> <span class="n">condc</span><span class="p">,</span> <span class="n">condp</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">producer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_mutex</span><span class="p">);</span>	<span class="cm">/* protect buffer */</span>
        
        <span class="k">while</span> <span class="p">(((</span><span class="n">in</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">out</span><span class="p">)</span>		       <span class="cm">/* If there is something in the buffer then wait */</span>
            <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">the_mutex</span><span class="p">);</span>

        <span class="n">buffer</span><span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"ProBuffer[%d]：%2d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">in</span><span class="p">]);</span>
        <span class="n">in</span> <span class="o">=</span> <span class="p">(</span><span class="n">in</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
   
        <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condc</span><span class="p">);</span>	<span class="cm">/* wake up consumer */</span>
        <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_mutex</span><span class="p">);</span>	<span class="cm">/* release the buffer */</span>
    <span class="p">}</span>

    <span class="n">pthread_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="o">*</span><span class="nf">consumer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_mutex</span><span class="p">);</span>	<span class="cm">/* protect buffer */</span>
    
        <span class="k">while</span> <span class="p">(</span><span class="n">in</span> <span class="o">==</span> <span class="n">out</span><span class="p">)</span>			<span class="cm">/* If there is nothing in the buffer then wait */</span>
            <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">the_mutex</span><span class="p">);</span>
    
        <span class="n">printf</span><span class="p">(</span><span class="s">"ConBuffer[%d]：%2d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">out</span><span class="p">]);</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
        <span class="n">buffer</span><span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
        <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condp</span><span class="p">);</span>	<span class="cm">/* wake up consumer */</span>
        <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_mutex</span><span class="p">);</span>	<span class="cm">/* release the buffer */</span>
    <span class="p">}</span>
    <span class="n">pthread_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pthread_t</span> <span class="n">pro</span><span class="p">,</span> <span class="n">con</span><span class="p">;</span>

    <span class="c1">// Initialize the mutex and condition variables
</span>    <span class="cm">/* What's the NULL for ??? */</span>
    <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>	
    <span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>		<span class="cm">/* Initialize consumer condition variable */</span>
    <span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>		<span class="cm">/* Initialize producer condition variable */</span>

    <span class="c1">// Create the threads
</span>    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">con</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">consumer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pro</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">producer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// Wait for the threads to finish
</span>    <span class="c1">// Otherwise main might run to the end
</span>    <span class="c1">// and kill the entire process when it exits.
</span>    <span class="n">pthread_join</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">pthread_join</span><span class="p">(</span><span class="n">pro</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// Cleanup -- would happen automatically at end of program
</span>    <span class="n">pthread_mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_mutex</span><span class="p">);</span>	<span class="cm">/* Free up the_mutex */</span>
    <span class="n">pthread_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condc</span><span class="p">);</span>		<span class="cm">/* Free up consumer condition variable */</span>
    <span class="n">pthread_cond_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">condp</span><span class="p">);</span>		<span class="cm">/* Free up producer condition variable */</span>
<span class="p">}</span>
</code></pre>
</div>

<ul>
  <li>執行結果<br />
<img src="https://i.imgur.com/6miNt1O.jpg" alt="" /></li>
</ul>

<h2 id="linux-">二、Linux 程式設計</h2>
<ul>
  <li>課程簡報
    <ul>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170331/Socket_Programming.pdf">Socket_Programming</a></li>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170331/Linux-Programming_Socket_1.pdf">Linux-Programming_Socket_1</a></li>
      <li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170331/Linux-Programming_Socket_2.pdf">Linux-Programming_Socket_2</a></li>
    </ul>
  </li>
</ul>

<h3 id="socket-programming">Socket Programming</h3>
<p>#### 1. What is a socket？<br />
* An interface between application and network.<br />
    * The application creates a socket.<br />
    * The socket type dictates the style of communication.<br />
        * <code class="highlighter-rouge">reliable</code> vs. <code class="highlighter-rouge">best effort</code><br />
        * <code class="highlighter-rouge">connection-oriented</code> vs. <code class="highlighter-rouge">connectionless</code></p>

<ul>
  <li>Once configured the application can
    <ul>
      <li>pass data to the socket for network transmission</li>
      <li>receive data from the socket (transmitted through the network by some other host)</li>
    </ul>
  </li>
</ul>

<h4 id="two-essential-types-of-sockets">2. Two essential types of sockets</h4>
<p><img src="https://i.imgur.com/HMu29e3.jpg" alt="" /></p>

<h4 id="sockstream">(1) SOCK_STREAM</h4>
<ul>
  <li>a.k.a. TCP</li>
  <li>reliable delivery</li>
  <li>in-order guaranteed</li>
  <li>connection-oriented</li>
  <li>bidirectional</li>
</ul>

<h4 id="sockdgram">(2) SOCK_DGRAM</h4>
<ul>
  <li>a.k.a. UDP</li>
  <li>unreliable delivery</li>
  <li>no order guarantees</li>
  <li>no notion of “connection” – app indicates dest. for each packet</li>
  <li>can send or receive</li>
</ul>

<h4 id="example">Example</h4>
<ul>
  <li><code class="highlighter-rouge">server</code> 部份<br />
```c<br />
/*  Make the necessary includes and set up the variables.  */</li>
</ul>

<p>#include &lt;sys/types.h&gt;<br />
#include &lt;sys/socket.h&gt;<br />
#include <stdio.h>
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include <unistd.h>
#include <stdlib.h></stdlib.h></unistd.h></stdio.h></p>

<p>int main()<br />
{<br />
    int server_sockfd, client_sockfd;<br />
    int server_len, client_len;<br />
    struct sockaddr_in server_address;<br />
    struct sockaddr_in client_address;</p>

<p>/*  Create an unnamed socket for the server.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server_sockfd = socket(AF_INET, SOCK_STREAM, 0);
</code></pre>
</div>

<p>/*  Name the socket.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server_address.sin_family = AF_INET;
server_address.sin_addr.s_addr = inet_addr("127.0.0.1");
server_address.sin_port = 9734;
server_len = sizeof(server_address);
bind(server_sockfd, (struct sockaddr *)&amp;server_address, server_len);
</code></pre>
</div>

<p>/*  Create a connection queue and wait for clients.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>listen(server_sockfd, 5);
while(1) {
    char ch;

    printf("server waiting\n");
</code></pre>
</div>

<p>/*  Accept a connection.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    client_len = sizeof(client_address);
    client_sockfd = accept(server_sockfd, 
        (struct sockaddr *)&amp;client_address, &amp;client_len);
</code></pre>
</div>

<p>/*  We can now read/write to client on client_sockfd.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    read(client_sockfd, &amp;ch, 1);
    printf("receive from client = %c\n", ch);
    ch++;
    write(client_sockfd, &amp;ch, 1);
    close(client_sockfd);
} } ```
</code></pre>
</div>

<ul>
  <li><code class="highlighter-rouge">client</code> 部份<br />
```c<br />
/*  Make the necessary includes and set up the variables.  */</li>
</ul>

<p>#include &lt;sys/types.h&gt;<br />
#include &lt;sys/socket.h&gt;<br />
#include <stdio.h>
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include <unistd.h>
#include <stdlib.h></stdlib.h></unistd.h></stdio.h></p>

<p>int main()<br />
{<br />
    int sockfd;<br />
    int len;<br />
    struct sockaddr_in address;<br />
    int result;<br />
    char ch = ‘A’;</p>

<p>/*  Create a socket for the client.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sockfd = socket(AF_INET, SOCK_STREAM, 0);
</code></pre>
</div>

<p>/*  Name the socket, as agreed with the server.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>address.sin_family = AF_INET;
address.sin_addr.s_addr = inet_addr("127.0.0.1");
address.sin_port = 9734;
len = sizeof(address);
</code></pre>
</div>

<p>/*  Now connect our socket to the server’s socket.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>result = connect(sockfd, (struct sockaddr *)&amp;address, len);

if(result == -1) {
    perror("oops: client2");
    exit(1);
}
</code></pre>
</div>

<p>/*  We can now read/write via sockfd.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>write(sockfd, &amp;ch, 1);
read(sockfd, &amp;ch, 1);
printf("char from server = %c\n", ch);
close(sockfd);
exit(0); } ```
</code></pre>
</div>

<h3 id="section-2">課程作業</h3>
<ul>
  <li>
    <p>利用Socket Programming，將 client 端的整數陣列傳送給 server 端排序，並將排序後的結果回傳給 client 端顯示。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">server</code> 部份<br />
```c<br />
/*  Make the necessary includes and set up the variables.  */</p>
  </li>
</ul>

<p>#include &lt;sys/types.h&gt;<br />
#include &lt;sys/socket.h&gt;<br />
#include <stdio.h>
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include <unistd.h>
#include <stdlib.h></stdlib.h></unistd.h></stdio.h></p>

<p>int main()<br />
{<br />
    int server_sockfd, client_sockfd;<br />
    int server_len, client_len;<br />
    struct sockaddr_in server_address;<br />
    struct sockaddr_in client_address;</p>

<p>/*  Create an unnamed socket for the server.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server_sockfd = socket(AF_INET, SOCK_STREAM, 0);
</code></pre>
</div>

<p>/*  Name the socket.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>server_address.sin_family = AF_INET;
server_address.sin_addr.s_addr = inet_addr("127.0.0.1");
server_address.sin_port = 9734;
server_len = sizeof(server_address);
bind(server_sockfd, (struct sockaddr *)&amp;server_address, server_len);
</code></pre>
</div>

<p>/*  Create a connection queue and wait for clients.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>listen(server_sockfd, 5);    

while(1) {
    printf("\nserver waiting\n");
</code></pre>
</div>

<p>/*  Accept a connection.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    client_len = sizeof(client_address);
    client_sockfd = accept(server_sockfd, (struct sockaddr *)&amp;client_address, &amp;client_len);
</code></pre>
</div>

<p>/*  We can now read/write to client on client_sockfd.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    int i, j, tmp = 0, get_n;
    int *buf;
    
    read(client_sockfd, &amp;get_n, sizeof(get_n));
    buf = (int *) malloc(get_n * sizeof(int));
    read(client_sockfd, buf, get_n * sizeof(int));
    printf("sort arr[%d] from client:\n", get_n);
 
    for (i = 0; i &lt; get_n; i++) {
        for (j = 0; j &lt; get_n; j++) {
            if (buf[i] &lt; buf[j]) {
                tmp = buf[i];
                buf[i] = buf[j];
                buf[j] = tmp;
            }
        }
    }
 
    for (i = 0; i &lt; get_n; i++)
        printf("arr[%d] = %d\n", i, buf[i]);
    
    write(client_sockfd, buf, get_n * sizeof(buf));
    close(client_sockfd);
} } ```
</code></pre>
</div>

<ul>
  <li><code class="highlighter-rouge">client</code> 部份<br />
```c<br />
/*  Make the necessary includes and set up the variables.  */</li>
</ul>

<p>#include &lt;sys/types.h&gt;<br />
#include &lt;sys/socket.h&gt;<br />
#include <stdio.h>
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include <unistd.h>
#include <stdlib.h></stdlib.h></unistd.h></stdio.h></p>

<p>#define SIZE 5</p>

<p>int main()<br />
{<br />
    int sockfd;<br />
    int len;<br />
    struct sockaddr_in address;<br />
    int result, n;</p>

<p>/*  Create a socket for the client.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sockfd = socket(AF_INET, SOCK_STREAM, 0);
</code></pre>
</div>

<p>/*  Name the socket, as agreed with the server.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>address.sin_family = AF_INET;
address.sin_addr.s_addr = inet_addr("127.0.0.1");
address.sin_port = 9734;
len = sizeof(address);
</code></pre>
</div>

<p>/*  Now connect our socket to the server’s socket.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>result = connect(sockfd, (struct sockaddr *)&amp;address, len);

if (result == -1) {
    perror("oops: client!");
    exit(1);
}
</code></pre>
</div>

<p>/*  We can now read/write via sockfd.  */</p>

<div class="highlighter-rouge"><pre class="highlight"><code>int i, j, tmp = 0, s = SIZE;
int arr[SIZE] = {4, 7, 1, 8, 3};
int rec[SIZE] = {0, 0, 0, 0, 0};
printf("%d\n", s);

write(sockfd, &amp;s, sizeof(int));
printf("\noriginal from client - arr[]\n"); 
for (i = 0; i &lt; SIZE; i++)
	printf("arr[%d] = %d\n", i, arr[i]);

write(sockfd, arr, sizeof(arr));
   
   
read(sockfd, rec, SIZE * sizeof(rec));    
printf("\nresult from server - rec[]\n");

for (i = 0; i &lt; SIZE; i++)
    printf("rec[%d] = %d\n", i, rec[i]); 


close(sockfd);
exit(0); } ```
</code></pre>
</div>

<ul>
  <li>執行結果<br />
<img src="https://i.imgur.com/AhJZRLN.jpg" alt="" /></li>
</ul>

        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/24/linux_system/">20170324 [學習筆記] Linux 系統程式 (4)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/22/get_prime/">20170322 [學習筆記] 關於用 Pthread 取質數的問題
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/17/vim/">20170317 [學習筆記] Vim 常用技巧
                            
                            </a>
                        </li>
                        
                        
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/17/linux_system/">20170317 [學習筆記] Linux 系統程式 (3)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/10/linux_system/">20170310 [學習筆記] Linux 系統程式 (2)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="http://shouzo.github.io/2017/03/04/linux_system/">20170303 [學習筆記] Linux 系統程式 (1)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
                
                    
                
                    
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    
    <div class="pre">

        <p><strong>上一篇</strong> <a href="/2017/03/30/ai/">20170330 [學習筆記] 人工智慧 (5)</a></p>
        
    </div>
    <div class="nex">

        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://shouzo.github.io/2017/03/31/linux_system/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://shouzo.github.io/2017/03/31/linux_system/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//shouzonotes.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


  <div class="wrapper">
     <p class="cc - icon">
          <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/"><img alt="創用 CC 授權條款" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/tw/88x31.png" /></a>
      </p>


      <p class="description">
          
          Martial Artist、Traceur & Engineer!
          
      </p>


        <p class="contact">
            Contact me at:
            
            <a href="https://github.com/shouzo"><i class="fa fa-github" aria-hidden="true"></i></a>
            

            
            <a href="mailto:danny200026@yahoo.com.tw"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>
            

            

            

            

            
            <a href="https://www.facebook.com/danny200026"><i class="fa fa-facebook-official" aria-hidden="true"></i></a>
            
        </p>


        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
            <span>
                <br> 除非另有註明，本部落格內容皆採用 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/tw/"> 創用 CC 姓名標示-非商業性-相同方式分享 3.0 台灣 </a> 授權條款
            </span>
        </p>

  </div>
	
	
	<div class="realtimeuserscounter realtimeuserscounter--styled"></div>
	<script src="https://realtimeusers.bycontrast.co/realtimeusers.js"></script>
	
</footer>
<script src="/js/main.js " charset="utf-8"></script>
    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
