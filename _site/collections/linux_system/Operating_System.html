<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        作業系統 - HackMD
    </title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
    <link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css" integrity="sha256-QiWfLIsCT02Sdwkogf6YMiQlj4NE84MKkzEMkZnMGdg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/github-gist.min.css" integrity="sha256-tAflq+ymku3Khs+I/WcAneIlafYgDiOQ9stIHH985Wo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojify.js/1.1.0/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <style>
        @import url(https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,600,600italic,300italic,300|Source+Serif+Pro|Source+Code+Pro:400,300,500&subset=latin,latin-ext);.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#c00}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e7e7e7;border:0}.markdown-body blockquote{padding:0 1em;color:#777;border-left:.25em solid #ddd}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body .loweralpha{list-style-type:lower-alpha}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#000;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#777}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol.no-list,.markdown-body ul.no-list{padding:0;list-style-type:none}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #ddd}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#333}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:0;padding-top:.2em;padding-bottom:.2em;margin:0;font-size:85%;background-color:rgba(0,0,0,.04);border-radius:3px}.markdown-body code:after,.markdown-body code:before,.markdown-body tt:after,.markdown-body tt:before{letter-spacing:-.2em;content:"\A0"}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f7f7f7;border-radius:3px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code:after,.markdown-body pre code:before,.markdown-body pre tt:after,.markdown-body pre tt:before{content:normal}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-line-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:700;background:#f8f8f8;border-top:0}.markdown-body kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#555;vertical-align:middle;background-color:#fcfcfc;border:1px solid #ccc;border-bottom-color:#bbb;border-radius:3px;box-shadow:inset 0 -1px 0 #bbb}.news .alert .markdown-body blockquote{padding:0 0 0 40px;border:0 none}.activity-tab .news .alert .commits,.activity-tab .news .markdown-body blockquote{padding-left:0}.task-list-item{list-style-type:none}.task-list-item label{font-weight:400}.task-list-item.enabled label{cursor:pointer}.task-list-item+.task-list-item{margin-top:3px}.task-list-item-checkbox{float:left;margin:.31em 0 .2em -1.3em!important;vertical-align:middle;cursor:default!important}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,sans-serif;padding-top:40px;padding-bottom:40px;max-width:758px;overflow:visible!important}.markdown-body pre{border:inherit!important}.markdown-body code{color:inherit!important}.markdown-body pre code .wrapper{display:-moz-inline-flex;display:-ms-inline-flex;display:-o-inline-flex;display:inline-flex}.markdown-body pre code .gutter{float:left;overflow:hidden;-webkit-user-select:none;user-select:none}.markdown-body pre code .gutter.linenumber{text-align:right;position:relative;display:inline-block;cursor:default;z-index:4;padding:0 8px 0 0;min-width:20px;box-sizing:content-box;color:#afafaf!important;border-right:3px solid #6ce26c!important}.markdown-body pre code .gutter.linenumber>span:before{content:attr(data-linenumber)}.markdown-body pre code .code{float:left;margin:0 0 0 16px}.markdown-body .gist .line-numbers{border-left:none;border-top:none;border-bottom:none}.markdown-body .gist .line-data{border:none}.markdown-body .gist table{border-spacing:0;border-collapse:inherit!important}.markdown-body code[data-gist-id]{background:none;padding:0}.markdown-body code[data-gist-id]:after,.markdown-body code[data-gist-id]:before{content:""}.markdown-body code[data-gist-id] .blob-num{border:unset}.markdown-body code[data-gist-id] table{overflow:unset;margin-bottom:unset}.markdown-body code[data-gist-id] table tr{background:unset}.markdown-body[dir=rtl] pre{direction:ltr}.markdown-body[dir=rtl] code{direction:ltr;unicode-bidi:embed}.markdown-body .alert>p{margin-bottom:0}.markdown-body pre.abc,.markdown-body pre.flow-chart,.markdown-body pre.graphviz,.markdown-body pre.mermaid,.markdown-body pre.sequence-diagram{text-align:center;background-color:inherit;border-radius:0;white-space:inherit}.markdown-body pre.abc>code,.markdown-body pre.flow-chart>code,.markdown-body pre.graphviz>code,.markdown-body pre.mermaid>code,.markdown-body pre.sequence-diagram>code{text-align:left}.markdown-body pre.abc>svg,.markdown-body pre.flow-chart>svg,.markdown-body pre.graphviz>svg,.markdown-body pre.mermaid>svg,.markdown-body pre.sequence-diagram>svg{max-width:100%;height:100%}.markdown-body pre>code.wrap{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word}.markdown-body .alert>p,.markdown-body .alert>ul{margin-bottom:0}.vimeo,.youtube{cursor:pointer;display:table;text-align:center;background-position:50%;background-repeat:no-repeat;background-size:contain;background-color:#000;overflow:hidden}.vimeo,.youtube{position:relative;width:100%}.youtube{padding-bottom:56.25%}.vimeo img{width:100%;object-fit:contain;z-index:0}.youtube img{object-fit:cover;z-index:0}.vimeo iframe,.youtube iframe,.youtube img{width:100%;height:100%;position:absolute;top:0;left:0}.vimeo iframe,.youtube iframe{vertical-align:middle;z-index:1}.vimeo .icon,.youtube .icon{position:absolute;height:auto;width:auto;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;opacity:.3;transition:opacity .2s;z-index:0}.vimeo:hover .icon,.youtube:hover .icon{opacity:.6;transition:opacity .2s}.slideshare .inner,.speakerdeck .inner{position:relative;width:100%}.slideshare .inner iframe,.speakerdeck .inner iframe{position:absolute;top:0;bottom:0;left:0;right:0;width:100%;height:100%}.MJX_Assistive_MathML{display:none}.ui-infobar{position:relative;z-index:2;max-width:758px;margin-top:25px;margin-bottom:-25px;color:#777}.ui-toc{position:fixed;bottom:20px;z-index:10000}.ui-toc-label{opacity:.3;background-color:#ccc;border:none;transition:opacity .2s}.ui-toc .open .ui-toc-label{opacity:1;color:#fff;transition:opacity .2s}.ui-toc-label:focus{opacity:.3;background-color:#ccc;color:#000}.ui-toc-label:hover{opacity:1;background-color:#ccc;transition:opacity .2s}.ui-toc-dropdown{margin-top:23px;margin-bottom:20px;padding-left:10px;padding-right:10px;max-width:45vw;width:25vw;max-height:70vh;overflow:auto;text-align:inherit}.ui-toc-dropdown>.toc{max-height:calc(70vh - 100px);overflow:auto}.ui-toc-dropdown[dir=rtl] .nav{padding-right:0;letter-spacing:.0029em}.ui-toc-dropdown a{overflow:hidden;text-overflow:ellipsis;white-space:pre}.ui-toc-dropdown .nav>li>a{display:block;padding:4px 20px;font-size:13px;font-weight:500;color:#767676}.ui-toc-dropdown .nav>li:first-child:last-child > ul,.ui-toc-dropdown .toc.expand ul{display:block}.ui-toc-dropdown .nav>li>a:focus,.ui-toc-dropdown .nav>li>a:hover{padding-left:19px;color:#000;text-decoration:none;background-color:transparent;border-left:1px solid #000}.ui-toc-dropdown[dir=rtl] .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav>li>a:hover{padding-right:19px;border-left:none;border-right:1px solid #000}.ui-toc-dropdown .nav>.active:focus>a,.ui-toc-dropdown .nav>.active:hover>a,.ui-toc-dropdown .nav>.active>a{padding-left:18px;font-weight:700;color:#000;background-color:transparent;border-left:2px solid #000}.ui-toc-dropdown[dir=rtl] .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav>.active>a{padding-right:18px;border-left:none;border-right:2px solid #000}.ui-toc-dropdown .nav .nav{display:none;padding-bottom:10px}.ui-toc-dropdown .nav>.active>ul{display:block}.ui-toc-dropdown .nav .nav>li>a{padding-top:1px;padding-bottom:1px;padding-left:30px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a{padding-right:30px}.ui-toc-dropdown .nav .nav>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:40px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a{padding-right:40px}.ui-toc-dropdown .nav .nav>li>a:focus,.ui-toc-dropdown .nav .nav>li>a:hover{padding-left:29px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:hover{padding-right:29px}.ui-toc-dropdown .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>a:hover{padding-left:39px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:hover{padding-right:39px}.ui-toc-dropdown .nav .nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>a{padding-left:28px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>a{padding-right:28px}.ui-toc-dropdown .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>a{padding-left:38px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>a{padding-right:38px}.markdown-body[lang^=ja]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,Hiragino Kaku Gothic Pro,\\30D2\30E9\30AE\30CE\89D2\30B4 Pro W3,Osaka,Meiryo,\\30E1\30A4\30EA\30AA,MS Gothic,"\FF2D\FF33   \30B4\30B7\30C3\30AF",sans-serif}.ui-toc-dropdown[lang^=ja]{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,"\FF2D\FF33   \FF30\30B4\30B7\30C3\30AF",sans-serif}.markdown-body[lang=zh-tw]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang TC,Microsoft JhengHei,\\5FAE\8EDF\6B63\9ED1,sans-serif}.ui-toc-dropdown[lang=zh-tw]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,\\5FAE\8EDF\6B63\9ED1UI,sans-serif}.markdown-body[lang=zh-cn]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang SC,Microsoft YaHei,\\5FAE\8F6F\96C5\9ED1,sans-serif}.ui-toc-dropdown[lang=zh-cn]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,\\5FAE\8F6F\96C5\9ED1UI,sans-serif}.ui-affix-toc{position:fixed;top:0;max-width:15vw;max-height:70vh;overflow:auto}.back-to-top,.expand-toggle,.go-to-bottom{display:block;padding:4px 10px;margin-top:10px;margin-left:10px;font-size:12px;font-weight:500;color:#999}.back-to-top:focus,.back-to-top:hover,.expand-toggle:focus,.expand-toggle:hover,.go-to-bottom:focus,.go-to-bottom:hover{color:#563d7c;text-decoration:none}.back-to-top,.go-to-bottom{margin-top:0}.ui-user-icon{width:20px;height:20px;display:block;border-radius:3px;margin-top:2px;margin-bottom:2px;margin-right:5px;background-position:50%;background-repeat:no-repeat;background-size:contain}.ui-user-icon.small{width:18px;height:18px;display:inline-block;vertical-align:middle;margin:0 0 .2em}small span{line-height:22px}small .dropdown{display:inline-block}small .dropdown a:focus,small .dropdown a:hover{text-decoration:none}.unselectable{-moz-user-select:none;-webkit-user-select:none;-o-user-select:none;user-select:none}@media print{blockquote,div,img,pre,table{page-break-inside:avoid!important}a[href]:after{font-size:12px!important}}.markdown-body.slides{position:relative;z-index:1;color:#222}.markdown-body.slides:before{content:"";display:block;position:absolute;top:0;left:0;right:0;bottom:0;z-index:-1;background-color:currentColor;box-shadow:0 0 0 50vw}.markdown-body.slides section[data-markdown]{position:relative;margin-bottom:1.5em;background-color:#fff;text-align:center}.markdown-body.slides section[data-markdown] code{text-align:left}.markdown-body.slides section[data-markdown]:before{content:"";display:block;padding-bottom:56.23%}.markdown-body.slides section[data-markdown]>div:first-child{position:absolute;top:50%;left:1em;right:1em;transform:translateY(-50%);max-height:100%;overflow:hidden}.markdown-body.slides section[data-markdown]>ul{display:inline-block}.markdown-body.slides>section>section+section:after{content:"";position:absolute;top:-1.5em;right:1em;height:1.5em;border:3px solid #777}body{font-smoothing:subpixel-antialiased!important;-webkit-font-smoothing:subpixel-antialiased!important;-moz-osx-font-smoothing:auto!important;text-shadow:0 0 1em transparent,1px 1px 1.2px rgba(0,0,0,.004);-webkit-overflow-scrolling:touch;font-family:Source Sans Pro,Helvetica,Arial,sans-serif;letter-spacing:.025em}.focus,:focus{outline:none!important}::-moz-focus-inner{border:0!important}body.modal-open{overflow-y:auto;padding-right:0!important}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
</head>

<body>
    <div id="doc" class="markdown-body container-fluid"><h1 id="作業系統"><a class="anchor hidden-xs" href="#作業系統" title="作業系統"><span class="octicon octicon-link"></span></a>作業系統</h1><h6 id="tags-作業系統"><a class="anchor hidden-xs" href="#tags-作業系統" title="tags-作業系統"><span class="octicon octicon-link"></span></a>tags: <code>作業系統</code></h6><ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/tree/master/class-tutorial" target="_blank">課程資料：Operating-System</a></li>
</ul><h2 id="20170302"><a class="anchor hidden-xs" href="#20170302" title="20170302"><span class="octicon octicon-link"></span></a>20170302</h2><ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170302/ch01.pdf" target="_blank">課程簡報 - Ch1：Introduction</a></li>
</ul><h2 id="20170309"><a class="anchor hidden-xs" href="#20170309" title="20170309"><span class="octicon octicon-link"></span></a>20170309</h2><ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170309/ch03.pdf" target="_blank">課程簡報 - Ch3：Process Concept</a></li>
</ul><h3 id="一-process-in-memory"><a class="anchor hidden-xs" href="#一-process-in-memory" title="一-process-in-memory"><span class="octicon octicon-link"></span></a>(一) Process in Memory</h3><p><img src="https://i.imgur.com/I9HnU1O.jpg" alt=""></p><h3 id="二-process-state"><a class="anchor hidden-xs" href="#二-process-state" title="二-process-state"><span class="octicon octicon-link"></span></a>(二) Process State</h3><p><img src="https://i.imgur.com/mFSgwiJ.jpg" alt=""><br>
* <strong>new</strong>: The process is being created<br>
* <strong>running</strong>: Instructions are being executed.<br>
* <strong>waiting</strong>: The process is waiting for some event to occur.<br>
* <strong>ready</strong>: The process is waiting to be assigned to a processor.<br>
* <strong>terminated</strong>: The process has finished execution.</p><h3 id="三-process-control-block-pcb"><a class="anchor hidden-xs" href="#三-process-control-block-pcb" title="三-process-control-block-pcb"><span class="octicon octicon-link"></span></a>(三) Process Control Block (PCB)</h3><p><img src="https://i.imgur.com/fOf7e2Q.jpg" alt=""></p><h3 id="四-process-switch"><a class="anchor hidden-xs" href="#四-process-switch" title="四-process-switch"><span class="octicon octicon-link"></span></a>(四) Process Switch</h3><p><img src="https://i.imgur.com/Bto5DiZ.jpg" alt=""></p><h3 id="五-process、thread"><a class="anchor hidden-xs" href="#五-process、thread" title="五-process、thread"><span class="octicon octicon-link"></span></a>(五) Process、Thread</h3><ul>
<li>參考資料
<ul>
<li><a href="https://goo.gl/whe9F" target="_blank">Program / Process / Thread 的差別</a></li>
<li><a href="https://goo.gl/5BnKWN" target="_blank">“Process 行程”、“Thread 執行緒”、“Multithreading 多執行緒” 簡介</a></li>
</ul>
</li>
</ul><h3 id="六-process-scheduling"><a class="anchor hidden-xs" href="#六-process-scheduling" title="六-process-scheduling"><span class="octicon octicon-link"></span></a>(六) Process Scheduling</h3><ul>
<li>Process scheduler selects among available processes for next execution on CPU</li>
<li>Maintains scheduling queues of processes
<ul>
<li>Job queue – set of all processes in the system.</li>
<li>Ready queue – set of all processes residing in main memory, ready and waiting to<br>
execute.</li>
<li>Device queues – set of processes waiting for an I/O device.</li>
<li>Processes migrate among the various queues.</li>
</ul>
</li>
</ul><h3 id="schedulers"><a class="anchor hidden-xs" href="#schedulers" title="schedulers"><span class="octicon octicon-link"></span></a>Schedulers</h3><ul>
<li><strong><ins>Long-term scheduler</ins></strong> (or job scheduler) – selects which processes should be brought into the<br>
ready queue.</li>
<li><strong><ins>Short-term scheduler</ins></strong> (or CPU scheduler) – selects which process should be executed next and<br>
allocates CPU.
<ul>
<li>Sometimes the only scheduler in a system.</li>
</ul>
</li>
<li>The long-term scheduler controls the <strong><ins>degree of multiprogramming</ins></strong>.</li>
<li><strong><ins>Medium-term scheduler</ins></strong> can be added if degree of multiple programming needs to decrease.
<ul>
<li>Remove process from memory, store on disk, bring back in from disk to continue execution:<br>
swapping.</li>
</ul>
</li>
</ul><p><strong><a href="http://enews.open2u.com.tw/~noupd/book_up/1746/8719.htm" target="_blank">Degree of multiprogramming</a></strong>：多工程度、記憶體中行程的總數量</p><h3 id="processes"><a class="anchor hidden-xs" href="#processes" title="processes"><span class="octicon octicon-link"></span></a>Processes</h3><ul>
<li><strong><ins>I/O-bound process</ins></strong> – spends more time doing I/O than computations, many short CPU<br>
bursts.
<ul>
<li>行程大部份的時間在做 I/O，只有少部份的時間在做計算。</li>
</ul>
</li>
<li><strong><ins>CPU-bound process</ins></strong> – spends more time doing computations; few very long CPU bursts.
<ul>
<li>行程大部份的時間在做計算，只有少部份的時間在做  I/O。</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/Xnhn0Sa.jpg" alt=""></p><h3 id="七-process-creation"><a class="anchor hidden-xs" href="#七-process-creation" title="七-process-creation"><span class="octicon octicon-link"></span></a>(七) Process Creation</h3><p><img src="https://i.imgur.com/MDkGD81.jpg" alt=""></p><ul>
<li>UNIX examples
<ul>
<li><strong>fork()</strong>：system call creates new process</li>
<li><strong>exec()</strong>：system call used after a fork() to replace the process’ memory space with a new program</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/AxrT24a.jpg" alt=""></p><ul>
<li>課程作業</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
	<span class="hljs-keyword">pid_t</span> pid;
	
<span class="hljs-comment">/* fork a child process */</span>
	pid = fork();

	
	<span class="hljs-keyword">if</span> (pid &lt; <span class="hljs-number">0</span>) {		<span class="hljs-comment">// erro occurred</span>
		<span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Fork Failed"</span>);
		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
	}
	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {	<span class="hljs-comment">// child process</span>
		execlp(<span class="hljs-string">"/bin/ls"</span>, <span class="hljs-string">"ls"</span>, <span class="hljs-literal">NULL</span>);
	}
	<span class="hljs-keyword">else</span> {			<span class="hljs-comment">// parent process</span>
		<span class="hljs-comment">// parent will wait for the child to complete</span>
		wait(<span class="hljs-literal">NULL</span>);
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Child Complete\n"</span>);
	}
	
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><ul>
<li>執行結果</li>
</ul><p><img src="https://i.imgur.com/CfTMr9N.jpg" alt=""></p><h2 id="20170316"><a class="anchor hidden-xs" href="#20170316" title="20170316"><span class="octicon octicon-link"></span></a>20170316</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170316/ch05.pdf" target="_blank">Chapter 5: Process Scheduling</a></li>
</ul>
</li>
<li>參考資料
<ul>
<li><a href="http://www.jollen.org/blog/2006/11/_scheduler_running_process.html" target="_blank">Preemptive Process Scheduling 的觀念</a></li>
<li><a href="http://moon.cse.yzu.edu.tw/~s981502/7/Chap4.pdf" target="_blank">各種 CPU 排程演算法之探討</a></li>
<li><a href="http://publish.get.com.tw/BookPre_pdf/51MG060707-2.PDF" target="_blank">行程排程演算法</a></li>
<li><a href="https://www.tutorialspoint.com/operating_system/os_process_scheduling_algorithms.htm" target="_blank">Operating System Scheduling algorithms</a></li>
</ul>
</li>
</ul><h3 id="一、basic-concepts"><a class="anchor hidden-xs" href="#一、basic-concepts" title="一、basic-concepts"><span class="octicon octicon-link"></span></a>一、Basic Concepts</h3><ul>
<li>Maximum CPU utilization obtained with multiprogramming.</li>
<li>CPU–I/O Burst Cycle – Process execution consists of a cycle of CPU execution and I/O wait.</li>
<li>CPU burst followed by I/O burst.</li>
<li>CPU burst distribution is of main concern.</li>
</ul><h3 id="二、cpu-scheduler"><a class="anchor hidden-xs" href="#二、cpu-scheduler" title="二、cpu-scheduler"><span class="octicon octicon-link"></span></a>二、CPU Scheduler</h3><ul>
<li>Short-term scheduler selects from among the processes in ready queue, and allocates the CPU to one of them.
<ul>
<li>Queue may be ordered in various ways.</li>
</ul>
</li>
<li>CPU scheduling decisions may take place when a process:
<ol>
<li>Switches from running to waiting state</li>
<li>Switches from running to ready state</li>
<li>Switches from waiting to ready</li>
<li>Terminates</li>
</ol>
</li>
<li>Scheduling under 1 and 4 is nonpreemptive.</li>
<li>All other scheduling is preemptive.
<ul>
<li>Consider access to shared data.</li>
<li>Consider preemption while in kernel mode.</li>
<li>Consider interrupts occurring during crucial OS activities.</li>
</ul>
</li>
</ul><h3 id="三、dispatcher"><a class="anchor hidden-xs" href="#三、dispatcher" title="三、dispatcher"><span class="octicon octicon-link"></span></a>三、Dispatcher</h3><ul>
<li>Dispatcher module gives control of the CPU to the process selected by the short-term scheduler; this involves：
<ol>
<li>switching context</li>
<li>switching to user mode</li>
<li>jumping to the proper location in the user program to restart that program</li>
</ol>
</li>
<li>Dispatch latency：time it takes for the dispatcher to stop one process and start another running.</li>
</ul><h3 id="四、scheduling-algorithm-optimization-criteria"><a class="anchor hidden-xs" href="#四、scheduling-algorithm-optimization-criteria" title="四、scheduling-algorithm-optimization-criteria"><span class="octicon octicon-link"></span></a>四、Scheduling Algorithm Optimization Criteria</h3><p><img src="https://i.imgur.com/LuBGjEu.jpg" alt=""></p><ol>
<li>CPU utilization – keep the CPU as busy as possible.</li>
<li>Throughput – # of processes that complete their execution per time unit.</li>
<li>Turnaround time – amount of time to execute a particular process.</li>
<li>Waiting time – amount of time a process has been waiting in the ready queue.</li>
<li>Response time – amount of time it takes from when a request was submitted until the first response is produced, not output (for time-sharing environment).</li>
</ol><ul>
<li>Length of Next CPU Burst
<ul>
<li>Determining<br>
<img src="https://i.imgur.com/1GaCgCb.jpg" alt=""></li>
<li>Prediction<br>
<img src="https://i.imgur.com/HWSLIdj.jpg" alt=""></li>
</ul>
</li>
</ul><h3 id="五、scheduling-algorithm"><a class="anchor hidden-xs" href="#五、scheduling-algorithm" title="五、scheduling-algorithm"><span class="octicon octicon-link"></span></a>五、Scheduling Algorithm</h3><h4 id="一-first-come-first-served-fcfs：先到先服務法"><a class="anchor hidden-xs" href="#一-first-come-first-served-fcfs：先到先服務法" title="一-first-come-first-served-fcfs：先到先服務法"><span class="octicon octicon-link"></span></a>(一) First-Come, First-Served (FCFS)：先到先服務法</h4><p><img src="https://i.imgur.com/xWKL0Z3.jpg" alt=""></p><hr><p><img src="https://i.imgur.com/6MIKb3Q.jpg" alt=""></p><ul>
<li>Convoy effect：很多短時間的 process，都在等一個長時間的 process 時，所產生的效應 (因為等待時間很長)。</li>
</ul><h4 id="二-shortest-job-first-sjf：最短優先法"><a class="anchor hidden-xs" href="#二-shortest-job-first-sjf：最短優先法" title="二-shortest-job-first-sjf：最短優先法"><span class="octicon octicon-link"></span></a>(二) Shortest-Job-First (SJF)：最短優先法</h4><ul>
<li>Associate with each process the length of its next CPU burst.
<ul>
<li>Use these lengths to schedule the process with the shortest time.</li>
</ul>
</li>
<li>SJF is optimal – gives minimum average waiting time for a given set of processes.
<ul>
<li>The difficulty is knowing the length of the next CPU request.</li>
<li>Could ask the user.</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/Wf8bEgG.jpg" alt=""></p><h4 id="三-priority-scheduling-ps：優先權排班法"><a class="anchor hidden-xs" href="#三-priority-scheduling-ps：優先權排班法" title="三-priority-scheduling-ps：優先權排班法"><span class="octicon octicon-link"></span></a>(三) Priority Scheduling (PS)：優先權排班法</h4><ul>
<li>A priority number (integer) is associated with each process.</li>
<li>The CPU is allocated to the process with the highest priority (smallest integer &gt;&gt; highest priority).
<ul>
<li>Preemptive</li>
<li>Nonpreemptive</li>
</ul>
</li>
<li>SJF is priority scheduling where priority is the inverse of predicted next CPU burst time.</li>
<li>Problem：Starvation – low priority processes may never execute.</li>
<li>Solution：Aging – as time progresses increase the priority of the process.</li>
</ul><p><img src="https://i.imgur.com/ZeyVmU1.jpg" alt=""></p><h4 id="四-round-robin-rr：輪流法"><a class="anchor hidden-xs" href="#四-round-robin-rr：輪流法" title="四-round-robin-rr：輪流法"><span class="octicon octicon-link"></span></a>(四) Round Robin (RR)：輪流法</h4><ul>
<li>Each process gets a small unit of CPU time (time quantum q), usually 10-100 milliseconds. After this time has elapsed, the process is preempted and added to the end of the ready queue.</li>
<li>If there are n processes in the ready queue and the time quantum is q, then each process gets 1/n of the CPU time in chunks of at most q time units at once. No process waits more than (n-1)q time units.</li>
<li>Timer interrupts every quantum to schedule next process.</li>
<li>Performance.
<ul>
<li>q large &gt;&gt; FIFO.</li>
<li>q small &gt;&gt; q must be large with respect to context switch, otherwise overhead is too high.</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/uu9W1cI.jpg" alt=""></p><h5 id="1-time-quantum-and-context-switch-time"><a class="anchor hidden-xs" href="#1-time-quantum-and-context-switch-time" title="1-time-quantum-and-context-switch-time"><span class="octicon octicon-link"></span></a>1. Time Quantum and Context Switch Time</h5><p><img src="http://i.imgur.com/7SMF7rd.jpg" alt=""></p><h5 id="2-turnaround-time-varies-with-the-time-quantum"><a class="anchor hidden-xs" href="#2-turnaround-time-varies-with-the-time-quantum" title="2-turnaround-time-varies-with-the-time-quantum"><span class="octicon octicon-link"></span></a>2. Turnaround Time Varies With The Time Quantum</h5><p><img src="http://i.imgur.com/EtNCekP.jpg" alt=""></p><h4 id="五-multilevel"><a class="anchor hidden-xs" href="#五-multilevel" title="五-multilevel"><span class="octicon octicon-link"></span></a>(五) Multilevel</h4><h5 id="1-queue"><a class="anchor hidden-xs" href="#1-queue" title="1-queue"><span class="octicon octicon-link"></span></a>1. Queue</h5><ul>
<li>Ready queue is partitioned into separate queues, eg:
<ul>
<li>foreground (interactive)</li>
<li>background (batch)</li>
</ul>
</li>
<li>Process permanently in a given queue.<br>
Each queue has its own scheduling algorithm:
<ul>
<li>foreground – RR</li>
<li>background – FCFS</li>
</ul>
</li>
<li>Scheduling must be done between the queues:
<ul>
<li>Fixed priority scheduling; (i.e., serve all from foreground then from background). Possibility of starvation.</li>
<li>Time slice – each queue gets a certain amount of CPU time which it can schedule amongst its processes; i.e., 80% to foreground in RR.</li>
<li>20% to background in FCFS.</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/rW9GXTr.jpg" alt=""></p><h5 id="2-feedback-queue"><a class="anchor hidden-xs" href="#2-feedback-queue" title="2-feedback-queue"><span class="octicon octicon-link"></span></a>2. Feedback Queue</h5><ul>
<li>A process can move between the various queues; aging can be implemented this way.</li>
<li>Multilevel-feedback-queue scheduler. defined by the following parameters:
<ul>
<li>number of queues.</li>
<li>scheduling algorithms for each queue.</li>
<li>method used to determine when to upgrade a process.</li>
<li>method used to determine when to demote a process.</li>
<li>method used to determine which queue a process will enter when that process needs service.</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/Nc2SsIQ.jpg" alt=""></p><h3 id="課程作業"><a class="anchor hidden-xs" href="#課程作業" title="課程作業"><span class="octicon octicon-link"></span></a>課程作業</h3><ul>
<li>程式流程</li>
</ul><h4 id="scheduler"><a class="anchor hidden-xs" href="#scheduler" title="scheduler"><span class="octicon octicon-link"></span></a>scheduler()</h4><ul>
<li>select one from the read processes by the round robin algorithm, and then return the pid of the selected process.</li>
<li>if no ready process (i.e., all the processes are finished), then return -1.</li>
</ul><h4 id="main"><a class="anchor hidden-xs" href="#main" title="main"><span class="octicon octicon-link"></span></a>main()</h4><ol>
<li>call scheduler() to get the pid of a process,</li>
<li>if the pid obtained by step 1 is -1, go to step 7.</li>
<li>if the remaining time of the selected process is smaller than a time slice add clock by the remaining time of the process store the value of clock as the turnaround time of the process；set the remaining time of the process as zero, endif.</li>
<li>if the remaining time of the selected process is equal to a time slice add clock by a time slice store the value of clock as the turnaround time of the process.set the remaining time of the process as zero, endif.</li>
<li>if the remaining time of the selected process is larger than a time slice add clock by a time slice subtract the remaining time of the process by a time slice, endif.</li>
<li>go to step 1.</li>
<li>summate the turnaround time of all the processes.</li>
<li>calculate the average turnaround time of the processes.</li>
</ol><ul>
<li>範例程式</li>
</ul><pre><code class="clike hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span></div><div class="code"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> TIMESLICE	1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PROCESS_NO	4</span>
<span class="hljs-keyword">int</span> remaintime[PROCESS_NO] = {<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>};
<span class="hljs-keyword">int</span> turnaroundtime[PROCESS_NO];
<span class="hljs-keyword">int</span> clock = <span class="hljs-number">0</span>; <span class="hljs-comment">// global time clock</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">scheduler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
    <span class="hljs-comment">// select one from the read processes by the round robin algorithm, </span>
    <span class="hljs-comment">// and then return the pid of the selected process;</span>
    <span class="hljs-comment">// if no ready process (i.e., all the processes are finished), then return -1;</span>
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{

    <span class="hljs-comment">//1. call scheduler() to get the pid of a process,</span>
    <span class="hljs-comment">//2. if the pid obtained by step 1 is -1, go to step 7</span>
    <span class="hljs-comment">//3. if the remaining time of the selected process is smaller than a time slice</span>
    <span class="hljs-comment">//         add clock by the remaining time of the process</span>
    <span class="hljs-comment">//         store the value of clock as the turnaround time of the process.</span>
    <span class="hljs-comment">//         set the remaining time of the process as zero.</span>
    <span class="hljs-comment">//  endif</span>
    <span class="hljs-comment">//4. if the remaining time of the selected process is equal to a time slice</span>
    <span class="hljs-comment">//         add clock by a time slice </span>
    <span class="hljs-comment">//         store the value of clock as the turnaround time of the process.</span>
    <span class="hljs-comment">//         set the remaining time of the process as zero.</span>
    <span class="hljs-comment">//  endif</span>
    <span class="hljs-comment">//5. if the remaining time of the selected process is larger than a time slice</span>
    <span class="hljs-comment">//         add clock by a time slice</span>
    <span class="hljs-comment">//         subtract the remaining time of the process by a time slice</span>
    <span class="hljs-comment">//  endif</span>
    <span class="hljs-comment">//6. go to step 1.</span>
    <span class="hljs-comment">//7. summate the turnaround time of all the processes</span>
    <span class="hljs-comment">//8. calculate the average turnaround time of the processes</span>
           
}


</div></div></code></pre><h2 id="20170323"><a class="anchor hidden-xs" href="#20170323" title="20170323"><span class="octicon octicon-link"></span></a>20170323</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170323/ch04.pdf" target="_blank">Chapter 4: Mutithread Programming</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170323/Linux_programming_pthread.pdf" target="_blank">Linux_programming_pthread</a></li>
</ul>
</li>
<li>參考資料
<ul>
<li><a href="https://hackmd.io/s/Skh_AaVix" target="_blank">Toward Concurrency</a></li>
<li><a href="https://chi_gitbook.gitbooks.io/personal-note/content/amdahls_law.html" target="_blank">Amdahl’s Law</a></li>
</ul>
</li>
</ul><h3 id="multithread-architecture"><a class="anchor hidden-xs" href="#multithread-architecture" title="multithread-architecture"><span class="octicon octicon-link"></span></a>Multithread Architecture</h3><p><img src="https://i.imgur.com/8ICdvBz.jpg" alt=""></p><ul>
<li><strong>Responsiveness</strong> – may allow continued execution if part of process is blocked, especially important for user interfaces.</li>
<li><strong>Resource Sharing</strong> – threads share resources of process, easier than shared memory or message passing.</li>
<li><strong>Economy</strong> – cheaper than process creation, thread switching lower overhead than context switching.</li>
<li><strong>Scalability</strong> – process can take advantage of multiprocessor architectures.</li>
</ul><h3 id="一、multicore-programming"><a class="anchor hidden-xs" href="#一、multicore-programming" title="一、multicore-programming"><span class="octicon octicon-link"></span></a>一、Multicore Programming</h3><ul>
<li>
<p><strong>Multicore</strong> or <strong>multiprocessor</strong> systems putting pressure on programmers, challenges include:</p>
<ul>
<li><strong>Dividing activities</strong></li>
<li><strong>Balance</strong></li>
<li><strong>Data splitting</strong></li>
<li><strong>Data dependency</strong></li>
<li><strong>Testing and debugging</strong></li>
</ul>
</li>
<li>
<p><strong>Parallelism</strong> implies a system can perform more than one task simultaneously.</p>
</li>
<li>
<p><strong>Concurrency</strong> supports more than one task making progress.</p>
<ul>
<li>Single processor / core, scheduler providing concurrency</li>
</ul>
</li>
<li>
<p>Types of parallelism</p>
<ul>
<li><strong>Data parallelism</strong> – distributes subsets of the same data across multiple cores, same operation on each.</li>
<li><strong>Task parallelism</strong> – distributing threads across cores, each thread performing unique operation.</li>
</ul>
</li>
<li>
<p>As # of threads grows, so does architectural support for threading.</p>
<ul>
<li>CPUs have cores as well as <strong>hardware threads</strong>.</li>
<li>Consider Oracle SPARC T4 with 8 cores, and 8 hardware threads per core.</li>
</ul>
</li>
</ul><h3 id="二、concurrency-vs-parallelism"><a class="anchor hidden-xs" href="#二、concurrency-vs-parallelism" title="二、concurrency-vs-parallelism"><span class="octicon octicon-link"></span></a>二、Concurrency vs Parallelism</h3><ul>
<li>引用資料：<a href="https://hackmd.io/s/Skh_AaVix" target="_blank">Toward Concurrency</a></li>
<li><a href="https://blog.golang.org/concurrency-is-not-parallelism" target="_blank">Concurrency is not Parallelism</a>, by Rob Pike
<ul>
<li><a href="https://talks.golang.org/2012/waza.slide#1" target="_blank">投影片</a></li>
<li><a href="https://www.youtube.com/watch?v=cN_DpYBzKso" target="_blank">錄影</a></li>
<li><a href="http://stackoverflow.com/questions/11700953/concurrency-is-not-parallelism" target="_blank">後續 stackoverflow 討論</a></li>
</ul>
</li>
<li>Concurrency 對軟體設計的影響
<ul>
<li>想要充分使用到 CPU 的資源</li>
<li>程式越來越有機會造成 CPU-bound。雖然主要還是 IO-bound 等，但如果 CPU 時脈無法增加，而其他存取方式速度變快，最後會發生 CPU-bound</li>
<li>軟體效能優化將會越來越重要</li>
<li>程式語言必須好好處理 concurrency</li>
</ul>
</li>
</ul><h4 id="1-concurrency"><a class="anchor hidden-xs" href="#1-concurrency" title="1-concurrency"><span class="octicon octicon-link"></span></a>1. Concurrency</h4><ul>
<li>是指程式架構，將程式拆開成多個可獨立運作的工作。eg：drivers，都可以獨立運作，但不需要平行化。
<ul>
<li>拆開多個的工作不一定要同時運行</li>
<li>多個工作在單核心 CPU 上運行</li>
</ul>
</li>
</ul><h4 id="2-parallelism"><a class="anchor hidden-xs" href="#2-parallelism" title="2-parallelism"><span class="octicon octicon-link"></span></a>2. Parallelism</h4><ul>
<li>是指程式執行，同時執行多個程式。Concurrency 可能會用到 parallelism，但不一定要用 parallelism 才能實現 concurrency。eg：Vector dot product
<ul>
<li>程式會同時執行 (例如：分支後，同時執行，再收集結果)</li>
<li>一個工作在多核心 CPU 上運行</li>
</ul>
</li>
</ul><h4 id="3-concurrency-vs-parallelism"><a class="anchor hidden-xs" href="#3-concurrency-vs-parallelism" title="3-concurrency-vs-parallelism"><span class="octicon octicon-link"></span></a>3. Concurrency vs Parallelism</h4><p>Rob Pike 用地鼠燒書做例子:<br>
<img src="https://hackpad-attachments.s3.amazonaws.com/embedded2016.hackpad.com_K6DJ0ZtiecH_p.537916_1460613009716_task.jpg" alt=""></p><ul>
<li>如果今天增加多一只地鼠，一個推車或多一個焚燒盧，這樣有機會作到更好的資源使用率，但我們不能保證兩只或更多地鼠會同時進行 (可能只有有限的火爐)。在單核系統中只能允許一次進行一次的燒書工作，那樣就沒有效率了。<br>
<img src="https://i.imgur.com/XTGAK98.jpg" alt=""><br>
以 Concurrency 的方式去作業，能夠以不同的解構方式去進行，可以是三個地鼠分別負責一部分的工作 (decomposition)<br>
<img src="https://i.imgur.com/w5Eugs7.jpg" alt=""><br>
其中也可以 Parallelism:<br>
<img src="https://i.imgur.com/3IHX5BT.jpg" alt=""><br>
或<br>
<img src="https://i.imgur.com/duEVvNK.jpg" alt=""></li>
</ul><p><strong>Concurrency:</strong>&nbsp;是指程式架構，將程式拆開成多個可獨立運作的工作，像是驅動程式都可獨立運作，但不需要平行化</p><ul>
<li>拆開多個的工作不一定要同時運行</li>
<li>多個工作在單核心 CPU 上運行</li>
</ul><p><strong>Parallelism:</strong>&nbsp;是指程式執行，同時執行多個程式。Concurrency 可能會用到 parallelism，但不一定要用 parallelism 才能實現 concurrency。eg：Vector dot product</p><ul>
<li>程式會同時執行 (例如：fork 後，同時執行，再收集結果 [join])</li>
<li>一個工作在多核心 CPU 上運行</li>
</ul><h4 id="4-相關整理"><a class="anchor hidden-xs" href="#4-相關整理" title="4-相關整理"><span class="octicon octicon-link"></span></a>4. 相關整理</h4><p>線上教材 <a href="https://www.youtube.com/watch?v=6jFkNjhJ-Z4" target="_blank">Introduction to OpenMP</a> 做了以下整理:</p><p>(1) Concurrent (並行)</p><ul>
<li>工作可拆分成「獨立執行」的部份，這樣「可以」讓很多事情一起做，但是「不一定」要真的同時做。下方情境：<br>
<img src="https://i.imgur.com/rweOyiD.png" alt="">
<ul>
<li>展示具有並行性，但不去同時執行。</li>
<li>並行性是種「架構程式」的概念。寫下一段程式之前，思考問題架構時就決定好的。</li>
</ul>
</li>
</ul><ul>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled"><label></label>Parallel (平行)</li>
</ul><ul>
<li>把規劃好、能夠並行的程式，分配給不同執行緒，並讓他們同時執行。<br>
<img src="https://i.imgur.com/Oom3wM5.png" alt="">
<ul>
<li>「平行」是一種選擇。</li>
</ul>
</li>
</ul><h3 id="三、single-and-multithreaded-processes"><a class="anchor hidden-xs" href="#三、single-and-multithreaded-processes" title="三、single-and-multithreaded-processes"><span class="octicon octicon-link"></span></a>三、Single and Multithreaded Processes</h3><p><img src="https://i.imgur.com/KLVunhJ.jpg" alt=""></p><ul>
<li><strong>Amdahl’s Law</strong>
<ul>
<li>針對系統裡面某一個特定的元件予以最佳化，對於整體系統有多少的效能改變。<br>
<img src="https://i.imgur.com/E1L6ODN.jpg" alt=""></li>
<li>分成兩部份
<ul>
<li><strong>有辦法改進的部份</strong></li>
<li><strong>沒有辦法改進的部份</strong></li>
</ul>
</li>
<li>因為有無法改進的部份，所以不可能無限提升系統的某一個特定部分的效率。</li>
</ul>
</li>
</ul><h3 id="四、user-threads-and-kernel-threads"><a class="anchor hidden-xs" href="#四、user-threads-and-kernel-threads" title="四、user-threads-and-kernel-threads"><span class="octicon octicon-link"></span></a>四、User Threads and Kernel Threads</h3><ul>
<li><strong>User threads</strong>
<ul>
<li>Management done by user-level threads library.</li>
</ul>
</li>
<li><strong>Kernel threads</strong>
<ul>
<li>Supported by the Kernel.</li>
</ul>
</li>
</ul><h3 id="五、multithreading-models"><a class="anchor hidden-xs" href="#五、multithreading-models" title="五、multithreading-models"><span class="octicon octicon-link"></span></a>五、Multithreading Models</h3><ol>
<li>
<p><strong>Many-to-One</strong></p>
<ul>
<li>Many user-level threads mapped to single kernel thread.</li>
<li><strong>One thread blocking causes all to block.</strong></li>
<li>Multiple threads may not run in parallel on muticore system because only one may be in kernel at a time.</li>
<li>Examples：<code>Solaris Green Threads</code>、<code>GNU Portable Threads</code><br>
<img src="https://i.imgur.com/dwfuxrT.jpg" alt=""></li>
</ul>
</li>
<li>
<p><strong>One-to-One</strong></p>
<ul>
<li>Each user-level thread maps to kernel thread.</li>
<li><strong>Creating a user-level thread creates a kernel thread.</strong></li>
<li>More concurrency than many-to-one.</li>
<li>Number of threads per process sometimes restricted due to overhead.</li>
<li>Examples：<code>Windows NT/XP/2000</code>、<code>Linux</code>、<code>Solaris 9 and later</code><br>
<img src="https://i.imgur.com/Fh9QH0S.jpg" alt=""></li>
</ul>
</li>
<li>
<p><strong>Many-to-Many</strong></p>
</li>
</ol><ul>
<li>Allows many user level threads to be mapped to many kernel threads.</li>
<li>Allows the operating system to create a sufficient number of kernel threads.</li>
<li>Solaris prior to version 9.</li>
<li>Example：<code>Windows NT/2000 with the ThreadFiber package</code><br>
<img src="https://i.imgur.com/hWCuKOk.jpg" alt=""></li>
</ul><ol start="4">
<li><strong>Two-level</strong></li>
</ol><ul>
<li>Similar to M:M, except that it allows a user thread to be bound to kernel thread.</li>
<li>Examples：<code>IRIX</code>、<code>HP-UX</code>、<code>Tru64 UNIX</code>、<code>Solaris 8 and earlier</code><br>
<img src="https://i.imgur.com/iRt3Xj2.jpg" alt=""></li>
</ul><h3 id="六、pthreads"><a class="anchor hidden-xs" href="#六、pthreads" title="六、pthreads"><span class="octicon octicon-link"></span></a>六、Pthreads</h3><ul>
<li>May be provided either as user-level or kernel-level.</li>
<li>A POSIX standard (IEEE 1003.1c) API for thread creation and synchronization.</li>
<li><strong>Specification, not implementation.</strong></li>
<li>API specifies behavior of the thread library, implementation is up to development of the library.</li>
<li>Common in UNIX operating systems (Solaris, Linux, Mac OS X).</li>
</ul><h4 id="pthreadh"><a class="anchor hidden-xs" href="#pthreadh" title="pthreadh"><span class="octicon octicon-link"></span></a>pthread.h</h4><pre><code class="c hljs"><span class="hljs-meta">#include &lt;pthread.h&gt;</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_create</span>(<span class="hljs-params">pthread_t *thread, pthread_attr_t
*attr, <span class="hljs-keyword">void</span> *(*start_routine</span>)(<span class="hljs-params"><span class="hljs-keyword">void</span> *</span>), <span class="hljs-keyword">void</span> *arg)</span>;
<span class="hljs-comment">//create a thread</span>


<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pthread_exit</span>(<span class="hljs-params"><span class="hljs-keyword">void</span> *retval</span>)</span>;
<span class="hljs-comment">//terminate a thread</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_join</span>(<span class="hljs-params">pthread_t th, <span class="hljs-keyword">void</span> **thread_return</span>)</span>;
<span class="hljs-comment">//wait for thread termination</span>

</code></pre><h5 id="pthread-create"><a class="anchor hidden-xs" href="#pthread-create" title="pthread-create"><span class="octicon octicon-link"></span></a>pthread_create()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_create</span>(<span class="hljs-params">pthread_t *thread,
pthread_attr_t *attr, <span class="hljs-keyword">void</span> *(*start_routine</span>)(<span class="hljs-params"><span class="hljs-keyword">void</span>
*</span>), <span class="hljs-keyword">void</span> *arg)</span>;
</code></pre><ul>
<li><code>pthread_t *thread</code>：thread 的識別字</li>
<li><code>pthread_attr_t *attr</code>：thread 的屬性，設定為 NULL 表示使用預設值</li>
<li><code>void *(*start_routine)(void*)</code>：thread 要執行的 function</li>
<li><code>void *arg</code>：傳遞給 thread 的參數</li>
</ul><h5 id="pthread-exit"><a class="anchor hidden-xs" href="#pthread-exit" title="pthread-exit"><span class="octicon octicon-link"></span></a>pthread_exit()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pthread_exit</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *retval)</span></span>;
</code></pre><ul>
<li><code>void *retval</code>：thread 結束時回傳的變數</li>
</ul><h5 id="pthread-join"><a class="anchor hidden-xs" href="#pthread-join" title="pthread-join"><span class="octicon octicon-link"></span></a>pthread_join()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_join</span><span class="hljs-params">(<span class="hljs-keyword">pthread_t</span> th, <span class="hljs-keyword">void</span> **thread_return)</span></span>;
</code></pre><ul>
<li><code>pthread_t th</code>：thread 識別字</li>
<li><code>void **thread_return</code>：接收 pthread_exit 傳回的變數</li>
</ul><h3 id="課程作業1"><a class="anchor hidden-xs" href="#課程作業1" title="課程作業1"><span class="octicon octicon-link"></span></a>課程作業</h3><p>從 1 - 10000 之間取出所有的質數，利用 threads 來分配計算質數的範圍。</p><pre><code class="clike hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span>
<span data-linenumber="72"></span>
<span data-linenumber="73"></span>
<span data-linenumber="74"></span>
<span data-linenumber="75"></span>
<span data-linenumber="76"></span>
<span data-linenumber="77"></span>
<span data-linenumber="78"></span>
<span data-linenumber="79"></span>
<span data-linenumber="80"></span>
<span data-linenumber="81"></span>
<span data-linenumber="82"></span>
<span data-linenumber="83"></span>
<span data-linenumber="84"></span>
<span data-linenumber="85"></span>
<span data-linenumber="86"></span>
<span data-linenumber="87"></span>
<span data-linenumber="88"></span>
<span data-linenumber="89"></span>
<span data-linenumber="90"></span>
<span data-linenumber="91"></span>
<span data-linenumber="92"></span>
<span data-linenumber="93"></span>
<span data-linenumber="94"></span>
<span data-linenumber="95"></span>
<span data-linenumber="96"></span>
<span data-linenumber="97"></span>
<span data-linenumber="98"></span>
<span data-linenumber="99"></span>
<span data-linenumber="100"></span>
<span data-linenumber="101"></span>
<span data-linenumber="102"></span>
<span data-linenumber="103"></span>
<span data-linenumber="104"></span>
<span data-linenumber="105"></span>
<span data-linenumber="106"></span>
<span data-linenumber="107"></span>
<span data-linenumber="108"></span>
<span data-linenumber="109"></span>
<span data-linenumber="110"></span>
<span data-linenumber="111"></span>
<span data-linenumber="112"></span>
<span data-linenumber="113"></span>
<span data-linenumber="114"></span>
<span data-linenumber="115"></span>
<span data-linenumber="116"></span>
<span data-linenumber="117"></span>
<span data-linenumber="118"></span></div><div class="code"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NUM_THREADS 10</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MSIZE 10000</span>

<span class="hljs-comment">// 找出 1 - 10000 的所有質數</span>

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getDoubleTime</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread_function</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span>;
<span class="hljs-keyword">pthread_mutex_t</span> work_mutex;

<span class="hljs-comment">// 宣告 prime_array 陣列</span>
<span class="hljs-keyword">int</span> prime_array[NUM_THREADS][(MSIZE / NUM_THREADS)];


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
	<span class="hljs-keyword">int</span> res;
	<span class="hljs-keyword">pthread_t</span> a_thread[NUM_THREADS];
	<span class="hljs-keyword">void</span> *thread_result;
	<span class="hljs-keyword">int</span> lots_of_threads;
    <span class="hljs-keyword">int</span> print_prime = <span class="hljs-number">0</span>;


	<span class="hljs-comment">// start to measure time...</span>
	<span class="hljs-keyword">double</span> start_time = getDoubleTime();
	
	<span class="hljs-comment">// initialize mutex...</span>
	res = pthread_mutex_init(&amp;work_mutex, <span class="hljs-literal">NULL</span>);
	<span class="hljs-keyword">if</span> (res != <span class="hljs-number">0</span>) {
       	perror(<span class="hljs-string">"Mutex initialization failed"</span>);
	    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

	<span class="hljs-comment">// pthread_create...</span>
	<span class="hljs-keyword">for</span> (lots_of_threads = <span class="hljs-number">0</span>; lots_of_threads &lt; NUM_THREADS; lots_of_threads ++) {
		res = pthread_create(&amp;(a_thread[lots_of_threads]), <span class="hljs-literal">NULL</span>, thread_function, (<span class="hljs-keyword">void</span>*)(<span class="hljs-keyword">long</span>)lots_of_threads);

        <span class="hljs-keyword">if</span> (res != <span class="hljs-number">0</span>) {
			perror(<span class="hljs-string">"Thread creation failed"</span>);
        		<span class="hljs-built_in">exit</span>(EXIT_FAILURE);
		}
	}

	<span class="hljs-comment">// pthread_join...</span>
	<span class="hljs-keyword">for</span> (lots_of_threads = NUM_THREADS - <span class="hljs-number">1</span>; lots_of_threads &gt;= <span class="hljs-number">0</span>; lots_of_threads--) {
        	res = pthread_join(a_thread[lots_of_threads], &amp;thread_result); 

            <span class="hljs-keyword">if</span> (res != <span class="hljs-number">0</span>) {
	            perror(<span class="hljs-string">"pthread_join failed"</span>);
        	}
    }	
    
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 設定計數器</span>
    <span class="hljs-keyword">for</span> (lots_of_threads = <span class="hljs-number">0</span>; lots_of_threads &lt; NUM_THREADS; lots_of_threads ++) { 
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n\nThe thread[%d]'s numbers：\n"</span>, lots_of_threads);

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; (MSIZE / NUM_THREADS); i++) {
            <span class="hljs-keyword">if</span> (prime_array[lots_of_threads][i] != <span class="hljs-number">0</span>)
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\t"</span>, prime_array[lots_of_threads][i]);                        }
    }


	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nThread joined\n"</span>);

	<span class="hljs-comment">// stop measuring time...</span>
	<span class="hljs-keyword">double</span> finish_time = getDoubleTime();
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Execute Time:  %.3lf ms\n"</span>, (finish_time - start_time));
    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}


<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread_function</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{
    <span class="hljs-comment">// pthread_mutex_lock(&amp;work_mutex);</span>
	
    <span class="hljs-keyword">int</span> my_num = (<span class="hljs-keyword">long</span>)arg;
	<span class="hljs-comment">// if (MSIZE % NUM_THREADS != 0){    printf("error");   pthread_exit(-1);    }</span>

    <span class="hljs-keyword">int</span> start_num = (MSIZE / NUM_THREADS) * my_num + <span class="hljs-number">1</span>;
	<span class="hljs-keyword">int</span> end_num = (MSIZE / NUM_THREADS) * (my_num + <span class="hljs-number">1</span>);

    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>, k = <span class="hljs-number">0</span>;   <span class="hljs-comment">// Set the loop</span>
    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;      <span class="hljs-comment">// Set the counter</span>
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;     <span class="hljs-comment">// result</span>

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"I'm thread[%d], start_num:%d, end_num:%d\n"</span>, my_num, start_num, end_num);

    <span class="hljs-comment">/* find the prime number */</span>
    <span class="hljs-keyword">for</span> (i = start_num; i &lt;= end_num; i++) {
        count = <span class="hljs-number">0</span>;      <span class="hljs-comment">// Reset counter</span>

        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">1</span>; j &lt;= i; j++) {
            <span class="hljs-keyword">if</span> (i % j == <span class="hljs-number">0</span>)
                count += <span class="hljs-number">1</span>;
        }
        
        <span class="hljs-keyword">if</span> (count == <span class="hljs-number">2</span>) { 
            prime_array[my_num][k] = i;
            k++;
        }
    }


    <span class="hljs-comment">// pthread_mutex_unlock(&amp;work_mutex);</span>
	pthread_exit(<span class="hljs-number">0</span>);
}


<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getDoubleTime</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">struct</span> timeval tm_tv;
        gettimeofday(&amp;tm_tv,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">double</span>)(((<span class="hljs-keyword">double</span>)tm_tv.tv_sec * (<span class="hljs-keyword">double</span>)<span class="hljs-number">1000.</span> + (<span class="hljs-keyword">double</span>)(tm_tv.tv_usec)) * (<span class="hljs-keyword">double</span>)<span class="hljs-number">0.001</span>);
}

</div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/jw2pSxj.jpg" alt=""></li>
</ul><h2 id="20170330"><a class="anchor hidden-xs" href="#20170330" title="20170330"><span class="octicon octicon-link"></span></a>20170330</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170330/ch04.pdf" target="_blank">Chapter 4: Mutithread Programming</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170330/ch05.pdf" target="_blank">Chapter 5: Process Scheduling</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170330/Linux_programming_pthread.pdf" target="_blank">Linux_programming_pthread</a></li>
</ul>
</li>
<li>參考資料
<ul>
<li><a href="https://hackmd.io/s/Skh_AaVix" target="_blank">Toward Concurrency</a></li>
<li><a href="http://tuxthink.blogspot.tw/2013/01/using-condition-variables-in-pthreads.html" target="_blank">Using condition variables in pthreads</a></li>
</ul>
</li>
</ul><h3 id="一-thread-synchronization"><a class="anchor hidden-xs" href="#一-thread-synchronization" title="一-thread-synchronization"><span class="octicon octicon-link"></span></a>(一) Thread Synchronization</h3><h3 id="1-semaphore"><a class="anchor hidden-xs" href="#1-semaphore" title="1-semaphore"><span class="octicon octicon-link"></span></a>1. Semaphore</h3><h4 id="semaphoreh"><a class="anchor hidden-xs" href="#semaphoreh" title="semaphoreh"><span class="octicon octicon-link"></span></a>semaphore.h</h4><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_init</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem, <span class="hljs-keyword">int</span> pshared, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> value)</span></span>;
<span class="hljs-comment">//create a semaphore</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_wait</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
<span class="hljs-comment">//lock a semaphore</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_post</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
<span class="hljs-comment">//unlock a semaphore</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_destroy</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
<span class="hljs-comment">//delete a semaphore</span>
</code></pre><h5 id="sem-init"><a class="anchor hidden-xs" href="#sem-init" title="sem-init"><span class="octicon octicon-link"></span></a>sem_init()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_init</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem, <span class="hljs-keyword">int</span> pshared, <span class="hljs-keyword">unsigned</span>
<span class="hljs-keyword">int</span> value)</span></span>;
</code></pre><ul>
<li><code>sem_t *sem</code>：semaphore 識別字</li>
<li><code>int pshared</code>：設定為 0 表示僅供目前的 process 及其 thread 使用。非 0 表示此 semaphore 與其他 process 共用</li>
<li><code>unsigned int value</code>：semaphore 的初始值</li>
</ul><h5 id="sem-wait"><a class="anchor hidden-xs" href="#sem-wait" title="sem-wait"><span class="octicon octicon-link"></span></a>sem_wait()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_wait</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
</code></pre><ul>
<li>若 semaphore 為非 0，則 semaphore 值減<br>
1；若 semaphore 為 0，則呼叫此 function<br>
的 thread 會被 block ，直到 semaphore 值不<br>
為 0。</li>
</ul><h5 id="sem-post"><a class="anchor hidden-xs" href="#sem-post" title="sem-post"><span class="octicon octicon-link"></span></a>sem_post()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_post</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
</code></pre><ul>
<li>對 semaphore 值加 1 。</li>
</ul><h5 id="sem-destroy"><a class="anchor hidden-xs" href="#sem-destroy" title="sem-destroy"><span class="octicon octicon-link"></span></a>sem_destroy()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_destroy</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
<span class="hljs-comment">//delete a semaphore</span>
</code></pre><h3 id="2-mutex"><a class="anchor hidden-xs" href="#2-mutex" title="2-mutex"><span class="octicon octicon-link"></span></a>2. Mutex</h3><h4 id="pthreadh1"><a class="anchor hidden-xs" href="#pthreadh1" title="pthreadh1"><span class="octicon octicon-link"></span></a>pthread.h</h4><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_init</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex, <span class="hljs-keyword">const</span> <span class="hljs-keyword">pthread_mutexattr_t</span> *mutexattr)</span></span>;
<span class="hljs-comment">//create a mutex</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_lock</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//lock a mutex</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_unlock</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//unlock a mutex</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_destroy</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//delete a mutex</span>
</code></pre><h5 id="pthread-mutex-init"><a class="anchor hidden-xs" href="#pthread-mutex-init" title="pthread-mutex-init"><span class="octicon octicon-link"></span></a>pthread_mutex_init()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_init</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex, <span class="hljs-keyword">const</span> <span class="hljs-keyword">pthread_mutexattr_t</span> *mutexattr)</span></span>;
</code></pre><ul>
<li><code>pthread_mutex_t *mutex</code>：mutex 識別字</li>
<li><code>const pthread_mutexattr_t *mutexattr</code>：mutex 的屬性。設定為 NULL 表示使用預設。</li>
</ul><h5 id="pthread-mutex-lock"><a class="anchor hidden-xs" href="#pthread-mutex-lock" title="pthread-mutex-lock"><span class="octicon octicon-link"></span></a>pthread_mutex_lock()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_lock</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//lock a mutex</span>
</code></pre><h5 id="pthread-mutex-unlock"><a class="anchor hidden-xs" href="#pthread-mutex-unlock" title="pthread-mutex-unlock"><span class="octicon octicon-link"></span></a>pthread_mutex_unlock()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_unlock</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//unlock a mutex</span>
</code></pre><h5 id="pthread-mutex-destroy"><a class="anchor hidden-xs" href="#pthread-mutex-destroy" title="pthread-mutex-destroy"><span class="octicon octicon-link"></span></a>pthread_mutex_destroy()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_destroy</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//delete a mutex</span>
</code></pre><h3 id="3-condition-variables"><a class="anchor hidden-xs" href="#3-condition-variables" title="3-condition-variables"><span class="octicon octicon-link"></span></a>3. Condition Variables</h3><h4 id="pthread-cond-init-condition-attr"><a class="anchor hidden-xs" href="#pthread-cond-init-condition-attr" title="pthread-cond-init-condition-attr"><span class="octicon octicon-link"></span></a>pthread_cond_init (condition, attr)</h4><ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_cond_init.txt" target="_blank">pthread_cond_init</a></li>
</ul><h4 id="pthread-cond-destroy-condition"><a class="anchor hidden-xs" href="#pthread-cond-destroy-condition" title="pthread-cond-destroy-condition"><span class="octicon octicon-link"></span></a>pthread_cond_destroy (condition)</h4><ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_cond_destroy.txt" target="_blank">pthread_cond_destroy</a></li>
</ul><h4 id="pthread-condattr-init-attr"><a class="anchor hidden-xs" href="#pthread-condattr-init-attr" title="pthread-condattr-init-attr"><span class="octicon octicon-link"></span></a>pthread_condattr_init (attr)</h4><ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_condattr_init.txt" target="_blank">pthread_condattr_init</a></li>
</ul><h4 id="pthread-condattr-destroy-attr"><a class="anchor hidden-xs" href="#pthread-condattr-destroy-attr" title="pthread-condattr-destroy-attr"><span class="octicon octicon-link"></span></a>pthread_condattr_destroy (attr)</h4><ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_condattr_destroy.txt" target="_blank">pthread_condattr_destroy</a></li>
</ul><h3 id="4-barrier"><a class="anchor hidden-xs" href="#4-barrier" title="4-barrier"><span class="octicon octicon-link"></span></a>4. Barrier</h3><ul>
<li><a href="http://angelonotes.blogspot.tw/2012/02/pthreadbarrier.html" target="_blank">Using barriers in pthreads</a></li>
<li><a href="http://angelonotes.blogspot.tw/2012/02/pthreadbarrier.html" target="_blank">pthread︰barrier</a></li>
</ul><h3 id="二-producer-consumer-problem"><a class="anchor hidden-xs" href="#二-producer-consumer-problem" title="二-producer-consumer-problem"><span class="octicon octicon-link"></span></a>(二) Producer-Consumer Problem</h3><h4 id="1-producer"><a class="anchor hidden-xs" href="#1-producer" title="1-producer"><span class="octicon octicon-link"></span></a>1. Producer</h4><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span></div><div class="code">item next produced;
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">/* produce an item in next produced */</span>
    
    <span class="hljs-keyword">while</span> (((<span class="hljs-keyword">in</span> + <span class="hljs-number">1</span>) % BUFFER SIZE) == <span class="hljs-keyword">out</span>)
    ; <span class="hljs-comment">/* do nothing */</span>
        
    buffer[<span class="hljs-keyword">in</span>] = next produced;
    <span class="hljs-keyword">in</span> = (<span class="hljs-keyword">in</span> + <span class="hljs-number">1</span>) % BUFFER SIZE;
}
</div></div></code></pre><h4 id="2-consumer"><a class="anchor hidden-xs" href="#2-consumer" title="2-consumer"><span class="octicon octicon-link"></span></a>2. Consumer</h4><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span></div><div class="code">item next consumed;
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">in</span> == <span class="hljs-keyword">out</span>)
    ; <span class="hljs-comment">/* do nothing */</span>
    
    next consumed = buffer[<span class="hljs-keyword">out</span>];
    <span class="hljs-keyword">out</span> = (<span class="hljs-keyword">out</span> + <span class="hljs-number">1</span>) % BUFFER SIZE;
    
    <span class="hljs-comment">/* consume the item in next consumed */</span>
}
</div></div></code></pre><h3 id="課程作業2"><a class="anchor hidden-xs" href="#課程作業2" title="課程作業2"><span class="octicon octicon-link"></span></a>課程作業</h3><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span>
<span data-linenumber="72"></span>
<span data-linenumber="73"></span>
<span data-linenumber="74"></span>
<span data-linenumber="75"></span>
<span data-linenumber="76"></span>
<span data-linenumber="77"></span>
<span data-linenumber="78"></span>
<span data-linenumber="79"></span>
<span data-linenumber="80"></span>
<span data-linenumber="81"></span>
<span data-linenumber="82"></span>
<span data-linenumber="83"></span>
<span data-linenumber="84"></span>
<span data-linenumber="85"></span>
<span data-linenumber="86"></span>
<span data-linenumber="87"></span>
<span data-linenumber="88"></span>
<span data-linenumber="89"></span>
<span data-linenumber="90"></span></div><div class="code"><span class="hljs-comment">/*
 *  Solution to Producer Consumer Problem
 *  Using Ptheads, a mutex and condition variables
 *  From Tanenbaum, Modern Operating Systems, 3rd Ed.
 */</span>

<span class="hljs-comment">/*
    In this version the buffer is a single number.
    The producer is putting numbers into the shared buffer
    (in this case sequentially)
    And the consumer is taking them out.
    If the buffer contains zero, that indicates that the buffer is empty.
    Any other value is valid.
*/</span>

<span class="hljs-meta">#include <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#include <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-meta">#define MAX 10//000000			/* Numbers to produce */</span>
<span class="hljs-meta">#define BUFFER_SIZE 5</span>

pthread_mutex_t the_mutex;
pthread_cond_t condc, condp;
<span class="hljs-keyword">int</span> buffer[BUFFER_SIZE];
<span class="hljs-keyword">int</span> <span class="hljs-keyword">in</span> = <span class="hljs-number">0</span>, <span class="hljs-keyword">out</span> = <span class="hljs-number">0</span>;

<span class="hljs-keyword">void</span> *producer(<span class="hljs-keyword">void</span> *ptr) {
    <span class="hljs-keyword">int</span> i;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX; i++) {
        pthread_mutex_lock(&amp;the_mutex);	<span class="hljs-comment">/* protect buffer */</span>
        
        <span class="hljs-keyword">while</span> (((<span class="hljs-keyword">in</span> + <span class="hljs-number">1</span>) % BUFFER_SIZE) == <span class="hljs-keyword">out</span>)		       <span class="hljs-comment">/* If there is something in the buffer then wait */</span>
            pthread_cond_wait(&amp;condp, &amp;the_mutex);

        buffer[<span class="hljs-keyword">in</span>] = i;
        printf(<span class="hljs-string">"ProBuffer[%d]：%2d\n"</span>, <span class="hljs-keyword">in</span>, buffer[<span class="hljs-keyword">in</span>]);
        <span class="hljs-keyword">in</span> = (<span class="hljs-keyword">in</span> + <span class="hljs-number">1</span>) % BUFFER_SIZE;
   
        pthread_cond_signal(&amp;condc);	<span class="hljs-comment">/* wake up consumer */</span>
        pthread_mutex_unlock(&amp;the_mutex);	<span class="hljs-comment">/* release the buffer */</span>
    }

    pthread_exit(<span class="hljs-number">0</span>);
}


<span class="hljs-keyword">void</span> *consumer(<span class="hljs-keyword">void</span> *ptr) {
    <span class="hljs-keyword">int</span> i;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MAX; i++) {
        pthread_mutex_lock(&amp;the_mutex);	<span class="hljs-comment">/* protect buffer */</span>
    
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">in</span> == <span class="hljs-keyword">out</span>)			<span class="hljs-comment">/* If there is nothing in the buffer then wait */</span>
            pthread_cond_wait(&amp;condc, &amp;the_mutex);
    
        printf(<span class="hljs-string">"ConBuffer[%d]：%2d\n"</span>, <span class="hljs-keyword">out</span>, buffer[<span class="hljs-keyword">out</span>]);
        <span class="hljs-keyword">out</span> = (<span class="hljs-keyword">out</span> + <span class="hljs-number">1</span>) % BUFFER_SIZE;
        buffer[<span class="hljs-keyword">out</span>] = <span class="hljs-number">0</span>;
    
        pthread_cond_signal(&amp;condp);	<span class="hljs-comment">/* wake up consumer */</span>
        pthread_mutex_unlock(&amp;the_mutex);	<span class="hljs-comment">/* release the buffer */</span>
    }
    pthread_exit(<span class="hljs-number">0</span>);
}

<span class="hljs-keyword">int</span> main(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv) {
    pthread_t pro, con;

    <span class="hljs-comment">// Initialize the mutex and condition variables</span>
    <span class="hljs-comment">/* What's the NULL for ??? */</span>
    pthread_mutex_init(&amp;the_mutex, <span class="hljs-literal">NULL</span>);	
    pthread_cond_init(&amp;condc, <span class="hljs-literal">NULL</span>);		<span class="hljs-comment">/* Initialize consumer condition variable */</span>
    pthread_cond_init(&amp;condp, <span class="hljs-literal">NULL</span>);		<span class="hljs-comment">/* Initialize producer condition variable */</span>

    <span class="hljs-comment">// Create the threads</span>
    pthread_create(&amp;con, <span class="hljs-literal">NULL</span>, consumer, <span class="hljs-literal">NULL</span>);
    pthread_create(&amp;pro, <span class="hljs-literal">NULL</span>, producer, <span class="hljs-literal">NULL</span>);

    <span class="hljs-comment">// Wait for the threads to finish</span>
    <span class="hljs-comment">// Otherwise main might run to the end</span>
    <span class="hljs-comment">// and kill the entire process when it exits.</span>
    pthread_join(con, <span class="hljs-literal">NULL</span>);
    pthread_join(pro, <span class="hljs-literal">NULL</span>);

    <span class="hljs-comment">// Cleanup -- would happen automatically at end of program</span>
    pthread_mutex_destroy(&amp;the_mutex);	<span class="hljs-comment">/* Free up the_mutex */</span>
    pthread_cond_destroy(&amp;condc);		<span class="hljs-comment">/* Free up consumer condition variable */</span>
    pthread_cond_destroy(&amp;condp);		<span class="hljs-comment">/* Free up producer condition variable */</span>
}
</div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/6miNt1O.jpg" alt=""></li>
</ul><h2 id="20170406"><a class="anchor hidden-xs" href="#20170406" title="20170406"><span class="octicon octicon-link"></span></a>20170406</h2><ul>
<li>
<p>課程簡報</p>
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170406/ch04.pdf" target="_blank">Chapter 4: Mutithread Programming</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170406/ch05.pdf" target="_blank">Chapter 5: Process Scheduling</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170406/Socket_Programming.pdf" target="_blank">Socket_Programming</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170406/Linux-Programming_Socket_1.pdf" target="_blank">Linux-Programming_Socket_1</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170406/Linux-Programming_Socket_2.pdf" target="_blank">Linux-Programming_Socket_2</a></li>
</ul>
</li>
<li>
<p>參考資料</p>
<ul>
<li><a href="https://goo.gl/Rs9JgE" target="_blank">簡易的程式平行化方法－OpenMP（一）簡介</a></li>
<li><a href="https://hackmd.io/s/Skh_AaVix" target="_blank">Toward Concurrency</a></li>
</ul>
</li>
</ul><h3 id="一-thread-pools"><a class="anchor hidden-xs" href="#一-thread-pools" title="一-thread-pools"><span class="octicon octicon-link"></span></a>(一) Thread Pools</h3><ul>
<li>Create a number of threads in a pool where they await work.</li>
<li>Advantages:
<ul>
<li>Usually slightly faster to service a request with an existing thread than create a new thread.</li>
<li>Allows the number of threads in the application(s) to be bound to the size of the pool.</li>
<li>Separating task to be performed from mechanics of creating task allows different strategies for running task.
<ul>
<li>Tasks could be scheduled to run periodically.</li>
</ul>
</li>
</ul>
</li>
</ul><h3 id="二-openmp"><a class="anchor hidden-xs" href="#二-openmp" title="二-openmp"><span class="octicon octicon-link"></span></a>(二) OpenMP</h3><ul>
<li>Set of compiler directives and an API for C, C++, FORTRAN.</li>
<li>Provides support for parallel programming in shared-memory environments.</li>
<li>Identifies <code>parallel regions</code> – blocks of code that can run in parallel.</li>
</ul><h4 id="pragma-omp-parallel"><a class="anchor hidden-xs" href="#pragma-omp-parallel" title="pragma-omp-parallel"><span class="octicon octicon-link"></span></a><code>#pragma omp parallel</code></h4><ul>
<li>Create as many threads as there are cores.</li>
</ul><pre><code class="c hljs"><span class="hljs-comment">#pragma omp parallel for</span>
<span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; N; i++) {
    c[i] = a[i] + b[i];
}
<span class="hljs-regexp">//</span> Run <span class="hljs-keyword">for</span> <span class="hljs-keyword">loop</span> <span class="hljs-keyword">in</span> parallel
</code></pre><h4 id="example"><a class="anchor hidden-xs" href="#example" title="example"><span class="octicon octicon-link"></span></a>Example</h4><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span></div><div class="code"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;omp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span> </span>{
    <span class="hljs-comment">/* sequential code */</span>
    
    <span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> omp parallel</span>
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"I am a parallel region."</span>);
    }

    <span class="hljs-comment">/* sequential code */</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></div></code></pre><h3 id="三-threading-issues"><a class="anchor hidden-xs" href="#三-threading-issues" title="三-threading-issues"><span class="octicon octicon-link"></span></a>(三) Threading Issues</h3><h4 id="1-semantics-of-fork-and-exec"><a class="anchor hidden-xs" href="#1-semantics-of-fork-and-exec" title="1-semantics-of-fork-and-exec"><span class="octicon octicon-link"></span></a>1. Semantics of fork() and exec()</h4><ul>
<li>Does fork() duplicate only the calling thread or all threads?
<ul>
<li>Some UNIXes have two versions of fork</li>
</ul>
</li>
<li>Exec() usually works as normal – replace the running process including all threads.</li>
</ul><h4 id="2-signal-handling"><a class="anchor hidden-xs" href="#2-signal-handling" title="2-signal-handling"><span class="octicon octicon-link"></span></a>2. Signal Handling</h4><ul>
<li>Signals are used in UNIX systems to notify a process that a particular event has occurred.</li>
<li>A <code>signal handler</code> is used to process signals.
<ol>
<li>Signal is generated by particular event</li>
<li>Signal is delivered to a process</li>
<li>Signal is handled by one of two signal handlers:
<ol>
<li>default</li>
<li>user-defined</li>
</ol>
</li>
</ol>
</li>
<li>Every signal has <code>default handler</code> that kernel runs when handling signal.
<ul>
<li>User-defined signal handler can override default.</li>
<li>For single-threaded, signal delivered to process.</li>
</ul>
</li>
<li>Where should a signal be delivered for multi-threaded?
<ul>
<li>Deliver the signal to the thread to which the signal applies.</li>
<li>Deliver the signal to every thread in the process.</li>
<li>Deliver the signal to certain threads in the process.</li>
<li>Assign a specific thread to receive all signals for the process.</li>
</ul>
</li>
</ul><h4 id="3-thread-cancellation"><a class="anchor hidden-xs" href="#3-thread-cancellation" title="3-thread-cancellation"><span class="octicon octicon-link"></span></a>3. Thread Cancellation</h4><ul>
<li>
<p>Terminating a thread before it has finished.</p>
</li>
<li>
<p>Thread to be canceled is target thread.</p>
</li>
<li>
<p>Two general approaches:</p>
<ul>
<li><code>Asynchronous cancellation</code> terminates the target thread immediately.</li>
<li><code>Deferred cancellation</code> allows the target thread to periodically check if it should be cancelled.</li>
</ul>
</li>
<li>
<p>Pthread code to create and cancel a thread:</p>
</li>
</ul><pre><code class="c hljs"><span class="hljs-keyword">pthread_t</span> tid;

<span class="hljs-comment">/* Create the thread */</span>
pthread_create(&amp;tid, <span class="hljs-number">0</span>, worker, <span class="hljs-literal">NULL</span>);

...

<span class="hljs-comment">/* Cancel the thread */</span>
pthread_cancel(tid);
</code></pre><h4 id="4-thread-local-storage"><a class="anchor hidden-xs" href="#4-thread-local-storage" title="4-thread-local-storage"><span class="octicon octicon-link"></span></a>4. Thread-Local Storage</h4><ul>
<li><code>Thread-local storage (TLS)</code> allows each thread to have its own copy of data.</li>
<li>Useful when you do not have control over the thread creation process (i.e., when using a thread).</li>
<li>Different from local variables
<ul>
<li>Local variables visible only during single function invocation.</li>
<li>TLS visible across function invocations</li>
</ul>
</li>
<li>Similar to static data
<ul>
<li>TLS is unique to each thread.</li>
</ul>
</li>
</ul><h4 id="5-scheduler-activations"><a class="anchor hidden-xs" href="#5-scheduler-activations" title="5-scheduler-activations"><span class="octicon octicon-link"></span></a>5. Scheduler Activations</h4><ul>
<li>Both M:M and Two-level models require communication to maintain the appropriate number of kernel threads allocated to the application.</li>
<li>Typically use an intermediate data structure between user and kernel threads – <code>lightweight process (LWP)</code><br>
<img src="http://i.imgur.com/N1XOvDn.jpg" alt="">
<ul>
<li>Appears to be a virtual processor on which process can schedule user thread to run</li>
<li>Each LWP attached to kernel thread.</li>
<li>How many LWPs to create?</li>
</ul>
</li>
<li>Scheduler activations provide <code>upcalls</code> - a communication mechanism from the kernel to the <code>upcall handler</code> in the thread library.</li>
<li>This communication allows an application to maintain the correct number kernel threads.</li>
</ul><h3 id="四-thread-scheduling"><a class="anchor hidden-xs" href="#四-thread-scheduling" title="四-thread-scheduling"><span class="octicon octicon-link"></span></a>(四) Thread Scheduling</h3><ul>
<li>Distinction between user-level and kernel-level threads.</li>
<li>When threads supported, threads scheduled, not processes.</li>
<li>Many-to-one and many-to-many models, thread library schedules user-level threads to run on LWP.
<ul>
<li>Known as <code>process-contention scope (PCS)</code> since scheduling competition is within the process.</li>
<li>Typically done via priority set by programmer.</li>
</ul>
</li>
<li>Kernel thread scheduled onto available CPU is <code>system-contention scope (SCS)</code> – competition among all threads in system.</li>
</ul><h3 id="五-pthread-scheduling"><a class="anchor hidden-xs" href="#五-pthread-scheduling" title="五-pthread-scheduling"><span class="octicon octicon-link"></span></a>(五) Pthread Scheduling</h3><ul>
<li>API allows specifying either PCS or SCS during thread creation.
<ul>
<li><code>PTHREAD_SCOPE_PROCESS</code> schedules threads using PCS scheduling.</li>
<li><code>PTHREAD_SCOPE_SYSTEM</code> schedules threads using SCS scheduling.</li>
</ul>
</li>
<li>Can be limited by OS – Linux and Mac OS X only allow <code>PTHREAD_SCOPE_SYSTEM</code>.</li>
</ul><h3 id="六-multiple-processor-scheduling"><a class="anchor hidden-xs" href="#六-multiple-processor-scheduling" title="六-multiple-processor-scheduling"><span class="octicon octicon-link"></span></a>(六) Multiple-Processor Scheduling</h3><p><img src="https://i.imgur.com/0nuvCJs.jpg" alt=""></p><ul>
<li>
<p>CPU scheduling more complex when multiple CPUs are available.</p>
</li>
<li>
<p><code>Homogeneous processors</code> within a multiprocessor.</p>
</li>
<li>
<p><code>Asymmetric multiprocessing</code> – only one processor accesses the system data structures, alleviating the need for data sharing.</p>
</li>
<li>
<p><code>Symmetric multiprocessing (SMP)</code> – each processor is self-scheduling, all processes in common ready queue, or each has its own private queue of ready processes.</p>
<ul>
<li>Currently, most common</li>
</ul>
</li>
<li>
<p><code>Processor affinity</code> – process has affinity for processor on which it is currently running.</p>
<ul>
<li>soft affinity</li>
<li>hard affinity</li>
<li>Variations including <code>processor sets</code></li>
</ul>
</li>
<li>
<p><strong>Load Balancing</strong> - attempts to keep workload evenly distributed.</p>
<ul>
<li><code>Push migration</code> – periodic task checks load on each processor, and if found pushes task from overloaded CPU to other CPUs.</li>
<li><code>Pull migration</code> – idle processors pulls waiting task from busy processor.</li>
</ul>
</li>
</ul><h3 id="七-socket-message-passing"><a class="anchor hidden-xs" href="#七-socket-message-passing" title="七-socket-message-passing"><span class="octicon octicon-link"></span></a>(七) Socket - Message Passing</h3><h4 id="1-what-is-a-socket？"><a class="anchor hidden-xs" href="#1-what-is-a-socket？" title="1-what-is-a-socket？"><span class="octicon octicon-link"></span></a>1. What is a socket？</h4><ul>
<li>
<p>An interface between application and network.</p>
<ul>
<li>The application creates a socket.</li>
<li>The socket type dictates the style of communication.
<ul>
<li><code>reliable</code> vs. <code>best effort</code></li>
<li><code>connection-oriented</code> vs. <code>connectionless</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Once configured the application can</p>
<ul>
<li>pass data to the socket for network transmission</li>
<li>receive data from the socket (transmitted through the network by some other host)</li>
</ul>
</li>
</ul><h4 id="2-two-essential-types-of-sockets"><a class="anchor hidden-xs" href="#2-two-essential-types-of-sockets" title="2-two-essential-types-of-sockets"><span class="octicon octicon-link"></span></a>2. Two essential types of sockets</h4><p><img src="https://i.imgur.com/HMu29e3.jpg" alt=""></p><h4 id="1-sock-stream"><a class="anchor hidden-xs" href="#1-sock-stream" title="1-sock-stream"><span class="octicon octicon-link"></span></a>(1) SOCK_STREAM</h4><ul>
<li>a.k.a. TCP</li>
<li>reliable delivery</li>
<li>in-order guaranteed</li>
<li>connection-oriented</li>
<li>bidirectional</li>
</ul><h4 id="2-sock-dgram"><a class="anchor hidden-xs" href="#2-sock-dgram" title="2-sock-dgram"><span class="octicon octicon-link"></span></a>(2) SOCK_DGRAM</h4><ul>
<li>a.k.a. UDP</li>
<li>unreliable delivery</li>
<li>no order guarantees</li>
<li>no notion of “connection” – app indicates dest. for each packet</li>
<li>can send or receive</li>
</ul><h4 id="3-connection-setup"><a class="anchor hidden-xs" href="#3-connection-setup" title="3-connection-setup"><span class="octicon octicon-link"></span></a>3. Connection setup</h4><p><img src="https://i.imgur.com/Je3VTRz.png" alt=""></p><h3 id="課程作業3"><a class="anchor hidden-xs" href="#課程作業3" title="課程作業3"><span class="octicon octicon-link"></span></a>課程作業</h3><ul>
<li>
<p>自 Client 端輸入一整數，將數字傳至 Server 端判斷是否為質數，再將結果回傳自 Client。</p>
</li>
<li>
<p><code>client</code> 部份</p>
</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span></div><div class="code"><span class="hljs-comment">/*  Make the necessary includes and set up the variables.  */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> sockfd;
    <span class="hljs-keyword">int</span> len;
    <span class="hljs-keyword">struct</span> sockaddr_in address;
    <span class="hljs-keyword">int</span> in;     <span class="hljs-comment">// integer</span>
    <span class="hljs-keyword">int</span> result;
    <span class="hljs-comment">// char ch = 'A';</span>
  

<span class="hljs-comment">/*  Create a socket for the client.  */</span>

    sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-comment">/*  Name the socket, as agreed with the server.  */</span>

    address.sin_family = AF_INET;
    address.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);
    address.sin_port = <span class="hljs-number">9453</span>;
    len = <span class="hljs-keyword">sizeof</span>(address);

<span class="hljs-comment">/*  Now connect our socket to the server's socket.  */</span>

    result = connect(sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;address, len);

    <span class="hljs-keyword">if</span>(result == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"oops: Client"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

<span class="hljs-comment">/*  We can now read/write via sockfd.  */</span>

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please key in an integer："</span>);
    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, &amp;in);

    write(sockfd, &amp;in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
    read(sockfd, &amp;in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));

    <span class="hljs-keyword">if</span> (in == <span class="hljs-number">1</span>)
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Result from Server：數字'是質數'\n"</span>);
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"result from server：數字'不是質數'\n"</span>);

    close(sockfd);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</div></div></code></pre><ul>
<li><code>server</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span></div><div class="code"><span class="hljs-comment">/*  Make the necessary includes and set up the variables.  */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> server_sockfd, client_sockfd;
    <span class="hljs-keyword">int</span> server_len, client_len;
    <span class="hljs-keyword">struct</span> sockaddr_in server_address;
    <span class="hljs-keyword">struct</span> sockaddr_in client_address;

<span class="hljs-comment">/*  Create an unnamed socket for the server.  */</span>

    server_sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-comment">/*  Name the socket.  */</span>

    server_address.sin_family = AF_INET;
    server_address.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);
    server_address.sin_port = <span class="hljs-number">9453</span>;
    server_len = <span class="hljs-keyword">sizeof</span>(server_address);
    bind(server_sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;server_address, server_len);

<span class="hljs-comment">/*  Create a connection queue and wait for clients.  */</span>

    listen(server_sockfd, <span class="hljs-number">5</span>);
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, count = <span class="hljs-number">0</span>;   <span class="hljs-comment">// Set loop</span>
        <span class="hljs-keyword">char</span> in;

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Server waiting...\n"</span>);

<span class="hljs-comment">/*  Accept a connection.  */</span>

        client_len = <span class="hljs-keyword">sizeof</span>(client_address);
        client_sockfd = accept(server_sockfd, 
            (<span class="hljs-keyword">struct</span> sockaddr *)&amp;client_address, &amp;client_len);

<span class="hljs-comment">/*  We can now read/write to client on client_sockfd.  */</span>

        read(client_sockfd, &amp;in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Input from Client = %d\n"</span>,in);

        <span class="hljs-keyword">for</span> (i = in; i &gt; <span class="hljs-number">0</span>; i--)
            <span class="hljs-keyword">if</span> (in % i == <span class="hljs-number">0</span>)
                count++;
        
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">2</span>)
            in = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">2</span>)
            in = <span class="hljs-number">1</span>;
     
        write(client_sockfd, &amp;in, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
        close(client_sockfd);
    }
}
</div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/vCZaRoc.jpg" alt=""></li>
</ul><h2 id="20170413"><a class="anchor hidden-xs" href="#20170413" title="20170413"><span class="octicon octicon-link"></span></a>20170413</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170413/ch03.pdf" target="_blank">Chapter 3: Process Concept</a></li>
</ul>
</li>
</ul><h3 id="一-direct-communication"><a class="anchor hidden-xs" href="#一-direct-communication" title="一-direct-communication"><span class="octicon octicon-link"></span></a>(一) Direct Communication</h3><ul>
<li>
<p>Processes must name each other explicitly：</p>
<ul>
<li>send(P, message) – send a message to process P</li>
<li>receive(Q, message) – receive a message from process Q</li>
</ul>
</li>
<li>
<p>Properties of communication link</p>
<ul>
<li>Links are established automatically</li>
<li>A link is associated with exactly one pair of communicating processes</li>
<li>Between each pair there exists exactly one link</li>
<li>The link may be unidirectional, but is usually bi-directional</li>
</ul>
</li>
</ul><h3 id="二-indirect-communication"><a class="anchor hidden-xs" href="#二-indirect-communication" title="二-indirect-communication"><span class="octicon octicon-link"></span></a>(二) Indirect Communication</h3><ul>
<li>
<p>Messages are directed and received from mailboxes (also referred to as ports)</p>
<ul>
<li>Each mailbox has a unique id</li>
<li>Processes can communicate only if they share a mailbox</li>
</ul>
</li>
<li>
<p>Properties of communication link</p>
<ul>
<li>Link established only if processes share a common mailbox</li>
<li>A link may be associated with many processes</li>
<li>Each pair of processes may share several communication links</li>
<li>Link may be unidirectional or bi-directional</li>
</ul>
</li>
<li>
<p>Operations</p>
<ul>
<li>create a new mailbox</li>
<li>send and receive messages through mailbox</li>
<li>destroy a mailbox</li>
</ul>
</li>
<li>
<p>Primitives are defined as：</p>
<ul>
<li>send(A, message) – send a message to mailbox A</li>
<li>receive(A, message) – receive a message from mailbox A</li>
</ul>
</li>
<li>
<p>Mailbox sharing</p>
<ul>
<li>Who gets the message？
<ul>
<li>P 1 , P 2 , and P 3 share mailbox A</li>
<li>P 1 , sends; P 2 and P 3 receive</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Solutions</p>
<ul>
<li>Allow a link to be associated with at most two processes.</li>
<li>Allow only one process at a time to execute a receive operation.</li>
<li>Allow the system to select arbitrarily the receiver. Sender is notified who the receiver was.</li>
</ul>
</li>
</ul><h3 id="三-synchronization"><a class="anchor hidden-xs" href="#三-synchronization" title="三-synchronization"><span class="octicon octicon-link"></span></a>(三) Synchronization</h3><ul>
<li>
<p>Message passing may be either blocking or non-blocking</p>
</li>
<li>
<p><strong>Blocking</strong> is considered <strong>synchronous</strong></p>
<ul>
<li><code>Blocking send</code> has the sender block until the message is received</li>
<li><code>Blocking receive</code> has the receiver block until a message is available</li>
</ul>
</li>
<li>
<p><strong>Non-blocking</strong> is considered <strong>asynchronous</strong></p>
<ul>
<li><code>Non-blocking send</code> has the sender send the message and continue</li>
<li><code>Non-blocking receive</code> has the receiver receive a valid message or null</li>
</ul>
</li>
<li>
<p>Different combinations possible</p>
<ul>
<li>If both send and receive are blocking, we have a rendezvous</li>
</ul>
</li>
<li>
<p>Producer-consumer becomes trivial</p>
</li>
</ul><h3 id="四-buffering"><a class="anchor hidden-xs" href="#四-buffering" title="四-buffering"><span class="octicon octicon-link"></span></a>(四) Buffering</h3><ul>
<li>Queue of messages attached to the link; implemented in one of three ways
<ol>
<li>Zero capacity – 0 messages<br>
Sender must wait for receiver (rendezvous)</li>
<li>Bounded capacity – finite length of n messages<br>
Sender must wait if link full</li>
<li>Unbounded capacity – infinite length<br>
Sender never waits</li>
</ol>
</li>
</ul><h3 id="examples-of-ipc-systems"><a class="anchor hidden-xs" href="#examples-of-ipc-systems" title="examples-of-ipc-systems"><span class="octicon octicon-link"></span></a>Examples of IPC Systems</h3><h4 id="1-posix"><a class="anchor hidden-xs" href="#1-posix" title="1-posix"><span class="octicon octicon-link"></span></a>1. POSIX</h4><ul>
<li>POSIX Shared Memory
<ul>
<li>Process first creates shared memory segment：<code>shm_fd = shm_open(name, O CREAT | O RDRW, 0666);</code></li>
<li>Also used to open an existing segment to share it</li>
<li>Set the size of the object：<code>ftruncate(shm fd, 4096);</code></li>
<li>Now the process could write to the shared memory：<code>sprintf(shared memory, "Writing to shared memory");</code></li>
</ul>
</li>
</ul><h4 id="2-mach"><a class="anchor hidden-xs" href="#2-mach" title="2-mach"><span class="octicon octicon-link"></span></a>2. Mach</h4><ul>
<li>Mach communication is message based
<ul>
<li>Even system calls are messages</li>
<li>Each task gets two mailboxes at creation- Kernel and Notify</li>
<li>Only three system calls needed for message transfer：<code>msg_send()</code>, <code>msg_receive()</code>, <code>msg_rpc()</code></li>
<li>Mailboxes needed for commuication, created via：<code>port_allocate()</code></li>
<li>Send and receive are flexible, for example four options if mailbox full：
<ul>
<li>Wait indefinitely</li>
<li>Wait at most n milliseconds</li>
<li>Return immediately</li>
<li>Temporarily cache a message</li>
</ul>
</li>
</ul>
</li>
</ul><h4 id="3-windows"><a class="anchor hidden-xs" href="#3-windows" title="3-windows"><span class="octicon octicon-link"></span></a>3. Windows</h4><ul>
<li>Message-passing centric via <code>advanced local procedure call (LPC)</code> facility
<ul>
<li>Only works between processes on the same system</li>
<li>Uses ports (like mailboxes) to establish and maintain communication channels</li>
<li>Communication works as follows：
<ul>
<li>The client opens a handle to the subsystem’s <code>connection port</code> object.</li>
<li>The client sends a connection request.</li>
<li>The server creates two private <code>communication ports</code> and returns the handle to one of them to the client.</li>
<li>The client and server use the corresponding port handle to send messages or callbacks and to listen for replies.</li>
</ul>
</li>
</ul>
</li>
</ul><h3 id="五-communications-in-client-server-systems"><a class="anchor hidden-xs" href="#五-communications-in-client-server-systems" title="五-communications-in-client-server-systems"><span class="octicon octicon-link"></span></a>(五) Communications in Client-Server Systems</h3><h4 id="1-sockets"><a class="anchor hidden-xs" href="#1-sockets" title="1-sockets"><span class="octicon octicon-link"></span></a>1. Sockets</h4><ul>
<li>A socket is defined as an endpoint for communication</li>
<li>Concatenation of <code>IP address</code> and <code>port</code> – a number included at start of message packet to differentiate network services on a host
<ul>
<li>The socket 161.25.19.8:1625 refers to port 1625 on host 161.25.19.8</li>
</ul>
</li>
<li>Communication consists between a pair of sockets</li>
<li>All ports below 1024 are well known, used for standard services</li>
<li>Special IP address <code>127.0.0.1 (loopback)</code> to refer to system on which process is running</li>
</ul><h4 id="2-remote-procedure-calls"><a class="anchor hidden-xs" href="#2-remote-procedure-calls" title="2-remote-procedure-calls"><span class="octicon octicon-link"></span></a>2. Remote Procedure Calls</h4><ul>
<li>Remote procedure call (RPC) abstracts procedure calls between processes on networked systems
<ul>
<li>Again uses ports for service differentiation</li>
</ul>
</li>
<li><strong>Stubs</strong> – client-side proxy for the actual procedure on the server</li>
<li>The client-side stub locates the server and <strong>marshalls</strong> the parameters</li>
<li>The server-side stub receives this message, unpacks the marshalled parameters, and performs the procedure on the server</li>
<li>On Windows, stub code compile from specification written in <strong>Microsoft Interface Definition Language (MIDL)</strong></li>
<li>Data representation handled via <strong>External Data Representation (XDL)</strong> format to account for different architectures
<ul>
<li><code>Big-endian</code> and <code>little-endian</code></li>
</ul>
</li>
<li>Remote communication has more failure scenarios than local
<ul>
<li>Messages can be delivered <code>exactly once</code> rather than <code>at most once</code></li>
</ul>
</li>
<li>OS typically provides a rendezvous (or <strong>matchmaker</strong>) service to connect client and server</li>
</ul><p><img src="https://i.imgur.com/fvjj3rR.jpg" alt=""></p><h4 id="3-pipes"><a class="anchor hidden-xs" href="#3-pipes" title="3-pipes"><span class="octicon octicon-link"></span></a>3. Pipes</h4><ul>
<li>Acts as a conduit allowing two processes to communicate</li>
<li><strong>Issues</strong>
<ul>
<li>Is communication unidirectional or bidirectional?</li>
<li>In the case of two-way communication, is it half or full-duplex?</li>
<li>Must there exist a relationship (i.e. parent-child) between the communicating processes?</li>
<li>Can the pipes be used over a network?</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/W3b5HkN.jpg" alt=""><br>
<img src="https://i.imgur.com/c18pKq0.jpg" alt=""></p><h3 id="課堂作業"><a class="anchor hidden-xs" href="#課堂作業" title="課堂作業"><span class="octicon octicon-link"></span></a>課堂作業</h3><ul>
<li><code>client</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span></div><div class="code"><span class="hljs-comment">/* vim: ts=4 sw=4 et
*/</span>
<span class="hljs-comment">/* The second program is the producer and allows us to enter data for consumers.
 It's very similar to shm1.c and looks like this. */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/shm.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"shm_com.h"</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> running = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">void</span> *shared_memory = (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>;
    <span class="hljs-keyword">struct</span> shared_use_st *shared_stuff;
    <span class="hljs-keyword">char</span> buffer[BUFSIZ];
    <span class="hljs-keyword">int</span> shmid;
    <span class="hljs-keyword">int</span> rand_arr[<span class="hljs-number">10</span>];

    shmid = shmget((<span class="hljs-keyword">key_t</span>)<span class="hljs-number">1234</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> shared_use_st), <span class="hljs-number">0666</span> | IPC_CREAT);
	
    <span class="hljs-keyword">if</span> (shmid == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmget failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    shared_memory = shmat(shmid, (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shared_memory == (<span class="hljs-keyword">void</span> *)<span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmat failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Memory attached at %X\n"</span>, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)(<span class="hljs-keyword">long</span>)shared_memory);

    shared_stuff = (<span class="hljs-keyword">struct</span> shared_use_st *)shared_memory;

    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">while</span> (shared_stuff-&gt;written_by_you == <span class="hljs-number">1</span>) {
            sleep(<span class="hljs-number">1</span>);            
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"waiting for client...\n"</span>);
        }
        
        <span class="hljs-comment">/*
        printf("\nPress Enter to continue...");
        while (getchar() != '\n');
        // fgets(buffer, BUFSIZ, stdin);
        */</span>

        srand((<span class="hljs-keyword">unsigned</span>)time(<span class="hljs-literal">NULL</span>));
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            rand_arr[i] = rand() % <span class="hljs-number">100</span> + <span class="hljs-number">1</span>;
            shared_stuff-&gt;some_text[i] = rand_arr[i];
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"[%d]%d \t"</span>, i, rand_arr[i]);
        }
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

        <span class="hljs-comment">//  strncpy(shared_stuff-&gt;some_text, &amp;rand_arr, TEXT_SZ);</span>
        shared_stuff-&gt;written_by_you = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">if</span> (shmdt(shared_memory) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmdt failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }
    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}
</div></div></code></pre><ul>
<li><code>server</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span>
<span data-linenumber="72"></span>
<span data-linenumber="73"></span>
<span data-linenumber="74"></span>
<span data-linenumber="75"></span>
<span data-linenumber="76"></span>
<span data-linenumber="77"></span>
<span data-linenumber="78"></span>
<span data-linenumber="79"></span></div><div class="code"><span class="hljs-comment">/* vim: ts=4 sw=4 et
*/</span>
<span class="hljs-comment">/* Our first program is a consumer. After the headers the shared memory segment
 (the size of our shared memory structure) is created with a call to shmget,
 with the IPC_CREAT bit specified. */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/shm.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"shm_com.h"</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> running = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">void</span> *shared_memory = (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>;
    <span class="hljs-keyword">struct</span> shared_use_st *shared_stuff;
    <span class="hljs-keyword">int</span> shmid;

    srand((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)getpid());    

    shmid = shmget((<span class="hljs-keyword">key_t</span>)<span class="hljs-number">1234</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> shared_use_st), <span class="hljs-number">0666</span> | IPC_CREAT);
    
    <span class="hljs-keyword">if</span> (shmid == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmget failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

<span class="hljs-comment">/* We now make the shared memory accessible to the program. */</span>

    shared_memory = shmat(shmid, (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shared_memory == (<span class="hljs-keyword">void</span> *)<span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmat failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Memory attached at %X\n"</span>, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)(<span class="hljs-keyword">long</span>)shared_memory);

<span class="hljs-comment">/* The next portion of the program assigns the shared_memory segment to shared_stuff,
 which then prints out any text in written_by_you. The loop continues until end is found
 in written_by_you. The call to sleep forces the consumer to sit in its critical section,
 which makes the producer wait. */</span>

    shared_stuff = (<span class="hljs-keyword">struct</span> shared_use_st *)shared_memory;
    shared_stuff-&gt;written_by_you = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (shared_stuff-&gt;written_by_you) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nYou wrote:\n"</span>);
            
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"[%d]%d \t"</span>, i, shared_stuff-&gt;some_text[i]);
            }
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);

            sleep(rand() % <span class="hljs-number">4</span>); <span class="hljs-comment">/* make the other process wait for us ! */</span>
            <span class="hljs-comment">// shared_stuff-&gt;written_by_you = 0;</span>
            
        shared_stuff-&gt;written_by_you = <span class="hljs-number">0</span>;
        }
    }
<span class="hljs-comment">/* Lastly, the shared memory is detached and then deleted. */</span>


    <span class="hljs-keyword">if</span> (shmdt(shared_memory) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmdt failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    <span class="hljs-keyword">if</span> (shmctl(shmid, IPC_RMID, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmctl(IPC_RMID) failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}
</div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/rPMcs2j.jpg" alt=""></li>
</ul><h2 id="20170424"><a class="anchor hidden-xs" href="#20170424" title="20170424"><span class="octicon octicon-link"></span></a>20170424</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170427/ch06.pdf" target="_blank">Chapter 6: Process Scheduling</a></li>
</ul>
</li>
</ul><h3 id="race-condition"><a class="anchor hidden-xs" href="#race-condition" title="race-condition"><span class="octicon octicon-link"></span></a>Race Condition</h3><ul>
<li>
<p>Consumer<br>
<img src="https://i.imgur.com/07kx1WD.jpg" alt=""></p>
</li>
<li>
<p>Producer<br>
<img src="https://i.imgur.com/eBPWPyb.jpg" alt=""></p>
</li>
<li>
<p>Race Condition<br>
<img src="https://i.imgur.com/Q5qf9Xi.jpg" alt=""></p>
</li>
</ul><h3 id="一-critical-section-problem"><a class="anchor hidden-xs" href="#一-critical-section-problem" title="一-critical-section-problem"><span class="octicon octicon-link"></span></a>(一) Critical-Section Problem</h3><ul>
<li>General Structure：<br>
<img src="https://i.imgur.com/yVVaplo.jpg" alt=""><br>
<img src="https://i.imgur.com/dWa1ujd.jpg" alt=""></li>
</ul><h3 id="二-solution-to-critical-section-problem"><a class="anchor hidden-xs" href="#二-solution-to-critical-section-problem" title="二-solution-to-critical-section-problem"><span class="octicon octicon-link"></span></a>(二) Solution to Critical-Section Problem</h3><ol>
<li>
<p><strong>Mutual Exclusion</strong> - If process Pi is executing in its critical section, then no other processes can be executing in their critical sections.</p>
</li>
<li>
<p><strong>Progress</strong> - If no process is executing in its critical section and there exist some processes that wish to enter their critical section, then the selection of the processes that will enter the critical section next cannot be postponed indefinitely.</p>
</li>
<li>
<p><strong>Bounded Waiting</strong> - A bound must exist on the number of times that other processes are allowed to enter their critical sections.</p>
<ul>
<li>Assume that each process executes at a nonzero speed.</li>
<li>No assumption concerning relative speed of the n processes.</li>
</ul>
</li>
<li>
<p>Two approaches depending on if kernel is preemptive or non-preemptive.</p>
<ul>
<li><strong>Preemptive</strong> – allows preemption of process when running in kernel mode.</li>
<li><strong>Non-preemptive</strong> – runs until exits kernel mode, blocks, or voluntarily yields CPU.
<ul>
<li>Essentially free of race conditions in kernel mode.</li>
</ul>
</li>
</ul>
</li>
</ol><h3 id="三-peterson’s-solution"><a class="anchor hidden-xs" href="#三-peterson’s-solution" title="三-peterson’s-solution"><span class="octicon octicon-link"></span></a>(三) Peterson’s Solution</h3><ul>
<li>Good algorithmic description of solving the problem.</li>
<li>Two process solution</li>
<li>Assume that the load and store instructions are atomic; that is, cannot be interrupted</li>
<li>The two processes share two variables：
<ul>
<li>int turn;</li>
<li>Boolean flag[2]</li>
</ul>
</li>
<li>The variable turn indicates whose turn it is to enter the critical section</li>
<li>The flag array is used to indicate if a process is ready to enter the critical section.</li>
<li><code>flag[i] = true</code> implies that process Pi is ready!</li>
</ul><p><img src="https://i.imgur.com/VjV8Owl.jpg" alt=""></p><ul>
<li>Provable that
<ol>
<li>Mutual exclusion is preserved.</li>
<li>Progress requirement is satisfied.</li>
<li>Bounded-waiting requirement is met.</li>
</ol>
</li>
</ul><h3 id="四-synchronization-hardware"><a class="anchor hidden-xs" href="#四-synchronization-hardware" title="四-synchronization-hardware"><span class="octicon octicon-link"></span></a>(四) Synchronization Hardware</h3><ul>
<li>Many systems provide hardware support for critical section code.</li>
<li>All solutions below based on idea of <strong>locking</strong>.
<ul>
<li>Protecting critical regions via locks.</li>
</ul>
</li>
<li>Uniprocessors – could disable interrupts
<ul>
<li>Currently running code would execute without preemption.</li>
<li>Generally too inefficient on multiprocessor systems.
<ul>
<li>Operating systems using this not broadly scalable.</li>
</ul>
</li>
</ul>
</li>
<li>Modern machines provide special atomic hardware instructions.
<ul>
<li><strong>Atomic</strong> = non-interruptible
<ul>
<li>Either test memory word and set value.</li>
<li>Or swap contents of two memory words.</li>
</ul>
</li>
</ul>
</li>
</ul><h4 id="1-test-and-set-instruction"><a class="anchor hidden-xs" href="#1-test-and-set-instruction" title="1-test-and-set-instruction"><span class="octicon octicon-link"></span></a>1. test_and_set Instruction</h4><p><img src="https://i.imgur.com/HP1PMeH.jpg" alt=""></p><ul>
<li>Solution using test_and_set()<br>
<img src="https://i.imgur.com/5SMn8ix.jpg" alt=""></li>
<li>Bounded-waiting Mutual Exclusion with test_and_set<br>
<img src="https://i.imgur.com/wGOMFdV.jpg" alt=""></li>
</ul><h4 id="2-compare-and-swap-instruction"><a class="anchor hidden-xs" href="#2-compare-and-swap-instruction" title="2-compare-and-swap-instruction"><span class="octicon octicon-link"></span></a>2. compare_and_swap Instruction</h4><p><img src="https://i.imgur.com/7neEbLe.jpg" alt=""></p><ul>
<li>Solution using compare_and_swap<br>
<img src="https://i.imgur.com/37TZRjA.jpg" alt=""></li>
</ul><h3 id="五-mutex-locks"><a class="anchor hidden-xs" href="#五-mutex-locks" title="五-mutex-locks"><span class="octicon octicon-link"></span></a>(五) Mutex Locks</h3><ul>
<li>Previous solutions are complicated and generally inaccessible to application programmers.</li>
<li>OS designers build software tools to solve critical section problem.</li>
<li>Simplest is mutex lock</li>
<li>Product critical regions with it by first <strong>acquire()</strong> a lock then <strong>release()</strong> it.
<ul>
<li>Boolean variable indicating if lock is available or not</li>
</ul>
</li>
<li>Calls to <strong>acquire()</strong> and <strong>release()</strong> must be atomic.
<ul>
<li>Usually implemented via hardware atomic instructions</li>
</ul>
</li>
<li>But this solution requires <strong>busy waiting</strong>.
<ul>
<li>This lock therefore called a <strong>spinlock</strong></li>
</ul>
</li>
</ul><h4 id="acquire-and-release"><a class="anchor hidden-xs" href="#acquire-and-release" title="acquire-and-release"><span class="octicon octicon-link"></span></a>acquire() and release()</h4><p><img src="https://i.imgur.com/stNKbbR.jpg" alt=""></p><h2 id="20170504"><a class="anchor hidden-xs" href="#20170504" title="20170504"><span class="octicon octicon-link"></span></a>20170504</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170504/ch06.pdf" target="_blank">Chapter 6: Process Scheduling</a></li>
</ul>
</li>
</ul><h3 id="一-semaphore"><a class="anchor hidden-xs" href="#一-semaphore" title="一-semaphore"><span class="octicon octicon-link"></span></a>(一) Semaphore</h3><ul>
<li>Synchronization tool that does not require busy waiting.</li>
<li>Semaphore S – integer variable</li>
<li>Two standard operations modify S: <code>wait()</code> and <code>signal()</code></li>
<li>Less complicated</li>
<li>Can only be accessed via two indivisible (atomic) operations</li>
</ul><pre><code class="c hljs"><span class="hljs-built_in">wait</span>(S)
    <span class="hljs-keyword">while</span> (S &lt;= 0)
        ; //busy <span class="hljs-built_in">wait</span>
    S--;
}
signal(S) {
    S++;
}
</code></pre><h4 id="1-usage"><a class="anchor hidden-xs" href="#1-usage" title="1-usage"><span class="octicon octicon-link"></span></a>1. Usage</h4><ul>
<li><strong>Counting semaphore</strong> – integer value can range over an unrestricted domain</li>
<li><strong>Binary semaphore</strong> – integer value can range only between 0 and 1
<ul>
<li>Then a <code>mutex lock</code></li>
</ul>
</li>
<li>Can implement a counting semaphore S as a binary semaphore</li>
<li>Can solve various synchronization problems</li>
<li>Consider P1 and P2 that require S1 to happen before S2</li>
</ul><pre><code class="c hljs"><span class="hljs-section">P1:</span>
    S1;
    signal(synch);
<span class="hljs-section">P2:</span>
    wait(synch);
    S2;
</code></pre><h4 id="2-implementation"><a class="anchor hidden-xs" href="#2-implementation" title="2-implementation"><span class="octicon octicon-link"></span></a>2. Implementation</h4><h5 id="1-busy-waiting"><a class="anchor hidden-xs" href="#1-busy-waiting" title="1-busy-waiting"><span class="octicon octicon-link"></span></a>(1) Busy waiting</h5><ul>
<li>
<p>Must guarantee that no two processes can execute <code>wait()</code> and <code>signal()</code> on the same semaphore at the same time</p>
</li>
<li>
<p>Thus, implementation becomes the critical section problem where the wait and signal code are placed in the critical section</p>
</li>
<li>
<p>Could now have <strong>busy waiting</strong> in critical section implementation</p>
<ul>
<li>But implementation code is short</li>
<li>Little busy waiting if critical section rarely occupied</li>
</ul>
</li>
<li>
<p>Note that applications may spend lots of time in critical sections and therefore this is not a good solution</p>
</li>
</ul><h5 id="2-with-no-busy-waiting"><a class="anchor hidden-xs" href="#2-with-no-busy-waiting" title="2-with-no-busy-waiting"><span class="octicon octicon-link"></span></a>(2) with no Busy waiting</h5><ul>
<li>With each semaphore there is an associated waiting queue</li>
<li>Each entry in a waiting queue has two data items:
<ul>
<li>value (of type integer)</li>
<li>pointer to next record in the list</li>
</ul>
</li>
<li>Two operations:
<ul>
<li><code>block</code> – place the process invoking the operation on the appropriate waiting queue</li>
<li><code>wakeup</code> – remove one of processes in the waiting queue and place it in the ready queue</li>
</ul>
</li>
</ul><pre><code class="c hljs">typedef <span class="hljs-keyword">struct</span>{
    <span class="hljs-keyword">int</span> <span class="hljs-keyword">value</span>;
    <span class="hljs-keyword">struct</span> process *list;
} semaphore;

wait(semaphore *S) {
    S-&gt;<span class="hljs-keyword">value</span>--;
    <span class="hljs-keyword">if</span> (S-&gt;<span class="hljs-keyword">value</span> &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// add this process to S-&gt;list;</span>
        block();
    }
}

signal(semaphore *S) {
    S-&gt;<span class="hljs-keyword">value</span>++;
    <span class="hljs-keyword">if</span> (S-&gt;<span class="hljs-keyword">value</span> &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// remove a process P from S-&gt;list;</span>
        wakeup(P);
    }
}
</code></pre><h3 id="二-deadlock-and-starvation"><a class="anchor hidden-xs" href="#二-deadlock-and-starvation" title="二-deadlock-and-starvation"><span class="octicon octicon-link"></span></a>(二) Deadlock and Starvation</h3><ul>
<li>
<p><strong>Deadlock</strong> – two or more processes are waiting indefinitely for an event that can be caused by only one of the waiting processes</p>
</li>
<li>
<p>Let S and Q be two semaphores initialized to 1<br>
<img src="https://i.imgur.com/9cUghpD.png" alt=""></p>
</li>
<li>
<p><strong>Starvation</strong> – indefinite blocking</p>
<ul>
<li>A process may never be removed from the semaphore queue in which it is suspended</li>
</ul>
</li>
<li>
<p><strong>Priority Inversion</strong></p>
<ul>
<li>Scheduling problem when lower-priority process holds a lock needed by higher-priority process</li>
<li>Solved via <strong>priority-inheritance protocol</strong></li>
</ul>
</li>
</ul><h3 id="三-classical-problems-of-synchronization"><a class="anchor hidden-xs" href="#三-classical-problems-of-synchronization" title="三-classical-problems-of-synchronization"><span class="octicon octicon-link"></span></a>(三) Classical Problems of Synchronization</h3><h4 id="1-bounded-buffer-problem"><a class="anchor hidden-xs" href="#1-bounded-buffer-problem" title="1-bounded-buffer-problem"><span class="octicon octicon-link"></span></a>1. Bounded-Buffer Problem</h4><ul>
<li>n buffers, each can hold one item
<ul>
<li>Semaphore <code>mutex</code> initialized to the value 1</li>
<li>Semaphore <code>full</code> initialized to the value 0</li>
<li>Semaphore <code>empty</code> initialized to the value n</li>
</ul>
</li>
</ul><h5 id="1-the-structure-of-the-producer-process"><a class="anchor hidden-xs" href="#1-the-structure-of-the-producer-process" title="1-the-structure-of-the-producer-process"><span class="octicon octicon-link"></span></a>(1) The structure of the producer process</h5><pre><code class="c hljs"><span class="hljs-keyword">do</span> {
    ...
    <span class="hljs-comment">/* produce an item in next_produced */</span>
    ...
    
    wait(<span class="hljs-keyword">empty</span>);
    wait(mutex);
    
    ...
    <span class="hljs-comment">/* add next produced to the buffer */</span>
    ...

    signal(mutex);
    signal(full);
} <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>);
</code></pre><h5 id="2-the-structure-of-the-consumer-process"><a class="anchor hidden-xs" href="#2-the-structure-of-the-consumer-process" title="2-the-structure-of-the-consumer-process"><span class="octicon octicon-link"></span></a>(2) The structure of the consumer process</h5><pre><code class="c hljs"><span class="hljs-keyword">do</span> {
    wait(full);
    wait(mutex);

    ...
    <span class="hljs-comment">/* remove an item from buffer to next_consumed */</span>
    ...

    signal(mutex);
    signal(<span class="hljs-keyword">empty</span>);

    ...
    <span class="hljs-comment">/* consume the item in next consumed */</span>
    ...
} <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>);
</code></pre><h4 id="2-readers-writers-problem"><a class="anchor hidden-xs" href="#2-readers-writers-problem" title="2-readers-writers-problem"><span class="octicon octicon-link"></span></a>2. Readers-Writers Problem</h4><ul>
<li>A data set is shared among a number of concurrent processes
<ul>
<li><strong>Readers</strong> - only read the data set; they do not perform any updates</li>
<li><strong>Writers</strong> - can both read and write</li>
</ul>
</li>
<li><strong>Problem</strong> - allow multiple readers to read at the same time</li>
<li>Several variations of how readers and writers are treated – all involve priorities</li>
<li>Shared Data
<ul>
<li>Data set</li>
<li>Semaphore <code>rw_mutex</code> initialized to 1</li>
<li>Semaphore <code>mutex</code> initialized to 1</li>
<li>Integer <code>read_count</code> initialized to 0</li>
</ul>
</li>
</ul><h5 id="1-the-structure-of-a-writer-process"><a class="anchor hidden-xs" href="#1-the-structure-of-a-writer-process" title="1-the-structure-of-a-writer-process"><span class="octicon octicon-link"></span></a>(1) The structure of a writer process</h5><pre><code class="c hljs"><span class="hljs-keyword">do</span> {
    <span class="hljs-built_in">wait</span>(rw_mutex);
    
    ...
    /* writing is performed */
    ...
    
    signal(rw_mutex);
} <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);
</code></pre><h5 id="2-the-structure-of-a-reader-process"><a class="anchor hidden-xs" href="#2-the-structure-of-a-reader-process" title="2-the-structure-of-a-reader-process"><span class="octicon octicon-link"></span></a>(2) The structure of a reader process</h5><pre><code class="c hljs"><span class="hljs-keyword">do</span> {
    <span class="hljs-built_in">wait</span>(mutex);
    read_count++;
    
    
    <span class="hljs-keyword">if</span> (read_count == 1)    // only <span class="hljs-keyword">for</span> the first reader entering
        <span class="hljs-built_in">wait</span>(rw_mutex);
        
    signal(mutex);    // <span class="hljs-keyword">if</span> the first reader <span class="hljs-built_in">wait</span> <span class="hljs-keyword">for</span> rw_mutex, other readers will be blocked on <span class="hljs-built_in">wait</span>(mutex)
        
    ...
    /* reading is performed */
    ...
        
    <span class="hljs-built_in">wait</span>(mutex);
    read_count--;
        
    <span class="hljs-keyword">if</span> (read_count == 0)    // only <span class="hljs-keyword">for</span> the last reader leaving
        signal(rw_mutex);
    
    signal(mutex);
} <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
</code></pre><h5 id="3-problem"><a class="anchor hidden-xs" href="#3-problem" title="3-problem"><span class="octicon octicon-link"></span></a>(3) Problem</h5><ul>
<li><strong>First variation</strong> – no reader kept waiting unless writer has permission to use shared object</li>
<li><strong>Second variation</strong> – once writer is ready, it performs write asap</li>
<li>Both may have starvation leading to even more variations</li>
<li>Problem is solved on some systems by kernel providing <code>reader-writer locks</code></li>
</ul><h4 id="3-dining-philosophers-problem"><a class="anchor hidden-xs" href="#3-dining-philosophers-problem" title="3-dining-philosophers-problem"><span class="octicon octicon-link"></span></a>3. Dining-Philosophers Problem</h4><ul>
<li>Philosophers spend their lives thinking and eating</li>
<li>Don’t interact with their neighbors, occasionally try to pick up 2 chopsticks (one at a time) to eat from bowl
<ul>
<li>Need both to eat, then release both when done<br>
<img src="https://i.imgur.com/9W4qi3z.png" alt=""></li>
</ul>
</li>
</ul><h5 id="1-in-the-case-of-5-philosophers"><a class="anchor hidden-xs" href="#1-in-the-case-of-5-philosophers" title="1-in-the-case-of-5-philosophers"><span class="octicon octicon-link"></span></a>(1) In the case of 5 philosophers</h5><ul>
<li>Shared data
<ul>
<li>Bowl of rice (data set)</li>
<li>Semaphore chopstick [5] initialized to 1</li>
</ul>
</li>
<li>The structure of Philosopher i:</li>
</ul><pre><code class="c hljs"><span class="hljs-keyword">do</span> {
    wait ( chopstick[i] );
    wait ( chopStick[ (i+<span class="hljs-number">1</span>) % <span class="hljs-number">5</span>] );
    
    <span class="hljs-comment">// eat</span>

    signal ( chopstick[i] );
    signal (chopstick[ (i+<span class="hljs-number">1</span>) % <span class="hljs-number">5</span>] );
    
    <span class="hljs-comment">// think</span>
    
} <span class="hljs-keyword">while</span> (<span class="hljs-literal">TRUE</span>);
</code></pre><ul>
<li>
<p>Incorrect use of semaphore operations:</p>
<ul>
<li>signal (mutex) … wait (mutex)</li>
<li>wait (mutex) … wait (mutex)</li>
<li>Omitting of wait (mutex) or signal (mutex) (or both)</li>
</ul>
</li>
<li>
<p>Deadlock and starvation</p>
</li>
</ul><h5 id="2-monitors"><a class="anchor hidden-xs" href="#2-monitors" title="2-monitors"><span class="octicon octicon-link"></span></a>(2) Monitors</h5><p><img src="https://i.imgur.com/Et1mwXN.png" alt=""></p><ul>
<li>A high-level abstraction that provides a convenient and effective mechanism for process synchronization</li>
<li>Abstract data type, internal variables only accessible by code within the procedure</li>
<li>Only one process may be active within the monitor at a time</li>
<li>But not powerful enough to model some synchronization schemes</li>
</ul><h5 id="monitors-implementation"><a class="anchor hidden-xs" href="#monitors-implementation" title="monitors-implementation"><span class="octicon octicon-link"></span></a>Monitors Implementation</h5><h6 id="1-using-semaphores"><a class="anchor hidden-xs" href="#1-using-semaphores" title="1-using-semaphores"><span class="octicon octicon-link"></span></a>1. Using Semaphores</h6><ul>
<li>Variables</li>
</ul><pre><code class="c hljs">semaphore mutex; <span class="hljs-comment">// (initially = 1)</span>
semaphore next; <span class="hljs-comment">// (initially = 0)</span>
<span class="hljs-keyword">int</span> next_count = <span class="hljs-number">0</span>;
</code></pre><ul>
<li>Each procedure F will be replaced by</li>
</ul><pre><code class="c hljs"><span class="hljs-keyword">wait</span>(mutex);

...
body of F;
...

<span class="hljs-keyword">if</span> (next_count &gt; <span class="hljs-number">0</span>)
    signal(<span class="hljs-keyword">next</span>)
<span class="hljs-keyword">else</span>
    signal(mutex);
</code></pre><ul>
<li>Mutual exclusion within a monitor is ensured</li>
</ul><h6 id="2-condition-variables"><a class="anchor hidden-xs" href="#2-condition-variables" title="2-condition-variables"><span class="octicon octicon-link"></span></a>2. Condition Variables</h6><ul>
<li>For each condition variable x, we have:</li>
</ul><pre><code class="c hljs">semaphore x_sem; <span class="hljs-comment">// (initially = 0)</span>
<span class="hljs-keyword">int</span> x_count = <span class="hljs-number">0</span>;
</code></pre><ul>
<li>The operation <code>x.wait</code> can be implemented as:</li>
</ul><pre><code class="c hljs"><span class="hljs-keyword">x</span>-count++;
<span class="hljs-keyword">if</span> (next_count &gt; <span class="hljs-number">0</span>)
    signal(<span class="hljs-keyword">next</span>);
<span class="hljs-keyword">else</span>
    signal(mutex);
<span class="hljs-keyword">wait</span>(x_sem);
<span class="hljs-keyword">x</span>-count--;
</code></pre><h6 id="resuming-processes"><a class="anchor hidden-xs" href="#resuming-processes" title="resuming-processes"><span class="octicon octicon-link"></span></a>Resuming Processes</h6><ul>
<li>If several processes queued on condition x, and x.signal() executed, which should be resumed?</li>
<li>FCFS frequently not adequate</li>
<li><strong>conditional-wait</strong> construct of the form x.wait©
<ul>
<li>Where c is <strong>priority number</strong></li>
<li>Process with lowest number (highest priority) is scheduled next</li>
</ul>
</li>
</ul><h6 id="allocate-single-resource"><a class="anchor hidden-xs" href="#allocate-single-resource" title="allocate-single-resource"><span class="octicon octicon-link"></span></a>Allocate Single Resource</h6><pre><code class="c hljs">monitor ResourceAllocator
{
    <span class="hljs-keyword">boolean</span> busy;
    condition x;
    
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">acquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> time)</span> </span>{
        <span class="hljs-keyword">if</span> (busy)
            x.wait(time);
        busy = TRUE;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">release</span><span class="hljs-params">()</span> </span>{
        busy = FALSE;
        x.signal();
    }
    
    <span class="hljs-function">initialization <span class="hljs-title">code</span><span class="hljs-params">()</span> </span>{
        busy = FALSE;
    }
}
</code></pre><h5 id="3-solution"><a class="anchor hidden-xs" href="#3-solution" title="3-solution"><span class="octicon octicon-link"></span></a>(3) Solution</h5><ul>
<li>Each philosopher i invokes the operations <code>pickup()</code> and <code>putdown()</code> in the following sequence:
<ul>
<li>No deadlock, but starvation is possible.</li>
</ul>
</li>
</ul><pre><code class="c hljs"><span class="hljs-selector-tag">DiningPhilosophers</span><span class="hljs-selector-class">.pickup</span>(<span class="hljs-selector-tag">i</span>);
    <span class="hljs-selector-tag">EAT</span>
<span class="hljs-selector-tag">DiningPhilosophers</span><span class="hljs-selector-class">.putdown</span>(<span class="hljs-selector-tag">i</span>);
</code></pre><pre><code class="c hljs">monitor DiningPhilosophers
{
    enum { THINKING; HUNGRY, EATING) <span class="hljs-keyword">state</span> [<span class="hljs-number">5</span>] ;
    condition self [<span class="hljs-number">5</span>];

    void pickup (<span class="hljs-keyword">int</span> i) {
        <span class="hljs-keyword">state</span>[i] = HUNGRY;
        test(i);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">state</span>[i] != EATING) self [i].wait;
    }
    
    void putdown (<span class="hljs-keyword">int</span> i) {
        <span class="hljs-keyword">state</span>[i] = THINKING;
    
        <span class="hljs-regexp">/* test left and right neighbors */</span>
        test((i + <span class="hljs-number">4</span>) % <span class="hljs-number">5</span>);
        test((i + <span class="hljs-number">1</span>) % <span class="hljs-number">5</span>);
    }

    void test (<span class="hljs-keyword">int</span> i) {
        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">state</span>[(i + <span class="hljs-number">4</span>) % <span class="hljs-number">5</span>] != EATING) &amp;&amp;
(<span class="hljs-keyword">state</span>[i] == HUNGRY) &amp;&amp;
(<span class="hljs-keyword">state</span>[(i + <span class="hljs-number">1</span>) % <span class="hljs-number">5</span>] != EATING)) {
            <span class="hljs-keyword">state</span>[i] = EATING;
            self[i].signal();
    }
}

    initialization_code() {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++)
            <span class="hljs-keyword">state</span>[i] = THINKING;
    }
}
</code></pre><h2 id="20170511"><a class="anchor hidden-xs" href="#20170511" title="20170511"><span class="octicon octicon-link"></span></a>20170511</h2><ul>
<li>課堂講義
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170511/ch07.pdf" target="_blank">Chapter 7: Deadlocks</a></li>
</ul>
</li>
</ul><h3 id="一-deadlock-characterization"><a class="anchor hidden-xs" href="#一-deadlock-characterization" title="一-deadlock-characterization"><span class="octicon octicon-link"></span></a>(一) Deadlock Characterization</h3><ul>
<li><strong>Mutual exclusion</strong>：only one process at a time can use a resource.</li>
<li><strong>Hold and wait</strong>：a process holding at least one resource is waiting to acquire additional resources held by other processes.</li>
<li><strong>No preemption</strong>：a resource can be released only voluntarily by the process holding it, after that process has completed its task.</li>
<li><strong>Circular wait</strong>：there exists a set {P0, P1, …, Pn } of waiting processes such that P0 is waiting for a resource that is held by P1, P1 is waiting for a resource that is held by P2 , …, Pn–1 is waiting for a resource that is held by Pn, and Pn is waiting for a resource that is held by P0.</li>
<li>Deadlocks can occur via system calls, locking, etc</li>
</ul><h3 id="二-resource-allocation-graph"><a class="anchor hidden-xs" href="#二-resource-allocation-graph" title="二-resource-allocation-graph"><span class="octicon octicon-link"></span></a>(二) Resource-Allocation Graph</h3><p><img src="https://i.imgur.com/ruQSE03.png" alt=""><br>
<img src="https://i.imgur.com/jSnZ1nO.png" alt=""></p><h4 id="1-example"><a class="anchor hidden-xs" href="#1-example" title="1-example"><span class="octicon octicon-link"></span></a>1. Example</h4><ul>
<li>
<p>Resource Allocation Graph<br>
<img src="https://i.imgur.com/e10FFPp.png" alt=""></p>
</li>
<li>
<p>Resource Allocation Graph With A Deadlock<br>
<img src="https://i.imgur.com/t2UkKLi.png" alt=""></p>
</li>
<li>
<p>Graph With A Cycle But No Deadlock<br>
<img src="https://i.imgur.com/3mqHz5J.png" alt=""></p>
</li>
</ul><h4 id="2-basic-facts"><a class="anchor hidden-xs" href="#2-basic-facts" title="2-basic-facts"><span class="octicon octicon-link"></span></a>2. Basic Facts</h4><ul>
<li>If graph contains no cycles &gt;&gt; no deadlock</li>
<li>If graph contains a cycle
<ul>
<li>if only one instance per resource type, then deadlock</li>
<li>if several instances per resource type, possibility of deadlock</li>
</ul>
</li>
</ul><h4 id="3-methods-for-handling-deadlocks"><a class="anchor hidden-xs" href="#3-methods-for-handling-deadlocks" title="3-methods-for-handling-deadlocks"><span class="octicon octicon-link"></span></a>3. Methods for Handling Deadlocks</h4><ul>
<li>Ensure that the system will never enter a deadlock state</li>
<li>Allow the system to enter a deadlock state and then recover</li>
<li>Ignore the problem and pretend that deadlocks never occur in the system; used by most operating systems, including UNIX</li>
</ul><h3 id="三-deadlock-prevention"><a class="anchor hidden-xs" href="#三-deadlock-prevention" title="三-deadlock-prevention"><span class="octicon octicon-link"></span></a>(三) Deadlock Prevention</h3><ul>
<li><strong>Mutual Exclusion</strong>：not required for sharable resources; must hold for nonsharable resources</li>
<li><strong>Hold and Wait</strong>：must guarantee that whenever a process requests a resource, it does not hold any other resources
<ul>
<li>Require process to request and be allocated all its resources before it begins execution, or allow process to request resources only when the process has none</li>
<li>Low resource utilization; starvation possible</li>
</ul>
</li>
<li><strong>No Preemption</strong>：
<ul>
<li>If a process that is holding some resources requests another resource that cannot be immediately allocated to it, then all resources currently being held are released</li>
<li>Preempted resources are added to the list of resources for which the process is waiting</li>
<li>Process will be restarted only when it can regain its old resources, as well as the new ones that it is requesting</li>
</ul>
</li>
<li><strong>Circular Wait</strong>：impose a total ordering of all resource types, and require that each process requests resources in an increasing order of enumeration</li>
</ul><h4 id="1-example1"><a class="anchor hidden-xs" href="#1-example1" title="1-example1"><span class="octicon octicon-link"></span></a>1. Example</h4><ul>
<li>Deadlock Example</li>
</ul><pre><code class="c hljs"><span class="hljs-comment">/* thread one runs in this function */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-keyword">do</span> work <span class="hljs-title">one</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *param)</span>
</span>{
    <span class="hljs-function">pthread mutex <span class="hljs-title">lock</span><span class="hljs-params">(&amp;first mutex)</span></span>;
    <span class="hljs-function">pthread mutex <span class="hljs-title">lock</span><span class="hljs-params">(&amp;second mutex)</span></span>;
    <span class="hljs-comment">/** * Do some work */</span>
    <span class="hljs-function">pthread mutex <span class="hljs-title">unlock</span><span class="hljs-params">(&amp;second mutex)</span></span>;
    <span class="hljs-function">pthread mutex <span class="hljs-title">unlock</span><span class="hljs-params">(&amp;first mutex)</span></span>;
    <span class="hljs-function">pthread <span class="hljs-title">exit</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;
}

<span class="hljs-comment">/* thread two runs in this function */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-keyword">do</span> work <span class="hljs-title">two</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *param)</span>
</span>{
    <span class="hljs-function">pthread mutex <span class="hljs-title">lock</span><span class="hljs-params">(&amp;second mutex)</span></span>;
    <span class="hljs-function">pthread mutex <span class="hljs-title">lock</span><span class="hljs-params">(&amp;first mutex)</span></span>;
    <span class="hljs-comment">/** * Do some work */</span>
    <span class="hljs-function">pthread mutex <span class="hljs-title">unlock</span><span class="hljs-params">(&amp;first mutex)</span></span>;
    <span class="hljs-function">pthread mutex <span class="hljs-title">unlock</span><span class="hljs-params">(&amp;second mutex)</span></span>;
    <span class="hljs-function">pthread <span class="hljs-title">exit</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;
}
</code></pre><ul>
<li>Deadlock Example with Lock Ordering</li>
</ul><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">transaction</span>(<span class="hljs-params">Account <span class="hljs-keyword">from</span>, Account to, <span class="hljs-keyword">double</span> amount</span>)
</span>{
    mutex lock1, lock2;
    lock1 = <span class="hljs-function"><span class="hljs-keyword">get</span> <span class="hljs-title">lock</span>(<span class="hljs-params"><span class="hljs-keyword">from</span></span>)</span>;
    lock2 = <span class="hljs-function"><span class="hljs-keyword">get</span> <span class="hljs-title">lock</span>(<span class="hljs-params">to</span>)</span>;
    acquire(lock1);
    acquire(lock2);
    withdraw(<span class="hljs-keyword">from</span>, amount);
    deposit(to, amount);
    release(lock2);
    release(lock1);
}
</code></pre><h4 id="2-deadlock-avoidance"><a class="anchor hidden-xs" href="#2-deadlock-avoidance" title="2-deadlock-avoidance"><span class="octicon octicon-link"></span></a>2. Deadlock Avoidance</h4><ul>
<li>Requires that the system has some additional a priori information available
<ul>
<li>Simplest and most useful model requires that each process declare the <strong>maximum number</strong> of resources of each type that it may need</li>
<li>The deadlock-avoidance algorithm dynamically examines the resource-allocation state to ensure that there can never be a circular-wait condition</li>
<li>Resource-allocation state is defined by the number of available and allocated resources, and the maximum demands of the processes</li>
</ul>
</li>
</ul><h4 id="3-safe-state"><a class="anchor hidden-xs" href="#3-safe-state" title="3-safe-state"><span class="octicon octicon-link"></span></a>3. Safe State</h4><p><img src="https://i.imgur.com/Qzeh5D8.png" alt=""></p><h4 id="4-basic-facts"><a class="anchor hidden-xs" href="#4-basic-facts" title="4-basic-facts"><span class="octicon octicon-link"></span></a>4. Basic Facts</h4><ul>
<li>If a system is in safe state &gt;&gt; no deadlocks</li>
<li>If a system is in unsafe state &gt;&gt; possibility of deadlock</li>
<li>Avoidance &gt;&gt; ensure that a system will never enter an unsafe state</li>
</ul><h4 id="5-safe-unsafe-deadlock-state"><a class="anchor hidden-xs" href="#5-safe-unsafe-deadlock-state" title="5-safe-unsafe-deadlock-state"><span class="octicon octicon-link"></span></a>5. Safe, Unsafe, Deadlock State</h4><p><img src="https://i.imgur.com/Y7KEMVp.png" alt=""></p><h4 id="6-avoidance-algorithms"><a class="anchor hidden-xs" href="#6-avoidance-algorithms" title="6-avoidance-algorithms"><span class="octicon octicon-link"></span></a>6. Avoidance algorithms</h4><ul>
<li>Single instance of a resource type
<ul>
<li>Use a resource-allocation graph</li>
</ul>
</li>
<li>Multiple instances of a resource type
<ul>
<li>Use the banker’s algorithm</li>
</ul>
</li>
</ul><h4 id="7-resource-allocation-graph"><a class="anchor hidden-xs" href="#7-resource-allocation-graph" title="7-resource-allocation-graph"><span class="octicon octicon-link"></span></a>7. Resource-Allocation Graph</h4><p><img src="https://i.imgur.com/aUkipvw.png" alt=""><br>
<img src="http://i.imgur.com/RtDzuXQ.jpg" alt=""></p><h4 id="8-algorithm"><a class="anchor hidden-xs" href="#8-algorithm" title="8-algorithm"><span class="octicon octicon-link"></span></a>8. Algorithm</h4><h5 id="1-data-structures-for-the-banker’s-algorithm"><a class="anchor hidden-xs" href="#1-data-structures-for-the-banker’s-algorithm" title="1-data-structures-for-the-banker’s-algorithm"><span class="octicon octicon-link"></span></a>(1) Data Structures for the Banker’s Algorithm</h5><p><img src="http://i.imgur.com/Z9SQSCC.png" alt=""></p><ul>
<li>Example<br>
<img src="http://i.imgur.com/IMSADSw.png" alt=""><br>
<img src="http://i.imgur.com/CnQFX9s.png" alt=""></li>
</ul><h5 id="2-safety-algorithm"><a class="anchor hidden-xs" href="#2-safety-algorithm" title="2-safety-algorithm"><span class="octicon octicon-link"></span></a>(2) Safety Algorithm</h5><p><img src="http://i.imgur.com/V6oA8hC.png" alt=""></p><h2 id="20170518"><a class="anchor hidden-xs" href="#20170518" title="20170518"><span class="octicon octicon-link"></span></a>20170518</h2><ul>
<li>課堂講義
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170518/ch07.pdf" target="_blank">Chapter 7: Deadlocks</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170518/ch08.pdf" target="_blank">Chapter 8: Memory-Management Strategies</a></li>
</ul>
</li>
<li>參考資料
<ul>
<li><a href="https://www3.nd.edu/~dthain/courses/classconf/worts2006/WangLiu.ppt" target="_blank">Static Linking VS. Dynamic Linking</a></li>
</ul>
</li>
</ul><h3 id="一-deadlock-detection"><a class="anchor hidden-xs" href="#一-deadlock-detection" title="一-deadlock-detection"><span class="octicon octicon-link"></span></a>(一) Deadlock Detection</h3><ul>
<li>Allow system to enter deadlock state</li>
<li>Detection algorithm</li>
<li>Recovery scheme</li>
</ul><h3 id="二-detection-algorithm"><a class="anchor hidden-xs" href="#二-detection-algorithm" title="二-detection-algorithm"><span class="octicon octicon-link"></span></a>(二) Detection Algorithm</h3><p><img src="https://i.imgur.com/LRO7qdP.png" alt=""><br>
<img src="https://i.imgur.com/ZG7BUjD.png" alt=""></p><ul>
<li><strong>Example</strong></li>
</ul><p><img src="https://i.imgur.com/PBYJ62y.png" alt=""><br>
<img src="https://i.imgur.com/rt4bsYL.png" alt=""></p><ul>
<li><strong>Usage</strong>
<ul>
<li>When, and how often, to invoke depends on
<ul>
<li>How often a deadlock is likely to occur?</li>
<li>How many processes will need to be rolled back?
<ul>
<li>one for each disjoint cycle</li>
</ul>
</li>
</ul>
</li>
<li>If detection algorithm is invoked arbitrarily, there may be many cycles in the resource graph and so we would not be able to tell which of the many deadlocked processes “caused” the deadlock.</li>
</ul>
</li>
</ul><h3 id="三-recovery-from-deadlock"><a class="anchor hidden-xs" href="#三-recovery-from-deadlock" title="三-recovery-from-deadlock"><span class="octicon octicon-link"></span></a>(三) Recovery from Deadlock</h3><h4 id="1-process-termination"><a class="anchor hidden-xs" href="#1-process-termination" title="1-process-termination"><span class="octicon octicon-link"></span></a>1. Process Termination</h4><ul>
<li>Abort all deadlocked processes</li>
<li>Abort one process at a time until the deadlock cycle is eliminated</li>
<li>In which order should we choose to abort?
<ol>
<li>Priority of the process</li>
<li>How long process has computed, and how much longer to completion</li>
<li>Resources the process has used</li>
<li>Resources process needs to complete</li>
<li>How many processes will need to be terminated</li>
<li>Is process interactive or batch?</li>
</ol>
</li>
</ul><h4 id="2-resource-preemption"><a class="anchor hidden-xs" href="#2-resource-preemption" title="2-resource-preemption"><span class="octicon octicon-link"></span></a>2. Resource Preemption</h4><ul>
<li><strong>Selecting a victim</strong> - minimize cost</li>
<li><strong>Rollback</strong> - return to some safe state, restart process for that state</li>
<li><strong>Starvation</strong> - same process may always be picked as victim, include number of rollback in cost factor</li>
</ul><h3 id="四-memory-management"><a class="anchor hidden-xs" href="#四-memory-management" title="四-memory-management"><span class="octicon octicon-link"></span></a>(四) Memory-Management</h3><ul>
<li>Program must be brought (from disk) into memory and placed within a process for it to be run</li>
<li>Main memory and registers are only storage CPU can access directly</li>
<li>Memory unit only sees a stream of <code>addresses + read requests</code>, or <code>address + data and write requests</code></li>
<li>Register access in one CPU clock (or less)</li>
<li>Main memory can take many cycles, causing a <strong>stall</strong></li>
<li><strong>Cache</strong> sits between main memory and CPU registers</li>
<li>Protection of memory required to ensure correct operation</li>
</ul><ol>
<li>
<p><strong>Base and Limit Registers</strong></p>
<ul>
<li>
<p>A pair of <strong>base</strong> and limit <strong>registers</strong> define the logical address space</p>
</li>
<li>
<p>CPU must check every memory access generated in user mode to be sure it is between base and limit for that user<br>
<img src="https://i.imgur.com/mxLWZHF.png" alt=""></p>
</li>
<li>
<p>Hardware Address Protection with Base and Limit Registers<br>
<img src="https://i.imgur.com/ztutE6h.png" alt=""></p>
</li>
</ul>
</li>
<li>
<p><strong>Address Binding</strong></p>
<ul>
<li>Programs on disk, ready to be brought into memory to execute form an <strong>input queue</strong>
<ul>
<li>Without support, must be loaded into address 0000</li>
</ul>
</li>
<li>Inconvenient to have first user process physical address always at 0000
<ul>
<li>How can it not be?</li>
</ul>
</li>
<li>Further, addresses represented in different ways at different stages of a program’s life
<ul>
<li>Source code addresses usually symbolic</li>
<li>Compiled code addresses <strong>bind</strong> to relocatable addresses
<ul>
<li>i.e. “14 bytes from beginning of this module”</li>
</ul>
</li>
<li>Linker or loader will bind relocatable addresses to absolute addresses
<ul>
<li>i.e. 74014</li>
</ul>
</li>
<li>Each binding maps one address space to another</li>
</ul>
</li>
</ul>
</li>
</ol><p><img src="https://i.imgur.com/cXzBuNp.jpg" alt=""></p><ol start="3">
<li>
<p><strong>Logical vs. Physical Address Space</strong><br>
<img src="https://i.imgur.com/LwA18UW.png" alt=""></p>
</li>
<li>
<p><strong>Memory-Management Unit (MMU)</strong></p>
<ul>
<li>Hardware device that at run time maps virtual to physical address</li>
<li>Many methods possible, covered in the rest of this chapter</li>
<li>To start, consider simple scheme where the value in the relocation register is added to every address generated by a user process at the time it is sent to memory
<ul>
<li>Base register now called <strong>relocation register</strong></li>
<li>MS-DOS on Intel 80x86 used 4 relocation registers</li>
</ul>
</li>
<li>The user program deals with logical addresses; it never sees the real physical addresses
<ul>
<li>Execution-time binding occurs when reference is made to location in memory</li>
<li>Logical address bound to physical addresses</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Dynamic relocation</strong></p>
<ul>
<li>Using a relocation register<br>
<img src="https://i.imgur.com/RICsWcf.png" alt=""></li>
</ul>
</li>
<li>
<p><strong>Dynamic Linking</strong></p>
<ul>
<li><strong>Static linking</strong> - system libraries and program code combined by the loader into the binary program image</li>
<li><strong>Dynamic linking</strong> – linking postponed until execution time</li>
<li>Small piece of code, <strong>stub</strong>, used to locate the appropriate memory-resident library routine</li>
<li>Stub replaces itself with the address of the routine, and executes the routine</li>
<li>Operating system checks if routine is in processes’ memory address
<ul>
<li>If not in address space, add to address space</li>
</ul>
</li>
<li>Dynamic linking is particularly useful for libraries</li>
<li>System also known as <strong>shared libraries</strong></li>
<li>Consider applicability to patching system libraries
<ul>
<li>Versioning may be needed</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Swapping</strong></p>
<ul>
<li>A process can be swapped temporarily out of memory to a backing store, and then brought back into memory for continued execution
<ul>
<li>Total physical memory space of processes can exceed physical memory</li>
</ul>
</li>
<li><strong>Backing store</strong> – fast disk large enough to accommodate copies of all memory images for all users; must provide direct access to these memory images</li>
<li><strong>Roll out, roll in</strong> – swapping variant used for priority-based scheduling algorithms; lower-priority process is swapped out so higher-priority process can be loaded and executed</li>
<li>Major part of swap time is transfer time; total transfer time is directly proportional to the amount of memory swapped</li>
<li>System maintains a <strong>ready queue</strong> of ready-to-run processes which have memory images on disk</li>
<li>Does the swapped out process need to swap back in to same physical addresses?
<ul>
<li>Depends on address binding method
<ul>
<li>Plus consider pending <code>I/O</code> to <code>/</code> from process memory space</li>
</ul>
</li>
</ul>
</li>
<li>Modified versions of swapping are found on many systems (i.e., UNIX, Linux, and Windows)
<ul>
<li>Swapping normally disabled</li>
<li>Started if more than threshold amount of memory allocated</li>
<li>Disabled again once memory demand reduced below threshold</li>
</ul>
</li>
</ul>
</li>
</ol><p><img src="https://i.imgur.com/hptlmlg.png" alt=""></p><h2 id="20170525"><a class="anchor hidden-xs" href="#20170525" title="20170525"><span class="octicon octicon-link"></span></a>20170525</h2><ul>
<li>課堂講義
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170525/ch08.pdf" target="_blank">Chapter 8: Memory-Management Strategies</a></li>
</ul>
</li>
</ul><h3 id="一-contiguous-allocation"><a class="anchor hidden-xs" href="#一-contiguous-allocation" title="一-contiguous-allocation"><span class="octicon octicon-link"></span></a>(一) Contiguous Allocation</h3><ul>
<li>
<p>Main memory must support both OS and user processes</p>
</li>
<li>
<p>Limited resource, must allocate efficiently</p>
</li>
<li>
<p>Contiguous allocation is one early method</p>
</li>
<li>
<p>Main memory usually into two <strong>partitions</strong></p>
<ul>
<li>Resident operating system, usually held in low memory with interrupt vector</li>
<li>User processes then held in high memory</li>
<li>Each process contained in single contiguous section of memory</li>
</ul>
</li>
<li>
<p>Relocation registers used to protect user processes from each other, and from changing operating-system code and data</p>
<ul>
<li>Base register contains value of smallest physical address</li>
<li>Limit register contains range of logical addresses – each logical address must be less than the limit register</li>
<li>MMU maps logical address dynamically</li>
<li>Can then allow actions such as kernel code being <code>transient</code> and kernel changing size</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/z3R2FCC.png" alt=""></p><ul>
<li>Multiple-partition allocation
<ul>
<li>Degree of multiprogramming limited by number of partitions</li>
<li>Variable-partition sizes for efficiency (sized to a given process’ needs)</li>
<li>Hole – block of available memory; holes of various size are scattered throughout memory</li>
<li>When a process arrives, it is allocated memory from a hole large enough to accommodate it</li>
<li>Process exiting frees its partition, adjacent free partitions combined</li>
<li>Operating system maintains information about
<ul>
<li>(a) allocated partitions</li>
<li>(b) free partitions (hole)</li>
</ul>
</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/JQ1uTUe.png" alt=""></p><h3 id="二-dynamic-storage-allocation-problem"><a class="anchor hidden-xs" href="#二-dynamic-storage-allocation-problem" title="二-dynamic-storage-allocation-problem"><span class="octicon octicon-link"></span></a>(二) Dynamic Storage-Allocation Problem</h3><ul>
<li>
<p><strong>First-fit</strong>：Allocate the <code>first</code> hole that is big enough</p>
</li>
<li>
<p><strong>Best-fit</strong>：Allocate the <code>smallest</code> hole that is big enough; must search entire list, unless ordered by size</p>
<ul>
<li>Produces the smallest leftover hole</li>
</ul>
</li>
<li>
<p><strong>Worst-fit</strong>：Allocate the <code>largest</code> hole; must also search entire list</p>
<ul>
<li>Produces the largest leftover hole</li>
</ul>
</li>
<li>
<p>First-fit and best-fit better than worst-fit in terms of speed and storage utilization</p>
</li>
</ul><h3 id="三-fragmentation"><a class="anchor hidden-xs" href="#三-fragmentation" title="三-fragmentation"><span class="octicon octicon-link"></span></a>(三) Fragmentation</h3><ul>
<li><strong>External Fragmentation</strong> – total memory space exists to satisfy a request, but it is not contiguous</li>
<li><strong>Internal Fragmentation</strong> – allocated memory may be slightly larger than requested memory; this size difference is memory internal to a partition, but not being used</li>
<li>First fit analysis reveals that given N blocks allocated, 0.5 N blocks lost to fragmentation
<ul>
<li>1/3 may be unusable -&gt; <strong>50-percent rule</strong></li>
</ul>
</li>
<li>Reduce external fragmentation by <strong>compaction</strong>
<ul>
<li>Shuffle memory contents to place all free memory together in one large block</li>
<li>Compaction is possible only if relocation is dynamic, and is done at execution time</li>
<li>I/O problem
<ul>
<li>Latch job in memory while it is involved in I/O</li>
<li>Do I/O only into OS buffers</li>
</ul>
</li>
</ul>
</li>
<li>Now consider that backing store has same fragmentation problems</li>
</ul><h3 id="四-segmentation"><a class="anchor hidden-xs" href="#四-segmentation" title="四-segmentation"><span class="octicon octicon-link"></span></a>(四) Segmentation</h3><ul>
<li>Memory-management scheme that supports user view of memory</li>
</ul><p><img src="https://i.imgur.com/hiMN3YJ.png" alt=""></p><ul>
<li>A program is a collection of segments
<ul>
<li>A segment is a logical unit such as：<code>main program</code>、<code>procedure</code>、<code>function</code>、<code>method</code>、<code>object</code>、<code>local variables</code>、<code>global variables</code>、<code>common block</code>、<code>stack</code>、<code>symbol table</code>、<code>arrays</code></li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/PKuwv70.png" alt=""></p><h4 id="segmentation-architecture"><a class="anchor hidden-xs" href="#segmentation-architecture" title="segmentation-architecture"><span class="octicon octicon-link"></span></a>Segmentation Architecture</h4><ul>
<li>Logical address consists of a two tuple：<code>&lt;segment-number, offset&gt;</code></li>
<li><strong>Segment table</strong> – maps two-dimensional physical addresses; each table entry has
<ul>
<li><strong>base</strong> – contains the starting physical address where the segments reside in memory</li>
<li><strong>limit</strong> – specifies the length of the segment</li>
</ul>
</li>
<li><strong>Segment-table base register (STBR)</strong> points to the segment table’s location in memory</li>
<li><strong>Segment-table length register (STLR)</strong> indicates number of segments used by a program：<code>segment number s is legal if s &lt; STLR</code></li>
<li>Protection
<ul>
<li>With each entry in segment table associate
<ul>
<li>validation bit = 0 &gt;&gt; illegal segment</li>
<li>read/write/execute privileges</li>
</ul>
</li>
</ul>
</li>
<li>Protection bits associated with segments; code sharing occurs at segment level</li>
<li>Since segments vary in length, memory allocation is a dynamic storage-allocation problem</li>
<li>A segmentation example is shown in the following diagram</li>
</ul><p><img src="https://i.imgur.com/raq8eDi.png" alt=""></p><h2 id="20170601"><a class="anchor hidden-xs" href="#20170601" title="20170601"><span class="octicon octicon-link"></span></a>20170601</h2><ul>
<li>課堂講義
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170601/ch08.pdf" target="_blank">Chapter 8: Memory-Management Strategies</a></li>
</ul>
</li>
</ul><h3 id="一-paging"><a class="anchor hidden-xs" href="#一-paging" title="一-paging"><span class="octicon octicon-link"></span></a>(一) Paging</h3><ul>
<li>Physical address space of a process can be noncontiguous; process is allocated physical memory whenever the latter is available
<ul>
<li>Avoids external fragmentation</li>
<li>Avoids problem of varying sized memory chunks</li>
</ul>
</li>
<li>Divide physical memory into fixed-sized blocks called <strong>frames</strong>
<ul>
<li>Size is power of 2, between 512 bytes and 16 Mbytes</li>
</ul>
</li>
<li>Divide logical memory into blocks of same size called <strong>pages</strong></li>
<li>Keep track of all free frames</li>
<li>To run a program of size <code>N</code> pages, need to find <code>N</code> free frames and load program</li>
<li>Set up a page table to translate logical to physical addresses</li>
<li>Backing store likewise split into pages</li>
<li>Still have Internal fragmentation</li>
<li>Calculating internal fragmentation
<ul>
<li>Page size = 2,048 bytes</li>
<li>Process size = 72,766 bytes</li>
<li>35 pages + 1,086 bytes</li>
<li>Internal fragmentation of 2,048 - 1,086 = 962 bytes</li>
<li>On average fragmentation = 1 / 2 frame size</li>
<li>So small frame sizes desirable?</li>
<li>But each page table entry takes memory to track</li>
<li>Page sizes growing over time
<ul>
<li>Solaris supports two page sizes – 8 KB and 4 MB</li>
</ul>
</li>
</ul>
</li>
<li>Process view and physical memory now very different</li>
<li>By implementation process can only access its own memory</li>
</ul><h3 id="二-address-translation-scheme"><a class="anchor hidden-xs" href="#二-address-translation-scheme" title="二-address-translation-scheme"><span class="octicon octicon-link"></span></a>(二) Address Translation Scheme</h3><p><img src="http://i.imgur.com/rbuMKKY.png" alt=""></p><ul>
<li>Address generated by CPU is divided into
<ul>
<li><strong>Page number <code>p</code></strong> – used as an index into a <strong>page table</strong> which contains base address of each page in physical memory</li>
<li><strong>Page offset <code>d</code></strong> – combined with base address to define the physical memory address that is sent to the memory unit</li>
</ul>
</li>
</ul><p><img src="http://i.imgur.com/hY3zgAC.png" alt=""><br>
<img src="http://i.imgur.com/ASgBcxX.png" alt=""><br>
<img src="https://i.imgur.com/tLepGb4.png" alt=""></p><h3 id="三-implementation-of-page-table"><a class="anchor hidden-xs" href="#三-implementation-of-page-table" title="三-implementation-of-page-table"><span class="octicon octicon-link"></span></a>(三) Implementation of Page Table</h3><ul>
<li>Page table is kept in main memory</li>
<li><strong>Page-table base register (PTBR)</strong> points to the page table</li>
<li><strong>Page-table length register (PTLR)</strong> indicates size of the page table</li>
<li>In this scheme every data/instruction access requires two memory accesses
<ul>
<li>One for the page table and one for the data / instruction</li>
</ul>
</li>
<li>The two memory access problem can be solved by the use of a special fast-lookup hardware cache called <strong>associative memory</strong> or <strong>translation look-aside buffers (TLBs)</strong></li>
<li>Some TLBs store <strong>address-space identifiers (ASIDs)</strong> in each TLB entry – uniquely identifies each process to provide address-space protection for that process
<ul>
<li>Otherwise need to flush at every context switch</li>
</ul>
</li>
<li>TLBs typically small (64 to 1,024 entries)</li>
<li>On a TLB miss, value is loaded into the TLB for faster access next time
<ul>
<li>Replacement policies must be considered</li>
<li>Some entries can be <strong>wired down</strong> for permanent fast access</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/aH3Zg2J.png" alt=""><br>
<img src="https://i.imgur.com/923AOvB.png" alt=""></p><h3 id="四-effective-access-time"><a class="anchor hidden-xs" href="#四-effective-access-time" title="四-effective-access-time"><span class="octicon octicon-link"></span></a>(四) Effective Access Time</h3><p><img src="https://i.imgur.com/Y0mMzTR.png" alt=""></p><h3 id="五-memory-protection"><a class="anchor hidden-xs" href="#五-memory-protection" title="五-memory-protection"><span class="octicon octicon-link"></span></a>(五) Memory Protection</h3><ul>
<li>
<p>Memory protection implemented by associating protection bit with each frame to indicate if read-only or read-write access is allowed</p>
<ul>
<li>Can also add more bits to indicate page execute-only, and so on</li>
</ul>
</li>
<li>
<p><strong>Valid-invalid</strong> bit attached to each entry in the page table</p>
<ul>
<li><code>valid</code> indicates that the associated page is in the process’ logical address space, and is thus a legal page</li>
<li><code>invalid</code> indicates that the page is not in the process’ logical address space</li>
<li>Or use <strong>page-table length register (PTLR)</strong></li>
</ul>
</li>
<li>
<p>Any violations result in a trap to the kernel</p>
</li>
</ul><p><img src="http://i.imgur.com/3UtvoGB.png" alt=""></p><h3 id="六-shared-pages"><a class="anchor hidden-xs" href="#六-shared-pages" title="六-shared-pages"><span class="octicon octicon-link"></span></a>(六) Shared Pages</h3><ul>
<li><strong>Shared code</strong>
<ul>
<li>One copy of read-only (<strong>reentrant</strong>) code shared among processes (i.e., text editors, compilers, window systems)</li>
<li>Similar to multiple threads sharing the same process space</li>
<li>Also useful for interprocess communication if sharing of read-write pages is allowed</li>
</ul>
</li>
<li><strong>Private code and data</strong>
<ul>
<li>Each process keeps a separate copy of the code and data</li>
<li>The pages for the private code and data can appear anywhere in the logical address space</li>
</ul>
</li>
</ul><p><img src="http://i.imgur.com/JYNkQQT.png" alt=""></p><h3 id="七-structure-of-the-page-table"><a class="anchor hidden-xs" href="#七-structure-of-the-page-table" title="七-structure-of-the-page-table"><span class="octicon octicon-link"></span></a>(七) Structure of the Page Table</h3><ul>
<li>Memory structures for paging can get huge using straight-forward methods
<ul>
<li>Consider a 32-bit logical address space as on modern computers</li>
<li>Page size of 4 KB (2<sup>12</sup>)</li>
<li>Page table would have 1 million entries (2<sup>32</sup> / 2<sup>12</sup>)</li>
<li>If each entry is 4 bytes -&gt; 4 MB of physical address space / memory for page table alone lot
<ul>
<li>Don’t want to allocate that contiguously in main memory</li>
</ul>
</li>
</ul>
</li>
<li>Hierarchical Paging</li>
<li>Hashed Page Tables</li>
<li>Inverted Page Tables</li>
</ul><h4 id="hierarchical-page-tables"><a class="anchor hidden-xs" href="#hierarchical-page-tables" title="hierarchical-page-tables"><span class="octicon octicon-link"></span></a>Hierarchical Page Tables</h4><ul>
<li>Break up the logical address space into multiple page tables</li>
<li>A simple technique is a two-level page table</li>
<li>We then page the page table</li>
</ul><h4 id="two-level-page-table-scheme"><a class="anchor hidden-xs" href="#two-level-page-table-scheme" title="two-level-page-table-scheme"><span class="octicon octicon-link"></span></a>Two-Level Page-Table Scheme</h4><p><img src="http://i.imgur.com/EXa669R.png" alt=""></p><ul>
<li><strong>Example</strong>
<ul>
<li>A logical address (on 32-bit machine with 1K page size) is divided into
<ul>
<li>a page number consisting of 22 bits</li>
<li>a page offset consisting of 10 bits</li>
</ul>
</li>
<li>Since the page table is paged, the page number is further divided into
<ul>
<li>a 12-bit page number</li>
<li>a 10-bit page offset</li>
</ul>
</li>
<li>Thus, a logical address is as follows<br>
<img src="http://i.imgur.com/uwG3NvI.png" alt=""></li>
<li>where p 1 is an index into the outer page table, and p 2 is the displacement within the page of the inner page table</li>
<li>Known as <strong>forward-mapped page table</strong></li>
</ul>
</li>
</ul><h4 id="three-level-paging-scheme"><a class="anchor hidden-xs" href="#three-level-paging-scheme" title="three-level-paging-scheme"><span class="octicon octicon-link"></span></a>Three-level Paging Scheme</h4><p><img src="http://i.imgur.com/LYA2JD3.png" alt=""></p><h4 id="hashed-page-tables"><a class="anchor hidden-xs" href="#hashed-page-tables" title="hashed-page-tables"><span class="octicon octicon-link"></span></a>Hashed Page Tables</h4><p><img src="https://i.imgur.com/itaf25z.png" alt=""></p><ul>
<li>Common in address spaces &gt; 32 bits</li>
<li>The virtual page number is hashed into a page table
<ul>
<li>This page table contains a chain of elements hashing to the same location</li>
</ul>
</li>
<li>Each element contains (1) the virtual page number (2) the value of the mapped page frame (3) a pointer to the next element</li>
<li>Virtual page numbers are compared in this chain searching for a match
<ul>
<li>If a match is found, the corresponding physical frame is extracted</li>
</ul>
</li>
<li>Variation for 64-bit addresses is <strong>clustered page tables</strong>
<ul>
<li>Similar to hashed but each entry refers to several pages (such as 16) rather than 1</li>
<li>Especially useful for <strong>sparse</strong> address spaces (where memory references are non-contiguous and scattered)</li>
</ul>
</li>
</ul><h4 id="inverted-page-table"><a class="anchor hidden-xs" href="#inverted-page-table" title="inverted-page-table"><span class="octicon octicon-link"></span></a>Inverted Page Table</h4><ul>
<li>Rather than each process having a page table and keeping track of all possible logical pages, track all physical pages</li>
<li>One entry for each real page of memory</li>
<li>Entry consists of the virtual address of the page stored in that real memory location, with information about the process that owns that page</li>
<li>Decreases memory needed to store each page table, but increases time needed to search the table when a page reference occurs</li>
<li>Use hash table to limit the search to one — or at most a few — page-table entries
<ul>
<li>TLB can accelerate access</li>
</ul>
</li>
<li>But how to implement shared memory?
<ul>
<li>One mapping of a virtual address to the shared physical address</li>
</ul>
</li>
</ul><h2 id="20170608"><a class="anchor hidden-xs" href="#20170608" title="20170608"><span class="octicon octicon-link"></span></a>20170608</h2><ul>
<li>課堂講義
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170608/ch09.pdf" target="_blank">Chapter 9: Virtual-Memory Management</a></li>
</ul>
</li>
</ul><h3 id="一-background"><a class="anchor hidden-xs" href="#一-background" title="一-background"><span class="octicon octicon-link"></span></a>(一) Background</h3><ul>
<li>Code needs to be in memory to execute, but entire program rarely used
<ul>
<li>Error code, unusual routines, large data structures</li>
</ul>
</li>
<li>Entire program code not needed at same time</li>
<li>Consider ability to execute partially-loaded program
<ul>
<li>Program no longer constrained by limits of physical memory</li>
<li>Program and programs could be larger than physical memory</li>
</ul>
</li>
<li><strong>Virtual memory</strong> – separation of user logical memory from physical memory
<ul>
<li>Only part of the program needs to be in memory for execution</li>
<li>Logical address space can therefore be much larger than physical address space</li>
<li>Allows address spaces to be shared by several processes</li>
<li>Allows for more efficient process creation</li>
<li>More programs running concurrently</li>
<li>Less I/O needed to load or swap processes</li>
</ul>
</li>
<li>Virtual memory can be implemented via
<ul>
<li>Demand paging</li>
<li>Demand segmentation</li>
</ul>
</li>
</ul><h3 id="二-virtual-address-space"><a class="anchor hidden-xs" href="#二-virtual-address-space" title="二-virtual-address-space"><span class="octicon octicon-link"></span></a>(二) Virtual Address Space</h3><p><img src="http://i.imgur.com/DkDhsAx.jpg" alt=""></p><ul>
<li>Enables <strong>sparse</strong> address spaces with holes left for growth, dynamically linked libraries, etc</li>
<li>System libraries shared via mapping into virtual address space</li>
<li>Shared memory by mapping pages read-write into virtual address space</li>
<li>Pages can be shared during <code>fork()</code>, speeding process creation</li>
</ul><p><img src="http://i.imgur.com/3jsjqeH.png" alt=""></p><h3 id="三-demand-paging"><a class="anchor hidden-xs" href="#三-demand-paging" title="三-demand-paging"><span class="octicon octicon-link"></span></a>(三) Demand Paging</h3><ul>
<li>Could bring entire process into memory at load time</li>
<li>Or bring a page into memory only when it is needed
<ul>
<li>Less I/O needed, no unnecessary I/O</li>
<li>Less memory needed</li>
<li>Faster response</li>
<li>More users</li>
</ul>
</li>
<li>Page is needed &gt;&gt; reference to it
<ul>
<li>invalid reference &gt;&gt; abort</li>
<li>not-in-memory &gt;&gt; bring to memory</li>
</ul>
</li>
<li><strong>Lazy swapper</strong> – never swaps a page into memory unless page will be needed
<ul>
<li>Swapper that deals with pages is a <strong>pager</strong></li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/aLRTern.png" alt=""></p><h4 id="1-valid-invalid-bit"><a class="anchor hidden-xs" href="#1-valid-invalid-bit" title="1-valid-invalid-bit"><span class="octicon octicon-link"></span></a>1. Valid-Invalid Bit</h4><ul>
<li>With each page table entry a valid–invalid bit is associated (<strong>v</strong> &gt;&gt; in-memory – <strong>memory resident</strong>, <strong>i</strong> &gt;&gt; not-in-memory)</li>
<li>Initially valid–invalid bit is set to <strong>i</strong> on all entries</li>
</ul><p><img src="https://i.imgur.com/0Fk929T.jpg" alt=""></p><h4 id="2-example"><a class="anchor hidden-xs" href="#2-example" title="2-example"><span class="octicon octicon-link"></span></a>2. Example</h4><ul>
<li>Memory access time = 200 nanoseconds</li>
<li>Average page-fault service time = 8 milliseconds</li>
</ul><blockquote>
<p>EAT = (1 – p) x 200 + p (8 milliseconds)<br>
= (1 – p) x 200 + p x 8,000,000<br>
= 200 + p x 7,999,800</p>
</blockquote><ul>
<li>If one access out of 1,000 causes a page fault, then EAT = 8.2 microseconds. (This is a slowdown by a factor of 40)</li>
<li>If want performance degradation &lt; 10 percent
<ul>
<li>220 &gt; 200 + 7,999,800 x p</li>
<li>20 &gt; 7,999,800 x p</li>
<li>p &lt; .0000025 (&lt; one page fault in every 400,000 memory accesses)</li>
</ul>
</li>
</ul><h4 id="3-optimizations"><a class="anchor hidden-xs" href="#3-optimizations" title="3-optimizations"><span class="octicon octicon-link"></span></a>3. Optimizations</h4><ul>
<li>Copy entire process image to swap space at process load time
<ul>
<li>Then page in and out of swap space</li>
<li>Used in older BSD Unix</li>
</ul>
</li>
<li>Demand page in from program binary on disk, but discard rather than paging out when freeing frame
<ul>
<li>Used in Solaris and current BSD</li>
</ul>
</li>
</ul><h3 id="四-page-fault"><a class="anchor hidden-xs" href="#四-page-fault" title="四-page-fault"><span class="octicon octicon-link"></span></a>(四) Page Fault</h3><ul>
<li>If there is a reference to a page, first reference to that page will trap to operating system
<ul>
<li><strong>page fault</strong></li>
</ul>
</li>
<li>Operating system looks at another table to decide
<ul>
<li>Invalid reference &gt;&gt; abort</li>
<li>Just not in memory</li>
</ul>
</li>
<li>Get empty frame</li>
<li>Swap page into frame via scheduled disk operation</li>
<li>Reset tables to indicate page now in memory Set validation bit = <strong>v</strong></li>
<li>Restart the instruction that caused the page fault</li>
</ul><p><img src="https://i.imgur.com/98V6oNY.png" alt=""></p><h4 id="1-aspects-of-demand-paging"><a class="anchor hidden-xs" href="#1-aspects-of-demand-paging" title="1-aspects-of-demand-paging"><span class="octicon octicon-link"></span></a>1. Aspects of Demand Paging</h4><ul>
<li>Extreme case – start process with no pages in memory
<ul>
<li>OS sets instruction pointer to first instruction of process, non-memory-resident -&gt; page fault</li>
<li>And for every other process pages on first access</li>
<li><strong>Pure demand paging</strong></li>
</ul>
</li>
<li>Actually, a given instruction could access multiple pages -&gt; multiple page faults
<ul>
<li>Pain decreased because of <strong>locality of reference</strong></li>
</ul>
</li>
<li>Hardware support needed for demand paging
<ul>
<li>Page table with valid / invalid bit</li>
<li>Secondary memory (swap device with <strong>swap space</strong>)</li>
<li>Instruction restart</li>
</ul>
</li>
</ul><h4 id="2-instruction-restart"><a class="anchor hidden-xs" href="#2-instruction-restart" title="2-instruction-restart"><span class="octicon octicon-link"></span></a>2. Instruction Restart</h4><ul>
<li>Consider an instruction that could access several different locations
<ul>
<li>block move</li>
<li>auto increment/decrement location</li>
<li>Restart the whole operation?
<ul>
<li>What if source and destination overlap?</li>
</ul>
</li>
</ul>
</li>
</ul><h5 id="performance-of-demand-paging"><a class="anchor hidden-xs" href="#performance-of-demand-paging" title="performance-of-demand-paging"><span class="octicon octicon-link"></span></a>Performance of Demand Paging</h5><ul>
<li>Stages in Demand Paging</li>
</ul><blockquote>
<ol>
<li>Trap to the operating system</li>
<li>Save the user registers and process state</li>
<li>Determine that the interrupt was a page fault</li>
<li>Check that the page reference was legal and determine the location of the page on the disk</li>
<li>Issue a read from the disk to a free frame:<br>
(1) Wait in a queue for this device until the read request is serviced<br>
(2) Wait for the device seek and/or latency time<br>
(3) Begin the transfer of the page to a free frame</li>
<li>While waiting, allocate the CPU to some other user</li>
<li>Receive an interrupt from the disk I/O subsystem (I/O completed)</li>
<li>Save the registers and process state for the other user</li>
<li>Determine that the interrupt was from the disk</li>
<li>Correct the page table and other tables to show page is now in memory</li>
<li>Wait for the CPU to be allocated to this process again</li>
<li>Restore the user registers, process state, and new page table, and then resume the interrupted instruction</li>
</ol>
</blockquote><p><img src="https://i.imgur.com/HA817pb.png" alt=""></p><h3 id="五-copy-on-write"><a class="anchor hidden-xs" href="#五-copy-on-write" title="五-copy-on-write"><span class="octicon octicon-link"></span></a>(五) Copy-on-Write</h3><ul>
<li><strong>Copy-on-Write</strong> (COW) allows both parent and child processes to initially share the same pages in memory
<ul>
<li>If either process modifies a shared page, only then is the page copied</li>
</ul>
</li>
<li>COW allows more efficient process creation as only modified pages are copied</li>
<li>In general, free pages are allocated from a <strong>pool</strong> of <strong>zero-fill-on-demand</strong> pages
<ul>
<li>Why zero-out a page before allocating it?</li>
</ul>
</li>
<li><code>vfork()</code> variation on <code>fork()</code> system call has parent suspend and child using copy-on-write address space of parent
<ul>
<li>Designed to have child call <code>exec()</code></li>
<li>Very efficient</li>
</ul>
</li>
</ul><p><img src="http://i.imgur.com/LABMPPo.jpg" alt=""></p><h3 id="六-page-replacement"><a class="anchor hidden-xs" href="#六-page-replacement" title="六-page-replacement"><span class="octicon octicon-link"></span></a>(六) Page Replacement</h3><ul>
<li>Prevent over-allocation of memory by modifying page-fault service routine to include page replacement</li>
<li>Use <strong>modify (dirty) bit</strong> to reduce overhead of page transfers – only modified pages are written to disk</li>
<li>Page replacement completes separation between logical memory and physical memory – large virtual memory can be provided on a smaller physical memory</li>
</ul><h4 id="1-what-happens-if-there-is-no-free-frame"><a class="anchor hidden-xs" href="#1-what-happens-if-there-is-no-free-frame" title="1-what-happens-if-there-is-no-free-frame"><span class="octicon octicon-link"></span></a>1. What Happens if There is no Free Frame?</h4><ul>
<li>Used up by process pages</li>
<li>Also in demand from the kernel, I/O buffers, etc</li>
<li>How much to allocate to each?</li>
<li>Page replacement – find some page in memory, but not really in use, page it out
<ul>
<li>Algorithm – terminate? swap out? replace the page?</li>
<li>Performance – want an algorithm which will result in minimum number of page faults</li>
</ul>
</li>
<li>Same page may be brought into memory several times</li>
</ul><p><img src="https://i.imgur.com/eFpQyPv.png" alt=""></p><h4 id="2-basic-page-replacement"><a class="anchor hidden-xs" href="#2-basic-page-replacement" title="2-basic-page-replacement"><span class="octicon octicon-link"></span></a>2. Basic Page Replacement</h4><blockquote>
<ol>
<li>Find the location of the desired page on disk</li>
<li>Find a free frame:<br>
a. If there is a free frame, use it<br>
b. If there is no free frame, use a page replacement algorithm to select a <strong>victim frame</strong><br>
c. Write victim frame to disk if dirty</li>
<li>Bring the desired page into the (newly) free frame; update the page and frame tables</li>
<li>Continue the process by restarting the instruction that caused the trap</li>
</ol>
</blockquote><ul>
<li>Note now potentially 2 page transfers for page fault – increasing EAT</li>
</ul><p><img src="https://i.imgur.com/Hm6MvuN.png" alt=""></p><h4 id="3-page-and-frame-replacement-algorithms"><a class="anchor hidden-xs" href="#3-page-and-frame-replacement-algorithms" title="3-page-and-frame-replacement-algorithms"><span class="octicon octicon-link"></span></a>3. Page and Frame Replacement Algorithms</h4><ul>
<li><strong>Frame-allocation algorithm</strong> determines
<ul>
<li>How many frames to give each process</li>
<li>Which frames to replace</li>
</ul>
</li>
<li><strong>Page-replacement algorithm</strong>
<ul>
<li>Want lowest page-fault rate on both first access and re-access</li>
</ul>
</li>
<li>Evaluate algorithm by running it on a particular string of memory references (reference string) and computing the number of page faults on that string
<ul>
<li>String is just page numbers, not full addresses</li>
<li>Repeated access to the same page does not cause a page fault</li>
</ul>
</li>
</ul><h5 id="1-first-in-first-out-fifo-algorithm"><a class="anchor hidden-xs" href="#1-first-in-first-out-fifo-algorithm" title="1-first-in-first-out-fifo-algorithm"><span class="octicon octicon-link"></span></a>(1) First-In-First-Out (FIFO) Algorithm</h5><p><img src="https://i.imgur.com/cSezcCO.png" alt=""><br>
<img src="https://i.imgur.com/NVa4BTe.png" alt=""><br>
<img src="https://i.imgur.com/6VeXbGw.png" alt=""></p><h5 id="2-optimal-algorithm"><a class="anchor hidden-xs" href="#2-optimal-algorithm" title="2-optimal-algorithm"><span class="octicon octicon-link"></span></a>(2) Optimal Algorithm</h5><ul>
<li>Replace page that will not be used for longest period of time
<ul>
<li>9 is optimal for the example on the next slide</li>
</ul>
</li>
<li>How do you know this?
<ul>
<li>Can’t read the future</li>
</ul>
</li>
<li>Used for measuring how well your algorithm performs</li>
</ul><p><img src="https://i.imgur.com/1jc2ngr.png" alt=""></p><h5 id="3-least-recently-used-lru-algorithm"><a class="anchor hidden-xs" href="#3-least-recently-used-lru-algorithm" title="3-least-recently-used-lru-algorithm"><span class="octicon octicon-link"></span></a>(3) Least Recently Used (LRU) Algorithm</h5><ul>
<li>Use past knowledge rather than future</li>
<li>Replace page that has not been used in the most amount of time</li>
<li>Associate time of last use with each page</li>
</ul><p><img src="https://i.imgur.com/RiLxhrF.png" alt=""></p><ul>
<li>Counter implementation
<ul>
<li>Every page entry has a counter; every time page is referenced through this entry, copy the clock into the counter</li>
<li>When a page needs to be changed, look at the counters to find smallest value
<ul>
<li>Search through table needed</li>
</ul>
</li>
</ul>
</li>
<li>Stack implementation
<ul>
<li>Keep a stack of page numbers in a double link form:</li>
<li>Page referenced:
<ul>
<li>move it to the top</li>
<li>requires 6 pointers to be changed</li>
</ul>
</li>
<li>But each update more expensive</li>
<li>No search for replacement</li>
</ul>
</li>
<li>LRU and OPT are cases of <strong>stack algorithms</strong> that don’t have Belady’s Anomaly</li>
</ul><p><img src="http://i.imgur.com/yvsGPvm.jpg" alt=""></p><h5 id="4-lru-approximation-algorithms"><a class="anchor hidden-xs" href="#4-lru-approximation-algorithms" title="4-lru-approximation-algorithms"><span class="octicon octicon-link"></span></a>(4) LRU Approximation Algorithms</h5><ul>
<li>LRU needs special hardware and still slow</li>
<li><strong>Reference bit</strong>
<ul>
<li>With each page associate a bit, initially = 0</li>
<li>When page is referenced bit set to 1</li>
<li>Replace any with reference bit = 0 (if one exists)
<ul>
<li>We do not know the order, however</li>
</ul>
</li>
</ul>
</li>
<li><strong>Second-chance algorithm</strong>
<ul>
<li>Generally FIFO, plus hardware-provided reference bit</li>
<li>Clock replacement</li>
<li>If page to be replaced has
<ul>
<li>Reference bit = 0 -&gt; replace it</li>
<li>reference bit = 1 then:
<ul>
<li>set reference bit 0, leave page in memory</li>
<li>replace next page, subject to same rules</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul><p><img src="http://i.imgur.com/jInNXqt.png" alt=""></p><h5 id="5-counting-algorithms"><a class="anchor hidden-xs" href="#5-counting-algorithms" title="5-counting-algorithms"><span class="octicon octicon-link"></span></a>(5) Counting Algorithms</h5><ul>
<li>Keep a counter of the number of references that have been made to each page
<ul>
<li>Not common</li>
</ul>
</li>
<li><strong>LFU Algorithm</strong>: replaces page with smallest count</li>
<li><strong>MFU Algorithm</strong>: based on the argument that the page with the smallest count was probably just brought in and has yet to be used</li>
</ul><h5 id="6-page-buffering-algorithms"><a class="anchor hidden-xs" href="#6-page-buffering-algorithms" title="6-page-buffering-algorithms"><span class="octicon octicon-link"></span></a>(6) Page-Buffering Algorithms</h5><ul>
<li>Keep a pool of free frames, always
<ul>
<li>Then frame available when needed, not found at fault time</li>
<li>Read page into free frame and select victim to evict and add to free pool</li>
<li>When convenient, evict victim</li>
</ul>
</li>
<li>Possibly, keep list of modified pages
<ul>
<li>When backing store otherwise idle, write pages there and set to non-dirty</li>
</ul>
</li>
<li>Possibly, keep free frame contents intact and note what is in them
<ul>
<li>If referenced again before reused, no need to load contents again from disk</li>
<li>Generally useful to reduce penalty if wrong victim frame selected</li>
</ul>
</li>
</ul><h2 id="20170615"><a class="anchor hidden-xs" href="#20170615" title="20170615"><span class="octicon octicon-link"></span></a>20170615</h2><ul>
<li>課堂講義
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170615/ch09.pdf" target="_blank">Chapter 9: Virtual-Memory Management</a></li>
</ul>
</li>
</ul><h3 id="一-allocation-of-frames"><a class="anchor hidden-xs" href="#一-allocation-of-frames" title="一-allocation-of-frames"><span class="octicon octicon-link"></span></a>(一) Allocation of Frames</h3><ul>
<li>Each process needs minimum number of frames</li>
<li>Example: IBM 370 – 6 pages to handle SS MOVE instruction:
<ul>
<li>instruction is 6 bytes, might span 2 pages</li>
<li>2 pages to handle from</li>
<li>2 pages to handle to</li>
</ul>
</li>
<li>Maximum of course is total frames in the system</li>
<li>Two major allocation schemes
<ul>
<li>fixed allocation</li>
<li>priority allocation</li>
</ul>
</li>
<li>Many variations</li>
</ul><h4 id="1-fixed-allocation"><a class="anchor hidden-xs" href="#1-fixed-allocation" title="1-fixed-allocation"><span class="octicon octicon-link"></span></a>1. Fixed Allocation</h4><ul>
<li>Equal allocation – For example, if there are 100 frames (after allocating frames for the OS) and 5 processes, give each process 20 frames
<ul>
<li>Keep some as free frame buffer pool</li>
</ul>
</li>
<li>Proportional allocation – Allocate according to the size of process
<ul>
<li>Dynamic as degree of multiprogramming, process sizes change</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/EwupsLy.png" alt=""></p><h4 id="2-priority-allocation"><a class="anchor hidden-xs" href="#2-priority-allocation" title="2-priority-allocation"><span class="octicon octicon-link"></span></a>2. Priority Allocation</h4><ul>
<li>Use a proportional allocation scheme using priorities rather than size</li>
<li>If process P i generates a page fault,
<ul>
<li>select for replacement one of its frames</li>
<li>select for replacement a frame from a process with lower priority number</li>
</ul>
</li>
</ul><h4 id="3-global-vs-local-allocation"><a class="anchor hidden-xs" href="#3-global-vs-local-allocation" title="3-global-vs-local-allocation"><span class="octicon octicon-link"></span></a>3. Global vs. Local Allocation</h4><ul>
<li><strong>Global replacement</strong> – process selects a replacement frame from the set of all frames; one process can take a frame from another
<ul>
<li>But then process execution time can vary greatly</li>
<li>But greater throughput so more common</li>
</ul>
</li>
<li><strong>Local replacement</strong> – each process selects from only its own set of allocated frames
<ul>
<li>More consistent per-process performance</li>
<li>But possibly underutilized memory</li>
</ul>
</li>
</ul><h4 id="4-non-uniform-memory-access"><a class="anchor hidden-xs" href="#4-non-uniform-memory-access" title="4-non-uniform-memory-access"><span class="octicon octicon-link"></span></a>4. Non-Uniform Memory Access</h4><ul>
<li>So far all memory accessed equally</li>
<li>Many systems are NUMA – speed of access to memory varies
<ul>
<li>Consider system boards containing CPUs and memory, interconnected over a system bus</li>
</ul>
</li>
<li>Optimal performance comes from allocating memory “close to” the CPU on which the thread is scheduled
<ul>
<li>And modifying the scheduler to schedule the thread on the same system board when possible</li>
<li>Solved by Solaris by creating <strong>lgroups</strong>
<ul>
<li>Structure to track CPU / Memory low latency groups</li>
<li>Used my schedule and pager</li>
<li>When possible schedule all threads of a process and allocate all memory for that process within the lgroup</li>
</ul>
</li>
</ul>
</li>
</ul><h4 id="5-thrashing"><a class="anchor hidden-xs" href="#5-thrashing" title="5-thrashing"><span class="octicon octicon-link"></span></a>5. Thrashing</h4><ul>
<li>If a process does not have “enough” pages, the page-fault rate is very high
<ul>
<li>Page fault to get page</li>
<li>Replace existing frame</li>
<li>But quickly need replaced frame back</li>
<li>This leads to:
<ul>
<li>Low CPU utilization</li>
<li>Operating system thinking that it needs to increase the degree of multiprogramming</li>
<li>Another process added to the system</li>
</ul>
</li>
</ul>
</li>
<li><strong>Thrashing</strong> - a process is busy swapping pages in and out</li>
</ul><p><img src="https://i.imgur.com/jBcF8pC.png" alt=""></p><h4 id="6-demand-paging-and-thrashing"><a class="anchor hidden-xs" href="#6-demand-paging-and-thrashing" title="6-demand-paging-and-thrashing"><span class="octicon octicon-link"></span></a>6. Demand Paging and Thrashing</h4><ul>
<li>Why does demand paging work? <strong>Locality model</strong>
<ul>
<li>Process migrates from one locality to another</li>
<li>Localities may overlap</li>
</ul>
</li>
<li>Why does thrashing occur? <strong>size of locality &gt; total memory size</strong>
<ul>
<li>Limit effects by using local or priority page replacement</li>
</ul>
</li>
</ul><h4 id="7-working-set-model"><a class="anchor hidden-xs" href="#7-working-set-model" title="7-working-set-model"><span class="octicon octicon-link"></span></a>7. Working-Set Model</h4><p><img src="https://i.imgur.com/Nsrm3Lw.png" alt=""><br>
<img src="https://i.imgur.com/Xy48qM2.png" alt=""></p><ul>
<li><strong>Keeping Track of the Working Set</strong><br>
<img src="https://i.imgur.com/QHoALdo.png" alt=""></li>
</ul><h4 id="8-page-fault-frequency"><a class="anchor hidden-xs" href="#8-page-fault-frequency" title="8-page-fault-frequency"><span class="octicon octicon-link"></span></a>8. Page-Fault Frequency</h4><ul>
<li>More direct approach than WSS</li>
<li>Establish “acceptable” <strong>page-fault frequency</strong> rate and use local replacement policy
<ul>
<li>If actual rate too low, process loses frame</li>
<li>If actual rate too high, process gains frame</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/ws4FmRA.png" alt=""><br>
<img src="https://i.imgur.com/ujHWuKv.png" alt=""></p><h3 id="二-memory-mapped-files"><a class="anchor hidden-xs" href="#二-memory-mapped-files" title="二-memory-mapped-files"><span class="octicon octicon-link"></span></a>(二) Memory-Mapped Files</h3><ul>
<li>Memory-mapped file I/O allows file I/O to be treated as routine memory access by <strong>mapping</strong> a disk block to a page in memory</li>
<li>A file is initially read using demand paging
<ul>
<li>A page-sized portion of the file is read from the file system into a physical page</li>
<li>Subsequent reads/writes to/from the file are treated as ordinary memory accesses</li>
</ul>
</li>
<li>Simplifies and speeds file access by driving file I/O through memory rather than <code>read()</code> and <code>write()</code> system calls</li>
<li>Also allows several processes to map the same file allowing the pages in memory to be shared</li>
<li>But when does written data make it to disk?
<ul>
<li>Periodically and / or at file <code>close()</code> time</li>
<li>For example, when the pager scans for dirty pages</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/zWof78r.png" alt=""></p><h3 id="三-other-considerations-–-prepaging"><a class="anchor hidden-xs" href="#三-other-considerations-–-prepaging" title="三-other-considerations-–-prepaging"><span class="octicon octicon-link"></span></a>(三) Other Considerations – Prepaging</h3><ul>
<li>To reduce the large number of page faults that occurs at process startup</li>
<li>Prepage all or some of the pages a process will need, before they are referenced</li>
<li>But if prepaged pages are unused, I/O and memory was wasted</li>
<li>Assume s pages are prepaged and α of the pages is used
<ul>
<li>Is cost of <code>s * α</code> save pages faults <code>&gt;</code> or <code>&lt;</code> than the cost of prepaging <code>s * (1-α)</code> unnecessary pages?</li>
<li>α near zero &gt;&gt; prepaging loses</li>
</ul>
</li>
</ul><h3 id="四-other-issues"><a class="anchor hidden-xs" href="#四-other-issues" title="四-other-issues"><span class="octicon octicon-link"></span></a>(四) Other Issues</h3><h2 id="tip98"><a class="anchor hidden-xs" href="#" title=""><span class="octicon octicon-link"></span></a><img src="https://i.imgur.com/289vIx7.png" alt=""></h2><h2 id="tip99"><a class="anchor hidden-xs" href="#" title=""><span class="octicon octicon-link"></span></a><img src="https://i.imgur.com/AzOr7n2.png" alt=""></h2><h2 id="tip100"><a class="anchor hidden-xs" href="#" title=""><span class="octicon octicon-link"></span></a><img src="https://i.imgur.com/9ZuU18h.png" alt=""></h2><p><img src="https://i.imgur.com/cHTpyGG.png" alt=""></p></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc"><ul class="nav"><li class=""><a href="#作業系統">作業系統</a><ul class="nav"><li><a href="#20170302">20170302</a></li><li><a href="#20170309">20170309</a><ul class="nav"><li><a href="#一-process-in-memory">(一) Process in Memory</a></li><li><a href="#二-process-state">(二) Process State</a></li><li><a href="#三-process-control-block-pcb">(三) Process Control Block (PCB)</a></li><li><a href="#四-process-switch">(四) Process Switch</a></li><li><a href="#五-process、thread">(五) Process、Thread</a></li><li><a href="#六-process-scheduling">(六) Process Scheduling</a></li><li><a href="#schedulers">Schedulers</a></li><li><a href="#processes">Processes</a></li><li><a href="#七-process-creation">(七) Process Creation</a></li></ul></li><li><a href="#20170316">20170316</a><ul class="nav"><li><a href="#一、basic-concepts">一、Basic Concepts</a></li><li><a href="#二、cpu-scheduler">二、CPU Scheduler</a></li><li><a href="#三、dispatcher">三、Dispatcher</a></li><li><a href="#四、scheduling-algorithm-optimization-criteria">四、Scheduling Algorithm Optimization Criteria</a></li><li><a href="#五、scheduling-algorithm">五、Scheduling Algorithm</a></li><li><a href="#課程作業">課程作業</a></li></ul></li><li><a href="#20170323">20170323</a><ul class="nav"><li><a href="#multithread-architecture">Multithread Architecture</a></li><li><a href="#一、multicore-programming">一、Multicore Programming</a></li><li><a href="#二、concurrency-vs-parallelism">二、Concurrency vs Parallelism</a></li><li><a href="#三、single-and-multithreaded-processes">三、Single and Multithreaded Processes</a></li><li><a href="#四、user-threads-and-kernel-threads">四、User Threads and Kernel Threads</a></li><li><a href="#五、multithreading-models">五、Multithreading Models</a></li><li><a href="#六、pthreads">六、Pthreads</a></li><li><a href="#課程作業1">課程作業</a></li></ul></li><li><a href="#20170330">20170330</a><ul class="nav"><li><a href="#一-thread-synchronization">(一) Thread Synchronization</a></li><li><a href="#1-semaphore">1. Semaphore</a></li><li><a href="#2-mutex">2. Mutex</a></li><li><a href="#3-condition-variables">3. Condition Variables</a></li><li><a href="#4-barrier">4. Barrier</a></li><li><a href="#二-producer-consumer-problem">(二) Producer-Consumer Problem</a></li><li><a href="#課程作業2">課程作業</a></li></ul></li><li><a href="#20170406">20170406</a><ul class="nav"><li><a href="#一-thread-pools">(一) Thread Pools</a></li><li><a href="#二-openmp">(二) OpenMP</a></li><li><a href="#三-threading-issues">(三) Threading Issues</a></li><li><a href="#四-thread-scheduling">(四) Thread Scheduling</a></li><li><a href="#五-pthread-scheduling">(五) Pthread Scheduling</a></li><li><a href="#六-multiple-processor-scheduling">(六) Multiple-Processor Scheduling</a></li><li><a href="#七-socket-message-passing">(七) Socket - Message Passing</a></li><li><a href="#課程作業3">課程作業</a></li></ul></li><li><a href="#20170413">20170413</a><ul class="nav"><li><a href="#一-direct-communication">(一) Direct Communication</a></li><li><a href="#二-indirect-communication">(二) Indirect Communication</a></li><li><a href="#三-synchronization">(三) Synchronization</a></li><li><a href="#四-buffering">(四) Buffering</a></li><li><a href="#examples-of-ipc-systems">Examples of IPC Systems</a></li><li><a href="#五-communications-in-client-server-systems">(五) Communications in Client-Server Systems</a></li><li><a href="#課堂作業">課堂作業</a></li></ul></li><li><a href="#20170424">20170424</a><ul class="nav"><li><a href="#race-condition">Race Condition</a></li><li><a href="#一-critical-section-problem">(一) Critical-Section Problem</a></li><li><a href="#二-solution-to-critical-section-problem">(二) Solution to Critical-Section Problem</a></li><li><a href="#三-peterson’s-solution">(三) Peterson’s Solution</a></li><li><a href="#四-synchronization-hardware">(四) Synchronization Hardware</a></li><li><a href="#五-mutex-locks">(五) Mutex Locks</a></li></ul></li><li><a href="#20170504">20170504</a><ul class="nav"><li><a href="#一-semaphore">(一) Semaphore</a></li><li><a href="#二-deadlock-and-starvation">(二) Deadlock and Starvation</a></li><li><a href="#三-classical-problems-of-synchronization">(三) Classical Problems of Synchronization</a></li></ul></li><li><a href="#20170511">20170511</a><ul class="nav"><li><a href="#一-deadlock-characterization">(一) Deadlock Characterization</a></li><li><a href="#二-resource-allocation-graph">(二) Resource-Allocation Graph</a></li><li><a href="#三-deadlock-prevention">(三) Deadlock Prevention</a></li></ul></li><li><a href="#20170518">20170518</a><ul class="nav"><li><a href="#一-deadlock-detection">(一) Deadlock Detection</a></li><li><a href="#二-detection-algorithm">(二) Detection Algorithm</a></li><li><a href="#三-recovery-from-deadlock">(三) Recovery from Deadlock</a></li><li><a href="#四-memory-management">(四) Memory-Management</a></li></ul></li><li><a href="#20170525">20170525</a><ul class="nav"><li><a href="#一-contiguous-allocation">(一) Contiguous Allocation</a></li><li><a href="#二-dynamic-storage-allocation-problem">(二) Dynamic Storage-Allocation Problem</a></li><li><a href="#三-fragmentation">(三) Fragmentation</a></li><li><a href="#四-segmentation">(四) Segmentation</a></li></ul></li><li><a href="#20170601">20170601</a><ul class="nav"><li><a href="#一-paging">(一) Paging</a></li><li><a href="#二-address-translation-scheme">(二) Address Translation Scheme</a></li><li><a href="#三-implementation-of-page-table">(三) Implementation of Page Table</a></li><li><a href="#四-effective-access-time">(四) Effective Access Time</a></li><li><a href="#五-memory-protection">(五) Memory Protection</a></li><li><a href="#六-shared-pages">(六) Shared Pages</a></li><li><a href="#七-structure-of-the-page-table">(七) Structure of the Page Table</a></li></ul></li><li><a href="#20170608">20170608</a><ul class="nav"><li><a href="#一-background">(一) Background</a></li><li><a href="#二-virtual-address-space">(二) Virtual Address Space</a></li><li><a href="#三-demand-paging">(三) Demand Paging</a></li><li><a href="#四-page-fault">(四) Page Fault</a></li><li><a href="#五-copy-on-write">(五) Copy-on-Write</a></li><li><a href="#六-page-replacement">(六) Page Replacement</a></li></ul></li><li><a href="#20170615">20170615</a><ul class="nav"><li><a href="#一-allocation-of-frames">(一) Allocation of Frames</a></li><li><a href="#二-memory-mapped-files">(二) Memory-Mapped Files</a></li><li><a href="#三-other-considerations-–-prepaging">(三) Other Considerations – Prepaging</a></li><li><a href="#四-other-issues">(四) Other Issues</a></li></ul></li><li><a href="#tip98"></a></li><li><a href="#tip99"></a></li><li><a href="#tip100"></a></li></ul></li></ul></div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;"  >
        <div class="toc"><ul class="nav"><li class=""><a href="#作業系統">作業系統</a><ul class="nav"><li><a href="#20170302">20170302</a></li><li><a href="#20170309">20170309</a><ul class="nav"><li><a href="#一-process-in-memory">(一) Process in Memory</a></li><li><a href="#二-process-state">(二) Process State</a></li><li><a href="#三-process-control-block-pcb">(三) Process Control Block (PCB)</a></li><li><a href="#四-process-switch">(四) Process Switch</a></li><li><a href="#五-process、thread">(五) Process、Thread</a></li><li><a href="#六-process-scheduling">(六) Process Scheduling</a></li><li><a href="#schedulers">Schedulers</a></li><li><a href="#processes">Processes</a></li><li><a href="#七-process-creation">(七) Process Creation</a></li></ul></li><li><a href="#20170316">20170316</a><ul class="nav"><li><a href="#一、basic-concepts">一、Basic Concepts</a></li><li><a href="#二、cpu-scheduler">二、CPU Scheduler</a></li><li><a href="#三、dispatcher">三、Dispatcher</a></li><li><a href="#四、scheduling-algorithm-optimization-criteria">四、Scheduling Algorithm Optimization Criteria</a></li><li><a href="#五、scheduling-algorithm">五、Scheduling Algorithm</a></li><li><a href="#課程作業">課程作業</a></li></ul></li><li><a href="#20170323">20170323</a><ul class="nav"><li><a href="#multithread-architecture">Multithread Architecture</a></li><li><a href="#一、multicore-programming">一、Multicore Programming</a></li><li><a href="#二、concurrency-vs-parallelism">二、Concurrency vs Parallelism</a></li><li><a href="#三、single-and-multithreaded-processes">三、Single and Multithreaded Processes</a></li><li><a href="#四、user-threads-and-kernel-threads">四、User Threads and Kernel Threads</a></li><li><a href="#五、multithreading-models">五、Multithreading Models</a></li><li><a href="#六、pthreads">六、Pthreads</a></li><li><a href="#課程作業1">課程作業</a></li></ul></li><li><a href="#20170330">20170330</a><ul class="nav"><li><a href="#一-thread-synchronization">(一) Thread Synchronization</a></li><li><a href="#1-semaphore">1. Semaphore</a></li><li><a href="#2-mutex">2. Mutex</a></li><li><a href="#3-condition-variables">3. Condition Variables</a></li><li><a href="#4-barrier">4. Barrier</a></li><li><a href="#二-producer-consumer-problem">(二) Producer-Consumer Problem</a></li><li><a href="#課程作業2">課程作業</a></li></ul></li><li><a href="#20170406">20170406</a><ul class="nav"><li><a href="#一-thread-pools">(一) Thread Pools</a></li><li><a href="#二-openmp">(二) OpenMP</a></li><li><a href="#三-threading-issues">(三) Threading Issues</a></li><li><a href="#四-thread-scheduling">(四) Thread Scheduling</a></li><li><a href="#五-pthread-scheduling">(五) Pthread Scheduling</a></li><li><a href="#六-multiple-processor-scheduling">(六) Multiple-Processor Scheduling</a></li><li><a href="#七-socket-message-passing">(七) Socket - Message Passing</a></li><li><a href="#課程作業3">課程作業</a></li></ul></li><li><a href="#20170413">20170413</a><ul class="nav"><li><a href="#一-direct-communication">(一) Direct Communication</a></li><li><a href="#二-indirect-communication">(二) Indirect Communication</a></li><li><a href="#三-synchronization">(三) Synchronization</a></li><li><a href="#四-buffering">(四) Buffering</a></li><li><a href="#examples-of-ipc-systems">Examples of IPC Systems</a></li><li><a href="#五-communications-in-client-server-systems">(五) Communications in Client-Server Systems</a></li><li><a href="#課堂作業">課堂作業</a></li></ul></li><li><a href="#20170424">20170424</a><ul class="nav"><li><a href="#race-condition">Race Condition</a></li><li><a href="#一-critical-section-problem">(一) Critical-Section Problem</a></li><li><a href="#二-solution-to-critical-section-problem">(二) Solution to Critical-Section Problem</a></li><li><a href="#三-peterson’s-solution">(三) Peterson’s Solution</a></li><li><a href="#四-synchronization-hardware">(四) Synchronization Hardware</a></li><li><a href="#五-mutex-locks">(五) Mutex Locks</a></li></ul></li><li><a href="#20170504">20170504</a><ul class="nav"><li><a href="#一-semaphore">(一) Semaphore</a></li><li><a href="#二-deadlock-and-starvation">(二) Deadlock and Starvation</a></li><li><a href="#三-classical-problems-of-synchronization">(三) Classical Problems of Synchronization</a></li></ul></li><li><a href="#20170511">20170511</a><ul class="nav"><li><a href="#一-deadlock-characterization">(一) Deadlock Characterization</a></li><li><a href="#二-resource-allocation-graph">(二) Resource-Allocation Graph</a></li><li><a href="#三-deadlock-prevention">(三) Deadlock Prevention</a></li></ul></li><li><a href="#20170518">20170518</a><ul class="nav"><li><a href="#一-deadlock-detection">(一) Deadlock Detection</a></li><li><a href="#二-detection-algorithm">(二) Detection Algorithm</a></li><li><a href="#三-recovery-from-deadlock">(三) Recovery from Deadlock</a></li><li><a href="#四-memory-management">(四) Memory-Management</a></li></ul></li><li><a href="#20170525">20170525</a><ul class="nav"><li><a href="#一-contiguous-allocation">(一) Contiguous Allocation</a></li><li><a href="#二-dynamic-storage-allocation-problem">(二) Dynamic Storage-Allocation Problem</a></li><li><a href="#三-fragmentation">(三) Fragmentation</a></li><li><a href="#四-segmentation">(四) Segmentation</a></li></ul></li><li><a href="#20170601">20170601</a><ul class="nav"><li><a href="#一-paging">(一) Paging</a></li><li><a href="#二-address-translation-scheme">(二) Address Translation Scheme</a></li><li><a href="#三-implementation-of-page-table">(三) Implementation of Page Table</a></li><li><a href="#四-effective-access-time">(四) Effective Access Time</a></li><li><a href="#五-memory-protection">(五) Memory Protection</a></li><li><a href="#六-shared-pages">(六) Shared Pages</a></li><li><a href="#七-structure-of-the-page-table">(七) Structure of the Page Table</a></li></ul></li><li><a href="#20170608">20170608</a><ul class="nav"><li><a href="#一-background">(一) Background</a></li><li><a href="#二-virtual-address-space">(二) Virtual Address Space</a></li><li><a href="#三-demand-paging">(三) Demand Paging</a></li><li><a href="#四-page-fault">(四) Page Fault</a></li><li><a href="#五-copy-on-write">(五) Copy-on-Write</a></li><li><a href="#六-page-replacement">(六) Page Replacement</a></li></ul></li><li><a href="#20170615">20170615</a><ul class="nav"><li><a href="#一-allocation-of-frames">(一) Allocation of Frames</a></li><li><a href="#二-memory-mapped-files">(二) Memory-Mapped Files</a></li><li><a href="#三-other-considerations-–-prepaging">(三) Other Considerations – Prepaging</a></li><li><a href="#四-other-issues">(四) Other Issues</a></li></ul></li><li><a href="#tip98"></a></li><li><a href="#tip99"></a></li><li><a href="#tip100"></a></li></ul></li></ul></div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
