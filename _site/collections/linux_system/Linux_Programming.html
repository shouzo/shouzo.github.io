<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>
        Linux 系統與程式設計 - HackMD
    </title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
    <link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css" integrity="sha256-3iu9jgsy9TpTwXKb7bNQzqWekRX7pPK+2OLj3R922fo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.5.0/octicons.min.css" integrity="sha256-QiWfLIsCT02Sdwkogf6YMiQlj4NE84MKkzEMkZnMGdg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.5.1/themes/prism.min.css" integrity="sha256-vtR0hSWRc3Tb26iuN2oZHt3KRUomwTufNIf5/4oeCyg=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/github-gist.min.css" integrity="sha256-tAflq+ymku3Khs+I/WcAneIlafYgDiOQ9stIHH985Wo=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/emojify.js/1.1.0/css/basic/emojify.min.css" integrity="sha256-UOrvMOsSDSrW6szVLe8ZDZezBxh5IoIfgTwdNDgTjiU=" crossorigin="anonymous" />
    <style>
        @import url(https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,600,600italic,300italic,300|Source+Serif+Pro|Source+Code+Pro:400,300,500&subset=latin,latin-ext);.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body .absent{color:#c00}.markdown-body .anchor{float:left;padding-right:4px;margin-left:-20px;line-height:1}.markdown-body .anchor:focus{outline:none}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e7e7e7;border:0}.markdown-body blockquote{padding:0 1em;color:#777;border-left:.25em solid #ddd}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body .loweralpha{list-style-type:lower-alpha}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#000;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1 code,.markdown-body h1 tt,.markdown-body h2 code,.markdown-body h2 tt,.markdown-body h3 code,.markdown-body h3 tt,.markdown-body h4 code,.markdown-body h4 tt,.markdown-body h5 code,.markdown-body h5 tt,.markdown-body h6 code,.markdown-body h6 tt{font-size:inherit}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eee}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#777}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol.no-list,.markdown-body ul.no-list{padding:0;list-style-type:none}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}.markdown-body table th{font-weight:700}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #ddd}.markdown-body table tr{background-color:#fff;border-top:1px solid #ccc}.markdown-body table tr:nth-child(2n){background-color:#f8f8f8}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body .emoji{max-width:none;vertical-align:text-top;background-color:transparent}.markdown-body span.frame{display:block;overflow:hidden}.markdown-body span.frame>span{display:block;float:left;width:auto;padding:7px;margin:13px 0 0;overflow:hidden;border:1px solid #ddd}.markdown-body span.frame span img{display:block;float:left}.markdown-body span.frame span span{display:block;padding:5px 0 0;clear:both;color:#333}.markdown-body span.align-center{display:block;overflow:hidden;clear:both}.markdown-body span.align-center>span{display:block;margin:13px auto 0;overflow:hidden;text-align:center}.markdown-body span.align-center span img{margin:0 auto;text-align:center}.markdown-body span.align-right{display:block;overflow:hidden;clear:both}.markdown-body span.align-right>span{display:block;margin:13px 0 0;overflow:hidden;text-align:right}.markdown-body span.align-right span img{margin:0;text-align:right}.markdown-body span.float-left{display:block;float:left;margin-right:13px;overflow:hidden}.markdown-body span.float-left span{margin:13px 0 0}.markdown-body span.float-right{display:block;float:right;margin-left:13px;overflow:hidden}.markdown-body span.float-right>span{display:block;margin:13px auto 0;overflow:hidden;text-align:right}.markdown-body code,.markdown-body tt{padding:0;padding-top:.2em;padding-bottom:.2em;margin:0;font-size:85%;background-color:rgba(0,0,0,.04);border-radius:3px}.markdown-body code:after,.markdown-body code:before,.markdown-body tt:after,.markdown-body tt:before{letter-spacing:-.2em;content:"\A0"}.markdown-body code br,.markdown-body tt br{display:none}.markdown-body del code{text-decoration:inherit}.markdown-body pre{word-wrap:normal}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f7f7f7;border-radius:3px}.markdown-body pre code,.markdown-body pre tt{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code:after,.markdown-body pre code:before,.markdown-body pre tt:after,.markdown-body pre tt:before{content:normal}.markdown-body .csv-data td,.markdown-body .csv-data th{padding:5px;overflow:hidden;font-size:12px;line-height:1;text-align:left;white-space:nowrap}.markdown-body .csv-data .blob-line-num{padding:10px 8px 9px;text-align:right;background:#fff;border:0}.markdown-body .csv-data tr{border-top:0}.markdown-body .csv-data th{font-weight:700;background:#f8f8f8;border-top:0}.markdown-body kbd{display:inline-block;padding:3px 5px;font-size:11px;line-height:10px;color:#555;vertical-align:middle;background-color:#fcfcfc;border:1px solid #ccc;border-bottom-color:#bbb;border-radius:3px;box-shadow:inset 0 -1px 0 #bbb}.news .alert .markdown-body blockquote{padding:0 0 0 40px;border:0 none}.activity-tab .news .alert .commits,.activity-tab .news .markdown-body blockquote{padding-left:0}.task-list-item{list-style-type:none}.task-list-item label{font-weight:400}.task-list-item.enabled label{cursor:pointer}.task-list-item+.task-list-item{margin-top:3px}.task-list-item-checkbox{float:left;margin:.31em 0 .2em -1.3em!important;vertical-align:middle;cursor:default!important}.markdown-body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,sans-serif;padding-top:40px;padding-bottom:40px;max-width:758px;overflow:visible!important}.markdown-body pre{border:inherit!important}.markdown-body code{color:inherit!important}.markdown-body pre code .wrapper{display:-moz-inline-flex;display:-ms-inline-flex;display:-o-inline-flex;display:inline-flex}.markdown-body pre code .gutter{float:left;overflow:hidden;-webkit-user-select:none;user-select:none}.markdown-body pre code .gutter.linenumber{text-align:right;position:relative;display:inline-block;cursor:default;z-index:4;padding:0 8px 0 0;min-width:20px;box-sizing:content-box;color:#afafaf!important;border-right:3px solid #6ce26c!important}.markdown-body pre code .gutter.linenumber>span:before{content:attr(data-linenumber)}.markdown-body pre code .code{float:left;margin:0 0 0 16px}.markdown-body .gist .line-numbers{border-left:none;border-top:none;border-bottom:none}.markdown-body .gist .line-data{border:none}.markdown-body .gist table{border-spacing:0;border-collapse:inherit!important}.markdown-body code[data-gist-id]{background:none;padding:0}.markdown-body code[data-gist-id]:after,.markdown-body code[data-gist-id]:before{content:""}.markdown-body code[data-gist-id] .blob-num{border:unset}.markdown-body code[data-gist-id] table{overflow:unset;margin-bottom:unset}.markdown-body code[data-gist-id] table tr{background:unset}.markdown-body[dir=rtl] pre{direction:ltr}.markdown-body[dir=rtl] code{direction:ltr;unicode-bidi:embed}.markdown-body .alert>p{margin-bottom:0}.markdown-body pre.abc,.markdown-body pre.flow-chart,.markdown-body pre.graphviz,.markdown-body pre.mermaid,.markdown-body pre.sequence-diagram{text-align:center;background-color:inherit;border-radius:0;white-space:inherit}.markdown-body pre.abc>code,.markdown-body pre.flow-chart>code,.markdown-body pre.graphviz>code,.markdown-body pre.mermaid>code,.markdown-body pre.sequence-diagram>code{text-align:left}.markdown-body pre.abc>svg,.markdown-body pre.flow-chart>svg,.markdown-body pre.graphviz>svg,.markdown-body pre.mermaid>svg,.markdown-body pre.sequence-diagram>svg{max-width:100%;height:100%}.markdown-body pre>code.wrap{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word}.markdown-body .alert>p,.markdown-body .alert>ul{margin-bottom:0}.vimeo,.youtube{cursor:pointer;display:table;text-align:center;background-position:50%;background-repeat:no-repeat;background-size:contain;background-color:#000;overflow:hidden}.vimeo,.youtube{position:relative;width:100%}.youtube{padding-bottom:56.25%}.vimeo img{width:100%;object-fit:contain;z-index:0}.youtube img{object-fit:cover;z-index:0}.vimeo iframe,.youtube iframe,.youtube img{width:100%;height:100%;position:absolute;top:0;left:0}.vimeo iframe,.youtube iframe{vertical-align:middle;z-index:1}.vimeo .icon,.youtube .icon{position:absolute;height:auto;width:auto;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;opacity:.3;transition:opacity .2s;z-index:0}.vimeo:hover .icon,.youtube:hover .icon{opacity:.6;transition:opacity .2s}.slideshare .inner,.speakerdeck .inner{position:relative;width:100%}.slideshare .inner iframe,.speakerdeck .inner iframe{position:absolute;top:0;bottom:0;left:0;right:0;width:100%;height:100%}.MJX_Assistive_MathML{display:none}.ui-infobar{position:relative;z-index:2;max-width:758px;margin-top:25px;margin-bottom:-25px;color:#777}.ui-toc{position:fixed;bottom:20px;z-index:10000}.ui-toc-label{opacity:.3;background-color:#ccc;border:none;transition:opacity .2s}.ui-toc .open .ui-toc-label{opacity:1;color:#fff;transition:opacity .2s}.ui-toc-label:focus{opacity:.3;background-color:#ccc;color:#000}.ui-toc-label:hover{opacity:1;background-color:#ccc;transition:opacity .2s}.ui-toc-dropdown{margin-top:23px;margin-bottom:20px;padding-left:10px;padding-right:10px;max-width:45vw;width:25vw;max-height:70vh;overflow:auto;text-align:inherit}.ui-toc-dropdown>.toc{max-height:calc(70vh - 100px);overflow:auto}.ui-toc-dropdown[dir=rtl] .nav{padding-right:0;letter-spacing:.0029em}.ui-toc-dropdown a{overflow:hidden;text-overflow:ellipsis;white-space:pre}.ui-toc-dropdown .nav>li>a{display:block;padding:4px 20px;font-size:13px;font-weight:500;color:#767676}.ui-toc-dropdown .nav>li:first-child:last-child > ul,.ui-toc-dropdown .toc.expand ul{display:block}.ui-toc-dropdown .nav>li>a:focus,.ui-toc-dropdown .nav>li>a:hover{padding-left:19px;color:#000;text-decoration:none;background-color:transparent;border-left:1px solid #000}.ui-toc-dropdown[dir=rtl] .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav>li>a:hover{padding-right:19px;border-left:none;border-right:1px solid #000}.ui-toc-dropdown .nav>.active:focus>a,.ui-toc-dropdown .nav>.active:hover>a,.ui-toc-dropdown .nav>.active>a{padding-left:18px;font-weight:700;color:#000;background-color:transparent;border-left:2px solid #000}.ui-toc-dropdown[dir=rtl] .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav>.active>a{padding-right:18px;border-left:none;border-right:2px solid #000}.ui-toc-dropdown .nav .nav{display:none;padding-bottom:10px}.ui-toc-dropdown .nav>.active>ul{display:block}.ui-toc-dropdown .nav .nav>li>a{padding-top:1px;padding-bottom:1px;padding-left:30px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a{padding-right:30px}.ui-toc-dropdown .nav .nav>li>ul>li>a{padding-top:1px;padding-bottom:1px;padding-left:40px;font-size:12px;font-weight:400}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a{padding-right:40px}.ui-toc-dropdown .nav .nav>li>a:focus,.ui-toc-dropdown .nav .nav>li>a:hover{padding-left:29px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>a:hover{padding-right:29px}.ui-toc-dropdown .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown .nav .nav>li>ul>li>a:hover{padding-left:39px}.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:focus,.ui-toc-dropdown[dir=rtl] .nav .nav>li>ul>li>a:hover{padding-right:39px}.ui-toc-dropdown .nav .nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>a{padding-left:28px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>a{padding-right:28px}.ui-toc-dropdown .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown .nav .nav>.active>.nav>.active>a{padding-left:38px;font-weight:500}.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:focus>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active:hover>a,.ui-toc-dropdown[dir=rtl] .nav .nav>.active>.nav>.active>a{padding-right:38px}.markdown-body[lang^=ja]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,Hiragino Kaku Gothic Pro,\\30D2\30E9\30AE\30CE\89D2\30B4 Pro W3,Osaka,Meiryo,\\30E1\30A4\30EA\30AA,MS Gothic,"\FF2D\FF33   \30B4\30B7\30C3\30AF",sans-serif}.ui-toc-dropdown[lang^=ja]{font-family:Source Sans Pro,Helvetica,Arial,Meiryo UI,MS PGothic,"\FF2D\FF33   \FF30\30B4\30B7\30C3\30AF",sans-serif}.markdown-body[lang=zh-tw]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang TC,Microsoft JhengHei,\\5FAE\8EDF\6B63\9ED1,sans-serif}.ui-toc-dropdown[lang=zh-tw]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft JhengHei UI,\\5FAE\8EDF\6B63\9ED1UI,sans-serif}.markdown-body[lang=zh-cn]{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Helvetica,Arial,PingFang SC,Microsoft YaHei,\\5FAE\8F6F\96C5\9ED1,sans-serif}.ui-toc-dropdown[lang=zh-cn]{font-family:Source Sans Pro,Helvetica,Arial,Microsoft YaHei UI,\\5FAE\8F6F\96C5\9ED1UI,sans-serif}.ui-affix-toc{position:fixed;top:0;max-width:15vw;max-height:70vh;overflow:auto}.back-to-top,.expand-toggle,.go-to-bottom{display:block;padding:4px 10px;margin-top:10px;margin-left:10px;font-size:12px;font-weight:500;color:#999}.back-to-top:focus,.back-to-top:hover,.expand-toggle:focus,.expand-toggle:hover,.go-to-bottom:focus,.go-to-bottom:hover{color:#563d7c;text-decoration:none}.back-to-top,.go-to-bottom{margin-top:0}.ui-user-icon{width:20px;height:20px;display:block;border-radius:3px;margin-top:2px;margin-bottom:2px;margin-right:5px;background-position:50%;background-repeat:no-repeat;background-size:contain}.ui-user-icon.small{width:18px;height:18px;display:inline-block;vertical-align:middle;margin:0 0 .2em}small span{line-height:22px}small .dropdown{display:inline-block}small .dropdown a:focus,small .dropdown a:hover{text-decoration:none}.unselectable{-moz-user-select:none;-webkit-user-select:none;-o-user-select:none;user-select:none}@media print{blockquote,div,img,pre,table{page-break-inside:avoid!important}a[href]:after{font-size:12px!important}}.markdown-body.slides{position:relative;z-index:1;color:#222}.markdown-body.slides:before{content:"";display:block;position:absolute;top:0;left:0;right:0;bottom:0;z-index:-1;background-color:currentColor;box-shadow:0 0 0 50vw}.markdown-body.slides section[data-markdown]{position:relative;margin-bottom:1.5em;background-color:#fff;text-align:center}.markdown-body.slides section[data-markdown] code{text-align:left}.markdown-body.slides section[data-markdown]:before{content:"";display:block;padding-bottom:56.23%}.markdown-body.slides section[data-markdown]>div:first-child{position:absolute;top:50%;left:1em;right:1em;transform:translateY(-50%);max-height:100%;overflow:hidden}.markdown-body.slides section[data-markdown]>ul{display:inline-block}.markdown-body.slides>section>section+section:after{content:"";position:absolute;top:-1.5em;right:1em;height:1.5em;border:3px solid #777}body{font-smoothing:subpixel-antialiased!important;-webkit-font-smoothing:subpixel-antialiased!important;-moz-osx-font-smoothing:auto!important;text-shadow:0 0 1em transparent,1px 1px 1.2px rgba(0,0,0,.004);-webkit-overflow-scrolling:touch;font-family:Source Sans Pro,Helvetica,Arial,sans-serif;letter-spacing:.025em}.focus,:focus{outline:none!important}::-moz-focus-inner{border:0!important}body.modal-open{overflow-y:auto;padding-right:0!important}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
    <![endif]-->
</head>

<body>
    <div id="doc" class="markdown-body container-fluid"><h1 id="linux-系統與程式設計"><a class="anchor hidden-xs" href="#linux-系統與程式設計" title="linux-系統與程式設計"><span class="octicon octicon-link"></span></a>Linux 系統與程式設計</h1><h6 id="tags-linux-系統與程式設計"><a class="anchor hidden-xs" href="#tags-linux-系統與程式設計" title="tags-linux-系統與程式設計"><span class="octicon octicon-link"></span></a>tags: <code>Linux 系統與程式設計</code></h6><ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/tree/master/class-tutorial" target="_blank">課程資料：Linux-Programming</a></li>
</ul><h2 id="20170303"><a class="anchor hidden-xs" href="#20170303" title="20170303"><span class="octicon octicon-link"></span></a>20170303</h2><ul>
<li>
<p><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170310/Creating_and_Executing_Processes.pdf" target="_blank">課程簡報 - Creating and Executing Processes</a></p>
</li>
<li>
<p>程式作業： <code>fork()</code> 的概念</p>
</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
<span class="hljs-comment">/* Press any Integer */</span>
	<span class="hljs-keyword">int</span> n;
	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, &amp;n);

<span class="hljs-comment">/* Use "fork()" to create Child's and Parent's process */</span>
	<span class="hljs-keyword">int</span> ret = fork();
	<span class="hljs-keyword">int</span> result = n;	<span class="hljs-comment">// Set the "result" initial value</span>

	<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>) {	<span class="hljs-comment">// Child's entry</span>
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n***** Child's pid = %d *****\n"</span>, getpid());
		<span class="hljs-keyword">while</span> (n --&gt; <span class="hljs-number">0</span>)
			result += n;
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"1 + 2 + ... + n = %d\n"</span>, result);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	
	} <span class="hljs-keyword">else</span> {	<span class="hljs-comment">// Parent's entry</span>
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"***** Parent's pid = %d *****\n"</span>, getpid());
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"n 的因數：%d"</span>, n);
		<span class="hljs-keyword">while</span> (n --&gt; <span class="hljs-number">1</span>)
			<span class="hljs-keyword">if</span> (result % n == <span class="hljs-number">0</span>)
				<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\t%d"</span>, n);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
	}
}
</code></pre><p><img src="https://i.imgur.com/TKyt2rB.jpg" alt=""></p><h3 id="延伸學習"><a class="anchor hidden-xs" href="#延伸學習" title="延伸學習"><span class="octicon octicon-link"></span></a>延伸學習</h3><ul>
<li><a href="http://stackoverflow.com/questions/19990704/how-why-can-fork-fail" target="_blank">How/Why can fork() fail</a></li>
<li><a href="https://read01.com/oOOdk6.html" target="_blank">EAGAIN 含意</a></li>
</ul><h2 id="20170310"><a class="anchor hidden-xs" href="#20170310" title="20170310"><span class="octicon octicon-link"></span></a>20170310</h2><ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170310/Creating_and_Executing_Processes.pdf" target="_blank">課程簡報 - Creating and Executing Processes</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170310/Signals.pdf" target="_blank">課程練習 - Signal</a></li>
</ul><h3 id="一-unix-system-call"><a class="anchor hidden-xs" href="#一-unix-system-call" title="一-unix-system-call"><span class="octicon octicon-link"></span></a>(一) Unix system call</h3><h4 id="1-execv"><a class="anchor hidden-xs" href="#1-execv" title="1-execv"><span class="octicon octicon-link"></span></a>1. execv()</h4><ul>
<li>課堂練習： <code>execv()</code> 的概念</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-keyword">char</span> * argv[] = {<span class="hljs-string">"/bin/ls"</span>, <span class="hljs-string">"-1"</span>, <span class="hljs-number">0</span>};
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{

	<span class="hljs-keyword">int</span> pid, status;

	<span class="hljs-keyword">if</span> ((pid = fork()) &lt; <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Fork error \n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
	}
	
	<span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {	<span class="hljs-comment">/* Child executes here */</span>
		execv (argv[<span class="hljs-number">0</span>], argv);
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Exec error \n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
	} <span class="hljs-keyword">else</span>		<span class="hljs-comment">/* Parent executes here */</span>
		wait(&amp;status);

	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello there! \n"</span>);
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><h3 id="二-signals"><a class="anchor hidden-xs" href="#二-signals" title="二-signals"><span class="octicon octicon-link"></span></a>(二) Signals</h3><h4 id="1-unix-process-control"><a class="anchor hidden-xs" href="#1-unix-process-control" title="1-unix-process-control"><span class="octicon octicon-link"></span></a>1. UNIX Process Control</h4><p><img src="https://i.imgur.com/kFzherv.jpg" alt=""></p><h4 id="2-kill-command"><a class="anchor hidden-xs" href="#2-kill-command" title="2-kill-command"><span class="octicon octicon-link"></span></a>2. kill Command</h4><blockquote>
<p>kill -signal pid</p>
</blockquote><ul>
<li>Example
<ul>
<li><em>kill –2 1234</em></li>
<li><em>kill -SIGINT 1234</em>
<ul>
<li>Same as pressing Ctrl-c if process 1234 is running in foreground.</li>
</ul>
</li>
</ul>
</li>
</ul><h4 id="3-function-call"><a class="anchor hidden-xs" href="#3-function-call" title="3-function-call"><span class="octicon octicon-link"></span></a>3. Function Call</h4><ul>
<li>raise()</li>
</ul><pre><code class="c hljs"><span class="hljs-keyword">int</span> ret = raise(SIGINT); <span class="hljs-comment">/* Process commits suicide. */</span>
<span class="hljs-keyword">assert</span>(ret != <span class="hljs-number">0</span>);        <span class="hljs-comment">/* Shouldn't get here. */</span>
</code></pre><ul>
<li>kill()</li>
</ul><blockquote>
<p>int kill(pid_t iPid, int iSig);</p>
</blockquote><pre><code class="c hljs">pid_t iPid = getpid(); <span class="hljs-comment">/* Process gets its id.*/</span>
<span class="hljs-keyword">kill</span>(iPid, SIGINT);
<span class="hljs-comment">/* Process sends itself a SIGINT signal (commits suicide?) */</span>
</code></pre><h4 id="4-linux-signal"><a class="anchor hidden-xs" href="#4-linux-signal" title="4-linux-signal"><span class="octicon octicon-link"></span></a>4. Linux Signal</h4><ul>
<li><a href="http://www.comptechdoc.org/os/linux/programming/linux_pgsignals.html" target="_blank">Linux Signal 種類</a>
<ul>
<li>Ctrl-C (in older Unixes, DEL)
<ul>
<li>sends an INT signal (SIGINT)</li>
<li>by default, this causes the process to terminate.</li>
</ul>
</li>
<li>Ctrl-Z
<ul>
<li>sends a TSTP signal (SIGTSTP)</li>
<li>by default, this causes the process to suspend execution.</li>
</ul>
</li>
<li>Ctrl-\
<ul>
<li>sends a QUIT signal (SIGQUIT)</li>
<li>by default, this causes the process to terminate and dump core.</li>
</ul>
</li>
</ul>
</li>
</ul><h4 id="5-訊號處理-signalh"><a class="anchor hidden-xs" href="#5-訊號處理-signalh" title="5-訊號處理-signalh"><span class="octicon octicon-link"></span></a>5. 訊號處理 - signal.h</h4><ul>
<li>意義說明
<ul>
<li>SIGABORT    程序停止</li>
<li>SIGALRM     警示</li>
<li>SIGFPE      浮點數例外</li>
<li>SIGHUP      掛斷</li>
<li>SIGILL      非法指令</li>
<li>SIGINT      終端機插斷</li>
</ul>
</li>
</ul><h5 id="1-signal"><a class="anchor hidden-xs" href="#1-signal" title="1-signal"><span class="octicon octicon-link"></span></a>(1) signal()</h5><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span>
<span class="hljs-keyword">void</span>(*signal(<span class="hljs-keyword">int</span> sig, <span class="hljs-keyword">void</span> (*func)(<span class="hljs-keyword">int</span>)))(<span class="hljs-keyword">int</span>) ;
</code></pre><ul>
<li>攔截 Ctrl-C 訊號</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ouch</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig)</span> </span>{
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"OUCH! - I got signal %d\n"</span>, sig);
	(<span class="hljs-keyword">void</span>) signal(SIGINT, SIG_DFL);
}

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
	(<span class="hljs-keyword">void</span>) signal(SIGINT, ouch);
	
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Hello World!\n"</span>);
		sleep(<span class="hljs-number">1</span>);
	}
}
</code></pre><h5 id="2-sigaction"><a class="anchor hidden-xs" href="#2-sigaction" title="2-sigaction"><span class="octicon octicon-link"></span></a>(2) sigaction()</h5><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sigaction</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig,<span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> sigaction *act, <span class="hljs-keyword">struct</span> sigaction *oact)</span></span>;
</code></pre><ul>
<li>
<p>參數說明</p>
<ul>
<li>sig: 要處理的訊號,若 act 指針非空, 則根據 act 修改<br>
該信號的處理動作。若 oact 指針非空,則通過 oact 傳出<br>
該信號原來的處理動作。</li>
<li>void(*)(int) sa_handler</li>
<li>sigset_t sa_mask</li>
<li>int sa_flags</li>
<li>sa_handler 代表新的信號處理。</li>
<li>sa_mask 用來設置在處理該信號時暫時將 sa_mask 指定<br>
的信號集擱置。</li>
<li>sa_flags 用來設置信號處理的其他相關操作。</li>
</ul>
</li>
<li>
<p>程式作業：<code>signal</code> 的處理<br>
<img src="https://i.imgur.com/1Zbog12.jpg" alt=""></p>
</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span>


<span class="hljs-comment">// When the process get the "Ctrl+C" signal.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">show_time</span><span class="hljs-params">()</span> </span>{
    system(<span class="hljs-string">"date"</span>); <span class="hljs-comment">// show the time.</span>
}

<span class="hljs-comment">// When the process gets the "Ctrl+\" signal.</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">go_default</span><span class="hljs-params">()</span> </span>{
    signal(SIGINT, SIG_DFL);    <span class="hljs-comment">// recover "Ctrl+C"</span>
}


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{

    signal(SIGINT, show_time);  <span class="hljs-comment">// triggering "Ctrl+C"</span>
    signal(SIGQUIT, go_default);<span class="hljs-comment">// triggering "Ctrl+\"</span>

    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"What time is it？\n"</span>);  <span class="hljs-comment">// Something interesting will happen if this line without "\n".</span>
        sleep(<span class="hljs-number">1</span>);
    }   
}
</code></pre><ul>
<li>執行結果</li>
</ul><p><img src="https://i.imgur.com/TgkFPdi.jpg" alt=""></p><h2 id="20170317"><a class="anchor hidden-xs" href="#20170317" title="20170317"><span class="octicon octicon-link"></span></a>20170317</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170317/Linux_programming_pthread-1.pdf" target="_blank">Linux_programming_pthread-1</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170317/Linux_programming_pthread-2.pdf" target="_blank">Linux_Programming_pthread-2</a></li>
</ul>
</li>
<li>參考資料
<ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/" target="_blank">POSIX Threads Programming</a></li>
</ul>
</li>
<li>額外練習
<ul>
<li><a href="https://hackmd.io/EwRgzArCAMAcAmBaARmazEBZPwOyNgDYAzAQ0WFM2IjFggE4BTWEIA==" target="_blank">關於用 Pthread 取質數的問題</a></li>
</ul>
</li>
</ul><h3 id="1-what-is-a-thread？"><a class="anchor hidden-xs" href="#1-what-is-a-thread？" title="1-what-is-a-thread？"><span class="octicon octicon-link"></span></a>1. What is a Thread？</h3><h4 id="1-os-view"><a class="anchor hidden-xs" href="#1-os-view" title="1-os-view"><span class="octicon octicon-link"></span></a>(1) OS view</h4><ul>
<li>A thread is an independent stream of instructions that can be scheduled to run by<br>
the OS.</li>
</ul><h4 id="2-software-developer-view"><a class="anchor hidden-xs" href="#2-software-developer-view" title="2-software-developer-view"><span class="octicon octicon-link"></span></a>(2) Software developer view</h4><ul>
<li>a thread can be considered as a “procedure” that runs independently from the main program.
<ul>
<li>Sequential program: a single stream of instructions in<br>
a program.</li>
<li>Multi-threaded program: a program with multiple streams.
<ul>
<li>Multiple threads are needed to use multiple cores/CPUs.</li>
</ul>
</li>
</ul>
</li>
</ul><h4 id="example"><a class="anchor hidden-xs" href="#example" title="example"><span class="octicon octicon-link"></span></a>[Example]</h4><ol>
<li>Computer games
<ul>
<li>each thread controls the movement of an object.</li>
</ul>
</li>
<li>Scientific simulations
<ul>
<li>Hurricane movement simulation: each thread simulates the hurricane in a small domain.</li>
<li>Molecular dynamic: each thread simulates a subset of particulars.</li>
</ul>
</li>
<li>Web server
<ul>
<li>Each thread handles a connection.</li>
</ul>
</li>
</ol><h3 id="2-process-and-thread"><a class="anchor hidden-xs" href="#2-process-and-thread" title="2-process-and-thread"><span class="octicon octicon-link"></span></a>2. Process and Thread</h3><h4 id="1-process-context"><a class="anchor hidden-xs" href="#1-process-context" title="1-process-context"><span class="octicon octicon-link"></span></a>(1) Process context</h4><ul>
<li>Two parts in the context: <code>self-contained domain (protection)</code> and <code>execution of instructions</code>.
<ul>
<li>Process ID, process group ID, user ID, and group ID</li>
<li>Environment</li>
<li>Working directory.</li>
<li>Program instructions</li>
<li>Registers (including PC)</li>
<li>Stack</li>
<li>Heap</li>
<li>File descriptors</li>
<li>Signal actions</li>
<li>Shared libraries</li>
<li>Inter-process communication tools</li>
</ul>
</li>
<li>What are absolutely needed to support a stream of instructions, given the process context?
<ul>
<li>Registers (including PC)</li>
<li>Stack</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/6kN1sIR.jpg" alt=""></p><h4 id="2-threads"><a class="anchor hidden-xs" href="#2-threads" title="2-threads"><span class="octicon octicon-link"></span></a>(2) Threads</h4><ul>
<li><strong>Advantages</strong>
<ul>
<li>Light-weight
<ul>
<li>Lower overhead for thread creation.</li>
<li>Lower Context Switching Overhead.
<ul>
<li>Fewer OS resources</li>
</ul>
</li>
</ul>
</li>
<li>Shared State
<ul>
<li>Don’t need IPC-like mechanism to communicate between threads of same process.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Disadvantages</strong>
<ul>
<li>Shared State!
<ul>
<li>Global variables are shared between threads. Accidental changes can be fatal.</li>
</ul>
</li>
<li>Many library functions are not thread-safe
<ul>
<li>Library Functions that return pointers to static internal memory. E.g. gethostbyname()</li>
</ul>
</li>
<li>Lack of robustness
<ul>
<li>Crash in one thread will crash the entire process.</li>
</ul>
</li>
</ul>
</li>
</ul><h3 id="3-pthreads"><a class="anchor hidden-xs" href="#3-pthreads" title="3-pthreads"><span class="octicon octicon-link"></span></a>3. Pthreads</h3><ul>
<li>Hardware vendors used to implement<br>
proprietary versions of threads
<ul>
<li>Thread programs are not portable</li>
</ul>
</li>
<li>Pthreads = POSIX threads, specified in IEEE POSIX 1003.1c (1995)</li>
</ul><h4 id="1-the-pthreads-api"><a class="anchor hidden-xs" href="#1-the-pthreads-api" title="1-the-pthreads-api"><span class="octicon octicon-link"></span></a>(1) The Pthreads API</h4><ul>
<li>Three types of routines:
<ol>
<li><code>Thread management</code>: create, terminate, join, and detach</li>
<li><code>Mutexes</code>: mutual exclusion, creating, destroying, locking, and unlocking mutexes</li>
<li><code>Condition variables</code>: event driven synchronizaiton.</li>
</ol>
<ul>
<li>Mutexes and condition variables are concerned about synchronization.</li>
<li>Why not anything related to inter-thread communication?</li>
</ul>
</li>
<li>The concept of opaque objects pervades the<br>
design of the API.</li>
<li>API naming convention<br>
<img src="https://i.imgur.com/euq9YUQ.jpg" alt=""></li>
</ul><h4 id="2-thread-management"><a class="anchor hidden-xs" href="#2-thread-management" title="2-thread-management"><span class="octicon octicon-link"></span></a>(2) Thread management</h4><ul>
<li>Pthread header file &lt;pthread.h&gt;</li>
<li>Compiling pthread programs：
<blockquote>
<p>gcc aaa.c -o aaa -lpthread</p>
</blockquote>
</li>
</ul><ol>
<li><code>Creation</code>
<ul>
<li>pthread_create<br>
<img src="https://i.imgur.com/KZ0yaCh.jpg" alt=""></li>
</ul>
</li>
<li><code>Termination</code>
<ul>
<li>Return</li>
<li>Pthread_exit</li>
<li>Can we still use exit？<br>
<img src="https://i.imgur.com/O8QpEBi.jpg" alt=""></li>
</ul>
</li>
<li><code>Wait (parent/child synchronization)</code>
<ul>
<li>pthread_join<br>
<img src="https://i.imgur.com/bacALSV.jpg" alt=""></li>
</ul>
</li>
</ol><ul>
<li>程式作業：<code>找出 1 - 100 的所有質數</code></li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NUM_THREADS 10</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MSIZE 100</span>

<span class="hljs-comment">// 找出 1 - 100 的所有質數</span>

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getDoubleTime</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread_function</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span>;
<span class="hljs-keyword">pthread_mutex_t</span> work_mutex;

<span class="hljs-comment">// 宣告 prime_array 陣列</span>
<span class="hljs-keyword">int</span> prime_array[NUM_THREADS][(MSIZE / NUM_THREADS)];


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
	<span class="hljs-keyword">int</span> res;
	<span class="hljs-keyword">pthread_t</span> a_thread[NUM_THREADS];
	<span class="hljs-keyword">void</span> *thread_result;
	<span class="hljs-keyword">int</span> lots_of_threads;
    <span class="hljs-keyword">int</span> print_prime = <span class="hljs-number">0</span>;


	<span class="hljs-comment">// start to measure time...</span>
	<span class="hljs-keyword">double</span> start_time = getDoubleTime();
	
	<span class="hljs-comment">// initialize mutex...</span>
	res = pthread_mutex_init(&amp;work_mutex, <span class="hljs-literal">NULL</span>);
	<span class="hljs-keyword">if</span> (res != <span class="hljs-number">0</span>) {
       	perror(<span class="hljs-string">"Mutex initialization failed"</span>);
	    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

	<span class="hljs-comment">// pthread_create...</span>
	<span class="hljs-keyword">for</span> (lots_of_threads = <span class="hljs-number">0</span>; lots_of_threads &lt; NUM_THREADS; lots_of_threads ++) {
		res = pthread_create(&amp;(a_thread[lots_of_threads]), <span class="hljs-literal">NULL</span>, thread_function, (<span class="hljs-keyword">void</span>*)(<span class="hljs-keyword">long</span>)lots_of_threads);

        <span class="hljs-keyword">if</span> (res != <span class="hljs-number">0</span>) {
			perror(<span class="hljs-string">"Thread creation failed"</span>);
        		<span class="hljs-built_in">exit</span>(EXIT_FAILURE);
		}
	}

	<span class="hljs-comment">// pthread_join...</span>
	<span class="hljs-keyword">for</span> (lots_of_threads = NUM_THREADS - <span class="hljs-number">1</span>; lots_of_threads &gt;= <span class="hljs-number">0</span>; lots_of_threads--) {
        	res = pthread_join(a_thread[lots_of_threads], &amp;thread_result); 

            <span class="hljs-keyword">if</span> (res != <span class="hljs-number">0</span>) {
	            perror(<span class="hljs-string">"pthread_join failed"</span>);
        	}
    }	
    
    <span class="hljs-comment">/* 輸出 prime_array 陣列 */</span>
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 設定計數器</span>
    <span class="hljs-keyword">for</span> (lots_of_threads = <span class="hljs-number">0</span>; lots_of_threads &lt; NUM_THREADS; lots_of_threads ++) { 
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n\nThe thread[%d]'s numbers：\n"</span>, lots_of_threads);
        
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; (MSIZE / NUM_THREADS); i++) {
            <span class="hljs-keyword">if</span> (prime_array[lots_of_threads][i] != <span class="hljs-number">0</span>)
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\t"</span>, prime_array[lots_of_threads][i]);                        }
    }

	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nThread joined\n"</span>);

	<span class="hljs-comment">// stop measuring time...</span>
	<span class="hljs-keyword">double</span> finish_time = getDoubleTime();
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Execute Time:  %.3lf ms\n"</span>, (finish_time - start_time));
    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}


<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread_function</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{
    <span class="hljs-comment">// pthread_mutex_lock(&amp;work_mutex);</span>
	
    <span class="hljs-keyword">int</span> my_num = (<span class="hljs-keyword">long</span>)arg;
	<span class="hljs-comment">// if (MSIZE % NUM_THREADS != 0){    printf("error");   pthread_exit(-1);    }</span>

    <span class="hljs-keyword">int</span> start_num = (MSIZE / NUM_THREADS) * my_num + <span class="hljs-number">1</span>;
	<span class="hljs-keyword">int</span> end_num = (MSIZE / NUM_THREADS) * (my_num + <span class="hljs-number">1</span>);

    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>, k = <span class="hljs-number">0</span>;   <span class="hljs-comment">// Set the loop</span>
    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;      <span class="hljs-comment">// Set the counter</span>
    <span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;     <span class="hljs-comment">// result</span>

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"I'm thread[%d], start_num:%d, end_num:%d\n"</span>, my_num, start_num, end_num);

    <span class="hljs-comment">/* find the prime number */</span>
    <span class="hljs-keyword">for</span> (i = start_num; i &lt;= end_num; i++) {
        count = <span class="hljs-number">0</span>;      <span class="hljs-comment">// Reset counter</span>

        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">1</span>; j &lt;= i; j++) {
            <span class="hljs-keyword">if</span> (i % j == <span class="hljs-number">0</span>)
                count += <span class="hljs-number">1</span>;
        }
        
        <span class="hljs-keyword">if</span> (count == <span class="hljs-number">2</span>) { 
            prime_array[my_num][k] = i;
            k++;
        }
    }


    <span class="hljs-comment">// pthread_mutex_unlock(&amp;work_mutex);</span>
	pthread_exit(<span class="hljs-number">0</span>);
}


<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getDoubleTime</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">struct</span> timeval tm_tv;
        gettimeofday(&amp;tm_tv,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">double</span>)(((<span class="hljs-keyword">double</span>)tm_tv.tv_sec * (<span class="hljs-keyword">double</span>)<span class="hljs-number">1000.</span> + (<span class="hljs-keyword">double</span>)(tm_tv.tv_usec)) * (<span class="hljs-keyword">double</span>)<span class="hljs-number">0.001</span>);
}
</code></pre><ul>
<li>執行結果</li>
</ul><p><img src="https://i.imgur.com/WU12UoO.jpg" alt=""></p><p><img src="https://i.imgur.com/CGXHTue.jpg" alt=""></p><h2 id="20170324"><a class="anchor hidden-xs" href="#20170324" title="20170324"><span class="octicon octicon-link"></span></a>20170324</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170324/Linux_programming_pthread.pdf" target="_blank">Linux Programming - Pthread</a></li>
</ul>
</li>
<li>參考資料
<ul>
<li><a href="https://hackmd.io/s/Skh_AaVix" target="_blank">Toward Concurrency</a></li>
<li><a href="https://barrgroup.com/Embedded-Systems/How-To/RTOS-Mutex-Semaphore" target="_blank">Mutexes and Semaphores Demystified</a></li>
<li><a href="https://blog.feabhas.com/2009/09/mutex-vs-semaphores-%E2%80%93-part-1-semaphores/" target="_blank">Mutex vs. Semaphores – Part 1: Semaphores</a></li>
<li><a href="https://blog.feabhas.com/2009/09/mutex-vs-semaphores-%E2%80%93-part-2-the-mutex/" target="_blank">Mutex vs. Semaphores – Part 2: The Mutex</a></li>
<li><a href="https://blog.feabhas.com/2009/10/mutex-vs-semaphores-%E2%80%93-part-3-final-part-mutual-exclusion-problems/" target="_blank">Mutex vs. Semaphores – Part 3: Mutual Exclusion Problems</a></li>
</ul>
</li>
</ul><h3 id="一、pthreads"><a class="anchor hidden-xs" href="#一、pthreads" title="一、pthreads"><span class="octicon octicon-link"></span></a>一、Pthreads</h3><ul>
<li>May be provided either as user-level or kernel-level.</li>
<li>A POSIX standard (IEEE 1003.1c) API for thread creation and synchronization.</li>
<li><strong>Specification, not implementation.</strong></li>
<li>API specifies behavior of the thread library, implementation is up to development of the library.</li>
<li>Common in UNIX operating systems (Solaris, Linux, Mac OS X).</li>
</ul><h4 id="pthreadh"><a class="anchor hidden-xs" href="#pthreadh" title="pthreadh"><span class="octicon octicon-link"></span></a>pthread.h</h4><pre><code class="c hljs"><span class="hljs-meta">#include &lt;pthread.h&gt;</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_create</span>(<span class="hljs-params">pthread_t *thread, pthread_attr_t
*attr, <span class="hljs-keyword">void</span> *(*start_routine</span>)(<span class="hljs-params"><span class="hljs-keyword">void</span> *</span>), <span class="hljs-keyword">void</span> *arg)</span>;
<span class="hljs-comment">//create a thread</span>


<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pthread_exit</span>(<span class="hljs-params"><span class="hljs-keyword">void</span> *retval</span>)</span>;
<span class="hljs-comment">//terminate a thread</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_join</span>(<span class="hljs-params">pthread_t th, <span class="hljs-keyword">void</span> **thread_return</span>)</span>;
<span class="hljs-comment">//wait for thread termination</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_cancel</span>(<span class="hljs-params">pthread_t thread</span>)</span>;
<span class="hljs-comment">//cancel a thread</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_setcancelstate</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> state, <span class="hljs-keyword">int</span> *oldstate</span>)</span>;
<span class="hljs-comment">//set cancellation state</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_setcanceltype</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> type, <span class="hljs-keyword">int</span> *oldtype</span>)</span>;
<span class="hljs-comment">//set cancellation type</span>
</code></pre><h5 id="pthread-create"><a class="anchor hidden-xs" href="#pthread-create" title="pthread-create"><span class="octicon octicon-link"></span></a>pthread_create()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_create</span>(<span class="hljs-params">pthread_t *thread,
pthread_attr_t *attr, <span class="hljs-keyword">void</span> *(*start_routine</span>)(<span class="hljs-params"><span class="hljs-keyword">void</span>
*</span>), <span class="hljs-keyword">void</span> *arg)</span>;
</code></pre><ul>
<li><code>pthread_t *thread</code>：thread 的識別字</li>
<li><code>pthread_attr_t *attr</code>：thread 的屬性，設定為 NULL 表示使用預設值</li>
<li><code>void *(*start_routine)(void*)</code>：thread 要執行的 function</li>
<li><code>void *arg</code>：傳遞給 thread 的參數</li>
</ul><h5 id="pthread-exit"><a class="anchor hidden-xs" href="#pthread-exit" title="pthread-exit"><span class="octicon octicon-link"></span></a>pthread_exit()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pthread_exit</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *retval)</span></span>;
</code></pre><ul>
<li><code>void *retval</code>：thread 結束時回傳的變數</li>
</ul><h5 id="pthread-join"><a class="anchor hidden-xs" href="#pthread-join" title="pthread-join"><span class="octicon octicon-link"></span></a>pthread_join()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_join</span><span class="hljs-params">(<span class="hljs-keyword">pthread_t</span> th, <span class="hljs-keyword">void</span> **thread_return)</span></span>;
</code></pre><ul>
<li><code>pthread_t th</code>：thread 識別字</li>
<li><code>void **thread_return</code>：接收 pthread_exit 傳回的變數</li>
</ul><h5 id="pthread-setcancelstate"><a class="anchor hidden-xs" href="#pthread-setcancelstate" title="pthread-setcancelstate"><span class="octicon octicon-link"></span></a>pthread_setcancelstate()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_setcancelstate</span><span class="hljs-params">(<span class="hljs-keyword">int</span> state, <span class="hljs-keyword">int</span> *oldstate)</span></span>;
</code></pre><ul>
<li><code>int state</code>：設定為 PTHREAD_CANCEL_ENABLE 即表示允許取消 thread 的請求；設定為 PTHREAD_CANCEL_DISABLE 即表示忽略取消的請求。</li>
<li><code>int *oldstate</code>：此指標指向前一個狀態</li>
</ul><h5 id="pthread-setcanceltype"><a class="anchor hidden-xs" href="#pthread-setcanceltype" title="pthread-setcanceltype"><span class="octicon octicon-link"></span></a>pthread_setcanceltype()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_setcanceltype</span><span class="hljs-params">(<span class="hljs-keyword">int</span> type, <span class="hljs-keyword">int</span> *oldtype)</span></span>;
</code></pre><ul>
<li><code>int type</code>：設定為 PTHREAD_CANCEL_ASYNCHRONOUS 則立即取消 thread；設定為 PTHREAD_CANCEL_DEFERRED 則會遇到取消點才會取消 thread。
<ul>
<li>取消點即是下列函數：<code>pthread_join</code>、<code>pthread_cond_wait</code>、<code>pthread_testcancel</code>…等</li>
</ul>
</li>
<li><code>int *oldtype</code>：此指標指向前一個型態。</li>
</ul><h3 id="二、condition-variables"><a class="anchor hidden-xs" href="#二、condition-variables" title="二、condition-variables"><span class="octicon octicon-link"></span></a>二、Condition Variables</h3><h4 id="pthread-cond-init-condition-attr"><a class="anchor hidden-xs" href="#pthread-cond-init-condition-attr" title="pthread-cond-init-condition-attr"><span class="octicon octicon-link"></span></a>pthread_cond_init (condition, attr)</h4><ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_cond_init.txt" target="_blank">pthread_cond_init</a></li>
</ul><h4 id="pthread-cond-destroy-condition"><a class="anchor hidden-xs" href="#pthread-cond-destroy-condition" title="pthread-cond-destroy-condition"><span class="octicon octicon-link"></span></a>pthread_cond_destroy (condition)</h4><ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_cond_destroy.txt" target="_blank">pthread_cond_destroy</a></li>
</ul><h4 id="pthread-condattr-init-attr"><a class="anchor hidden-xs" href="#pthread-condattr-init-attr" title="pthread-condattr-init-attr"><span class="octicon octicon-link"></span></a>pthread_condattr_init (attr)</h4><ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_condattr_init.txt" target="_blank">pthread_condattr_init</a></li>
</ul><h4 id="pthread-condattr-destroy-attr"><a class="anchor hidden-xs" href="#pthread-condattr-destroy-attr" title="pthread-condattr-destroy-attr"><span class="octicon octicon-link"></span></a>pthread_condattr_destroy (attr)</h4><ul>
<li><a href="https://computing.llnl.gov/tutorials/pthreads/man/pthread_condattr_destroy.txt" target="_blank">pthread_condattr_destroy</a></li>
</ul><h3 id="三、thread-synchronization"><a class="anchor hidden-xs" href="#三、thread-synchronization" title="三、thread-synchronization"><span class="octicon octicon-link"></span></a>三、Thread Synchronization</h3><h3 id="1-semaphore"><a class="anchor hidden-xs" href="#1-semaphore" title="1-semaphore"><span class="octicon octicon-link"></span></a>1. Semaphore</h3><h4 id="semaphoreh"><a class="anchor hidden-xs" href="#semaphoreh" title="semaphoreh"><span class="octicon octicon-link"></span></a>semaphore.h</h4><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;semaphore.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_init</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem, <span class="hljs-keyword">int</span> pshared, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> value)</span></span>;
<span class="hljs-comment">//create a semaphore</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_wait</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
<span class="hljs-comment">//lock a semaphore</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_post</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
<span class="hljs-comment">//unlock a semaphore</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_destroy</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
<span class="hljs-comment">//delete a semaphore</span>
</code></pre><h5 id="sem-init"><a class="anchor hidden-xs" href="#sem-init" title="sem-init"><span class="octicon octicon-link"></span></a>sem_init()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_init</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem, <span class="hljs-keyword">int</span> pshared, <span class="hljs-keyword">unsigned</span>
<span class="hljs-keyword">int</span> value)</span></span>;
</code></pre><ul>
<li><code>sem_t *sem</code>：semaphore 識別字</li>
<li><code>int pshared</code>：設定為 0 表示僅供目前的 process 及其 thread 使用。非 0 表示此 semaphore 與其他 process 共用</li>
<li><code>unsigned int value</code>：semaphore 的初始值</li>
</ul><h5 id="sem-wait"><a class="anchor hidden-xs" href="#sem-wait" title="sem-wait"><span class="octicon octicon-link"></span></a>sem_wait()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_wait</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
</code></pre><ul>
<li>若 semaphore 為非 0，則 semaphore 值減<br>
1；若 semaphore 為 0，則呼叫此 function<br>
的 thread 會被 block ，直到 semaphore 值不<br>
為 0。</li>
</ul><h5 id="sem-post"><a class="anchor hidden-xs" href="#sem-post" title="sem-post"><span class="octicon octicon-link"></span></a>sem_post()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_post</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
</code></pre><ul>
<li>對 semaphore 值加 1。</li>
</ul><h5 id="sem-destroy"><a class="anchor hidden-xs" href="#sem-destroy" title="sem-destroy"><span class="octicon octicon-link"></span></a>sem_destroy()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sem_destroy</span><span class="hljs-params">(<span class="hljs-keyword">sem_t</span> *sem)</span></span>;
<span class="hljs-comment">//delete a semaphore</span>
</code></pre><h3 id="2-mutex"><a class="anchor hidden-xs" href="#2-mutex" title="2-mutex"><span class="octicon octicon-link"></span></a>2. Mutex</h3><h4 id="pthreadh1"><a class="anchor hidden-xs" href="#pthreadh1" title="pthreadh1"><span class="octicon octicon-link"></span></a>pthread.h</h4><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_init</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex, <span class="hljs-keyword">const</span> <span class="hljs-keyword">pthread_mutexattr_t</span> *mutexattr)</span></span>;
<span class="hljs-comment">//create a mutex</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_lock</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//lock a mutex</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_unlock</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//unlock a mutex</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_destroy</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//delete a mutex</span>
</code></pre><h5 id="pthread-mutex-init"><a class="anchor hidden-xs" href="#pthread-mutex-init" title="pthread-mutex-init"><span class="octicon octicon-link"></span></a>pthread_mutex_init()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_init</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex, <span class="hljs-keyword">const</span> <span class="hljs-keyword">pthread_mutexattr_t</span> *mutexattr)</span></span>;
</code></pre><ul>
<li><code>pthread_mutex_t *mutex</code>：mutex 識別字</li>
<li><code>const pthread_mutexattr_t *mutexattr</code>：mutex 的屬性。設定為 NULL 表示使用預設。</li>
</ul><h5 id="pthread-mutex-lock"><a class="anchor hidden-xs" href="#pthread-mutex-lock" title="pthread-mutex-lock"><span class="octicon octicon-link"></span></a>pthread_mutex_lock()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_lock</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//lock a mutex</span>
</code></pre><h5 id="pthread-mutex-unlock"><a class="anchor hidden-xs" href="#pthread-mutex-unlock" title="pthread-mutex-unlock"><span class="octicon octicon-link"></span></a>pthread_mutex_unlock()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_unlock</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//unlock a mutex</span>
</code></pre><h5 id="pthread-mutex-destroy"><a class="anchor hidden-xs" href="#pthread-mutex-destroy" title="pthread-mutex-destroy"><span class="octicon octicon-link"></span></a>pthread_mutex_destroy()</h5><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">pthread_mutex_destroy</span><span class="hljs-params">(<span class="hljs-keyword">pthread_mutex_t</span> *mutex)</span></span>;
<span class="hljs-comment">//delete a mutex</span>
</code></pre><h3 id="課程作業"><a class="anchor hidden-xs" href="#課程作業" title="課程作業"><span class="octicon octicon-link"></span></a>課程作業</h3><ul>
<li>Producer - Consumer</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span>
<span data-linenumber="72"></span>
<span data-linenumber="73"></span>
<span data-linenumber="74"></span>
<span data-linenumber="75"></span>
<span data-linenumber="76"></span>
<span data-linenumber="77"></span>
<span data-linenumber="78"></span>
<span data-linenumber="79"></span>
<span data-linenumber="80"></span>
<span data-linenumber="81"></span>
<span data-linenumber="82"></span>
<span data-linenumber="83"></span>
<span data-linenumber="84"></span>
<span data-linenumber="85"></span>
<span data-linenumber="86"></span>
<span data-linenumber="87"></span>
<span data-linenumber="88"></span>
<span data-linenumber="89"></span>
<span data-linenumber="90"></span></div><div class="code"><span class="hljs-comment">/*
 *  Solution to Producer Consumer Problem
 *  Using Ptheads, a mutex and condition variables
 *  From Tanenbaum, Modern Operating Systems, 3rd Ed.
 */</span>

<span class="hljs-comment">/*
    In this version the buffer is a single number.
    The producer is putting numbers into the shared buffer
    (in this case sequentially)
    And the consumer is taking them out.
    If the buffer contains zero, that indicates that the buffer is empty.
    Any other value is valid.
*/</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MAX 10   <span class="hljs-comment">/* Numbers to produce */</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> buf_max 5</span>

<span class="hljs-keyword">pthread_mutex_t</span> the_mutex;
<span class="hljs-keyword">pthread_cond_t</span> condc, condp;
<span class="hljs-keyword">int</span> buffer[<span class="hljs-number">5</span>];
<span class="hljs-keyword">int</span> in = <span class="hljs-number">0</span>;
<span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">producer</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *ptr)</span> </span>{
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt;= MAX; i++) {
        pthread_mutex_lock(&amp;the_mutex);	    <span class="hljs-comment">/* protect buffer */</span>
        <span class="hljs-keyword">while</span> (count == buf_max)    <span class="hljs-comment">/* If there is something in the buffer then wait */</span>
            pthread_cond_wait(&amp;condp, &amp;the_mutex);
    
        in++;
        buffer[in] = i;
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ProBuffer[%d]：%2d\n"</span>, in, buffer[in]);
        count++;

        pthread_cond_signal(&amp;condc);	    <span class="hljs-comment">/* wake up consumer */</span>
        pthread_mutex_unlock(&amp;the_mutex);	<span class="hljs-comment">/* release the buffer */</span>
    }
    pthread_exit(<span class="hljs-number">0</span>);
}

<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">consumer</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *ptr)</span> </span>{
    <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt;= MAX; i++) {
        pthread_mutex_lock(&amp;the_mutex);	    <span class="hljs-comment">/* protect buffer */</span>
        <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)			    <span class="hljs-comment">/* If there is nothing in the buffer then wait */</span>
            pthread_cond_wait(&amp;condc, &amp;the_mutex);
        
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ConBuffer[%d]：%2d\n"</span>, in, buffer[in]);
        buffer[in] = <span class="hljs-number">0</span>;
        in--;
        count--;
        pthread_cond_signal(&amp;condp);	    <span class="hljs-comment">/* wake up consumer */</span>

        pthread_mutex_unlock(&amp;the_mutex);	<span class="hljs-comment">/* release the buffer */</span>
    }
    pthread_exit(<span class="hljs-number">0</span>);
}


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>{
    <span class="hljs-keyword">pthread_t</span> pro, con;

    <span class="hljs-comment">// Initialize the mutex and condition variables</span>
    <span class="hljs-comment">/* What's the NULL for ??? */</span>
    pthread_mutex_init(&amp;the_mutex, <span class="hljs-literal">NULL</span>);	
    pthread_cond_init(&amp;condc, <span class="hljs-literal">NULL</span>);		<span class="hljs-comment">/* Initialize consumer condition variable */</span>
    pthread_cond_init(&amp;condp, <span class="hljs-literal">NULL</span>);		<span class="hljs-comment">/* Initialize producer condition variable */</span>

    <span class="hljs-comment">// Create the threads</span>
    pthread_create(&amp;con, <span class="hljs-literal">NULL</span>, consumer, <span class="hljs-literal">NULL</span>);
    pthread_create(&amp;pro, <span class="hljs-literal">NULL</span>, producer, <span class="hljs-literal">NULL</span>);

    <span class="hljs-comment">// Wait for the threads to finish</span>
    <span class="hljs-comment">// Otherwise main might run to the end</span>
    <span class="hljs-comment">// and kill the entire process when it exits.</span>
    pthread_join(con, <span class="hljs-literal">NULL</span>);
    pthread_join(pro, <span class="hljs-literal">NULL</span>);

    <span class="hljs-comment">// Cleanup -- would happen automatically at end of program</span>
    pthread_mutex_destroy(&amp;the_mutex);	<span class="hljs-comment">/* Free up the_mutex */</span>
    pthread_cond_destroy(&amp;condc);		<span class="hljs-comment">/* Free up consumer condition variable */</span>
    pthread_cond_destroy(&amp;condp);		<span class="hljs-comment">/* Free up producer condition variable */</span>
}
</div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/OCVTU3V.jpg" alt=""></li>
</ul><h2 id="20170331"><a class="anchor hidden-xs" href="#20170331" title="20170331"><span class="octicon octicon-link"></span></a>20170331</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170331/Socket_Programming.pdf" target="_blank">Socket_Programming</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170331/Linux-Programming_Socket_1.pdf" target="_blank">Linux-Programming_Socket_1</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170331/Linux-Programming_Socket_2.pdf" target="_blank">Linux-Programming_Socket_2</a></li>
</ul>
</li>
</ul><h3 id="socket-programming"><a class="anchor hidden-xs" href="#socket-programming" title="socket-programming"><span class="octicon octicon-link"></span></a>Socket Programming</h3><h4 id="1-what-is-a-socket？"><a class="anchor hidden-xs" href="#1-what-is-a-socket？" title="1-what-is-a-socket？"><span class="octicon octicon-link"></span></a>1. What is a socket？</h4><ul>
<li>
<p>An interface between application and network.</p>
<ul>
<li>The application creates a socket.</li>
<li>The socket type dictates the style of communication.
<ul>
<li><code>reliable</code> vs. <code>best effort</code></li>
<li><code>connection-oriented</code> vs. <code>connectionless</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Once configured the application can</p>
<ul>
<li>pass data to the socket for network transmission</li>
<li>receive data from the socket (transmitted through the network by some other host)</li>
</ul>
</li>
</ul><h4 id="2-two-essential-types-of-sockets"><a class="anchor hidden-xs" href="#2-two-essential-types-of-sockets" title="2-two-essential-types-of-sockets"><span class="octicon octicon-link"></span></a>2. Two essential types of sockets</h4><p><img src="https://i.imgur.com/HMu29e3.jpg" alt=""></p><h4 id="1-sock-stream"><a class="anchor hidden-xs" href="#1-sock-stream" title="1-sock-stream"><span class="octicon octicon-link"></span></a>(1) SOCK_STREAM</h4><ul>
<li>a.k.a. TCP</li>
<li>reliable delivery</li>
<li>in-order guaranteed</li>
<li>connection-oriented</li>
<li>bidirectional</li>
</ul><h4 id="2-sock-dgram"><a class="anchor hidden-xs" href="#2-sock-dgram" title="2-sock-dgram"><span class="octicon octicon-link"></span></a>(2) SOCK_DGRAM</h4><ul>
<li>a.k.a. UDP</li>
<li>unreliable delivery</li>
<li>no order guarantees</li>
<li>no notion of “connection” – app indicates dest. for each packet</li>
<li>can send or receive</li>
</ul><h4 id="example1"><a class="anchor hidden-xs" href="#example1" title="example1"><span class="octicon octicon-link"></span></a>Example</h4><ul>
<li><code>server</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span></div><div class="code"><span class="hljs-comment">/*  Make the necessary includes and set up the variables.  */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> server_sockfd, client_sockfd;
    <span class="hljs-keyword">int</span> server_len, client_len;
    <span class="hljs-keyword">struct</span> sockaddr_in server_address;
    <span class="hljs-keyword">struct</span> sockaddr_in client_address;

<span class="hljs-comment">/*  Create an unnamed socket for the server.  */</span>

    server_sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-comment">/*  Name the socket.  */</span>

    server_address.sin_family = AF_INET;
    server_address.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);
    server_address.sin_port = <span class="hljs-number">9734</span>;
    server_len = <span class="hljs-keyword">sizeof</span>(server_address);
    bind(server_sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;server_address, server_len);

<span class="hljs-comment">/*  Create a connection queue and wait for clients.  */</span>

    listen(server_sockfd, <span class="hljs-number">5</span>);
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">char</span> ch;

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"server waiting\n"</span>);

<span class="hljs-comment">/*  Accept a connection.  */</span>

        client_len = <span class="hljs-keyword">sizeof</span>(client_address);
        client_sockfd = accept(server_sockfd, 
            (<span class="hljs-keyword">struct</span> sockaddr *)&amp;client_address, &amp;client_len);

<span class="hljs-comment">/*  We can now read/write to client on client_sockfd.  */</span>

        read(client_sockfd, &amp;ch, <span class="hljs-number">1</span>);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"receive from client = %c\n"</span>, ch);
        ch++;
        write(client_sockfd, &amp;ch, <span class="hljs-number">1</span>);
        close(client_sockfd);
    }
}
</div></div></code></pre><ul>
<li><code>client</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span></div><div class="code"><span class="hljs-comment">/*  Make the necessary includes and set up the variables.  */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> sockfd;
    <span class="hljs-keyword">int</span> len;
    <span class="hljs-keyword">struct</span> sockaddr_in address;
    <span class="hljs-keyword">int</span> result;
    <span class="hljs-keyword">char</span> ch = <span class="hljs-string">'A'</span>;

<span class="hljs-comment">/*  Create a socket for the client.  */</span>

    sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-comment">/*  Name the socket, as agreed with the server.  */</span>

    address.sin_family = AF_INET;
    address.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);
    address.sin_port = <span class="hljs-number">9734</span>;
    len = <span class="hljs-keyword">sizeof</span>(address);

<span class="hljs-comment">/*  Now connect our socket to the server's socket.  */</span>

    result = connect(sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;address, len);

    <span class="hljs-keyword">if</span>(result == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"oops: client2"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

<span class="hljs-comment">/*  We can now read/write via sockfd.  */</span>

    write(sockfd, &amp;ch, <span class="hljs-number">1</span>);
    read(sockfd, &amp;ch, <span class="hljs-number">1</span>);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"char from server = %c\n"</span>, ch);
    close(sockfd);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</div></div></code></pre><h3 id="課程作業1"><a class="anchor hidden-xs" href="#課程作業1" title="課程作業1"><span class="octicon octicon-link"></span></a>課程作業</h3><ul>
<li>
<p>利用Socket Programming，將 client 端的整數陣列傳送給 server 端排序，並將排序後的結果回傳給 client 端顯示。</p>
</li>
<li>
<p><code>server</code> 部份</p>
</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span></div><div class="code"><span class="hljs-comment">/*  Make the necessary includes and set up the variables.  */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> server_sockfd, client_sockfd;
    <span class="hljs-keyword">int</span> server_len, client_len;
    <span class="hljs-keyword">struct</span> sockaddr_in server_address;
    <span class="hljs-keyword">struct</span> sockaddr_in client_address;

<span class="hljs-comment">/*  Create an unnamed socket for the server.  */</span>

    server_sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-comment">/*  Name the socket.  */</span>

    server_address.sin_family = AF_INET;
    server_address.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);
    server_address.sin_port = <span class="hljs-number">9734</span>;
    server_len = <span class="hljs-keyword">sizeof</span>(server_address);
    bind(server_sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;server_address, server_len);

<span class="hljs-comment">/*  Create a connection queue and wait for clients.  */</span>

    listen(server_sockfd, <span class="hljs-number">5</span>);    
    
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nserver waiting\n"</span>);

<span class="hljs-comment">/*  Accept a connection.  */</span>

        client_len = <span class="hljs-keyword">sizeof</span>(client_address);
        client_sockfd = accept(server_sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;client_address, &amp;client_len);

<span class="hljs-comment">/*  We can now read/write to client on client_sockfd.  */</span>

        <span class="hljs-keyword">int</span> i, j, tmp = <span class="hljs-number">0</span>, get_n;
        <span class="hljs-keyword">int</span> *buf;
        
        read(client_sockfd, &amp;get_n, <span class="hljs-keyword">sizeof</span>(get_n));
        buf = (<span class="hljs-keyword">int</span> *) <span class="hljs-built_in">malloc</span>(get_n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
        read(client_sockfd, buf, get_n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"sort arr[%d] from client:\n"</span>, get_n);
     
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; get_n; i++) {
            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; get_n; j++) {
                <span class="hljs-keyword">if</span> (buf[i] &lt; buf[j]) {
                    tmp = buf[i];
                    buf[i] = buf[j];
                    buf[j] = tmp;
                }
            }
        }
 
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; get_n; i++)
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"arr[%d] = %d\n"</span>, i, buf[i]);
        
        write(client_sockfd, buf, get_n * <span class="hljs-keyword">sizeof</span>(buf));
        close(client_sockfd);
    }
}
</div></div></code></pre><ul>
<li><code>client</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span></div><div class="code"><span class="hljs-comment">/*  Make the necessary includes and set up the variables.  */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIZE 5</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> sockfd;
    <span class="hljs-keyword">int</span> len;
    <span class="hljs-keyword">struct</span> sockaddr_in address;
    <span class="hljs-keyword">int</span> result, n;

<span class="hljs-comment">/*  Create a socket for the client.  */</span>

    sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-comment">/*  Name the socket, as agreed with the server.  */</span>

    address.sin_family = AF_INET;
    address.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);
    address.sin_port = <span class="hljs-number">9734</span>;
    len = <span class="hljs-keyword">sizeof</span>(address);

<span class="hljs-comment">/*  Now connect our socket to the server's socket.  */</span>

    result = connect(sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;address, len);

    <span class="hljs-keyword">if</span> (result == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"oops: client!"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

<span class="hljs-comment">/*  We can now read/write via sockfd.  */</span>

    <span class="hljs-keyword">int</span> i, j, tmp = <span class="hljs-number">0</span>, s = SIZE;
    <span class="hljs-keyword">int</span> arr[SIZE] = {<span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>};
    <span class="hljs-keyword">int</span> rec[SIZE] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, s);

    write(sockfd, &amp;s, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\noriginal from client - arr[]\n"</span>); 
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; SIZE; i++)
    	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"arr[%d] = %d\n"</span>, i, arr[i]);

    write(sockfd, arr, <span class="hljs-keyword">sizeof</span>(arr));
   
   
    read(sockfd, rec, SIZE * <span class="hljs-keyword">sizeof</span>(rec));    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nresult from server - rec[]\n"</span>);

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; SIZE; i++)
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"rec[%d] = %d\n"</span>, i, rec[i]); 
    

    close(sockfd);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/AhJZRLN.jpg" alt=""></li>
</ul><h2 id="20170407"><a class="anchor hidden-xs" href="#20170407" title="20170407"><span class="octicon octicon-link"></span></a>20170407</h2><h3 id="課堂練習-一"><a class="anchor hidden-xs" href="#課堂練習-一" title="課堂練習-一"><span class="octicon octicon-link"></span></a>課堂練習 (一)</h3><ul>
<li>
<p>將 Socket 以 multithread 的方式執行：</p>
</li>
<li>
<p><code>Server</code> 部份</p>
</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span>
<span data-linenumber="72"></span>
<span data-linenumber="73"></span>
<span data-linenumber="74"></span>
<span data-linenumber="75"></span>
<span data-linenumber="76"></span>
<span data-linenumber="77"></span>
<span data-linenumber="78"></span>
<span data-linenumber="79"></span>
<span data-linenumber="80"></span>
<span data-linenumber="81"></span>
<span data-linenumber="82"></span>
<span data-linenumber="83"></span>
<span data-linenumber="84"></span>
<span data-linenumber="85"></span>
<span data-linenumber="86"></span>
<span data-linenumber="87"></span>
<span data-linenumber="88"></span>
<span data-linenumber="89"></span></div><div class="code"><span class="hljs-comment">/*  Make the necessary includes and set up the variables.  */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread_function</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> server_sockfd, client_sockfd;
    <span class="hljs-keyword">int</span> server_len, client_len;
    <span class="hljs-keyword">struct</span> sockaddr_in server_address;
    <span class="hljs-keyword">struct</span> sockaddr_in client_address;
    
    <span class="hljs-keyword">pthread_t</span> a_thread;
    <span class="hljs-keyword">void</span> *thread_result;
    <span class="hljs-keyword">int</span> res;

<span class="hljs-comment">/*  Create an unnamed socket for the server.  */</span>

    server_sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-comment">/*  Name the socket.  */</span>

    server_address.sin_family = AF_INET;
    server_address.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);
    server_address.sin_port = <span class="hljs-number">9734</span>;
    server_len = <span class="hljs-keyword">sizeof</span>(server_address);
    bind(server_sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;server_address, server_len);

<span class="hljs-comment">/*  Create a connection queue and wait for clients.  */</span>

    listen(server_sockfd, <span class="hljs-number">5</span>);    
    
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nServer waiting...\n"</span>);

<span class="hljs-comment">/*  Accept a connection.  */</span>

        client_len = <span class="hljs-keyword">sizeof</span>(client_address);
        client_sockfd = accept(server_sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;client_address, &amp;client_len);

        res = pthread_create(&amp;a_thread, <span class="hljs-literal">NULL</span>, thread_function, (<span class="hljs-keyword">void</span> *)(<span class="hljs-keyword">long</span>)client_sockfd);
        
        <span class="hljs-keyword">if</span> (res != <span class="hljs-number">0</span>) {
            perror(<span class="hljs-string">"Thread creation failed"</span>);
            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
        }
    }
}


<span class="hljs-comment">/*  We can now read/write to client on client_sockfd.  */</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread_function</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{
    <span class="hljs-keyword">int</span> i, j, tmp = <span class="hljs-number">0</span>, get_n;
    <span class="hljs-keyword">int</span> client_sockfd = (<span class="hljs-keyword">long</span>)arg;
    <span class="hljs-keyword">int</span> *buf;
        
    read(client_sockfd, &amp;get_n, <span class="hljs-keyword">sizeof</span>(get_n));
    buf = (<span class="hljs-keyword">int</span> *) <span class="hljs-built_in">malloc</span>(get_n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
    read(client_sockfd, buf, get_n * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"sort arr[%d] from client:\n"</span>, get_n);
     
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; get_n; i++) {
        <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; get_n; j++) {
            <span class="hljs-keyword">if</span> (buf[i] &lt; buf[j]) {
                tmp = buf[i];
                buf[i] = buf[j];
                buf[j] = tmp;
            }
        }
    }


    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; get_n; i++)
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"arr[%d] = %d\n"</span>, i, buf[i]);

    <span class="hljs-comment">// sleep(3);</span>
    write(client_sockfd, buf, get_n * <span class="hljs-keyword">sizeof</span>(buf));
    close(client_sockfd);
    pthread_detach(pthread_self());
    pthread_exit(<span class="hljs-number">0</span>);
}
</div></div></code></pre><ul>
<li><code>Client</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span></div><div class="code"><span class="hljs-comment">/*  Make the necessary includes and set up the variables.  */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIZE 5</span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">int</span> sockfd;
    <span class="hljs-keyword">int</span> len;
    <span class="hljs-keyword">struct</span> sockaddr_in address;
    <span class="hljs-keyword">int</span> result, n;

<span class="hljs-comment">/*  Create a socket for the client.  */</span>

    sockfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-comment">/*  Name the socket, as agreed with the server.  */</span>

    address.sin_family = AF_INET;
    address.sin_addr.s_addr = inet_addr(<span class="hljs-string">"127.0.0.1"</span>);
    address.sin_port = <span class="hljs-number">9734</span>;
    len = <span class="hljs-keyword">sizeof</span>(address);

<span class="hljs-comment">/*  Now connect our socket to the server's socket.  */</span>

    result = connect(sockfd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;address, len);

    <span class="hljs-keyword">if</span> (result == <span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"oops: client!"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

<span class="hljs-comment">/*  We can now read/write via sockfd.  */</span>

    <span class="hljs-keyword">int</span> i, j, tmp = <span class="hljs-number">0</span>, s = SIZE;
    <span class="hljs-keyword">int</span> arr[SIZE] = {<span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>};
    <span class="hljs-keyword">int</span> rec[SIZE] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>, s);

    write(sockfd, &amp;s, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>));
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\noriginal from client - arr[]\n"</span>); 
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; SIZE; i++)
    	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"arr[%d] = %d\n"</span>, i, arr[i]);

    write(sockfd, arr, <span class="hljs-keyword">sizeof</span>(arr));
   
   
    read(sockfd, rec, SIZE * <span class="hljs-keyword">sizeof</span>(rec));    
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nresult from server - rec[]\n"</span>);

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; SIZE; i++)
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"rec[%d] = %d\n"</span>, i, rec[i]); 
    

    close(sockfd);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/PaWoNZx.jpg" alt=""></li>
</ul><h3 id="課堂練習-二"><a class="anchor hidden-xs" href="#課堂練習-二" title="課堂練習-二"><span class="octicon octicon-link"></span></a>課堂練習 (二)</h3><ul>
<li>矩陣相乘</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span>
<span data-linenumber="72"></span>
<span data-linenumber="73"></span>
<span data-linenumber="74"></span>
<span data-linenumber="75"></span>
<span data-linenumber="76"></span>
<span data-linenumber="77"></span>
<span data-linenumber="78"></span>
<span data-linenumber="79"></span>
<span data-linenumber="80"></span>
<span data-linenumber="81"></span>
<span data-linenumber="82"></span>
<span data-linenumber="83"></span>
<span data-linenumber="84"></span>
<span data-linenumber="85"></span>
<span data-linenumber="86"></span>
<span data-linenumber="87"></span>
<span data-linenumber="88"></span>
<span data-linenumber="89"></span>
<span data-linenumber="90"></span>
<span data-linenumber="91"></span>
<span data-linenumber="92"></span>
<span data-linenumber="93"></span>
<span data-linenumber="94"></span>
<span data-linenumber="95"></span>
<span data-linenumber="96"></span>
<span data-linenumber="97"></span>
<span data-linenumber="98"></span>
<span data-linenumber="99"></span>
<span data-linenumber="100"></span>
<span data-linenumber="101"></span>
<span data-linenumber="102"></span>
<span data-linenumber="103"></span>
<span data-linenumber="104"></span>
<span data-linenumber="105"></span>
<span data-linenumber="106"></span>
<span data-linenumber="107"></span>
<span data-linenumber="108"></span>
<span data-linenumber="109"></span>
<span data-linenumber="110"></span>
<span data-linenumber="111"></span>
<span data-linenumber="112"></span>
<span data-linenumber="113"></span>
<span data-linenumber="114"></span></div><div class="code"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NUM_THREADS 5</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> MSIZE 10</span>

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getDoubleTime</span><span class="hljs-params">()</span></span>;
<span class="hljs-comment">// void check();</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread_function</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span>;
<span class="hljs-comment">// srand(time(NULL));</span>
<span class="hljs-comment">// int a = (rand() % 10) + 1;</span>
<span class="hljs-keyword">int</span> A[MSIZE][MSIZE];
<span class="hljs-keyword">int</span> B[MSIZE][MSIZE];
<span class="hljs-keyword">int</span> C[MSIZE][MSIZE];
<span class="hljs-keyword">int</span> D[MSIZE][MSIZE];

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span> </span>{
	<span class="hljs-keyword">int</span> res;
	<span class="hljs-keyword">int</span> i, j;

	srand(time(<span class="hljs-literal">NULL</span>));
	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; MSIZE; i++) {
		<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; MSIZE; j++) {
			A[i][j] = <span class="hljs-number">1</span>;    <span class="hljs-comment">// (rand() % 10) + 1;</span>
			B[i][j] = <span class="hljs-number">2</span>;    <span class="hljs-comment">// (rand() % 10) + 1;</span>
		}
	}

	<span class="hljs-keyword">pthread_t</span> a_thread[NUM_THREADS];
	<span class="hljs-keyword">void</span> *thread_result;
	<span class="hljs-keyword">int</span> lots_of_threads;

	<span class="hljs-keyword">double</span> start_time = getDoubleTime();

	<span class="hljs-keyword">for</span> (lots_of_threads = <span class="hljs-number">0</span>; lots_of_threads &lt; NUM_THREADS; lots_of_threads++) {
        res = pthread_create(&amp;(a_thread[lots_of_threads]), <span class="hljs-literal">NULL</span>, thread_function, (<span class="hljs-keyword">void</span> *)(<span class="hljs-keyword">long</span>)lots_of_threads);
		<span class="hljs-keyword">if</span> (res != <span class="hljs-number">0</span>) {
			perror(<span class="hljs-string">"Thread creation failed"</span>);
			<span class="hljs-built_in">exit</span>(EXIT_FAILURE);
		}
		<span class="hljs-comment">// sleep(1);</span>
	}

	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Waiting for threads to finish...\n"</span>);
	
    <span class="hljs-keyword">for</span> (lots_of_threads = NUM_THREADS - <span class="hljs-number">1</span>; lots_of_threads &gt;= <span class="hljs-number">0</span>; lots_of_threads--) {
		res = pthread_join(a_thread[lots_of_threads], &amp;thread_result);
		<span class="hljs-keyword">if</span> (res == <span class="hljs-number">0</span>) {
			<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Picked up a thread[%d]\n"</span>, lots_of_threads);
		}
		<span class="hljs-keyword">else</span> {
			perror(<span class="hljs-string">"pthread_join failed"</span>);
		}
	}

	<span class="hljs-keyword">double</span> finish_time = getDoubleTime();
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"All done\n"</span>);

	<span class="hljs-comment">// check();</span>

	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Execute Time:  %.3lf ms\n"</span>, (finish_time - start_time));
	<span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}


<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">thread_function</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span> </span>{
	<span class="hljs-keyword">int</span> my_number = (<span class="hljs-keyword">long</span>)arg;
	<span class="hljs-keyword">int</span> i, j, k;
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Thread Number[%d]\n"</span>, my_number); 
	<span class="hljs-keyword">for</span> (i = (MSIZE / NUM_THREADS) * my_number; i &lt; ((MSIZE / NUM_THREADS) * my_number) + (MSIZE / NUM_THREADS); i++) {
		<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; MSIZE; j++) {
            <span class="hljs-keyword">for</span> (k = <span class="hljs-number">0</span>; k &lt; MSIZE; k++)
			    C[i][j] += A[i][k] * B[k][j];
			
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"C[%d][%d]:{%d} = A[%d][%d]:{%d} * B[%d][%d]:{%d}\n"</span>, i, j, C[i][j], i, j, A[i][j], i, j, B[i][j]);
		}
	}

	pthread_exit(<span class="hljs-literal">NULL</span>);
}


<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getDoubleTime</span><span class="hljs-params">()</span> </span>{
	<span class="hljs-keyword">struct</span> timeval tm_tv;
	gettimeofday(&amp;tm_tv, <span class="hljs-number">0</span>);
	<span class="hljs-keyword">return</span> (<span class="hljs-keyword">double</span>)(((<span class="hljs-keyword">double</span>)tm_tv.tv_sec * (<span class="hljs-keyword">double</span>)<span class="hljs-number">1000.</span> + (<span class="hljs-keyword">double</span>)(tm_tv.tv_usec)) * (<span class="hljs-keyword">double</span>)<span class="hljs-number">0.001</span>);
}

<span class="hljs-comment">/*
void check() {
	int i, j, k;
	int count = 0;

	for (i = 0; i &lt; MSIZE; i++) {
		for (j = 0; j &lt; MSIZE; j++) {
            for (k = 0; k &lt; MSIZE; j++)
			    D[i][j] += A[i][k] * B[k][j];
		}
	}

	for (i = 0; i &lt; MSIZE; i++) {
		for (j = 0; j &lt; MSIZE; j++) {
			if ((D[i][j] - C[i][j]) != 0) {
				count++;
				printf("Error[%d][%d] = [%d]\n", i, j, D[i][j] - C[i][j]);
			}
		}
	}

	printf("Different = [%d]\n", count);
}
</span></div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/g61ccDI.jpg" alt=""></li>
</ul><h2 id="20170414"><a class="anchor hidden-xs" href="#20170414" title="20170414"><span class="octicon octicon-link"></span></a>20170414</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170414/Linux.Programming.Programming.IPC-2.pdf" target="_blank">Linux-Programming-IPC-2</a></li>
</ul>
</li>
</ul><h3 id="一-shared-memory-concept"><a class="anchor hidden-xs" href="#一-shared-memory-concept" title="一-shared-memory-concept"><span class="octicon octicon-link"></span></a>(一) Shared Memory Concept</h3><ul>
<li>共享記憶體是由 IPC 為一程序所建立的特殊記憶體位址，其他的程序可以將此相同的 shared memory 區段納入自己的位址空間中，所有的程序皆可存取這些記憶體位址，就像是由自己定址一樣。<br>
<img src="https://i.imgur.com/ctobLbA.jpg" alt=""></li>
</ul><h3 id="二-shared-memory-function"><a class="anchor hidden-xs" href="#二-shared-memory-function" title="二-shared-memory-function"><span class="octicon octicon-link"></span></a>(二) Shared Memory Function</h3><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span></div><div class="code"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/sem.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/type.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ipc.h&gt;</span></span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmget</span><span class="hljs-params">(<span class="hljs-keyword">key_t</span> key, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">int</span> shmflg)</span></span>;
    <span class="hljs-comment">// 建立 shared memory 。</span>


<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">shmat</span><span class="hljs-params">(<span class="hljs-keyword">int</span> shm_id, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *shm_addr, <span class="hljs-keyword">int</span> shmflg)</span></span>;
    <span class="hljs-comment">// 允許程序對 shared memory 存取。</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmdt</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *shm_addr)</span></span>;
    <span class="hljs-comment">// 讓目前的程序從 shared memory 脫離出來。</span>


<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmctl</span><span class="hljs-params">( <span class="hljs-keyword">int</span> shm_id, <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">struct</span> shmid_ds *buf )</span></span>;
    <span class="hljs-comment">// 用來改變 shared memory 。</span>
</div></div></code></pre><h4 id="shmget"><a class="anchor hidden-xs" href="#shmget" title="shmget"><span class="octicon octicon-link"></span></a>shmget()</h4><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmget</span><span class="hljs-params">(<span class="hljs-keyword">key_t</span> key, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">int</span> shmflg)</span></span>;
</code></pre><ul>
<li>key: 用來為 shared memory 命名。</li>
<li>size: 需要的 shared memory 大小，以 byte 為單位。</li>
<li>shmflg: shared memory 的權限。在建立新的 shared memory 時要加上 IPC_CREATE。</li>
</ul><h4 id="shmat"><a class="anchor hidden-xs" href="#shmat" title="shmat"><span class="octicon octicon-link"></span></a>*shmat()</h4><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">shmat</span><span class="hljs-params">(<span class="hljs-keyword">int</span> shm_id, <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *shm_addr, <span class="hljs-keyword">int</span> shmflg)</span></span>;
</code></pre><ul>
<li>shm_id: Shared memory id.</li>
<li>shm_addr: Shared memory 加到目前程序中的位址，通常為一 null 指標。</li>
<li>shmflg: 一般設為 0 即可。</li>
</ul><h4 id="shmdt"><a class="anchor hidden-xs" href="#shmdt" title="shmdt"><span class="octicon octicon-link"></span></a>shmdt()</h4><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmdt</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span> *shm_addr)</span></span>;
</code></pre><ul>
<li>shm_addr: shmat 傳回的位址。</li>
</ul><h4 id="shmctl"><a class="anchor hidden-xs" href="#shmctl" title="shmctl"><span class="octicon octicon-link"></span></a>shmctl()</h4><pre><code class="c hljs"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">shmctl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> shm_id, <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">struct</span> shmid_ds *buf)</span></span>;
</code></pre><ul>
<li>shm_id: Shared memory id.</li>
<li>cmd:IPC_RMID: 刪除 shared memory 區段。</li>
<li>struct shmid_ds:</li>
</ul><pre><code class="c hljs"><span class="hljs-keyword">struct</span> shmid_ds {
    <span class="hljs-keyword">uid_t</span> shm_perm.uid;
    <span class="hljs-keyword">uid_t</span> shm_perm.gid;
    <span class="hljs-keyword">mode_t</span> shm_perm.mode;
}
</code></pre><h3 id="課堂作業"><a class="anchor hidden-xs" href="#課堂作業" title="課堂作業"><span class="octicon octicon-link"></span></a>課堂作業</h3><ul>
<li><code>client</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span>
<span data-linenumber="72"></span>
<span data-linenumber="73"></span>
<span data-linenumber="74"></span>
<span data-linenumber="75"></span>
<span data-linenumber="76"></span>
<span data-linenumber="77"></span>
<span data-linenumber="78"></span>
<span data-linenumber="79"></span>
<span data-linenumber="80"></span>
<span data-linenumber="81"></span>
<span data-linenumber="82"></span>
<span data-linenumber="83"></span>
<span data-linenumber="84"></span>
<span data-linenumber="85"></span>
<span data-linenumber="86"></span>
<span data-linenumber="87"></span>
<span data-linenumber="88"></span>
<span data-linenumber="89"></span>
<span data-linenumber="90"></span>
<span data-linenumber="91"></span>
<span data-linenumber="92"></span></div><div class="code"><span class="hljs-comment">/* vim: ts=4 sw=4 et
*/</span>
<span class="hljs-comment">/* The second program is the producer and allows us to enter data for consumers.
 It's very similar to shm1.c and looks like this. */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/shm.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"shm_com.h"</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">void</span> *shared_memory = (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>;
    <span class="hljs-keyword">struct</span> shared_use_st *shared_stuff;
    <span class="hljs-keyword">char</span> buffer[BUFSIZ];
    <span class="hljs-keyword">int</span> shmid;
    <span class="hljs-keyword">int</span> rand_arr[<span class="hljs-number">10</span>];

    shmid = shmget((<span class="hljs-keyword">key_t</span>)<span class="hljs-number">1234</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> shared_use_st), <span class="hljs-number">0666</span> | IPC_CREAT);
	
    <span class="hljs-keyword">if</span> (shmid == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmget failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    shared_memory = shmat(shmid, (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shared_memory == (<span class="hljs-keyword">void</span> *)<span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmat failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Memory attached at %X\n"</span>, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)(<span class="hljs-keyword">long</span>)shared_memory);

    shared_stuff = (<span class="hljs-keyword">struct</span> shared_use_st *)shared_memory;


    <span class="hljs-comment">/* Initial the array */</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++)
        shared_stuff-&gt;some_text[i] = <span class="hljs-number">0</span>;
 

    shared_stuff-&gt;written_by_you = <span class="hljs-number">1</span>;
    shared_stuff-&gt;answer_by_you = <span class="hljs-number">0</span>;


    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">while</span> (shared_stuff-&gt;written_by_you == <span class="hljs-number">1</span>) {
            sleep(<span class="hljs-number">1</span>);            
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Waiting for server...\n"</span>);
        }
      

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n【Server connected】\n"</span>);

        <span class="hljs-comment">/* Generate random number */</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Generate random number\n"</span>);
        srand((<span class="hljs-keyword">unsigned</span>)time(<span class="hljs-literal">NULL</span>));
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            rand_arr[i] = rand() % <span class="hljs-number">100</span> + <span class="hljs-number">1</span>;
            shared_stuff-&gt;some_text[i] = rand_arr[i];
        }
        shared_stuff-&gt;written_by_you = <span class="hljs-number">2</span>;


        <span class="hljs-comment">/* Wait for the sorted array */</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Wait for the sorted array...\n"</span>);
        <span class="hljs-keyword">while</span> (shared_stuff-&gt;answer_by_you == <span class="hljs-number">0</span>);

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"The array (After Sorted)\n"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"[%d]%d \t"</span>, i, shared_stuff-&gt;some_text[i]);
        }

        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);


        shared_stuff-&gt;written_by_you = <span class="hljs-number">1</span>;
        shared_stuff-&gt;answer_by_you = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">if</span> (shmdt(shared_memory) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmdt failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }
    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}
</div></div></code></pre><ul>
<li><code>server</code> 部份</li>
</ul><pre><code class="c hljs"><div class="wrapper"><div class="gutter linenumber"><span data-linenumber="1"></span>
<span data-linenumber="2"></span>
<span data-linenumber="3"></span>
<span data-linenumber="4"></span>
<span data-linenumber="5"></span>
<span data-linenumber="6"></span>
<span data-linenumber="7"></span>
<span data-linenumber="8"></span>
<span data-linenumber="9"></span>
<span data-linenumber="10"></span>
<span data-linenumber="11"></span>
<span data-linenumber="12"></span>
<span data-linenumber="13"></span>
<span data-linenumber="14"></span>
<span data-linenumber="15"></span>
<span data-linenumber="16"></span>
<span data-linenumber="17"></span>
<span data-linenumber="18"></span>
<span data-linenumber="19"></span>
<span data-linenumber="20"></span>
<span data-linenumber="21"></span>
<span data-linenumber="22"></span>
<span data-linenumber="23"></span>
<span data-linenumber="24"></span>
<span data-linenumber="25"></span>
<span data-linenumber="26"></span>
<span data-linenumber="27"></span>
<span data-linenumber="28"></span>
<span data-linenumber="29"></span>
<span data-linenumber="30"></span>
<span data-linenumber="31"></span>
<span data-linenumber="32"></span>
<span data-linenumber="33"></span>
<span data-linenumber="34"></span>
<span data-linenumber="35"></span>
<span data-linenumber="36"></span>
<span data-linenumber="37"></span>
<span data-linenumber="38"></span>
<span data-linenumber="39"></span>
<span data-linenumber="40"></span>
<span data-linenumber="41"></span>
<span data-linenumber="42"></span>
<span data-linenumber="43"></span>
<span data-linenumber="44"></span>
<span data-linenumber="45"></span>
<span data-linenumber="46"></span>
<span data-linenumber="47"></span>
<span data-linenumber="48"></span>
<span data-linenumber="49"></span>
<span data-linenumber="50"></span>
<span data-linenumber="51"></span>
<span data-linenumber="52"></span>
<span data-linenumber="53"></span>
<span data-linenumber="54"></span>
<span data-linenumber="55"></span>
<span data-linenumber="56"></span>
<span data-linenumber="57"></span>
<span data-linenumber="58"></span>
<span data-linenumber="59"></span>
<span data-linenumber="60"></span>
<span data-linenumber="61"></span>
<span data-linenumber="62"></span>
<span data-linenumber="63"></span>
<span data-linenumber="64"></span>
<span data-linenumber="65"></span>
<span data-linenumber="66"></span>
<span data-linenumber="67"></span>
<span data-linenumber="68"></span>
<span data-linenumber="69"></span>
<span data-linenumber="70"></span>
<span data-linenumber="71"></span>
<span data-linenumber="72"></span>
<span data-linenumber="73"></span>
<span data-linenumber="74"></span>
<span data-linenumber="75"></span>
<span data-linenumber="76"></span>
<span data-linenumber="77"></span>
<span data-linenumber="78"></span>
<span data-linenumber="79"></span>
<span data-linenumber="80"></span>
<span data-linenumber="81"></span>
<span data-linenumber="82"></span>
<span data-linenumber="83"></span>
<span data-linenumber="84"></span>
<span data-linenumber="85"></span>
<span data-linenumber="86"></span>
<span data-linenumber="87"></span>
<span data-linenumber="88"></span>
<span data-linenumber="89"></span>
<span data-linenumber="90"></span>
<span data-linenumber="91"></span>
<span data-linenumber="92"></span>
<span data-linenumber="93"></span>
<span data-linenumber="94"></span>
<span data-linenumber="95"></span>
<span data-linenumber="96"></span>
<span data-linenumber="97"></span>
<span data-linenumber="98"></span></div><div class="code"><span class="hljs-comment">/* vim: ts=4 sw=4 et
*/</span>
<span class="hljs-comment">/* Our first program is a consumer. After the headers the shared memory segment
 (the size of our shared memory structure) is created with a call to shmget,
 with the IPC_CREAT bit specified. */</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/shm.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"shm_com.h"</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">void</span> *shared_memory = (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>;
    <span class="hljs-keyword">struct</span> shared_use_st *shared_stuff;
    <span class="hljs-keyword">int</span> shmid;

    srand((<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)getpid());    

    shmid = shmget((<span class="hljs-keyword">key_t</span>)<span class="hljs-number">1234</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> shared_use_st), <span class="hljs-number">0666</span> | IPC_CREAT);
    
    <span class="hljs-keyword">if</span> (shmid == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmget failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

<span class="hljs-comment">/* We now make the shared memory accessible to the program. */</span>

    shared_memory = shmat(shmid, (<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shared_memory == (<span class="hljs-keyword">void</span> *)<span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmat failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Memory attached at %X\n"</span>, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span>)(<span class="hljs-keyword">long</span>)shared_memory);

<span class="hljs-comment">/* The next portion of the program assigns the shared_memory segment to shared_stuff,
 which then prints out any text in written_by_you. The loop continues until end is found
 in written_by_you. The call to sleep forces the consumer to sit in its critical section,
 which makes the producer wait. */</span>

    shared_stuff = (<span class="hljs-keyword">struct</span> shared_use_st *)shared_memory;


    shared_stuff-&gt;written_by_you = <span class="hljs-number">1</span>;

    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-comment">/* Wait for the client */</span>
        <span class="hljs-keyword">if</span> (shared_stuff-&gt;written_by_you != <span class="hljs-number">2</span>)
            shared_stuff-&gt;written_by_you = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">if</span> (shared_stuff-&gt;written_by_you == <span class="hljs-number">2</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n【Get the client's array】\n"</span>);
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"The array (Before Sorted)\n"</span>);
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">"[%d]%d \t"</span>, i, shared_stuff-&gt;some_text[i]);
            }
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n"</span>);


            <span class="hljs-comment">/* Sort the array */</span>
            shared_stuff-&gt;answer_by_you = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">int</span> tmp = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10</span> ; j++) {
                    <span class="hljs-keyword">if</span> (shared_stuff-&gt;some_text[i] &lt; shared_stuff-&gt;some_text[j]) {
                        tmp = shared_stuff-&gt;some_text[i];
                        shared_stuff-&gt;some_text[i] = shared_stuff-&gt;some_text[j];
                        shared_stuff-&gt;some_text[j] = tmp;
                    }
                }
            }
            shared_stuff-&gt;answer_by_you = <span class="hljs-number">1</span>;
            sleep(rand() % <span class="hljs-number">4</span>); <span class="hljs-comment">/* make the other process wait for us ! */</span> 
            shared_stuff-&gt;written_by_you = <span class="hljs-number">1</span>;
        }
        sleep(<span class="hljs-number">1</span>);
    }


<span class="hljs-comment">/* Lastly, the shared memory is detached and then deleted. */</span>
    <span class="hljs-keyword">if</span> (shmdt(shared_memory) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmdt failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    <span class="hljs-keyword">if</span> (shmctl(shmid, IPC_RMID, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"shmctl(IPC_RMID) failed\n"</span>);
        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
    }

    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}

</div></div></code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/6VYmXyg.jpg" alt=""></li>
</ul><h2 id="20170428"><a class="anchor hidden-xs" href="#20170428" title="20170428"><span class="octicon octicon-link"></span></a>20170428</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170428/Working-with-files.pdf" target="_blank">Working with Files</a></li>
<li><a href="http://advancedlinuxprogramming.com/alp-folder/alp-apB-low-level-io.pdf" target="_blank">Low-Level I/O</a></li>
</ul>
</li>
</ul><h3 id="一-low-level-file-access"><a class="anchor hidden-xs" href="#一-low-level-file-access" title="一-low-level-file-access"><span class="octicon octicon-link"></span></a>(一) Low-level file access</h3><p>Header：<code>#include &lt;unistd.h&gt;</code></p><ul>
<li>
<p>Action</p>
<ul>
<li>open</li>
<li>read</li>
<li>write</li>
<li>close</li>
<li>ioctl</li>
</ul>
</li>
<li>
<p>Status</p>
<ul>
<li>0：standard input</li>
<li>1：standard output</li>
<li>2：standard error</li>
</ul>
</li>
<li>
<p>Permission</p>
<ul>
<li>S_IRUSR</li>
<li>S_IWUSR</li>
<li>S_IXUSR</li>
<li>S_IRGRP</li>
<li>S_IWGRP</li>
<li>S_IWGRP</li>
<li>S_IROTH</li>
<li>S_IWOTH</li>
<li>S_IXOTH</li>
</ul>
</li>
</ul><h4 id="1-open"><a class="anchor hidden-xs" href="#1-open" title="1-open"><span class="octicon octicon-link"></span></a>1. open</h4><ul>
<li><code>int open(const char* path, int oflags);</code></li>
<li><code>int open(const char* path, int oflags, mode_t mode);</code></li>
<li>Mode
<ul>
<li>O_RDONLY</li>
<li>O_WRONLY</li>
<li>O_RDWR</li>
</ul>
</li>
<li>Oflags
<ul>
<li>O_APPEND</li>
<li>O_TRUNC ( 放棄現有的內容、長度歸零)</li>
<li>O_CREAT</li>
<li>O_EXCL (確保呼叫者可以產生檔案)</li>
</ul>
</li>
</ul><h4 id="2-read"><a class="anchor hidden-xs" href="#2-read" title="2-read"><span class="octicon octicon-link"></span></a>2. read</h4><ul>
<li><code>size_t read(int fildes, void* buf, size_t nbytes);</code></li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">char</span> buffer[<span class="hljs-number">128</span>];
    <span class="hljs-keyword">int</span> nread;
    
    nread = read(<span class="hljs-number">0</span>, buffer, <span class="hljs-number">128</span>);
    <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)
        write(<span class="hljs-number">2</span>, <span class="hljs-string">"A read error has occurred\n"</span>, <span class="hljs-number">26</span>);

    <span class="hljs-keyword">if</span> ((write(<span class="hljs-number">1</span>, buffer, nread)) != nread)
        write(<span class="hljs-number">2</span>, <span class="hljs-string">"A write error has occurred\n"</span>, <span class="hljs-number">27</span>);
        
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</code></pre><h4 id="3-write"><a class="anchor hidden-xs" href="#3-write" title="3-write"><span class="octicon octicon-link"></span></a>3. write</h4><ul>
<li><code>size_t write(int fildes, void* buf, size_t n bytes);</code></li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> ((write(<span class="hljs-number">1</span>, <span class="hljs-string">"Here is some data\n"</span>, <span class="hljs-number">18</span>)) != <span class="hljs-number">18</span>
)
    write(<span class="hljs-number">2</span>, <span class="hljs-string">"A write error has occurred on file descriptor 1\n"</span>,<span class="hljs-number">46</span>);

    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);
}
</code></pre><h4 id="example-file-copy"><a class="anchor hidden-xs" href="#example-file-copy" title="example-file-copy"><span class="octicon octicon-link"></span></a>[Example] File copy</h4><ul>
<li>Example 1</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#include <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#include <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#include <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>

<span class="hljs-keyword">int</span> main()
{
    <span class="hljs-keyword">char</span> c;
    <span class="hljs-keyword">int</span> <span class="hljs-keyword">in</span>, <span class="hljs-keyword">out</span>;
    
    <span class="hljs-keyword">in</span> = open(<span class="hljs-string">"file.in"</span>, O_RDONLY);
    <span class="hljs-keyword">out</span> = open(<span class="hljs-string">"file.out"</span>, O_WRONLY|O_CREAT, S_IRUSR|S_IWUSR);

    <span class="hljs-keyword">while</span>(read(<span class="hljs-keyword">in</span>,&amp;c,<span class="hljs-number">1</span>) == <span class="hljs-number">1</span>)
        write(<span class="hljs-keyword">out</span>,&amp;c,<span class="hljs-number">1</span>);
        
    exit(<span class="hljs-number">0</span>);
}
</code></pre><ul>
<li>Example2</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#include <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#include <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#include <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span>

<span class="hljs-keyword">int</span> main()
{
    <span class="hljs-keyword">char</span> block[<span class="hljs-number">1024</span>];
    <span class="hljs-keyword">int</span> <span class="hljs-keyword">in</span>, <span class="hljs-keyword">out</span>;
    <span class="hljs-keyword">int</span> nread;
    
    <span class="hljs-keyword">in</span> = open(<span class="hljs-string">"file.in"</span>, O_RDONLY);
    <span class="hljs-keyword">out</span> = open(<span class="hljs-string">"file.out"</span>, O_WRONLY|O_CREAT, S_IRUSR|S_IWUSR);
    <span class="hljs-keyword">while</span>((nread = read(<span class="hljs-keyword">in</span>,block,<span class="hljs-keyword">sizeof</span>(block))) &gt; <span class="hljs-number">0</span>)
        write(<span class="hljs-keyword">out</span>,block,nread);

    exit(<span class="hljs-number">0</span>);
}
</code></pre><h3 id="二-standard-io-library"><a class="anchor hidden-xs" href="#二-standard-io-library" title="二-standard-io-library"><span class="octicon octicon-link"></span></a>(二) Standard I/O Library</h3><p>Header：<code>#include &lt;stdio.h&gt;</code></p><ul>
<li><code>fopen</code>, <code>fclose</code>
<ul>
<li>int fclose(FILE* stream);</li>
</ul>
</li>
<li><code>fread</code>, <code>fwrite</code>
<ul>
<li>size_t fread(void* ptr, size_t size, size_t nitems, FILE* stream);</li>
<li>size_t fwrite(void* ptr, size_t size, size_t nitems, FILE* stream);</li>
</ul>
</li>
<li><code>fflush</code>
<ul>
<li>int fflush(FLIE* stream);</li>
</ul>
</li>
<li><code>fseek</code>
<ul>
<li>int fseek(FILE* stream, long int offset, int whence);</li>
</ul>
</li>
<li><code>fgetc</code>, <code>getc</code>, <code>getchar</code>
<ul>
<li>int fgetc(FILE* stream);</li>
<li>int getc(FILE* stream);</li>
<li>int getchar();</li>
</ul>
</li>
<li><code>fputc</code>, <code>putc</code>, <code>putchar</code>
<ul>
<li>int fputc(int c, FILE* stream);</li>
<li>int putc(int c, FILE* stream);</li>
<li>int putchar(int c);</li>
</ul>
</li>
<li><code>fgets</code>, <code>gets</code>
<ul>
<li>char* fgets(char<em>s, int n, FILE</em> stream);</li>
<li>char* gets(char*s);</li>
</ul>
</li>
<li><code>printf</code>, <code>fprintf</code>, <code>sprintf</code></li>
<li><code>scanf</code>, <code>fscanf</code>, <code>sscanf</code></li>
</ul><h4 id="fopen"><a class="anchor hidden-xs" href="#fopen" title="fopen"><span class="octicon octicon-link"></span></a>fopen</h4><ul>
<li><code>FILE *fopen(const char *filename, const char* mode);</code>
<ul>
<li><code>r</code> (唯讀模式)</li>
<li><code>w</code> (寫入模式、長度歸零)</li>
<li><code>a</code> (寫入模式、附加)</li>
</ul>
</li>
</ul><h4 id="2-printf-sprintf-fprintf"><a class="anchor hidden-xs" href="#2-printf-sprintf-fprintf" title="2-printf-sprintf-fprintf"><span class="octicon octicon-link"></span></a>2. printf, sprintf, fprintf</h4><p>%d, %o, %x, %c ,%s ,%f (float) ,%e (double) ,%g (double)</p><h4 id="3-scanf-fscanf-sscanf"><a class="anchor hidden-xs" href="#3-scanf-fscanf-sscanf" title="3-scanf-fscanf-sscanf"><span class="octicon octicon-link"></span></a>3. scanf, fscanf, sscanf</h4><p>%d, %o, %x, %f, %e, %g, %c, %s, %[] (掃瞄特定字元), %% (掃瞄 % 的字元)</p><h2 id="20170505"><a class="anchor hidden-xs" href="#20170505" title="20170505"><span class="octicon octicon-link"></span></a>20170505</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170505/Working-with-files.pdf" target="_blank">Working-with-files</a></li>
</ul>
</li>
</ul><h3 id="一-mmap"><a class="anchor hidden-xs" href="#一-mmap" title="一-mmap"><span class="octicon octicon-link"></span></a>(一) mmap</h3><ul>
<li><code>void *mmap(void *addr, size_t len, int port, int flags, int fildes, off_t off);</code>
<ul>
<li>PORT_READ</li>
<li>PORT_WRITE</li>
<li>PORT_EXEC</li>
<li>PORT_NONE</li>
<li>MAP_PRIVATE</li>
<li>MAP_SHARED</li>
<li>MAP_FIXED</li>
</ul>
</li>
</ul><h3 id="二-msync"><a class="anchor hidden-xs" href="#二-msync" title="二-msync"><span class="octicon octicon-link"></span></a>(二) msync</h3><ul>
<li><code>int msync(void* addr, size_t len, int flags);</code>
<ul>
<li>MS_AYSNC (非同步寫入)</li>
<li>MS_SYNC (同步寫入)</li>
<li>MS_INVALIDATE (再從檔案讀)</li>
</ul>
</li>
</ul><h3 id="三-munmap"><a class="anchor hidden-xs" href="#三-munmap" title="三-munmap"><span class="octicon octicon-link"></span></a>(三) munmap</h3><ul>
<li>
<p><code>int munmap(void * addr, size_t len);</code></p>
</li>
<li>
<p><code>fprintf.c</code></p>
</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIZE 100</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{

	FILE *fptr, *fptr2;
	<span class="hljs-keyword">int</span> i, j;
	<span class="hljs-keyword">float</span> a, b;
    srand(time(<span class="hljs-literal">NULL</span>));

	fptr = fopen(<span class="hljs-string">"ans.txt"</span>, <span class="hljs-string">"w"</span>);

	<span class="hljs-keyword">if</span> (!fptr){
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"open error \n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
	} <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"open success, start writing into file\n"</span>);
    }

	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt;= SIZE; i++) {
        a = ((<span class="hljs-keyword">float</span>)rand() / (<span class="hljs-keyword">float</span>)(RAND_MAX)) * <span class="hljs-number">100</span>;
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"[%3d] = %3.3f\n"</span>, i, a);
		<span class="hljs-built_in">fprintf</span>(fptr, <span class="hljs-string">"%3.3f\n"</span>, a);
	}

	fclose(fptr);
	<span class="hljs-comment">/*---------------------------------------------------------- */</span>
	fptr2 = fopen(<span class="hljs-string">"ans.txt"</span>, <span class="hljs-string">"r"</span>);

	<span class="hljs-keyword">if</span>(!fptr2) {
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"open error\n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
	} <span class="hljs-keyword">else</span> {
	    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"open success, start reading from file\n"</span>);
	}

	i = <span class="hljs-number">1</span>;
	<span class="hljs-keyword">while</span> (<span class="hljs-built_in">fscanf</span>(fptr2, <span class="hljs-string">"%6f"</span> ,&amp;b) == <span class="hljs-number">1</span>)
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"[%3d] = %3.3f\n"</span>, i++, b);
	
	fclose(fptr2);
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><ul>
<li>執行結果</li>
</ul><p><img src="https://i.imgur.com/WkwKXZJ.png" alt=""></p><p><img src="https://i.imgur.com/vFysQAi.png" alt=""></p><h3 id="課堂作業1"><a class="anchor hidden-xs" href="#課堂作業1" title="課堂作業1"><span class="octicon octicon-link"></span></a>課堂作業</h3><ul>
<li>給予一個資料檔，計算其平均值與標準差。</li>
</ul><pre><code class="c hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SIZE 100</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{

	FILE *fptr1, *fptr2;
	<span class="hljs-keyword">int</span> i;
	<span class="hljs-keyword">float</span> a = <span class="hljs-number">.0</span>, total = <span class="hljs-number">.0</span>, avg = <span class="hljs-number">.0</span>;
    <span class="hljs-keyword">float</span> sigma = <span class="hljs-number">.0</span>, sd = <span class="hljs-number">.0</span>;


    <span class="hljs-comment">/* Use fptr1 to calculate total and average */</span>
    fptr1 = fopen(<span class="hljs-string">"ans.txt"</span>, <span class="hljs-string">"r"</span>);
	<span class="hljs-keyword">if</span> (!fptr1) {
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"open error\n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
	} 
    
    <span class="hljs-keyword">else</span> {
	    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nopen success, fptr1 starts reading from file\n"</span>);
	}


    i = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fscanf</span>(fptr1, <span class="hljs-string">"%6f"</span> ,&amp;a) == <span class="hljs-number">1</span>) {
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"[%3d] = %3.3f\n"</span>, i++, a);
        total += a;
    }
	avg = (total / i);
    fclose(fptr1);




    <span class="hljs-comment">/* Use fptr2 to calculate standard deviation */</span>
    fptr2 = fopen(<span class="hljs-string">"ans.txt"</span>, <span class="hljs-string">"r"</span>);
    <span class="hljs-keyword">if</span> (!fptr2) {
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"open error\n"</span>);
		<span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
	} 
    
    <span class="hljs-keyword">else</span> {
	    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\nopen success, fptr2 starts reading from file\n"</span>);
	}


    i = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fscanf</span>(fptr2, <span class="hljs-string">"%6f"</span> ,&amp;a) == <span class="hljs-number">1</span>) {
        sigma += (a - avg) * (a - avg);
        i++;
    }
    sd = <span class="hljs-built_in">sqrt</span>(sigma / i); 
    fclose(fptr2);




    <span class="hljs-comment">/* Output */</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\n\nThe average = %f\n"</span>, avg);
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"The standard deviation = %f\n"</span>, sd);


	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/W17ixQD.png" alt=""></li>
</ul><h2 id="20170512"><a class="anchor hidden-xs" href="#20170512" title="20170512"><span class="octicon octicon-link"></span></a>20170512</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170512/Linux_shell.pdf" target="_blank">Linux_shell</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170512/Shell_practice.pdf" target="_blank">Shell_practice</a></li>
</ul>
</li>
<li>參考資料
<ul>
<li><a href="http://linux.vbird.org/linux_basic/0340bashshell-scripts.php#script_why" target="_blank">學習 Shell Scripts</a></li>
</ul>
</li>
</ul><h3 id="一-shell-簡介"><a class="anchor hidden-xs" href="#一-shell-簡介" title="一-shell-簡介"><span class="octicon octicon-link"></span></a>(一) Shell 簡介</h3><ul>
<li>Shell 是使用者與 Linux 系統的介面，可以輸入命令，交由作業系統去執行。
<ul>
<li>Shell 快速且簡單</li>
<li>Shell 一般稱為 script</li>
<li>直譯式執行，容易除錯</li>
</ul>
</li>
</ul><p><img src="https://i.imgur.com/xadWBBf.png" alt=""></p><h3 id="二-變數-variables"><a class="anchor hidden-xs" href="#二-變數-variables" title="二-變數-variables"><span class="octicon octicon-link"></span></a>(二) 變數 (variables)</h3><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
salutation=Hello
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$salutation</span>

salutation=<span class="hljs-string">"Yes Dear"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$salutation</span>

salutation=7+5
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$salutation</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/jaY3g8G.png" alt=""></li>
</ul><h3 id="三-引號-quoting"><a class="anchor hidden-xs" href="#三-引號-quoting" title="三-引號-quoting"><span class="octicon octicon-link"></span></a>(三) 引號 (quoting)</h3><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
myvar=<span class="hljs-string">"Hi there"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-variable">$myvar</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$myvar</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'$myvar'</span>
<span class="hljs-built_in">echo</span> \<span class="hljs-variable">$myvar</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Please enter something..."</span>
<span class="hljs-built_in">read</span> myvar
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$myvar</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/NobGb6l.png" alt=""></li>
</ul><h3 id="四-條件判斷-condition"><a class="anchor hidden-xs" href="#四-條件判斷-condition" title="四-條件判斷-condition"><span class="octicon octicon-link"></span></a>(四) 條件判斷 (condition)</h3><p><img src="https://i.imgur.com/enjX7FA.png" alt=""><br>
<img src="https://i.imgur.com/nVZTV1F.png" alt=""></p><h3 id="五-控制結構-if"><a class="anchor hidden-xs" href="#五-控制結構-if" title="五-控制結構-if"><span class="octicon octicon-link"></span></a>(五) 控制結構 - if</h3><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Is it morning ?"</span>
<span class="hljs-built_in">read</span> timeofday

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$timeofday</span> = <span class="hljs-string">"yes"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good morning"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good afternoon"</span>
<span class="hljs-keyword">fi</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/lSzTfpI.png" alt=""></li>
</ul><h3 id="六-控制結構-elif"><a class="anchor hidden-xs" href="#六-控制結構-elif" title="六-控制結構-elif"><span class="octicon octicon-link"></span></a>(六) 控制結構 - elif</h3><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Is it morning ?"</span>
<span class="hljs-built_in">read</span> timeofday

<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$timeofday</span>"</span> = <span class="hljs-string">"yes"</span> ]
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good morning"</span>

<span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">$timeofday</span>"</span> = <span class="hljs-string">"no"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good afternoon"</span>

<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Sorry, <span class="hljs-variable">$timeofday</span> not recognized"</span>
<span class="hljs-keyword">fi</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/6T6jDMe.png" alt=""></li>
</ul><h3 id="七-控制結構-for"><a class="anchor hidden-xs" href="#七-控制結構-for" title="七-控制結構-for"><span class="octicon octicon-link"></span></a>(七) 控制結構 - for</h3><h5 id="example-1"><a class="anchor hidden-xs" href="#example-1" title="example-1"><span class="octicon octicon-link"></span></a>Example 1</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">for</span> foo <span class="hljs-keyword">in</span> bar fud 43
<span class="hljs-keyword">do</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$foo</span>
<span class="hljs-keyword">done</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/rfV1Ra5.png" alt=""></li>
</ul><h5 id="example-2"><a class="anchor hidden-xs" href="#example-2" title="example-2"><span class="octicon octicon-link"></span></a>Example 2</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 1 2 3
<span class="hljs-keyword">do</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$i</span>
<span class="hljs-keyword">done</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/0h1Rraa.png" alt=""></li>
</ul><h3 id="八-控制結構-while"><a class="anchor hidden-xs" href="#八-控制結構-while" title="八-控制結構-while"><span class="octicon octicon-link"></span></a>(八) 控制結構 - while</h3><h5 id="example-11"><a class="anchor hidden-xs" href="#example-11" title="example-11"><span class="octicon octicon-link"></span></a>Example 1</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Enter password"</span>
<span class="hljs-built_in">read</span> trythis
    
<span class="hljs-keyword">while</span> [ <span class="hljs-string">"<span class="hljs-variable">$trythis</span>"</span> != <span class="hljs-string">"secret"</span> ]; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Sorry, try again"</span>
    <span class="hljs-built_in">read</span> trythis
<span class="hljs-keyword">done</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/bLumx82.png" alt=""></li>
</ul><h5 id="example-21"><a class="anchor hidden-xs" href="#example-21" title="example-21"><span class="octicon octicon-link"></span></a>Example 2</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
foo=1

<span class="hljs-keyword">while</span> [ <span class="hljs-string">"<span class="hljs-variable">$foo</span>"</span> -le 20 ]
<span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Here we go again"</span>
    foo=$((<span class="hljs-variable">$foo</span>+1))
<span class="hljs-keyword">done</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/tr0Zi4C.png" alt=""></li>
</ul><h5 id="example-3"><a class="anchor hidden-xs" href="#example-3" title="example-3"><span class="octicon octicon-link"></span></a>Example 3</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
x=0

<span class="hljs-keyword">while</span> [ <span class="hljs-string">"<span class="hljs-variable">$x</span>"</span> <span class="hljs-_">-ne</span> 10 ]; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-variable">$x</span>
    x=$((<span class="hljs-variable">$x</span>+1))
<span class="hljs-keyword">done</span>
<span class="hljs-built_in">exit</span> 0
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/eeuK6q3.png" alt=""></li>
</ul><h3 id="九-控制結構-case"><a class="anchor hidden-xs" href="#九-控制結構-case" title="九-控制結構-case"><span class="octicon octicon-link"></span></a>(九) 控制結構 - case</h3><h5 id="example-12"><a class="anchor hidden-xs" href="#example-12" title="example-12"><span class="octicon octicon-link"></span></a>Example 1</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Is it morning? Please answer 'Yes'、'y'、'No'、'n'"</span>
<span class="hljs-built_in">read</span> timeofday

<span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$timeofday</span>"</span> <span class="hljs-keyword">in</span>
	Yes) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good Morning"</span> ;;
	No) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good Aftrenoon"</span> ;;
	y) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good Morning"</span> ;;
	n) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good Aftrenoon"</span> ;;
	*) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Sorry, answer not recognized"</span> ;;
<span class="hljs-keyword">esac</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/Hnaa66Y.png" alt=""></li>
</ul><h5 id="example-22"><a class="anchor hidden-xs" href="#example-22" title="example-22"><span class="octicon octicon-link"></span></a>Example 2</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Is it morning? Please answer 'Yes'、'Y...'、'y'、'No'、'N...'、'n'"</span>
<span class="hljs-built_in">read</span> timeofday

<span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$timeofday</span>"</span> <span class="hljs-keyword">in</span>
    Y* | y | Yes) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good Morning"</span> ;;
    N* | n | No) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Good Aftrenoon"</span> ;;
    *) <span class="hljs-built_in">echo</span> <span class="hljs-string">"Sorry, answer not recognized"</span> ;;
<span class="hljs-keyword">esac</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/Opd1dfC.png" alt=""></li>
</ul><h3 id="十-控制結構-and"><a class="anchor hidden-xs" href="#十-控制結構-and" title="十-控制結構-and"><span class="octicon octicon-link"></span></a>(十) 控制結構 - AND</h3><h5 id="example-13"><a class="anchor hidden-xs" href="#example-13" title="example-13"><span class="octicon octicon-link"></span></a>Example 1</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
touch file_one
rm file_two

<span class="hljs-keyword">if</span> [ <span class="hljs-_">-f</span> file_one ] &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"hello"</span> &amp;&amp; [ <span class="hljs-_">-f</span> file_two ] &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-string">"there"</span>
<span class="hljs-keyword">then</span> 
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"in if"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"in else"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">exit</span> 0
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/P3wITc9.png" alt=""></li>
</ul><h3 id="十一-控制結構-or"><a class="anchor hidden-xs" href="#十一-控制結構-or" title="十一-控制結構-or"><span class="octicon octicon-link"></span></a>(十一) 控制結構 - OR</h3><h5 id="example-14"><a class="anchor hidden-xs" href="#example-14" title="example-14"><span class="octicon octicon-link"></span></a>Example 1</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh</span>
rm –f file_one

<span class="hljs-keyword">if</span> [ <span class="hljs-_">-f</span> file_one ] || <span class="hljs-built_in">echo</span> <span class="hljs-string">"hello"</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">"there"</span>
<span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"in if"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"in else"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">exit</span> 0
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/POqHcOx.png" alt=""></li>
</ul><h3 id="課堂作業2"><a class="anchor hidden-xs" href="#課堂作業2" title="課堂作業2"><span class="octicon octicon-link"></span></a>課堂作業</h3><p><img src="https://i.imgur.com/UYMl9ZM.png" alt=""></p><h2 id="20170519"><a class="anchor hidden-xs" href="#20170519" title="20170519"><span class="octicon octicon-link"></span></a>20170519</h2><ul>
<li>課程簡報
<ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170512/Linux_shell.pdf" target="_blank">Linux_shell</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170512/Shell_practice.pdf" target="_blank">Shell_practice</a></li>
</ul>
</li>
<li>參考資料
<ul>
<li><a href="http://linux.vbird.org/linux_basic/0340bashshell-scripts.php#script_why" target="_blank">學習 Shell Scripts</a></li>
</ul>
</li>
</ul><h3 id="一-函數-function"><a class="anchor hidden-xs" href="#一-函數-function" title="一-函數-function"><span class="octicon octicon-link"></span></a>(一) 函數 (Function)</h3><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-function"><span class="hljs-title">foo</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Function foo is excuting"</span>
}

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Script starting"</span>
foo
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Script ending"</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/WPrf3XF.png" alt=""></li>
</ul><h3 id="二-命令-command"><a class="anchor hidden-xs" href="#二-命令-command" title="二-命令-command"><span class="octicon octicon-link"></span></a>(二) 命令 (command)</h3><h5 id="example-15"><a class="anchor hidden-xs" href="#example-15" title="example-15"><span class="octicon octicon-link"></span></a>Example 1</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> 1 2 3
<span class="hljs-keyword">do</span> 
    <span class="hljs-built_in">echo</span> before <span class="hljs-variable">$x</span>
    <span class="hljs-built_in">continue</span>
    <span class="hljs-built_in">echo</span> after <span class="hljs-variable">$x</span>
<span class="hljs-keyword">done</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/3WgXZOC.png" alt=""></li>
</ul><h5 id="example-23"><a class="anchor hidden-xs" href="#example-23" title="example-23"><span class="octicon octicon-link"></span></a>Example 2</h5><pre><code class="shell hljs"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> 1 2 3
<span class="hljs-keyword">do</span> 
    <span class="hljs-built_in">echo</span> before <span class="hljs-variable">$x</span>
    <span class="hljs-built_in">break</span>
    <span class="hljs-built_in">echo</span> after <span class="hljs-variable">$x</span>
<span class="hljs-keyword">done</span>
</code></pre><ul>
<li>執行結果<br>
<img src="https://i.imgur.com/DVLkGCC.png" alt=""></li>
</ul><h4 id="其他命令"><a class="anchor hidden-xs" href="#其他命令" title="其他命令"><span class="octicon octicon-link"></span></a>其他命令</h4><ul>
<li>exit</li>
<li>export</li>
<li>expr</li>
<li>printf</li>
<li>return</li>
<li>set</li>
<li>shift</li>
</ul><h3 id="三-命令-command-find"><a class="anchor hidden-xs" href="#三-命令-command-find" title="三-命令-command-find"><span class="octicon octicon-link"></span></a>(三) 命令 (command) - find</h3><pre><code>-atime N           檔案最後存取時間是 N 天以前
-mtime N           檔案最後修改時間是 N 天以前
-newer otherfle    檔案比 otherfle 還要新
-name pattern      搜尋 pattern 名稱的檔案
-type C            檔案型態是 C 的檔案
-user username     檔案為 username 使用者所擁有
</code></pre><blockquote>
<p>find / -name test -print<br>
find . -newer test -print</p>
</blockquote><h3 id="四-命令-command-grep"><a class="anchor hidden-xs" href="#四-命令-command-grep" title="四-命令-command-grep"><span class="octicon octicon-link"></span></a>(四) 命令 (command) - grep</h3><pre><code>-c    不印出吻合的那一行,只印出吻合的數量
-E    開啟延伸表示式
-h    輸出的結果不顯示檔案名稱
-I    忽略大小寫
-l    只列出檔案名稱
-v    反向比對,排除吻合樣本的結果
</code></pre><blockquote>
<p>grep in word.txt<br>
grep -c in word.txt word2.txt</p>
</blockquote><h4 id="正規表示式"><a class="anchor hidden-xs" href="#正規表示式" title="正規表示式"><span class="octicon octicon-link"></span></a>正規表示式</h4><p><img src="https://i.imgur.com/ZL5A5xf.png" alt=""><br>
<img src="https://i.imgur.com/rLplSSh.png" alt=""></p><h2 id="20170526"><a class="anchor hidden-xs" href="#20170526" title="20170526"><span class="octicon octicon-link"></span></a>20170526</h2><ul>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170526/MPI_setup.pdf" target="_blank">MPI 環境架設</a></li>
<li><a href="https://github.com/shouzo/Operating-System_pages/blob/master/class-tutorial/20170526/MPI_doing.pdf" target="_blank">MPI程式撰寫與實作</a></li>
</ul></div>
    <div class="ui-toc dropup unselectable hidden-print" style="display:none;">
        <div class="pull-right dropdown">
            <a id="tocLabel" class="ui-toc-label btn btn-default" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false" title="Table of content">
                <i class="fa fa-bars"></i>
            </a>
            <ul id="ui-toc" class="ui-toc-dropdown dropdown-menu" aria-labelledby="tocLabel">
                <div class="toc"><ul class="nav"><li class=""><a href="#linux-系統與程式設計">Linux 系統與程式設計</a><ul class="nav"><li class=""><a href="#20170303">20170303</a><ul class="nav"><li class=""><a href="#延伸學習">延伸學習</a></li></ul></li><li class=""><a href="#20170310">20170310</a><ul class="nav"><li class=""><a href="#一-unix-system-call">(一) Unix system call</a></li><li class=""><a href="#二-signals">(二) Signals</a></li></ul></li><li class=""><a href="#20170317">20170317</a><ul class="nav"><li class=""><a href="#1-what-is-a-thread？">1. What is a Thread？</a></li><li class=""><a href="#2-process-and-thread">2. Process and Thread</a></li><li class=""><a href="#3-pthreads">3. Pthreads</a></li></ul></li><li class=""><a href="#20170324">20170324</a><ul class="nav"><li class=""><a href="#一、pthreads">一、Pthreads</a></li><li class=""><a href="#二、condition-variables">二、Condition Variables</a></li><li><a href="#三、thread-synchronization">三、Thread Synchronization</a></li><li class=""><a href="#1-semaphore">1. Semaphore</a></li><li class=""><a href="#2-mutex">2. Mutex</a></li><li class=""><a href="#課程作業">課程作業</a></li></ul></li><li class=""><a href="#20170331">20170331</a><ul class="nav"><li class=""><a href="#socket-programming">Socket Programming</a></li><li class=""><a href="#課程作業1">課程作業</a></li></ul></li><li class=""><a href="#20170407">20170407</a><ul class="nav"><li class=""><a href="#課堂練習-一">課堂練習 (一)</a></li><li class=""><a href="#課堂練習-二">課堂練習 (二)</a></li></ul></li><li class=""><a href="#20170414">20170414</a><ul class="nav"><li class=""><a href="#一-shared-memory-concept">(一) Shared Memory Concept</a></li><li class=""><a href="#二-shared-memory-function">(二) Shared Memory Function</a></li><li class=""><a href="#課堂作業">課堂作業</a></li></ul></li><li class=""><a href="#20170428">20170428</a><ul class="nav"><li class=""><a href="#一-low-level-file-access">(一) Low-level file access</a></li><li class=""><a href="#二-standard-io-library">(二) Standard I/O Library</a></li></ul></li><li class=""><a href="#20170505">20170505</a><ul class="nav"><li class=""><a href="#一-mmap">(一) mmap</a></li><li><a href="#二-msync">(二) msync</a></li><li class=""><a href="#三-munmap">(三) munmap</a></li><li class=""><a href="#課堂作業1">課堂作業</a></li></ul></li><li class=""><a href="#20170512">20170512</a><ul class="nav"><li class=""><a href="#一-shell-簡介">(一) Shell 簡介</a></li><li class=""><a href="#二-變數-variables">(二) 變數 (variables)</a></li><li class=""><a href="#三-引號-quoting">(三) 引號 (quoting)</a></li><li class=""><a href="#四-條件判斷-condition">(四) 條件判斷 (condition)</a></li><li class=""><a href="#五-控制結構-if">(五) 控制結構 - if</a></li><li class=""><a href="#六-控制結構-elif">(六) 控制結構 - elif</a></li><li class=""><a href="#七-控制結構-for">(七) 控制結構 - for</a></li><li class=""><a href="#八-控制結構-while">(八) 控制結構 - while</a></li><li class=""><a href="#九-控制結構-case">(九) 控制結構 - case</a></li><li class=""><a href="#十-控制結構-and">(十) 控制結構 - AND</a></li><li class=""><a href="#十一-控制結構-or">(十一) 控制結構 - OR</a></li><li class=""><a href="#課堂作業2">課堂作業</a></li></ul></li><li class=""><a href="#20170519">20170519</a><ul class="nav"><li class=""><a href="#一-函數-function">(一) 函數 (Function)</a></li><li class=""><a href="#二-命令-command">(二) 命令 (command)</a></li><li class=""><a href="#三-命令-command-find">(三) 命令 (command) - find</a></li><li class=""><a href="#四-命令-command-grep">(四) 命令 (command) - grep</a></li></ul></li><li><a href="#20170526">20170526</a></li></ul></li></ul></div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
            </ul>
        </div>
    </div>
    <div id="ui-toc-affix" class="ui-affix-toc ui-toc-dropdown unselectable hidden-print" data-spy="affix" style="top:17px;display:none;"  >
        <div class="toc"><ul class="nav"><li class=""><a href="#linux-系統與程式設計">Linux 系統與程式設計</a><ul class="nav"><li class=""><a href="#20170303">20170303</a><ul class="nav"><li class=""><a href="#延伸學習">延伸學習</a></li></ul></li><li class=""><a href="#20170310">20170310</a><ul class="nav"><li class=""><a href="#一-unix-system-call">(一) Unix system call</a></li><li class=""><a href="#二-signals">(二) Signals</a></li></ul></li><li class=""><a href="#20170317">20170317</a><ul class="nav"><li class=""><a href="#1-what-is-a-thread？">1. What is a Thread？</a></li><li class=""><a href="#2-process-and-thread">2. Process and Thread</a></li><li class=""><a href="#3-pthreads">3. Pthreads</a></li></ul></li><li class=""><a href="#20170324">20170324</a><ul class="nav"><li class=""><a href="#一、pthreads">一、Pthreads</a></li><li class=""><a href="#二、condition-variables">二、Condition Variables</a></li><li><a href="#三、thread-synchronization">三、Thread Synchronization</a></li><li class=""><a href="#1-semaphore">1. Semaphore</a></li><li class=""><a href="#2-mutex">2. Mutex</a></li><li class=""><a href="#課程作業">課程作業</a></li></ul></li><li class=""><a href="#20170331">20170331</a><ul class="nav"><li class=""><a href="#socket-programming">Socket Programming</a></li><li class=""><a href="#課程作業1">課程作業</a></li></ul></li><li class=""><a href="#20170407">20170407</a><ul class="nav"><li class=""><a href="#課堂練習-一">課堂練習 (一)</a></li><li class=""><a href="#課堂練習-二">課堂練習 (二)</a></li></ul></li><li class=""><a href="#20170414">20170414</a><ul class="nav"><li class=""><a href="#一-shared-memory-concept">(一) Shared Memory Concept</a></li><li class=""><a href="#二-shared-memory-function">(二) Shared Memory Function</a></li><li class=""><a href="#課堂作業">課堂作業</a></li></ul></li><li class=""><a href="#20170428">20170428</a><ul class="nav"><li class=""><a href="#一-low-level-file-access">(一) Low-level file access</a></li><li class=""><a href="#二-standard-io-library">(二) Standard I/O Library</a></li></ul></li><li class=""><a href="#20170505">20170505</a><ul class="nav"><li class=""><a href="#一-mmap">(一) mmap</a></li><li><a href="#二-msync">(二) msync</a></li><li class=""><a href="#三-munmap">(三) munmap</a></li><li class=""><a href="#課堂作業1">課堂作業</a></li></ul></li><li class=""><a href="#20170512">20170512</a><ul class="nav"><li class=""><a href="#一-shell-簡介">(一) Shell 簡介</a></li><li class=""><a href="#二-變數-variables">(二) 變數 (variables)</a></li><li class=""><a href="#三-引號-quoting">(三) 引號 (quoting)</a></li><li class=""><a href="#四-條件判斷-condition">(四) 條件判斷 (condition)</a></li><li class=""><a href="#五-控制結構-if">(五) 控制結構 - if</a></li><li class=""><a href="#六-控制結構-elif">(六) 控制結構 - elif</a></li><li class=""><a href="#七-控制結構-for">(七) 控制結構 - for</a></li><li class=""><a href="#八-控制結構-while">(八) 控制結構 - while</a></li><li class=""><a href="#九-控制結構-case">(九) 控制結構 - case</a></li><li class=""><a href="#十-控制結構-and">(十) 控制結構 - AND</a></li><li class=""><a href="#十一-控制結構-or">(十一) 控制結構 - OR</a></li><li class=""><a href="#課堂作業2">課堂作業</a></li></ul></li><li class=""><a href="#20170519">20170519</a><ul class="nav"><li class=""><a href="#一-函數-function">(一) 函數 (Function)</a></li><li class=""><a href="#二-命令-command">(二) 命令 (command)</a></li><li class=""><a href="#三-命令-command-find">(三) 命令 (command) - find</a></li><li class=""><a href="#四-命令-command-grep">(四) 命令 (command) - grep</a></li></ul></li><li><a href="#20170526">20170526</a></li></ul></li></ul></div><div class="toc-menu"><a class="expand-toggle" href="#">Expand all</a><a class="back-to-top" href="#">Back to top</a><a class="go-to-bottom" href="#">Go to bottom</a></div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gist-embed/2.6.0/gist-embed.min.js" integrity="sha256-KyF2D6xPIJUW5sUDSs93vWyZm+1RzIpKCexxElmxl8g=" crossorigin="anonymous" defer></script>
    <script>
        var markdown = $(".markdown-body");
        //smooth all hash trigger scrolling
        function smoothHashScroll() {
            var hashElements = $("a[href^='#']").toArray();
            for (var i = 0; i < hashElements.length; i++) {
                var element = hashElements[i];
                var $element = $(element);
                var hash = element.hash;
                if (hash) {
                    $element.on('click', function (e) {
                        // store hash
                        var hash = this.hash;
                        if ($(hash).length <= 0) return;
                        // prevent default anchor click behavior
                        e.preventDefault();
                        // animate
                        $('body, html').stop(true, true).animate({
                            scrollTop: $(hash).offset().top
                        }, 100, "linear", function () {
                            // when done, add hash to url
                            // (default click behaviour)
                            window.location.hash = hash;
                        });
                    });
                }
            }
        }

        smoothHashScroll();
        var toc = $('.ui-toc');
        var tocAffix = $('.ui-affix-toc');
        var tocDropdown = $('.ui-toc-dropdown');
        //toc
        tocDropdown.click(function (e) {
            e.stopPropagation();
        });

        var enoughForAffixToc = true;

        function generateScrollspy() {
            $(document.body).scrollspy({
                target: ''
            });
            $(document.body).scrollspy('refresh');
            if (enoughForAffixToc) {
                toc.hide();
                tocAffix.show();
            } else {
                tocAffix.hide();
                toc.show();
            }
            $(document.body).scroll();
        }

        function windowResize() {
            //toc right
            var paddingRight = parseFloat(markdown.css('padding-right'));
            var right = ($(window).width() - (markdown.offset().left + markdown.outerWidth() - paddingRight));
            toc.css('right', right + 'px');
            //affix toc left
            var newbool;
            var rightMargin = (markdown.parent().outerWidth() - markdown.outerWidth()) / 2;
            //for ipad or wider device
            if (rightMargin >= 133) {
                newbool = true;
                var affixLeftMargin = (tocAffix.outerWidth() - tocAffix.width()) / 2;
                var left = markdown.offset().left + markdown.outerWidth() - affixLeftMargin;
                tocAffix.css('left', left + 'px');
            } else {
                newbool = false;
            }
            if (newbool != enoughForAffixToc) {
                enoughForAffixToc = newbool;
                generateScrollspy();
            }
        }
        $(window).resize(function () {
            windowResize();
        });
        $(document).ready(function () {
            windowResize();
            generateScrollspy();
        });

        //remove hash
        function removeHash() {
            window.location.hash = '';
        }

        var backtotop = $('.back-to-top');
        var gotobottom = $('.go-to-bottom');

        backtotop.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToTop)
                scrollToTop();
            removeHash();
        });
        gotobottom.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            if (scrollToBottom)
                scrollToBottom();
            removeHash();
        });

        var toggle = $('.expand-toggle');
        var tocExpand = false;

        checkExpandToggle();
        toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            tocExpand = !tocExpand;
            checkExpandToggle();
        })

        function checkExpandToggle () {
            var toc = $('.ui-toc-dropdown .toc');
            var toggle = $('.expand-toggle');
            if (!tocExpand) {
                toc.removeClass('expand');
                toggle.text('Expand all');
            } else {
                toc.addClass('expand');
                toggle.text('Collapse all');
            }
        }

        function scrollToTop() {
            $('body, html').stop(true, true).animate({
                scrollTop: 0
            }, 100, "linear");
        }

        function scrollToBottom() {
            $('body, html').stop(true, true).animate({
                scrollTop: $(document.body)[0].scrollHeight
            }, 100, "linear");
        }
    </script>
</body>

</html>
