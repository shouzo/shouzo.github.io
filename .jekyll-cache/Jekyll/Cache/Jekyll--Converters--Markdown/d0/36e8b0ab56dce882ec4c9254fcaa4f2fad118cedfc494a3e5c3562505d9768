I"B<ul id="markdown-toc">
  <li><a href="#20210518---day_4" id="markdown-toc-20210518---day_4">20210518 - Day_4</a>    <ul>
      <li><a href="#æ’°å¯«-makefile" id="markdown-toc-æ’°å¯«-makefile">æ’°å¯« Makefile</a>        <ul>
          <li><a href="#step-1---è£½ä½œç›¸é—œæª”æ¡ˆ" id="markdown-toc-step-1---è£½ä½œç›¸é—œæª”æ¡ˆ">STEP 1 - è£½ä½œç›¸é—œæª”æ¡ˆ</a></li>
          <li><a href="#step-2---è£½ä½œæ˜ åƒæª”" id="markdown-toc-step-2---è£½ä½œæ˜ åƒæª”">STEP 2 - è£½ä½œæ˜ åƒæª”</a></li>
          <li><a href="#å®Œæ•´-makefile-ç¨‹å¼ç¢¼" id="markdown-toc-å®Œæ•´-makefile-ç¨‹å¼ç¢¼">å®Œæ•´ Makefile ç¨‹å¼ç¢¼</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<ul>
  <li>å·¥ä½œç’°å¢ƒ
    <ul>
      <li>Lubuntu 20.04</li>
      <li>VMware Workstation 16.1.1</li>
    </ul>
  </li>
</ul>

<h1 id="20210518---day_4">20210518 - Day_4</h1>
<ul>
  <li>é€²åº¦æ‘˜è¦
    <ol>
      <li>æ’°å¯« Makefile</li>
      <li>æ§åˆ¶ç•«é¢é¡è‰² (ç™½è‰²ã€æ¢ç´‹è‰²)</li>
      <li>çŸ©å½¢çš„ç¹ªè£½èˆ‡è™•ç†</li>
      <li>è¢å¹•é¡¯ç¤ºå‡ºç‹€æ…‹åˆ—åœ–æ¨£</li>
    </ol>
  </li>
  <li>å®Œæ•´å°ˆæ¡ˆ
    <ul>
      <li><a href="https://github.com/shouzo/My-30OS/tree/master/20210518">https://github.com/shouzo/My-30OS/tree/master/20210518</a></li>
    </ul>
  </li>
  <li>åƒè€ƒæ–‡ç« 
    <ul>
      <li><a href="https://www.gnu.org/software/mtools/manual/mtools.html">Mtools 4.0.27</a>
        <ul>
          <li><a href="https://en.wikipedia.org/wiki/Mtools">mcopy - The following refers to mtools usage in floppy images</a></li>
        </ul>
      </li>
      <li><a href="https://stackoverflow.com/questions/45422374/undefined-reference-to-global-offset-table-only-when-generating-binaries">undefined reference to <em>GLOBAL_OFFSET_TABLE</em> (only when generating binaries)</a></li>
      <li><a href="https://blog.gtwang.org/linux/linux-mount/">Linux æª”æ¡ˆç³»çµ±æ›è¼‰ï¼ˆmountï¼‰ä½¿ç”¨æ•™å­¸èˆ‡ç¯„ä¾‹</a></li>
      <li><a href="https://askubuntu.com/questions/986684/how-would-i-extract-a-img-file">How would I extract a .img file</a></li>
      <li><a href="https://www.itread01.com/p/194699.html">Makefile é›™å†’è™Ÿè¦å‰‡ - zxiaocheng</a></li>
      <li><a href="https://www.howtogeek.com/443342/how-to-use-the-mkfs-command-on-linux/">How to Use the mkfs Command on Linux</a></li>
      <li><a href="https://stackoverflow.com/questions/32893607/how-do-i-write-a-bin-file-512-bytes-to-the-first-sector-sector-0-of-a-floppy">How do I write a bin file (512 bytes) to the first sector (sector 0) of a floppy disk?</a></li>
      <li><a href="http://wen00072.github.io/blog/2014/03/14/study-on-the-linker-script/">Linker Scriptåˆæ¢ - GNU Linker Ldæ‰‹å†Šç•¥è®€</a></li>
      <li><a href="http://www.study-area.org/cyril/opentools/opentools/x909.html">gccèˆ‡Objæª”ï¼Œå‹•æ…‹é€£çµèˆ‡ELFæª”</a></li>
      <li><a href="https://blog.louie.lu/2016/11/06/10%E5%88%86%E9%90%98%E8%AE%80%E6%87%82-linker-scripts/">10åˆ†é˜è®€æ‡‚ linker scripts</a></li>
      <li><a href="https://bit.ly/3wijRxO">oslite.ldsã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã®ã¨ãŠã‚Šè¨˜è¿°ã—ã¾ã™ã€‚</a> (åƒè€ƒ oslite.lds çš„ç’°ç¯€ä¾†æ’°å¯«)</li>
    </ul>
  </li>
</ul>

<h2 id="æ’°å¯«-makefile">æ’°å¯« Makefile</h2>
<p>å¾æ’°å¯«åŸå§‹æª”ã€çµ„/ç·¨è­¯ç¨‹å¼ï¼Œåˆ°äº†æœ€å¾Œé‚„è¦è·‘è™›æ“¬æ©Ÿã€‚
å¦‚æœæ¯æ¬¡éƒ½è¦ä¸€è¡Œè¡Œæ‰“æŒ‡ä»¤æœƒå¾ˆè¾›è‹¦ã€‚
æ‰€ä»¥è¦æŠŠé€™äº›æŒ‡ä»¤å¯«æˆ Makefileï¼Œåœ¨å¾€å¾Œçš„æ¸¬è©¦æœƒç›¸å°å®¹æ˜“å’Œç°¡ä¾¿ã€‚</p>

<p>Makefile ä¸»è¦è¦åšçš„äº‹æƒ…æœ‰ï¼š</p>
<ul>
  <li><strong>STEP 1 - è£½ä½œç›¸é—œæª”æ¡ˆ</strong>
    <ul>
      <li>è™•ç†é–‹æ©Ÿç£å€ - <code class="language-plaintext highlighter-rouge">ipl10.asm</code></li>
      <li>åŒ…å«ä½œæ¥­ç³»çµ±æœ¬é«” -<code class="language-plaintext highlighter-rouge">asmhead.asm</code>ã€<code class="language-plaintext highlighter-rouge">nasmfunc.asm</code>ã€<code class="language-plaintext highlighter-rouge">bootpack.c</code>ã€<code class="language-plaintext highlighter-rouge">os.lds</code></li>
    </ul>
  </li>
  <li><strong>STEP 2 - è£½ä½œæ˜ åƒæª”</strong>
    <ul>
      <li>è£½ä½œé–‹æ©Ÿç£å€æ˜ åƒæª”</li>
      <li>å°‡ä½œæ¥­ç³»çµ±æœ¬é«”å¯«å…¥æ˜ åƒæª”</li>
    </ul>
  </li>
</ul>

<h3 id="step-1---è£½ä½œç›¸é—œæª”æ¡ˆ">STEP 1 - è£½ä½œç›¸é—œæª”æ¡ˆ</h3>
<p>ä¸»è¦çš„æŒ‡ä»¤æœ‰é€™äº›</p>
<blockquote>
  <p>nasm ipl10.asm -o ipl10.bin -l ipl10.lst</p>

  <p>nasm asmhead.asm -o asmhead.bin -l asmhead.lst</p>

  <p>nasm -g -f elf nasmfunc.asm -o nasmfunc.o</p>

  <p>gcc -march=i486 -m32 -nostdlib -g -O0 -T os.lds bootpack.c nasmfunc.o -o bootpack.hrb -fno-pie</p>

  <p>cat asmhead.bin bootpack.hrb &gt; haribote.sys</p>
</blockquote>

<h3 id="step-2---è£½ä½œæ˜ åƒæª”">STEP 2 - è£½ä½œæ˜ åƒæª”</h3>
<p>æœ‰å…©ç¨®ç”¢ç”Ÿæ˜ åƒæª”çš„å¯«æ³•ï¼Œé€™å…©ç¨®éƒ½æœƒç”¨åˆ° <code class="language-plaintext highlighter-rouge">mcopy</code>ã€‚
<img src="https://i.imgur.com/xRC0Tut.png" alt="" /></p>

<ul>
  <li><strong>å¯«æ³• 1 (ä¸»è¦æŒ‡ä»¤ - <code class="language-plaintext highlighter-rouge">mformat</code>ã€<code class="language-plaintext highlighter-rouge">mcopy</code>)</strong>ï¼š
    <blockquote>
      <p>mformat -f 1440 -C -B ipl10.bin -i haribote.img ::</p>

      <p>mcopy -i haribote.img haribote.sys ::</p>
    </blockquote>
  </li>
  <li><strong>å¯«æ³• 2 (ä¸»è¦æŒ‡ä»¤ - <code class="language-plaintext highlighter-rouge">dd</code>ã€<code class="language-plaintext highlighter-rouge">mcopy</code>)</strong>ï¼š
    <blockquote>
      <p>dd if=/dev/zero of=haribote.img bs=512 count=2880</p>

      <p>dd if=ipl10.bin of=haribote.img conv=notrunc</p>

      <p>mcopy -i haribote.img haribote.sys ::</p>
    </blockquote>
  </li>
</ul>

<h3 id="å®Œæ•´-makefile-ç¨‹å¼ç¢¼">å®Œæ•´ Makefile ç¨‹å¼ç¢¼</h3>
<ul>
  <li>å°ˆæ¡ˆåŸå§‹æª” (<strong>==Makefile==</strong>)ï¼š<a href="https://github.com/shouzo/My-30OS/tree/master/20210518/Makefile/Makefile">https://github.com/shouzo/My-30OS/tree/master/20210518/Makefile/Makefile</a></li>
</ul>

<p><strong>å°‡ä»¥ä¸Š STEP 1ã€STEP 2 è£¡çš„æŒ‡ä»¤å¯«æˆ Makefileã€‚</strong>
(ä»¥ä¸‹ç‚ºå®Œæ•´ç¨‹å¼ç¢¼)</p>

<p>```
OSNAME := haribote</p>

<p>.DEFAULT_GOAL : all
.PHONY : all
all : img
	DEBUG_DIR := ./debug
	OBJDUMP_FLAGS := â€“full-contents â€“all-headers â€“target=binary â€“architecture=i386:intel â€“disassemble-all</p>

<p>#===============================================================================
ipl10.bin    : ipl10.asm
asmhead.bin  : asmhead.asm
nasmfunc.o   : nasmfunc.asm</p>

<p>%.bin : %.asm 
	@make make-debug-dir
	nasm $^ -o $@ -l ${DEBUG_DIR}/$*.lst</p>

<p>%.o : %.asm
	@make make-debug-dir
	nasm -f elf $^ -o $@ -l ${DEBUG_DIR}/$*.lst</p>

<p>BOOTPACK_FILES := bootpack.c nasmfunc.o
bootpack.hrb : ${BOOTPACK_FILES} os.lds
	@make make-debug-dir</p>

<p>gcc -march=i486 -m32 -nostdlib -g -O0 <br />
	-T os.lds <br />
	-o $@ <br />
	-fno-pie<br />
	${BOOTPACK_FILES}</p>

<p>objdump ${OBJDUMP_FLAGS} $@ &gt; ${DEBUG_DIR}/$@.dasm</p>

<p>${OSNAME}.sys : asmhead.bin bootpack.hrb
%.sys :
	@make make-debug-dir
	cat $^ &gt; $@</p>

<p>objdump ${OBJDUMP_FLAGS} $@ &gt; ${DEBUG_DIR}/$@.dasm</p>
:ET